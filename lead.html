<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Agente - Equipo</title>
  
  <!-- Scripts críticos de redirección -->
  <script>
    // Función para verificar si el usuario es de Team Líneas
    function isTeamLineasUser() {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const username = (userData.username || '').toLowerCase();
        const role = (userData.role || '').toLowerCase();
        return role === 'teamlineas' || username.startsWith('lineas-');
      } catch (e) {
        console.error('Error al verificar usuario de Team Líneas:', e);
        return false;
      }
    }

    // Redirigir SOLO a Team Líneas
    if (isTeamLineasUser() && !window.location.pathname.endsWith('lead-lineas.html')) {
      window.location.replace('/lead-lineas.html');
    }
  </script>
  
  <!-- Interceptor de API para manejo de permisos -->
  <script src="js/api-interceptor.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/theme.css?v=20250905-163930">
  <link rel="stylesheet" href="/css/sidebar-shared.css?v=20250905-163930">
  <link rel="stylesheet" href="/css/form-styles.css?v=20250916">
  
  <!-- Scripts -->
  <script src="js/fetch-interceptor.js"></script>
  <!-- <script src="/agentes-clean/agentes/js/auth-check.js"></script> -->
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <!-- Sistema de Inactividad -->
  <script src="js/crm-config.js"></script>
  <script src="js/inactivity-manager.js"></script>
  <script src="js/crm-init.js"></script>
  <script src="/js/sidebar-loader.js"></script>
  <!-- Redirección ya aplicada arriba; bloque redundante eliminado para evitar parpadeo -->
  <script>
    // Versionado para romper caché (actualiza este valor cuando hagas cambios visibles)
    window.__APP_VERSION__ = '20250905-163930';
    console.info('[lead.html] version', window.__APP_VERSION__);
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <!-- Scripts de la aplicación -->
  <script>
    // Verificación de autenticación deshabilitada
    window.authChecked = true;
  </script>
  <script>
    // Opción para silenciar logs solo si se activa explícitamente
    (function() {
      try {
        const shouldSilence = typeof localStorage !== 'undefined' && localStorage.getItem('silenceLogs') === '1';
        if (shouldSilence && typeof console !== 'undefined') {
          const noop = function(){};
          console.log = noop;
          console.info = noop;
          // console.warn y console.error se mantienen activos
        }
      } catch (e) {
        // Ignorar si localStorage no está disponible
      }
    })();
  </script>
  <!-- <script src="agentes-clean/agentes/js/auth-check.js?v=20250905-163930"></script> -->
  <script src="/js/logout-handler.js?v=20250905-163930"></script>
  <script src="/js/user-info.js?v=20250905-163930"></script>
  <script src="/js/form-config.js?v=20250905-163930"></script>
  <script src="/utils/teams.js?v=20250905-163930"></script>
  <!-- Sistema de Puntación Automática -->
  <!-- <script src="/js/scoring-system.js"></script> -->
  <script>
    // Marcar body como team-lineas lo antes posible para aplicar CSS de ocultamiento
    (function(){
      try {
        const norm = (s)=>String(s||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
        const ALLOW = new Set(['jonathan figueroa','lineas-carlos','lineas-cristian r','lineas-edward','lineas-jocelyn','lineas-luis g','lineas-oscar r','lineas- karla','lineas-karla','lineas- daniel','lineas-daniel','lineas-sandy'].map(norm));
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
        const user = JSON.parse(userStr||'{}');
        const candidates = [user?.username, user?.name, user?.nombre, user?.fullName].map(norm).filter(Boolean);
        let isLineas = candidates.some(n=>ALLOW.has(n));
        try {
          if (!isLineas && window.Teams && typeof window.Teams.getTeamForUser==='function') {
            const t = window.Teams.getTeamForUser(user) || '';
            const tk = norm(t);
            isLineas = (tk === 'team lineas' || tk === 'team lineas 1' || tk === 'team lineas 2');
          }
        } catch {}
        if (isLineas) { document.addEventListener('DOMContentLoaded', ()=>document.body.classList.add('team-lineas')); }
      } catch {}
    })();
  </script>
  <!-- Estilos específicos del formulario -->
  <!-- Script para cargar la información del usuario en el sidebar -->
  <style>
    /* Estilos del sidebar se toman de css/sidebar-shared.css */

    /* Estilos para el contenedor de la gráfica */
    .graph-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
      width: 100%;
      height: 460px;
      max-height: 460px;
      position: relative;
    }
    
    .graph-canvas {
      width: 100% !important;
      height: 100% !important;
      min-height: 420px;
    }
    
    /* Estilos para notificaciones */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      transform: translateX(120%);
      transition: transform 0.3s ease-in-out;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background-color: #10b981;
      border-left: 4px solid #059669;
    }

    .notification.error {
      background-color: #ef4444;
      border-left: 4px solid #dc2626;
    }

    .notification i {
      margin-right: 10px;
      font-size: 20px;
    }

    :root {
      --azul-oscuro: #1e293b;
      --azul-acento: #22b3ec;
      --gris-bg: #f5f7fa;
      --gris-borde: #e3e8ee;
      --gris-titulo: #edf3fa;
      --azul-celda: #f1f5fa;
      --radius: 15px;
      --sombra: 0 4px 24px 0 rgba(30,41,59,0.09);
      --trans: 0.18s;
      --form-width: 420px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Roboto', 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--gris-bg);
      color: var(--azul-oscuro);
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    /* Asegurar capas correctas */
    .main-content { position: relative; z-index: 1; }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      padding: 20px;
      transition: margin 0.3s ease;
      min-height: calc(100vh - 40px); /* Altura mínima para que ocupe toda la pantalla */
      background-color: #f8fafc; /* Fondo para el área de contenido */
    }
    /* LEAD FORM */
    .lead-content-row {
      display: flex;
      flex-direction: row;
      gap: 40px;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px 20px 20px;
      align-items: flex-start;
      box-sizing: border-box;
    }
    .graphs-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 30px;
      min-width: 0;
      width: 100%;
      max-width: 100%;
      height: 100%;
      min-height: 100%;
      box-sizing: border-box;
      padding: 20px 10px;
      overflow-y: auto;
    }
    
    .graph-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: visible;
      box-sizing: border-box;
      width: 100%;
      min-height: 0;  /* Permite que se encoja si es necesario */
    }
    .form-section {
      background: #fcfafa;
      border-radius: 16px;
      padding: 56px 56px; /* laterales cómodos para respiración */
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      width: 100%;
      max-width: 2000px; /* más ancho pero centrado */
      margin: 25px auto;
      border: 1px solid #ffffff;
      position: relative;
      height: calc(100vh - 120px); /* se ajusta a la pantalla */
      overflow: hidden; /* los campos scrollean dentro si es necesario */
      transition: all 0.3s ease;
    }
    
    .form-section:hover {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }
    
    .form-section h2 {
      color: #2c3e50;
      margin: 0 0 14px 0;
      font-size: 1.5rem; /* título más compacto */
      text-align: center;
      font-weight: 700;
      position: relative;
      padding-bottom: 10px;
    }
    
    .form-section h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 2px;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px 15px;
    }
    
    .form-group {
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 60px;
      justify-content: flex-start;
      background: transparent; /* sin contenedor interno */
      border-radius: 0;
      padding: 0; /* sin padding extra */
      border: none; /* sin borde de caja */
      transition: all 0.2s ease;
      margin-bottom: 0;
    }
    
    .form-group-full {
      background: transparent; /* sin contenedor interno */
      border: none;
      padding: 0;
      border-radius: 0;
      grid-column: 1 / -1; /* ocupar ambas columnas para mantener simetría */
      position: relative;
      z-index: auto;
      overflow: visible;
    }
    /* Motivo: mantener el bloque solo en la columna izquierda y fila controlada */
    .form-group-motivo { grid-area: motivo; grid-column: 1 / span 1 !important; z-index: auto; }

    /* Mapear áreas a cada grupo */
    .form-group[data-field="nombre_cliente"] { grid-area: nombre; }
    .form-group[data-field="telefono_alterno"] { grid-area: telefono2; }
    .form-group[data-field="direccion"] { grid-area: direccion; }
    /* "Tipo de servicios" (select id="tipo-servicio") vive en data-field="servicios" en la izquierda, lo mapeamos al slot derecho de esa fila */
    .form-group[data-field="servicios"] { grid-area: tipo_servicios; }
    .form-group.area-servicios { grid-area: servicios; }
    .form-group[data-field="telefono_principal"] { grid-area: telefono; }
    .form-group[data-field="numero_cuenta"] { grid-area: numero; }
    .form-group[data-field="autopay"] { grid-area: autopago; }
    .form-group[data-field="sistema"] { grid-area: sistema; }
    .form-group[data-field="status"] { grid-area: status; }
    .form-group[data-field="riesgo"] { grid-area: riesgo; }
    .form-group[data-field="dia_venta"] { grid-area: dia_venta; }
    .form-group[data-field="dia_instalacion"] { grid-area: dia_instalacion; }
    .form-group[data-field="mercado"] { grid-area: mercado; }
    .form-group[data-field="supervisor"] { grid-area: supervisor; }
    .form-group[data-field="comentario"] { grid-area: comentario; }
    /* Elementos sin data-field: mapear por clase */
    .form-group.area-zip { grid-area: zip; }
    .form-group.area-puntaje { grid-area: puntaje; }
    
    .form-group:hover { background: transparent; box-shadow: none; }
    /* Espacio extra entre Motivo (izquierda) y Status (derecha) */
    .form-group[data-field="status"] { margin-left: 24px; margin-top: 28px !important; }
    
    /* Contenedor del formulario con scroll */
    #crmForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden; /* Ocultar el scroll por defecto */
    }
    
    /* Contenedor de los campos del formulario con scroll */
    .form-fields-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
      margin-right: -8px;
      padding-bottom: 84px;
      display: grid;
      grid-template-columns: repeat(2, minmax(540px, 1fr)); /* 2 columnas un poco más anchas */
      gap: 14px 24px; /* filas x columnas: compacto */
      align-items: start;
      padding-top: 6px;
      grid-auto-flow: row; /* orden natural, evita reacomodos que pueden causar solapes visuales */
      grid-auto-rows: auto; /* que cada fila crezca según su contenido */
      /* Layout fijo por filas/columnas */
      grid-template-areas:
        "nombre telefono"
        "direccion telefono2"
        "servicios tipo_servicios"
        "motivo numero"
        "motivo autopago"
        "motivo sistema"
        "status riesgo"
        "dia_venta dia_instalacion"
        "mercado supervisor"
        "comentario zip"
        "puntaje .";
    }
    .form-group, .form-group-full, .form-group-section { height: auto; }
    
    /* Columnas del formulario */
    .form-column {
      display: contents; /* aplanar para que sus hijos participen del grid padre */
      min-width: 0;
    }
    
    .form-column-left { padding-right: 0; }
    
    .form-column-right { padding-left: 0; }
    
    /* Sección agrupada en la columna derecha */
    .form-group-section {
      display: contents; /* IMPORTANT: que sus hijos participen del grid principal */
    }
    .form-group-section .form-group { margin: 0; }
    /* Aumentar separación superior específicamente para STATUS dentro de la sección derecha */
    .form-group-section .form-group[data-field="status"] { margin-top: 28px !important; }

    /* Distribuir opciones largas en varias columnas para reducir altura */
    .form-group-full .radio-group {
      display: grid !important;
      grid-template-columns: repeat(2, minmax(260px, 1fr));
      gap: 10px 16px !important;
      align-items: start;
      position: relative;
      z-index: 6;
    }
    /* Forzar 2 columnas ordenadas para esta sección específica */
    .radio-grid-2 {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important; /* exactamente dos columnas */
      grid-auto-flow: row; /* fila por fila */
      column-gap: 24px !important;
      row-gap: 12px !important;
      align-items: start;
      justify-items: stretch; /* que cada celda use todo el ancho */
    }
    .radio-grid-2 .radio-label {
      display: flex; /* conservar icono + texto alineado */
      width: 100%;
      margin: 0;
      justify-content: flex-start;
    }
    /* Contenedor del botón ahora es sticky dentro del área scrolleable */
    .form-button-container {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 22px 0 18px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      z-index: 5;
      margin-top: 10px;
      width: 100%;
      grid-column: 1 / -1; /* que ocupe ambas columnas */
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }
    /* Asegurar que el último form-group tenga espacio adicional */
    .form-fields-container .form-group:last-of-type {
      margin-bottom: 24px;
    }
    
    /* Estilo para la barra de desplazamiento */
    .form-fields-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .form-fields-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Contenedor del botón fijo */
    .form-button-container {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px 0 8px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      z-index: 5;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #3498db, #2ecc71);
      color: #fff;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 1.2rem;
      padding: 18px 40px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 400px;
      margin: 15px auto 0;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      position: relative;
      overflow: hidden;
      z-index: 1;
      min-height: 60px;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .btn-submit::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(135deg, #2ecc71, #3498db);
      transition: all 0.4s ease;
      z-index: -1;
    }
    
    .btn-submit:hover::before {
      width: 100%;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
    }
    
    .btn-submit:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #0f172a;
      font-size: 0.92rem;
      transition: color 0.2s ease;
      line-height: 1.2;
      text-transform: none;
      letter-spacing: 0.2px;
    }
    
    .form-group:focus-within label {
      color: #3498db;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.98rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      background-color: #ffffff;
      color: #0f172a;
      min-height: 44px;
      flex: none;
      font-weight: 500;
      border: 1px solid #dfe3ea;
      box-shadow: inset 0 0 0 0 rgba(0,0,0,0);
    }
    
    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
      background-color: #fff;
    }
    
    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 0;
      min-height: 40px;
      align-items: center;
      padding: 4px 0;
      /* sin apilamiento especial */
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #dfe3ea;
      transition: border-color 0.2s ease, background 0.2s ease;
      font-weight: 600;
      min-height: 44px;
    }
    
    .radio-label:hover {
      background: #f8fafc;
      border-color: #c9d2de;
    }
    
    .radio-label input[type="radio"]:checked + span {
      color: #0f172a;
      font-weight: 700;
    }
    
    .radio-label input[type="radio"] {
      margin: 0;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e0;
      border-radius: 50%;
      appearance: none;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .radio-label input[type="radio"]:checked {
      border-color: #3b82f6;
      background-color: #fff;
    }
    
    .radio-label input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: #3b82f6;
      border-radius: 50%;
    }
    
    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }
    
    @media (max-width: 600px) {
      .form-group {
        flex: 1 1 100%;
      }
    }
    
    /* Responsive: Una columna en dispositivos móviles */
    /* En pantallas medianas: 2 columnas algo más compactas */
    @media (max-width: 1200px) {
      .form-fields-container { grid-template-columns: repeat(2, minmax(360px, 1fr)); }
      .form-group-section { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
      .form-group-full .radio-group { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    }

    @media (max-width: 768px) {
      .form-fields-container {
        grid-template-columns: 1fr;
        gap: 18px;
        padding-top: 6px;
      }
      .form-group-section { grid-template-columns: 1fr; }
      .form-group-full .radio-group { grid-template-columns: 1fr; }
      .form-section { max-width: 100%; padding: 22px; }
      .form-group { min-height: 78px; padding: 12px; }
      .form-control { padding: 12px 14px; min-height: 44px; }
      .form-group-section { padding: 14px; }
    }
    .form-section h2 {
      font-weight: 700;
      font-size: 2em;
      color: #183153;
      margin-bottom: 28px;
      margin-top: 0;
    }
    /* Mensajes de error y resaltado de campos inválidos */
    .form-group .error-text {
      display: none;
      color: #dc2626; /* rojo */
      margin-top: 6px;
      font-size: 0.85em;
    }
    .form-group.has-error .form-control {
      border-color: #dc2626;
      box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.10);
    }
    .form-group.has-error .radio-group {
      border-left: 3px solid #dc2626;
      padding-left: 10px;
    }
    .form-group { margin-bottom: 18px;}
    .form-section label {
      color: #25a9dd;
      font-weight: 700;
      margin-bottom: 7px;
      display: block;
    }
    .form-section label[for="fecha-lead"] {
      color: #183153;
    }
    .form-section input, .form-section select {
      background: #f8fcff;
      border-radius: 7px;
      border: 1.5px solid #e4e6f1;
      padding: 13px 15px;
      font-size: 1.12em;
      width: 100%;
      margin-top: 2px;
    }
    .form-section button[type="submit"] {
      background: #25a9dd;
      color: #fff;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      font-size: 1.18em;
      padding: 16px 0;
      width: 100%;
      margin-top: 9px;
      transition: background 0.2s;
    }
    .form-section button[type="submit"]:hover {
      background: #183153;
    }
    .graph-container {
      min-height: 420px;
      height: 460px;
      max-height: 460px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--sombra);
      padding: 20px;
      overflow: visible;
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .graph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .graph-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--azul-oscuro);
    }
    
    .week-navigation {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .week-nav-button {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #64748b;
      transition: all 0.2s ease;
    }
    
    .week-nav-button:hover:not(:disabled) {
      background: #f1f5f9;
      color: var(--azul-acento);
      border-color: #cbd5e1;
    }
    
    .week-nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #semana-actual {
      font-size: 0.9rem;
      color: #64748b;
      min-width: 100px;
      text-align: center;
    }
    
    .graph-scroll-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      margin-bottom: 10px;
    }
    
    .graph-scroll-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    .graph-wrapper {
      min-width: 100%;
      width: max-content;
      height: 300px;
    }
    
    .graph-scroll-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .scroll-button {
      background: #f0f4f8;
      border: 1px solid #d9e2ec;
      border-radius: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #486581;
      transition: all 0.2s ease;
    }
    
    .scroll-button:hover {
      background: #e0e7ff;
      color: #3b82f6;
    }
    
    .scroll-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .scroll-track {
      flex: 1;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    
    .scroll-thumb {
      position: absolute;
      height: 100%;
      background: #3b82f6;
      border-radius: 3px;
      width: 100px;
      left: 0;
      top: 0;
    }
    
    @media (max-width: 1100px) {
      .lead-content-row { 
        flex-direction: column; 
        gap: 20px; 
        max-height: none;
      }
      .main-content { 
        padding: 15px; 
        height: auto;
      }
      .form-section {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        position: relative;
      }
    }
    @media (max-width: 700px) {
      .layout { flex-direction: column;}
      .sidebar { flex-direction: row; width: 100vw; min-height: 0; height: 70px; align-items: center; padding: 7px 0; }
      .sidebar-logo { margin: 0 12px 0 0; }
      .sidebar-title { font-size: 1em; margin-bottom: 0;}
      .sidebar-nav { flex-direction: row; gap: 0; }
      .sidebar-nav button { font-size: 1em; padding: 11px 6px; width: auto; border-radius: 7px; margin:0 3px; }
      .sidebar-lema { display: none;}
      /* Asegurar que el contenido principal quede DEBAJO de la barra superior */
      .main-content { 
        padding: 12px 2px; 
        flex-direction: column;
        margin-left: 0 !important; /* Anula margen del sidebar fijo en desktop */
        margin-top: 70px; /* Altura de la barra superior */
      }
      .lead-content-row { 
        flex-direction: column; 
        gap: 16px; 
        width: 100%;
        max-width: 100%;
      }
      .form-section, .graphs-section { 
        width: 100%;
        max-width: 100%;
        padding: 13px 7px;
      }
      .graphs-section {
        grid-template-columns: 1fr !important;
      }
    }
    /* Estilos para el filtro de fecha */
    .date-filter-container {
      width: 100%;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .date-filter {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .date-filter label {
      color: #15344a;
      font-weight: 600;
      margin-right: 5px;
    }
    
    .date-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background-color: #f9fafb;
      font-size: 14px;
      min-width: 120px;
    }
    
    .filter-button {
      padding: 8px 16px;
      background-color: #15344a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    .filter-button:hover {
      background-color: #1e4b6e;
    }
    
    #reset-filter {
      background-color: #6b7280;
    }
    
    #reset-filter:hover {
      background-color: #4b5563;
    }
    /* Usuario en sidebar: igual que en otras páginas */
    .sidebar .user-info {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
      padding: 0 20px;
    }
    .sidebar .user-info .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 40px;
      color: #4a5568;
    }
    .sidebar .user-info .user-details { margin-top: 10px; }
    .sidebar .user-info .user-name {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #2d3748;
      font-size: 1.1em;
    }
    .sidebar .user-info .user-role {
      display: inline-block;
      font-size: 0.8em;
      color: white;
      background: #4a5568;
      padding: 3px 12px;
      border-radius: 12px;
      margin-top: 5px;
      font-weight: 500;
      text-transform: capitalize;
    }
    /* Teléfono + Servicio (encabezado en línea y campo debajo) */
    .inline-phone-service { display: block; }
    .inline-phone-service .inline-header { display:flex; align-items:center; gap:32px; margin-bottom:6px; }
    .inline-phone-service .inline-header label { margin:0; font-weight:700; color:#25a9dd; }
    .inline-phone-service .radio-group { display:flex; gap:28px; align-items:center; }
    .inline-phone-service .radio-label { display:flex; gap:6px; align-items:center; }
    .inline-phone-service .radio-label input { margin:0; vertical-align: middle; }
    .inline-phone-service .radio-label span { font-weight:700; color:#25a9dd; text-transform: uppercase; letter-spacing: 0.3px; }
    .inline-phone-service .form-control { width:100%; min-width: 240px; }
    /* Ocultamiento forzado para Team Líneas */
    body.team-lineas [data-field="comentario"],
    body.team-lineas [data-field="servicios"],
    body.team-lineas label[for="servicios"],
    body.team-lineas #servicios,
    body.team-lineas select[name="servicios"] {
      display: none !important;
    }
  </style>
</head>
<body>
<button class="menu-toggle" id="menuToggle" style="display: none;">
  <i class="fas fa-bars"></i>
</button>
<div class="layout">
  <!-- Sidebar compartido -->
  <nav class="sidebar sidebar-inicio" data-active="lead"></nav>
  <main class="main-content">
    <div class="lead-content-row">
      <!-- FORMULARIO -->
      <section class="form-section" id="form-panel" style="background: #ffffff; border-radius: 20px; padding: 50px 60px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12); width: 100%; max-width: 1600px; margin: 20px auto; border: 1px solid #e8ecf4; position: relative; min-height: 80vh; transition: all 0.3s ease;">
        <h2>Formulario de Registro</h2>
        <form id="crmForm">
          <!-- Contenedor de campos con scroll -->
          <div class="form-fields-container">
            <!-- COLUMNA IZQUIERDA -->
            <div class="form-column form-column-left">
              <!-- Nombre Cliente -->
              <div class="form-group" data-field="nombre_cliente">
                <label for="nombre-cliente">NOMBRE DEL CLIENTE</label>
                <input type="text" id="nombre-cliente" name="nombre_cliente" class="form-control" required>
              </div>
              
              <!-- Teléfono Alterno -->
              <div class="form-group" data-field="telefono_alterno">
                <label for="telefono_2">TELÉFONO ALTERNO</label>
                <input type="tel" id="telefono_2" name="telefono_2" class="form-control" required>
              </div>
              
              <!-- Dirección -->
              <div class="form-group" data-field="direccion">
                <label for="direccion">DIRECCIÓN *</label>
                <input type="text" id="direccion" name="direccion" class="form-control" required>
              </div>
              
              <!-- Tipo de servicios -->
              <div class="form-group" data-field="servicios">
                <label for="tipo-servicio">TIPO DE SERVICIOS</label>
                <select id="tipo-servicio" name="servicios" class="form-control" required>
                  <option value="">Elige</option>
                  <option value="video">VIDEO</option>
                  <option value="internet">INTERNET</option>
                  <option value="att-air">AT&T AIR</option>
                  <option value="wireless">WIRELESS</option>
                  <option value="single-internet">SINGLE INTERNET</option>
                  <option value="frontier">FRONTIER</option>
                  <option value="windstream">WINDSTREAM</option>
                  <option value="optimum">OPTIMUM</option>
                  <option value="wow">WOW</option>
                  <option value="altafiber">ALTAFIBER</option>
                  <option value="consolidate">CONSOLIDATE</option>
                  <option value="hughesnet">HUGHESNET</option>
                  <option value="viasat">VIASAT</option>
                  <option value="centurylink">CENTURYLINK</option>
                  <option value="metronet">METRONET</option>
                  <option value="ziply-fiber">ZIPLY FIBER</option>
                  <option value="hawaiian">HAWAIIAN</option>
                  <option value="double-play">DOUBLE PLAY</option>
                  <option value="vivint">VIVINT</option>
                  <option value="brightspeed">BRIGHTSPEED</option>
                  <option value="mobility">MOBILITY</option>
                  <option value="sim-mobility">SIM MOBILITY</option>
                  <option value="earthlink">EARTHLINK</option>
                  <option value="earthlink">XFINITY</option>
                </select>
              </div>
              
              <!-- Servicios (izquierda) -->
              <div class="form-group area-servicios">
                <label for="servicios">SERVICIOS</label>
                <select id="servicios" name="servicios" class="form-control" required>
                  <option value="">Elige</option>
                  <option value="video-directv-internet">VIDEO DIRECTV VIA INTERNET</option>
                  <option value="video-directv-satelite">VIDEO DIRECTV VIA SATELITE</option>
                  <option value="att-air">ATT AIR</option>
                  <option value="att-18-25-mb">ATT 18 - 25 MB</option>
                  <option value="att-50-100-mb">ATT 50 - 100 MB</option>
                  <option value="att-300-500-mb">ATT 300 - 500 MB</option>
                  <option value="att-1g-plus">ATT 1G+</option>
                  <option value="mobility-spectrum">MOBILITY SPECTRUM</option>
                  <option value="sim-spectrum">SIM SPECTRUM</option>
                  <option value="frontier-200-mb">FRONTIER 200 MB</option>
                  <option value="frontier-500-mb">FRONTIER 500 MB</option>
                  <option value="frontier-1g">FRONTIER 1G</option>
                  <option value="frontier-2g-plus">FRONTIER 2G+</option>
                  <option value="spectrum-500">SPECTRUM 500</option>
                  <option value="spectrum-1g">SPECTRUM 1G</option>
                  <option value="spectrum-2g">SPECTRUM 2G</option>
                  <option value="internet-wow">INTERNET WOW</option>
                  <option value="internet-altafiber">INTERNET ALTA FIBER</option>
                  <option value="internet-windstream">INTERNET WINDSTREAM</option>
                  <option value="internet-hughesnet">INTERNET HUGHESNET</option>
                  <option value="internet-viasat">INTERNET VIASAT</option>
                  <option value="internet-consolidate">INTERNET CONSOLIDATE</option>
                  <option value="internet-centurylink">INTERNET CENTURYLINK</option>
                  <option value="internet-metronet">INTERNET METRONET</option>
                  <option value="internet-ziply-fiber">INTERNET ZIPLY FIBER</option>
                  <option value="internet-hawaiian">INTERNET HAWAIIAN</option>
                  <option value="video-select-spectrum">VIDEO SELECT SPECTRUM</option>
                  <option value="double-play-spectrum">DOUBLE PLAY SPECTRUM</option>
                  <option value="brightspeed-10-100">BRIGHTSPEED 10-100MBPS</option>
                  <option value="brightspeed-100-900">BRIGHTSPEED 100-900MBPS</option>
                  <option value="internet-optimum">INTERNET OPTIMUM</option>
                  <option value="internet-earthlink">INTERNET EARTHLINK</option>
                  <option value="xfinity-double-play">XFINITY DOUBLE PLAY</option>
                  <option value="xfinity-100-299">XFINITY 100 - 299 MBPS</option>
                  <option value="xfinity-300">XFINITY 300MBPS</option>
                  <option value="xfinity-500-plus">XFINITY 500MBPS+</option>
                  <option value="xfinity-ultimate-tv">XFINITY ULTIMATE TV</option>
                  <option value="xfinity-unlimited-voip">XFINITY UNLIMITED VOIP</option>
                </select>
              </div>
              
              <!-- Motivo de la llamada -->
              <div class="form-group form-group-full form-group-motivo">
                <label>¿POR QUÉ LLAMÓ EL CLIENTE? *</label>
                <div class="radio-group radio-grid-2" style="display:grid; grid-template-columns: 1fr 1fr; column-gap:24px; row-gap:12px;">
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="BILL ALTO" required />
                    <span>BILL ALTO</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="PROBLEMAS DE INTERNET" required />
                    <span>PROBLEMAS DE INTERNET</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="ADQUIRIR SERVICIOS" required />
                    <span>ADQUIRIR SERVICIOS</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="MUDANZA" required />
                    <span>MUDANZA</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="CANCELAR SERVICIOS" required />
                    <span>CANCELAR SERVICIOS</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="PAGAR BILL" required />
                    <span>PAGAR BILL</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="motivo-llamada" value="ATENCION AL CLIENTE" required />
                    <span>ATENCION AL CLIENTE</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- COLUMNA DERECHA -->
            <div class="form-column form-column-right">
              <!-- Teléfono Principal -->
              <div class="form-group" data-field="telefono_principal">
                <label for="telefono-principal">TELÉFONO PRINCIPAL</label>
                <input type="tel" id="telefono-principal" name="telefono_principal" class="form-control" required>
              </div>
              
              <!-- Número de cuenta -->
              <div class="form-group" data-field="numero_cuenta">
                <label for="numero-cuenta">NÚMERO DE CUENTA</label>
                <input type="text" id="numero-cuenta" name="numero_cuenta" class="form-control" required>
              </div>
              
              <!-- Autopago -->
              <div class="form-group" data-field="autopay">
                <label for="autopago">AUTOPAGO</label>
                <select id="autopago" name="autopay" class="form-control" required>
                  <option value="">Elige</option>
                  <option value="si">SI</option>
                  <option value="no">NO</option>
                </select>
              </div>
              
              <!-- Sistema -->
              <div class="form-group" data-field="sistema">
                <label for="sistema">SISTEMA</label>
                <select id="sistema" name="sistema" class="form-control" required>
                  <option value="">Elige</option>
                  <option value="sara">SARA</option>
                  <option value="bo">B.O</option>
                  <option value="na">N/A</option>
                  <option value="chuzo">CHUZO</option>
                </select>
              </div>
              
              <!-- Status y campos adicionales en una sección -->
              <div class="form-group-section">
                <!-- Status -->
                <div class="form-group" data-field="status">
                  <label>STATUS</label>
                  <div class="radio-group">
                    <label class="radio-label">
                      <input type="radio" name="status" value="PENDING" required />
                      <span>PENDING</span>
                    </label>
                    <label class="radio-label">
                      <input type="radio" name="status" value="REPRO" />
                      <span>REPRO</span>
                    </label>
                  </div>
                </div>
                
                <!-- Riesgo -->
                <div class="form-group" data-field="riesgo">
                  <label for="riesgo">RIESGO</label>
                  <select id="riesgo" name="riesgo" class="form-control" required>
                    <option value="">Elige</option>
                    <option value="low">LOW</option>
                    <option value="medium">MEDIUM</option>
                    <option value="high">HIGH</option>
                    <option value="na">N/A</option>
                  </select>
                </div>
                
                <!-- Día de venta -->
                <div class="form-group" data-field="dia_venta">
                  <label for="dia-venta">DÍA DE VENTA</label>
                  <input type="date" id="dia-venta" name="dia_venta" class="form-control" required>
                </div>
                
                <!-- Día de instalación -->
                <div class="form-group" data-field="dia_instalacion">
                  <label for="dia-instalacion">DÍA DE INSTALACIÓN</label>
                  <input type="date" id="dia-instalacion" name="dia_instalacion" class="form-control" required>
                </div>
                
                <!-- Mercado -->
                <div class="form-group" data-field="mercado">
                  <label for="mercado">MERCADO</label>
                  <select id="mercado" name="mercado" class="form-control" required>
                    <option value="">Seleccione</option>
                    <option value="icon">ICON</option>
                    <option value="bamo">BAMO</option>
                  </select>
                </div>
                
                <!-- Supervisor -->
                <div class="form-group" data-field="supervisor">
                  <label for="supervisor">SUPERVISOR</label>
                  <select id="supervisor" name="supervisor" class="form-control" required>
                    <option value="">Seleccione</option>
                    <option value="IRANIA">IRANIA</option>
                    <option value="ROBERTO">ROBERTO</option>
                    <option value="MARISOL">MARISOL</option>
                    <option value="PLEITEZ">PLEITEZ</option>
                    <option value="JOHANA">JOHANA</option>
                    <option value="JONATHAN">JONATHAN</option>
                  </select>
                </div>
                
                <!-- Comentario -->
                <div class="form-group" data-field="comentario">
                  <label for="comentario">COMENTARIO *</label>
                  <select id="comentario" name="comentario" class="form-control" required>
                    <option value="">Elige</option>
                    <option value="ADQUIRIR SERVICIOS">ADQUIRIR SERVICIOS</option>
                    <option value="CANCELAR SERVICIO ANTERIOR">CANCELAR SERVICIO ANTERIOR</option>
                    <option value="QUITAR FEE $99.00">QUITAR FEE $99.00</option>
                    <option value="CREAR ORDEN DE INTERNET">CREAR ORDEN DE INTERNET</option>
                  </select>
                </div>
                
                <!-- ZIP CODE -->
                <div class="form-group area-zip">
                  <label for="zip-code">ZIP CODE</label>
                  <input type="text" id="zip-code" name="zip-code" class="form-control" required>
                </div>
                
                <!-- Puntaje (Auto-calculado) -->
                <div class="form-group area-puntaje">
                  <label for="puntaje">
                    PUNTAJE 
                    <span style="font-size: 0.75em; color: #22b3ec; font-weight: normal;">(Auto)</span>
                  </label>
                  <input 
                    type="text" 
                    id="puntaje" 
                    name="puntaje" 
                    class="form-control" 
                    readonly 
                    required
                    style="background-color: #f0f9ff; cursor: not-allowed; font-weight: 600; color: #0369a1;"
                    placeholder="Selecciona servicio y riesgo"
                  />
                  <input type="hidden" id="puntaje-value" name="puntaje-value" />
                </div>
              </div>
            </div>
          
          <!-- Contenedor del botón dentro del área scrolleable (sticky) -->
          <div class="form-button-container">
            <button type="submit" class="btn-submit">Guardar Lead</button>
          </div>
          </div> <!-- Cierre del form-fields-container -->
        </form>
      </section>
      <script>
        // Limpieza agresiva para Team Líneas: remover del DOM "comentario" y "servicios" si aún aparecen
        (function(){
          const cleanup = () => {
            try {
              if (!document.body.classList.contains('team-lineas')) return;
              // 1) data-field="comentario"
              const com = document.querySelector('[data-field="comentario"]');
              if (com) com.remove();
              // 2) data-field="servicios"
              const dfServ = document.querySelector('[data-field="servicios"]');
              if (dfServ) dfServ.remove();
              // 3) select[name="servicios"] o #servicios y su contenedor
              const selByName = document.querySelector('select[name="servicios"]');
              if (selByName) { const c = selByName.closest('[data-field], .form-group'); if (c) c.remove(); else selByName.remove(); }
              const selById = document.getElementById('servicios');
              if (selById) { const c2 = selById.closest('[data-field], .form-group'); if (c2) c2.remove(); else selById.remove(); }
              const lbl = document.querySelector('label[for="servicios"]');
              if (lbl) { const c3 = lbl.closest('[data-field], .form-group'); if (c3) c3.remove(); else lbl.remove(); }
              // 4) Bloque alterno: label con texto "¿Por qué llamó el cliente?"q
              const norm = (s)=>String(s||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
              document.querySelectorAll('.form-group label').forEach(lab => {
                try {
                  const t = norm(lab.textContent);
                  if (t.includes('por que llamo el cliente')) {
                    const cg = lab.closest('.form-group');
                    if (cg) cg.remove();
                  }
                } catch {}
              });
            } catch (e) { console.warn('[Team Lineas] cleanup error:', e); }
          };
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', cleanup);
          } else {
            cleanup();
          }
          // Por si UI dinámica vuelve a inyectar algo, intentar de nuevo tras un tick
          setTimeout(cleanup, 300);
        })();
      </script>
    </div>
  </main>
</div>
<script>
  // Forzar recarga de la info del usuario cuando la página termina de cargar
  window.addEventListener('load', function() {
    if (window.cargarInfoUsuario) {
      try { window.cargarInfoUsuario(); } catch (e) { console.warn('cargarInfoUsuario falló:', e); }
    }
  });
</script>
<!-- Chart.js ya está cargado en <head>; se elimina la inclusión duplicada -->
<script>
  // Aplicar configuración dinámica del formulario según el equipo del usuario
  (function() {
    function applyConfigForCurrentUser() {
      try {
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
        const user = JSON.parse(userStr || '{}');
        const teamKey = (window.Teams && typeof window.Teams.getTeamForUser === 'function')
          ? (window.Teams.getTeamForUser(user) || '')
          : '';
        if (teamKey && typeof window.applyTeamFormConfig === 'function') {
          window.__currentTeamKey = String(teamKey).toLowerCase();
          console.log('Aplicando configuración de formulario para equipo:', window.__currentTeamKey);
          window.applyTeamFormConfig(window.__currentTeamKey);
        }
      } catch (e) {
        console.warn('No se pudo aplicar la configuración del formulario por equipo:', e);
      }
    }

    // Al cargar el DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyConfigForCurrentUser);
    } else {
      applyConfigForCurrentUser();
    }

    // Cuando el sidebar cargue (puede actualizar user info)
    document.addEventListener('sidebar:loaded', applyConfigForCurrentUser);
  })();
  </script>

<script>
// Forzar la visualización del sidebar
document.addEventListener('DOMContentLoaded', function() {
  // Asegurarse de que el sidebar esté visible
  const sidebar = document.querySelector('.sidebar.sidebar-inicio');
  if (sidebar) {
    sidebar.style.display = 'flex';
    sidebar.style.visibility = 'visible';
    sidebar.style.opacity = '1';
    sidebar.style.transform = 'translateX(0)';
  
  // Manejar el menú en dispositivos móviles
  const menuToggle = document.getElementById('menuToggle');
  
  // Mostrar/ocultar menú en móviles
  function checkScreenSize() {
    if (window.innerWidth <= 768) {
      menuToggle.style.display = 'block';
      sidebar.classList.remove('active');
    } else {
      menuToggle.style.display = 'none';
      sidebar.classList.add('active');
    }
  }
  
  // Verificar tamaño de pantalla al cargar y al redimensionar
  checkScreenSize();
  window.addEventListener('resize', checkScreenSize);
  
  // Alternar menú al hacer clic en el botón
  menuToggle.addEventListener('click', function() {
    sidebar.classList.toggle('active');
  });
  
  // Cerrar menú al hacer clic en un enlace
  document.querySelectorAll('.sidebar .btn-sidebar').forEach(link => {
    link.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('active');
      }
    });
  });
  } // Cierre del if (sidebar)
});
</script>

<script>
  // Datos de prueba para la gráfica
  const datosPrueba = [
    { fecha: '2025-08-06', ventas: 5, puntaje: 25 },
    { fecha: '2025-08-07', ventas: 8, puntaje: 40 },
    { fecha: '2025-08-08', ventas: 12, puntaje: 60 },
    { fecha: '2025-08-09', ventas: 7, puntaje: 35 },
    { fecha: '2025-08-10', ventas: 15, puntaje: 75 },
    { fecha: '2025-08-11', ventas: 10, puntaje: 50 },
    { fecha: '2025-08-12', ventas: 18, puntaje: 90 }
  ];
  
  // Función para mostrar mensajes de error
  function mostrarMensajeError(mensaje) {
    console.error(mensaje);
    // Crear notificación visual si no existe
    let notification = document.querySelector('.notification.error');
    if (!notification) {
      notification = document.createElement('div');
      notification.className = 'notification error';
      notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span></span>';
      document.body.appendChild(notification);
    }
    
    // Mostrar el mensaje
    const span = notification.querySelector('span');
    if (span) {
      span.textContent = mensaje;
    }
    
    // Mostrar la notificación
    notification.classList.add('show');
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  }
  
  // Nota: Se mantiene una única implementación de actualizarGraficaVentasPuntaje() más abajo.

  // Función para actualizar la gráfica de ventas y puntaje con datos de la colección costumer
  async function actualizarGraficaVentasPuntaje(datos = null) {
    // No hacer nada si el usuario es de Team Líneas
    if (isTeamLineasUser()) {
      console.log('[GRAFICA] Usuario de Team Líneas detectado, omitiendo actualización de gráfica');
      return;
    }
    try {
      console.log('=== INICIANDO ACTUALIZACIÓN DE GRÁFICA DE VENTAS ===');
      
      // Si se proporcionan datos directamente, úsalos y omite la llamada al backend
      if (Array.isArray(datos) && datos.length) {
        console.log('Usando datos proporcionados para la gráfica');
        return await procesarDatosGrafica(datos);
      }
      
      // Obtener el nombre del agente del localStorage o del DOM
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const nombreAgente = userData.name || 'Usuario';
      
      // Obtener la fecha actual y la fecha de hace 6 días (últimos 7 días incluyendo hoy)
      const hoy = new Date();
      const fechaInicio = new Date();
      fechaInicio.setDate(hoy.getDate() - 6);
      
      // Función para formatear fechas como YYYY-MM-DD
      const formatoFecha = (fecha) => {
        return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
      };
      
      // Construir la URL del endpoint de leads con filtro por agente (backend lo soporta vía query "agente")
      // Filtramos últimos 7 días en frontend; el backend devuelve los leads del agente solicitado
      let url = '/api/leads';
      try {
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
        const user = JSON.parse(userStr);
        const roleLower = ((user && user.role) || '').toString().toLowerCase();
        const agenteNombreQuery = (user && (user.username || user.name)) || nombreAgente || '';
        const u = new URL(url, location.origin);
        const params = new URLSearchParams(u.search);
        // Solo los agentes se filtran por su propio nombre; roles privilegiados ven todo
        if (roleLower === 'agent' && agenteNombreQuery) {
          params.set('agente', agenteNombreQuery);
          console.info('[Filtro agente] (rol agent) Enviado en query a /api/leads:', agenteNombreQuery);
        } else {
          console.info('[Filtro agente] Rol no-agent detectado (', roleLower, '): no se envía parámetro agente');
        }
        const qs = params.toString();
        url = qs ? `${u.pathname}?${qs}` : `${u.pathname}`;
      } catch (e) {
        console.warn('No se pudo construir la URL con filtro por agente:', e?.message);
      }
      console.log('Solicitando datos a:', url);
      
      // Realizar la petición a la API (incluyendo Authorization si hay token)
      console.log('Realizando petición a:', url);
      const tokenForGet = localStorage.getItem('token') || sessionStorage.getItem('token');
      const baseHeaders = {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache'
      };
      if (tokenForGet) baseHeaders['Authorization'] = `Bearer ${tokenForGet}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: baseHeaders,
        credentials: 'same-origin'
      });
      
      // Verificar si la respuesta es exitosa; si no, usar datos de prueba
      if (!response.ok) {
        let bodyText = '';
        try { bodyText = await response.text(); } catch (_) {}
        console.warn(`Respuesta no OK (${response.status}). Cuerpo:`, bodyText);
        return await procesarDatosGrafica(datosPrueba);
      }
      
      // Obtener los datos de la respuesta
      const responseData = await response.json();
      console.log('Datos recibidos de la API:', responseData);
      
      // Extraer el array de clientes de la respuesta de forma robusta
      const safeData = responseData || {};
      console.log('Estructura de la respuesta:', safeData);
      
      // El backend devuelve {success: true, data: [...]}
      let costumers = [];
      if (Array.isArray(safeData)) {
        costumers = safeData; // Si la respuesta es directamente un array
      } else if (Array.isArray(safeData.data)) {
        costumers = safeData.data; // Si la respuesta es {data: [...]}
      } else if (Array.isArray(safeData.leads)) {
        costumers = safeData.leads; // Si la respuesta es {leads: [...]}
      } else if (Array.isArray(safeData.customers)) {
        costumers = safeData.customers; // Si la respuesta es {customers: [...]}
      }

      console.log(`Datos extraídos: ${costumers.length} registros`);

      // Si no hay datos, usar datos de prueba
      if (!Array.isArray(costumers) || costumers.length === 0) {
        console.warn('No se encontraron datos en la respuesta. Usando datos de prueba.');
        console.log('Respuesta completa:', JSON.stringify(safeData, null, 2));
        return await procesarDatosGrafica(datosPrueba);
      }

      // Paginación: si la respuesta indica más páginas, traerlas y combinarlas
      try {
        const totalPages = Number(safeData.pages || 1);
        const currentPage = Number(safeData.page || 1);
        const limit = Number(safeData.limit || 50);
        if (totalPages > currentPage) {
          console.log(`[PAGINACIÓN] Se detectaron ${totalPages} páginas (actual: ${currentPage}). Descargando páginas restantes...`);
          // Reconstruir query params para preservar filtros
          const u = new URL(url, location.origin);
          const baseParams = new URLSearchParams(u.search);
          baseParams.set('limit', String(limit || 50));
          for (let p = currentPage + 1; p <= totalPages; p++) {
            baseParams.set('page', String(p));
            const pageUrl = `${u.pathname}?${baseParams.toString()}`;
            console.log(`[PAGINACIÓN] Solicitando página ${p}:`, pageUrl);
            const r = await fetch(pageUrl, {
              method: 'GET',
              headers: baseHeaders,
              credentials: 'same-origin'
            });
            if (!r.ok) {
              let errTxt = '';
              try { errTxt = await r.text(); } catch (_) {}
              console.warn(`[PAGINACIÓN] Respuesta no OK en página ${p}:`, r.status, errTxt);
              continue;
            }
            const d = await r.json();
            const arr = Array.isArray(d)
              ? d
              : (Array.isArray(d.leads) ? d.leads
                : (Array.isArray(d.customers) ? d.customers
                  : (Array.isArray(d.data) ? d.data : [])));
            console.log(`[PAGINACIÓN] Página ${p} retornó ${arr.length} registros`);
            costumers = costumers.concat(arr);
          }
          console.log(`[PAGINACIÓN] Total acumulado tras paginación: ${costumers.length}`);
        }
      } catch (e) {
        console.warn('[PAGINACIÓN] Error durante la descarga de páginas adicionales:', e?.message);
      }
      
      // Filtro Team Líneas a nivel de documentos crudos (ANTES de agregar por día)
      try {
        const norm = (s) => (window.Teams && typeof window.Teams.norm === 'function')
          ? window.Teams.norm(s)
          : (function(x){ try { return String(x||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/[^a-z0-9 ]+/g,'').replace(/\s+/g,' ');} catch { return ''; } })(s);
        const canonicalFromName = (name) => (window.Teams && typeof window.Teams.canonicalFromName === 'function')
          ? window.Teams.canonicalFromName(name)
          : norm(name);
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
        const user = JSON.parse(userStr||'{}');
        const teamKey = (window.Teams && typeof window.Teams.getTeamForUser==='function') ? (window.Teams.getTeamForUser(user) || '') : '';
        const tk = norm(teamKey);
        const isLineas = (tk === 'team lineas 1' || tk === 'team lineas 2');
        if (isLineas && window.Teams && typeof window.Teams.getAgentsByTeam==='function') {
          const allowed = new Set((window.Teams.getAgentsByTeam(teamKey) || []).map(canonicalFromName).map(norm));
          const before = Array.isArray(costumers) ? costumers.length : 0;
          const expectedSupervisor = (tk === 'team lineas 1') ? 'jonathan' : (tk === 'team lineas 2') ? 'gutierrez' : '';
          costumers = (costumers || []).filter(c => {
            const raw = c.agenteNombre || c.nombreAgente || c.agente || '';
            const canon = norm(canonicalFromName(raw));
            if (allowed.has(canon)) return true;
            // Fallback por supervisor para robustez
            const sup = norm(c.supervisor || c.SUPERVISOR || '');
            if (expectedSupervisor && sup.includes(expectedSupervisor)) return true;
            return false;
          });
          // Logs de depuración
          try {
            console.log('[Lead][Team Líneas] allowed agents:', Array.from(allowed));
            console.log('[Lead][Team Líneas] primeros docs mapeados:', (costumers||[]).slice(0,5).map(c=>({
              agenteRaw: c.agenteNombre || c.nombreAgente || c.agente || '',
              agenteCanon: norm(canonicalFromName(c.agenteNombre || c.nombreAgente || c.agente || '')),
              supervisor: c.supervisor || c.SUPERVISOR || ''
            })));
          } catch {}
          console.log(`[Lead] [actualizarGraficaVentasPuntaje] Filtro Team Líneas (${tk}) aplicado: ${before} -> ${costumers.length}`);
        }
      } catch (e) {
        console.warn('[Lead] No se pudo aplicar filtro Team Líneas previo a la agregación:', e);
      }

      // Inicializar un objeto para almacenar las ventas por día (claves en día de negocio UTC-6)
      const ventasPorDia = {};
      
      // Helper local para esta función: convertir Date a YYYY-MM-DD en TZ negocio
      const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // UTC-6 fijo
      const toISOInTZ_local = (date, tzOffsetMinutes) => {
        const target = new Date(date.getTime() + tzOffsetMinutes * 60000);
        const y = target.getUTCFullYear();
        const m = String(target.getUTCMonth() + 1).padStart(2, '0');
        const d = String(target.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };
      
      // Helper: obtener valor por ruta anidada (e.g., "_raw.createdAt")
      const getByPath = (obj, path) => {
        try {
          return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj);
        } catch (_) {
          return undefined;
        }
      };
      
      // Helper: retorna el primer valor definido no vacío entre múltiples rutas
      const findFirst = (obj, paths) => {
        for (const p of paths) {
          const v = getByPath(obj, p);
          if (v !== undefined && v !== null && v !== '') return v;
        }
        return undefined;
      };
      
      // Inicializar los últimos 7 días "rodantes" en la zona de negocio
      const fechasUltimos7Dias = new Set();
      const hoyISO = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
      const [hy, hm, hd] = hoyISO.split('-').map(Number);
      const baseUTCNoon = new Date(Date.UTC(hy, hm - 1, hd, 12, 0, 0));
      for (let i = 6; i >= 0; i--) {
        const fechaUTC = new Date(baseUTCNoon);
        fechaUTC.setUTCDate(baseUTCNoon.getUTCDate() - i);
        const clave = toISOInTZ_local(fechaUTC, BUSINESS_TZ_OFFSET_MIN);
        fechasUltimos7Dias.add(clave);
        ventasPorDia[clave] = { ventas: 0, puntaje: 0 };
      }
      console.log('Rango últimos 7 días (UTC-6):', Array.from(fechasUltimos7Dias));
      
      console.log('Clientes a procesar:', costumers);
      // Guardar la fecha más reciente encontrada en los datos (YYYY-MM-DD en TZ negocio)
      let maxFechaISOFromData = null;
      // Exponer variables y helpers para depuración en consola
      try {
        const g = (typeof window !== 'undefined' ? window : (typeof globalThis !== 'undefined' ? globalThis : this));
        g.__lastResponse = responseData;
        g.__lastCostumers = costumers;
        g.__fechasUltimos7Dias = Array.from(fechasUltimos7Dias);
        g.__hoyISO = hoyISO;
        g.__getByPath = getByPath;
        g.debugDates = function(index = 0) {
          const c = (g.__lastCostumers || [])[index];
          if (!c) { console.warn('debugDates: índice fuera de rango'); return null; }
          const paths = [
            // Raíz
            'dia_venta','diaVenta','dia','fecha','fecha_lead',
            'fecha_creacion','fechaCreacion','createdAt','created_at','createdon','createdOn',
            'created','insertedAt','inserted_at','createdDate','created_date','created_datetime',
            // _raw
            '_raw.dia_venta','_raw.diaVenta','_raw.dia','_raw.fecha','_raw.fecha_lead',
            '_raw.fecha_creacion','_raw.fechaCreacion','_raw.createdAt','_raw.created_at','_raw.createdon','_raw.createdOn',
            '_raw.created','_raw.insertedAt','_raw.inserted_at','_raw.createdDate','_raw.created_date','_raw.created_datetime',
            // metadata
            'metadata.createdAt','metadata.created_at','metadata.createdon','metadata.createdOn',
            // audit/timestamps
            'audit.createdAt','audit.created_at','audit.createdon','audit.createdOn',
            'timestamps.createdAt','timestamps.created_at','timestamps.createdon','timestamps.createdOn'
          ];
          const byPath = (p)=>{
            try { return g.__getByPath(c, p); } catch { return undefined; }
          };
          const found = paths.map(p => ({ path: p, value: byPath(p) }))
                            .filter(x => x.value !== undefined && x.value !== null && x.value !== '');
          console.table(found);
          return { index, hoyISO: g.__hoyISO, found };
        };
      } catch (_) {}
      
      // Procesar los datos de los clientes
      if (Array.isArray(costumers)) {
        if (costumers.length > 0) {
          costumers.forEach(costumer => {
          console.log('Procesando cliente:', costumer);
          
          // Elegir día de negocio priorizando dia_venta; si no, usar fechas de creación
          let fechaStr = '';
          const createdPaths = [
            'creadoEn','fecha_creacion','fechaCreacion','createdAt','created_at','createdon','createdOn','fecha',
            '_raw.creadoEn','_raw.fecha_creacion','_raw.fechaCreacion','_raw.createdAt','_raw.created_at','_raw.fecha',
            'metadata.createdAt','audit.createdAt','timestamps.createdAt'
          ];
          const diaVentaPaths = ['dia_venta','diaVenta'];

          const tryDateFrom = (val) => {
            if (!val) return null;
            if (typeof val === 'string') {
              const s = val.trim();
              // YYYY-MM-DD
              if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                const [y,m,d] = s.split('-').map(Number);
                return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
              }
              // DD/MM/YYYY o DD-MM-YYYY (asumimos day-first)
              if (/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)) {
                const parts = s.split(/[\/\-]/).map(Number);
                const [d,m,y] = parts;
                if (d >= 1 && d <= 31 && m >= 1 && m <= 12 && y >= 1900) {
                  return new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
                }
              }
            }
            if (typeof val === 'number') return new Date(val < 1e12 ? val*1000 : val);
            const dt = new Date(val); return isNaN(dt) ? null : dt;
          };

          // 1) Intentar con dia_venta primero
          let fecha = null;
          const diaVentaVal = findFirst(costumer, diaVentaPaths);
          fecha = tryDateFrom(typeof diaVentaVal === 'string' ? diaVentaVal.trim() : diaVentaVal);
          
          // 2) Si dia_venta no es válido, intentar con fechas de creación
          if (!fecha) {
            const fechaCreacionVal = findFirst(costumer, createdPaths);
            fecha = tryDateFrom(fechaCreacionVal);
          }

          if (fecha && !isNaN(fecha.getTime())) {
            fechaStr = toISOInTZ_local(fecha, BUSINESS_TZ_OFFSET_MIN);
            console.log('Fecha elegida (prior DIA_VENTA, fallback CREACION):', fechaStr);
          } else {
            // Fallback a hoy si nada es válido
            fechaStr = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
          }
          
          // Si no hay fecha válida, usar la fecha actual
          if (!fechaStr) {
            fechaStr = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
            console.log('Usando fecha actual:', fechaStr);
          }
          
          // Contar solo si la fecha pertenece a los últimos 7 días inicializados
          if (!fechasUltimos7Dias.has(fechaStr)) {
            return; // omitir registros fuera del rango
          }
          
          // Obtener el puntaje (puede estar en diferentes campos o ser un número)
          let puntaje = 0;
          if (typeof costumer.puntaje === 'number') {
            puntaje = costumer.puntaje;
          } else if (typeof costumer.puntaje === 'string') {
            puntaje = parseFloat(costumer.puntaje) || 0;
          } else if (costumer.score) {
            puntaje = parseFloat(costumer.score) || 0;
          }
          
          console.log(`Registrando venta para ${fechaStr}: +1 venta, +${puntaje} puntos`);
          
          // Contar la venta y sumar el puntaje (total diario)
          ventasPorDia[fechaStr].ventas += 1;
          ventasPorDia[fechaStr].puntaje += puntaje;
          // Registrar fecha máxima encontrada para posible reanclaje de ventana
          if (!maxFechaISOFromData || fechaStr > maxFechaISOFromData) {
            maxFechaISOFromData = fechaStr;
          }
          });
        } else {
          console.info('No hay clientes para procesar (array vacío). Se mostrará la gráfica con ceros.');
        }
      } else {
        console.warn('La respuesta no es un array:', costumers);
      }
      
      // Si no hubo ventas en la semana actual, intentar reanclar la ventana a la última semana con datos
      try {
        const totalVentasSemanaActual = Object.values(ventasPorDia).reduce((acc, v) => acc + (Number(v.ventas) || 0), 0);
        if (totalVentasSemanaActual === 0 && maxFechaISOFromData) {
          console.warn('[Reanclaje] No hay ventas en los últimos 7 días desde hoy. Reanclando a la última fecha con datos:', maxFechaISOFromData);
          // Recalcular el set de días basado en la fecha máxima detectada
          const [ry, rm, rd] = maxFechaISOFromData.split('-').map(Number);
          const refUTCNoon = new Date(Date.UTC(ry, rm - 1, rd, 12, 0, 0));
          const nuevasFechas = new Set();
          for (let i = 6; i >= 0; i--) {
            const f = new Date(refUTCNoon);
            f.setUTCDate(refUTCNoon.getUTCDate() - i);
            const clave = toISOInTZ_local(f, BUSINESS_TZ_OFFSET_MIN);
            nuevasFechas.add(clave);
          }
          // Reinicializar ventasPorDia con las nuevas claves
          const ventasPorDiaReanclado = {};
          Array.from(nuevasFechas).forEach(k => { ventasPorDiaReanclado[k] = { ventas: 0, puntaje: 0 }; });
          // Volver a recorrer los clientes y contar solo dentro del nuevo rango
          if (Array.isArray(costumers) && costumers.length > 0) {
            costumers.forEach(costumer => {
              const createdPaths = [
                'creadoEn','fecha_creacion','fechaCreacion','createdAt','created_at','createdon','createdOn','fecha',
                '_raw.creadoEn','_raw.fecha_creacion','_raw.fechaCreacion','_raw.createdAt','_raw.created_at','_raw.fecha',
                'metadata.createdAt','audit.createdAt','timestamps.createdAt'
              ];
              const diaVentaPaths = ['dia_venta','diaVenta'];
              const tryDateFrom = (val) => {
                if (!val) return null;
                if (typeof val === 'string') {
                  const s = val.trim();
                  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [y,m,d] = s.split('-').map(Number); return new Date(Date.UTC(y, m-1, d, 12, 0, 0)); }
                  if (/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)) { const parts = s.split(/[\/\-]/).map(Number); const [d,m,y] = parts; return new Date(Date.UTC(y, m-1, d, 12, 0, 0)); }
                }
                if (typeof val === 'number') return new Date(val < 1e12 ? val*1000 : val);
                const dt = new Date(val); return isNaN(dt) ? null : dt;
              };
              const findFirst = (obj, paths) => {
                for (const p of paths) {
                  try {
                    const v = p.split('.').reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj);
                    if (v !== undefined && v !== null && v !== '') return v;
                  } catch(_) {}
                }
                return undefined;
              };
              let fecha = null;
              const diaVentaVal = findFirst(costumer, diaVentaPaths);
              fecha = tryDateFrom(typeof diaVentaVal === 'string' ? diaVentaVal.trim() : diaVentaVal);
              if (!fecha) {
                const fechaCreacionVal = findFirst(costumer, createdPaths);
                fecha = tryDateFrom(fechaCreacionVal);
              }
              if (!fecha || isNaN(fecha.getTime())) return;
              const fechaStr2 = toISOInTZ_local(fecha, BUSINESS_TZ_OFFSET_MIN);
              if (!nuevasFechas.has(fechaStr2)) return;
              let puntaje = 0;
              if (typeof costumer.puntaje === 'number') puntaje = costumer.puntaje;
              else if (typeof costumer.puntaje === 'string') puntaje = parseFloat(costumer.puntaje) || 0;
              else if (costumer.score) puntaje = parseFloat(costumer.score) || 0;
              ventasPorDiaReanclado[fechaStr2].ventas += 1;
              ventasPorDiaReanclado[fechaStr2].puntaje += puntaje;
            });
          }
          // Reemplazar el mapa original por el reanclado
          for (const k of Object.keys(ventasPorDia)) delete ventasPorDia[k];
          for (const [k, v] of Object.entries(ventasPorDiaReanclado)) ventasPorDia[k] = v;
          console.warn('[Reanclaje] Ventas por día recalculadas:', ventasPorDia);
        }
      } catch (e) {
        console.warn('[Reanclaje] Error durante el reanclaje de la ventana:', e?.message);
      }
      
      // Convertir el objeto a un array y ordenar por fecha
      const datosFinales = Object.entries(ventasPorDia)
        .map(([fecha, datos]) => ({
          fecha,
          ventas: datos.ventas,
          puntaje: datos.puntaje
        }))
        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      
      console.log('Ventas por día procesadas:', ventasPorDia);
      
      // Si no hay datos válidos, intentar con datos de prueba
      if (datosFinales.length === 0) {
        console.warn('No hay datos válidos para mostrar en la gráfica. Usando datos de prueba.');
        return await procesarDatosGrafica(datosPrueba);
      }
      
      console.log('Datos procesados para la gráfica:', datosFinales);
      
      // Procesar los datos y actualizar la gráfica
      try {
        const resultado = await procesarDatosGrafica(datosFinales);
        console.log('Gráfica de ventas y puntaje actualizada correctamente');
        return resultado;
      } catch (error) {
        console.error('Error al procesar datos para la gráfica:', error);
        mostrarMensajeError('Error al procesar los datos de la gráfica');
        return false;
      }
      
    } catch (error) {
      console.error('Error al actualizar la gráfica de ventas y puntaje:', error);
      // Fallback: mostrar gráfica con datos de prueba para no dejar la UI vacía
      try {
        return await procesarDatosGrafica(datosPrueba);
      } catch (e) {
        mostrarMensajeError('Error al actualizar la gráfica de ventas');
        return false;
      }
    }
  }
  
  // Función auxiliar para procesar los datos y actualizar la gráfica
  async function procesarDatosGrafica(datos) {
    try {
      console.log('=== INICIANDO PROCESAMIENTO DE DATOS PARA GRÁFICA ===');
      
      // Validar datos
      if (!Array.isArray(datos) || datos.length === 0) {
        console.warn('No hay datos disponibles para mostrar en la gráfica');
        mostrarMensajeError('No hay datos de ventas para mostrar');
        return false;
      }
      
      // Determinar si el usuario pertenece a TEAM LINEAS 1 o 2 y filtrar solo ventas de sus agentes
    // También activar bandera para mostrar solo ventas (sin puntaje) para Team Líneas
    let onlyVentas = false;
    try {
      const norm = (s) => (window.Teams && typeof window.Teams.norm === 'function')
        ? window.Teams.norm(s)
        : (function(x){ try { return String(x||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/[^a-z0-9 ]+/g,'').replace(/\s+/g,' ');} catch { return ''; } })(s);
      const canonicalFromName = (name) => (window.Teams && typeof window.Teams.canonicalFromName === 'function')
        ? window.Teams.canonicalFromName(name)
        : norm(name);
      const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
      const user = JSON.parse(userStr||'{}');
      const teamKey = (window.Teams && typeof window.Teams.getTeamForUser==='function') ? (window.Teams.getTeamForUser(user) || '') : '';
      const tk = norm(teamKey);
      const isLineas = (tk === 'team lineas 1' || tk === 'team lineas 2');
      onlyVentas = isLineas;
      // Solo filtrar aquí si los elementos parecen documentos crudos (con agenteNombre)
      if (isLineas && Array.isArray(datos) && datos.length && Object.prototype.hasOwnProperty.call(datos[0] || {}, 'agenteNombre') && window.Teams && typeof window.Teams.getAgentsByTeam==='function') {
        // allowed contendrá los nombres CANÓNICOS tal como los define utils/teams.js
        const allowed = new Set((window.Teams.getAgentsByTeam(teamKey) || []).map(canonicalFromName).map(norm));
        const before = datos.length;
        datos = datos.filter(d => {
          const raw = d.agenteNombre || '';
          const canon = norm(canonicalFromName(raw));
          return allowed.has(canon);
        });
        console.log(`[Lead] Filtro Team Líneas (${tk}) aplicado: ${before} -> ${datos.length}`);
      }
    } catch (e) {
      console.warn('No se pudo aplicar filtro Team Líneas:', e);
    }

    console.log('Datos recibidos para procesar:', datos);
      
      // Helper: convertir Date (instante absoluto) a YYYY-MM-DD en zona fija (UTC-6)
      const toISOInTZ = (date, tzOffsetMinutes) => {
        // Tomar el instante UTC y desplazarlo por el offset de la TZ objetivo
        const target = new Date(date.getTime() + tzOffsetMinutes * 60000);
        const y = target.getUTCFullYear();
        const m = String(target.getUTCMonth() + 1).padStart(2, '0');
        const d = String(target.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

    const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // UTC-6 fijo

    // Función para normalizar fechas al día de negocio (UTC-6)
    // Devuelve un objeto con: { dateObj: Date (a las 12:00 UTC), isoDay: 'YYYY-MM-DD' en TZ negocio }
    const normalizarFecha = (fechaInput) => {
      if (!fechaInput) return null;
      try {
        let fecha;
        // Si ya viene como Date
        if (fechaInput instanceof Date) {
          fecha = fechaInput;
        } else if (/^\d{4}-\d{2}-\d{2}$/.test(fechaInput)) {
          // Cadena YYYY-MM-DD: interpretarla como día de negocio directamente
          // Creamos un Date a mediodía UTC para evitar cambios por horario de verano
          const [y, m, d] = fechaInput.split('-').map(Number);
          fecha = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
        } else {
          // Timestamp o ISO
          fecha = new Date(fechaInput);
          if (isNaN(fecha.getTime())) return null;
        }
        // Obtener YYYY-MM-DD en la zona del negocio
        const isoDay = toISOInTZ(fecha, BUSINESS_TZ_OFFSET_MIN);
        // Representar este día a las 12:00 UTC para consistencia
        const [yy, mm, dd] = isoDay.split('-').map(Number);
        const dateObj = new Date(Date.UTC(yy, mm - 1, dd, 12, 0, 0));
        return { dateObj, isoDay };
      } catch (error) {
        console.error('Error al normalizar fecha (UTC-6):', fechaInput, error);
        return null;
      }
    };
    
    // Ordenar datos por fecha (día de negocio en UTC-6)
    const datosOrdenados = [...datos].sort((a, b) => {
      const nA = a.fechaObj ? { dateObj: a.fechaObj, isoDay: toISOInTZ(a.fechaObj, BUSINESS_TZ_OFFSET_MIN) } : normalizarFecha(a.fecha);
      const nB = b.fechaObj ? { dateObj: b.fechaObj, isoDay: toISOInTZ(b.fechaObj, BUSINESS_TZ_OFFSET_MIN) } : normalizarFecha(b.fecha);
      const fechaA = nA?.dateObj || new Date(0);
      const fechaB = nB?.dateObj || new Date(0);
      return fechaA - fechaB;
    });
    
    // Generar etiquetas y datasets para los últimos 7 días en la TZ de negocio (UTC-6)
    const labels = [];
    const ventasData = [];
    const puntajesData = [];
    const datosPorFecha = {};
    const puntajesListaPorDia = {}; // depuración: lista de puntajes por día
    
    // Mapear datos por clave de día (YYYY-MM-DD en TZ negocio)
    for (const item of datosOrdenados) {
      try {
        let isoDay;
        if (item.fechaObj instanceof Date) {
          isoDay = toISOInTZ(item.fechaObj, BUSINESS_TZ_OFFSET_MIN);
        } else {
          const n = normalizarFecha(item.fecha);
          if (!n) continue;
          isoDay = n.isoDay;
        }
        if (!datosPorFecha[isoDay]) {
          datosPorFecha[isoDay] = { ventas: 0, puntaje: 0, fecha: isoDay };
        }
        const ventasItem = Number(item.ventas) || 0;
        const puntajeItem = Number(item.puntaje) || 0;
        datosPorFecha[isoDay].ventas += ventasItem;
        datosPorFecha[isoDay].puntaje += puntajeItem;
        if (!puntajesListaPorDia[isoDay]) puntajesListaPorDia[isoDay] = [];
        puntajesListaPorDia[isoDay].push(puntajeItem);
      } catch (e) {
        console.error('Error procesando item:', item, e);
      }
    }
    
    // Base: hoy en TZ negocio
    const hoyLocal = new Date();
    const hoyISO = toISOInTZ(hoyLocal, BUSINESS_TZ_OFFSET_MIN);
    const [hy, hm, hd] = hoyISO.split('-').map(Number);
    const baseUTCNoon = new Date(Date.UTC(hy, hm - 1, hd, 12, 0, 0));
    for (let i = 6; i >= 0; i--) {
      const fechaUTC = new Date(baseUTCNoon);
      fechaUTC.setUTCDate(baseUTCNoon.getUTCDate() - i);
      const etiquetaISO = toISOInTZ(fechaUTC, BUSINESS_TZ_OFFSET_MIN);
      const [ey, em, ed] = etiquetaISO.split('-').map(Number);
      const etiquetaRef = new Date(Date.UTC(ey, em - 1, ed, 12, 0, 0));
      const diaSemanaNum = etiquetaRef.getUTCDay();
      const diasSemana = ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'];
      const diaSemana = diasSemana[diaSemanaNum];
      const diaDelMes = ed;
      const etiqueta = `${diaSemana} ${diaDelMes}`.toLowerCase();
      labels.push(etiqueta);
      const claveDia = etiquetaISO; // usar día de negocio (UTC-6) como clave
      if (!datosPorFecha[claveDia]) {
        datosPorFecha[claveDia] = { ventas: 0, puntaje: 0 };
      }
      const datosDia = datosPorFecha[claveDia];
      ventasData.push(Number(datosDia.ventas) || 0);
      // Puntaje diario como SUMA (no promedio)
      const sumaPuntaje = Number(datosDia.puntaje) || 0;
      puntajesData.push(sumaPuntaje);
      console.log(`Datos para ${claveDia} (${etiqueta}):`, {
        ventas: datosDia.ventas,
        puntaje_sum: datosDia.puntaje,
        puntajes: puntajesListaPorDia[claveDia] || []
      });
    }

    // Exponer variables de depuración para comparar con los conteos reales
    try {
      const g = (typeof window !== 'undefined' ? window : (typeof globalThis !== 'undefined' ? globalThis : this));
      g.__labelsGraf = labels.slice();
      g.__ventasGraf = ventasData.slice();
      g.__puntajeGraf = puntajesData.slice();
      g.__datosPorFechaGraf = { ...datosPorFecha };
      g.__puntajesListaPorDia = { ...puntajesListaPorDia };
      // Tabla combinada día->ventas/puntaje para ver rápidamente desalineaciones
      console.table(labels.map((lbl, i) => ({
        idx: i,
        dia_label: lbl,
        dia_iso: Object.keys(datosPorFecha)[i] || '(map)\n',
        ventas: ventasData[i],
        puntaje: puntajesData[i]
      })));
    } catch (_) {}
    
    // Calcular máximos para escalar ejes adecuadamente
      const maxVentas = ventasData.reduce((m, v) => Math.max(m, Number(v) || 0), 0);
      const maxPuntaje = puntajesData.reduce((m, v) => Math.max(m, Number(v) || 0), 0);
      const maxBoth = Math.max(maxVentas, maxPuntaje);

      // Configuración de la gráfica
      const config = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: (function(){
            const arr = [
              {
                label: 'Ventas',
                data: ventasData,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4,
                yAxisID: 'y',
                categoryPercentage: 0.6,
                barPercentage: 0.9,
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  offset: 4,
                  color: '#2c3e50',
                  font: { weight: 'bold' },
                  formatter: (v) => (v != null && !isNaN(v) && Number(v) !== 0 ? Math.round(v) : '')
                }
              }
            ];
            if (!onlyVentas) {
              arr.push({
                label: 'Puntaje',
                data: puntajesData,
                type: 'bar',
                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                borderRadius: 4,
                yAxisID: 'y1',
                categoryPercentage: 0.6,
                barPercentage: 0.9,
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  offset: 4,
                  color: '#7f1d1d',
                  font: { weight: 'bold' },
                  formatter: (v) => {
                    if (v == null || isNaN(v) || Number(v) === 0) return '';
                    const n = Number(v);
                    return n.toFixed(2).replace(/\.00$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
                  }
                }
              });
            }
            return arr;
          })()
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: { bottom: 40 }
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                display: true,
                color: '#4a4a4a',
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0,
                padding: 8,
                font: { size: 12 }
              },
              title: { display: true, text: 'Días' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: false, text: 'N° de Ventas' },
              beginAtZero: true,
              grid: { display: false },
              border: { display: false },
              ticks: { display: false },
              max: (() => {
                const m = Number(maxBoth) || 0;
                if (m <= 0) return 1;
                if (m <= 5) return 5;
                return Math.ceil(m * 1.2);
              })()
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { display: false, drawOnChartArea: false },
              border: { display: false },
              title: { display: false, text: 'Puntaje' },
              beginAtZero: true,
              min: 0,
              // Usar el mismo max que el eje Y para que valores iguales tengan la misma altura visual
              max: (() => {
                const m = Number(maxBoth) || 0;
                if (m <= 0) return 1;
                if (m <= 5) return 5;         // mejor precisión visual en rangos pequeños
                return Math.ceil(m * 1.2);    // margen de 20%
              })(),
              ticks: { display: false }
            }
          },
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) { label += ': '; }
                  if (context.parsed.y !== null) { label += context.parsed.y; }
                  return label;
                }
              }
            },
            legend: {
              position: 'top',
              labels: { usePointStyle: true, pointStyle: 'circle', padding: 20 }
            },
            datalabels: {
              display: true,
              clamp: true,
              clip: false
            }
          }
        }
      };

      // Reconstruir la gráfica para evitar errores de actualización de ejes
      const canvasEl = document.getElementById('ventasPuntajeChart');
      if (!canvasEl) {
        console.info('Canvas ventasPuntajeChart no encontrado - gráficas deshabilitadas en esta página');
        return;
      }
      const ctx = canvasEl.getContext('2d');
      if (ventasPuntajeChart) {
        try { ventasPuntajeChart.destroy(); } catch (_) {}
        ventasPuntajeChart = null;
      }
      ventasPuntajeChart = new Chart(ctx, config);
      
      console.log('Configuración de la gráfica actualizada:', config);
      
      // Guardar en caché los datos utilizados para la gráfica
      try {
        const payload = { datos, savedAt: Date.now() };
        const key = typeof getVentasCacheKey === 'function' ? getVentasCacheKey() : 'ventasPuntajeCache';
        localStorage.setItem(key, JSON.stringify(payload));
        console.log('Caché de ventas/puntaje actualizado');
      } catch (e) {
        console.warn('No se pudo guardar la caché de la gráfica:', e);
      }
      
      // No es necesario llamar update después de crear
      return true;
    } catch (error) {
      console.error('Error al procesar datos de la gráfica:', error);
      mostrarMensajeError('Error al procesar los datos de la gráfica');
      return false;
    }
  }

  // Función para actualizar la gráfica de ventas por producto con datos de prueba
  function actualizarGraficaVentasProducto() {
    console.log('Usando datos de prueba para la gráfica de productos...');
    
    // Datos de prueba para la gráfica de productos
    const datosPrueba = {
      labels: ['Internet', 'Televisión', 'Telefonía', 'Paquete Completo', 'Internet + TV'],
      datos: [35, 25, 20, 15, 5]
    };
    
    // Inicializar la gráfica si no existe
    if (!ventasProductoChart) {
      console.log('Inicializando gráfica de productos...');
      ventasProductoChart = inicializarGraficaVentasProducto();
      if (!ventasProductoChart) {
        console.error('No se pudo inicializar la gráfica de productos');
        return;
      }
    }

    // Actualizar los datos de la gráfica con los datos de prueba
    ventasProductoChart.data.labels = datosPrueba.labels;
    
    // Actualizar datos de ventas
    if (ventasProductoChart.data.datasets[0]) {
      ventasProductoChart.data.datasets[0].data = datosPrueba.datos;
      
      // Colores para la gráfica
      const backgroundColors = [
        'rgba(54, 162, 235, 0.7)',  // Azul
        'rgba(255, 99, 132, 0.7)',  // Rojo
        'rgba(75, 192, 192, 0.7)',  // Verde
        'rgba(255, 205, 86, 0.7)',  // Amarillo
        'rgba(153, 102, 255, 0.7)'  // Morado
      ];
      
      const borderColors = [
        'rgba(54, 162, 235, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(255, 205, 86, 1)',
        'rgba(153, 102, 255, 1)'
      ];
      
      // Aplicar colores a los datos
      ventasProductoChart.data.datasets[0].backgroundColor = backgroundColors;
      ventasProductoChart.data.datasets[0].borderColor = borderColors;
    }
    
    // Actualizar la gráfica con animación
    ventasProductoChart.update({
      duration: 800,
      easing: 'easeOutQuart'
    });
  }

  // Función para obtener los nombres de los días de la semana
  function obtenerNombresDias(fechaInicio) {
    const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const fecha = new Date(fechaInicio);
    const resultado = [];
    
    for (let i = 0; i < 7; i++) {
      const fechaActual = new Date(fecha);
      fechaActual.setDate(fecha.getDate() + i);
      const nombreDia = dias[fechaActual.getDay()];
      const diaMes = fechaActual.getDate();
      const mes = fechaActual.getMonth() + 1;
      resultado.push(`${nombreDia} ${diaMes}/${mes}`);
    }
    
    return resultado;
  }

  // Función para actualizar las gráficas con datos de prueba
  async function actualizarGraficas(fecha = null) {
    console.log('Iniciando actualización de gráfica de ventas...');
    
    try {
      // Verificar si el elemento del gráfico existe
      const ventasPuntajeCanvas = document.getElementById('ventasPuntajeChart');
      
      if (!ventasPuntajeCanvas) {
        console.info('Canvas para gráfica de ventas no encontrado - gráficas deshabilitadas en esta página');
        return;
      }
      
      // Actualizar gráfica de ventas y puntaje
      try {
        console.log('Actualizando gráfica de ventas y puntaje...');
        await actualizarGraficaVentasPuntaje();
        console.log('Gráfica de ventas y puntaje actualizada exitosamente');
      } catch (error) {
        console.error('Error al actualizar gráfica de ventas y puntaje:', error);
        mostrarMensajeError('Error al actualizar gráfica de ventas y puntaje: ' + error.message);
      }
      
    } catch (error) {
      console.error('Error crítico al actualizar las gráficas:', error);
      mostrarMensajeError('Error crítico al actualizar las gráficas: ' + error.message);
    }  }

  

  // Función para obtener los días en un mes específico
  function getDaysInMonth(month, year) {
    // Nota: En JavaScript, los meses van de 0 a 11
    return new Date(year, month + 1, 0).getDate();
  }

  // Función para actualizar los días disponibles según el mes y año seleccionados
  function updateDaysDropdown() {
    const daySelect = document.getElementById('day-select');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    
    // Verificar que todos los elementos existan
    if (!daySelect || !monthSelect || !yearSelect) {
      return;
    }
    
    const selectedMonth = parseInt(monthSelect.value);
    const selectedYear = parseInt(yearSelect.value);
    const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
    
    // Guardar el día seleccionado actualmente
    const selectedDay = parseInt(daySelect.value) || 1;
    
    // Limpiar opciones actuales
    daySelect.innerHTML = '';
    
    // Agregar opciones de días
    for (let day = 1; day <= daysInMonth; day++) {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      daySelect.appendChild(option);
    }
    
    // Establecer el día seleccionado (si es válido para el nuevo mes)
    if (selectedDay <= daysInMonth) {
      daySelect.value = selectedDay;
    } else {
      daySelect.value = daysInMonth; // Último día del mes si el día seleccionado es inválido
    }
  }
  
  // Función para establecer la fecha actual en los selectores
  function setCurrentDate() {
    const now = new Date();
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const daySelect = document.getElementById('day-select');
    
    if (monthSelect) {
      monthSelect.value = now.getMonth();
    }
    if (yearSelect) {
      yearSelect.value = now.getFullYear();
    }
    if (monthSelect && yearSelect) {
      updateDaysDropdown();
    }
    if (daySelect) {
      daySelect.value = now.getDate();
    }
  }
  
  // Función para obtener la fecha seleccionada en formato YYYY-MM-DD
  function getSelectedDate() {
    const daySelect = document.getElementById('day-select');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    
    // Verificar que todos los elementos existan
    if (!daySelect || !monthSelect || !yearSelect) {
      // Retornar fecha actual si los elementos no existen
      const now = new Date();
      return now.toISOString().split('T')[0];
    }
    
    const day = daySelect.value.padStart(2, '0');
    const month = (parseInt(monthSelect.value) + 1).toString().padStart(2, '0');
    const year = yearSelect.value;
    return `${year}-${month}-${day}`;
  }
  
  // Función para cargar datos con filtro de fecha
  async function cargarDatosConFiltro() {
    const fechaSeleccionada = getSelectedDate();
    try {
      // Invalidar caché al cambiar filtros de fecha
      if (typeof clearVentasCache === 'function') {
        clearVentasCache();
      }
      // Aquí iría la llamada a tu API para obtener los datos filtrados por fecha
      // Por ahora, usamos la función actualizarGraficas existente
      // En una implementación real, deberías modificar actualizarGraficas para aceptar una fecha
      console.log('Cargando datos para la fecha:', fechaSeleccionada);
      await actualizarGraficas(fechaSeleccionada);
    } catch (error) {
      console.error('Error al cargar datos con filtro:', error);
    }
  }

  // Función para inicializar la gráfica de ventas y puntaje
  function inicializarGraficaVentasPuntaje() {
    try {
      // Verificar que el contenedor del gráfico exista
      const canvas = document.getElementById('ventasPuntajeChart');
      if (!canvas) {
        console.info('Canvas para gráfica de ventas no encontrado - gráficas deshabilitadas en esta página');
        return null;
      }
      
      // Destruir la instancia anterior del gráfico si existe
      if (ventasPuntajeChart) {
        console.log('Destruyendo instancia anterior del gráfico...');
        ventasPuntajeChart.destroy();
        ventasPuntajeChart = null;
      }
      
      // Obtener el contexto 2D después de asegurarnos de que el canvas existe
      const ctx = canvas.getContext('2d');
      
      // Asegurarse de que el contenedor tenga un tamaño adecuado
      const container = canvas.parentElement;
      container.style.width = '100%';
      container.style.height = '400px';
      
      // Crear y retornar la instancia del gráfico
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Ventas',
              type: 'bar',
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              yAxisID: 'y',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#2c3e50',
                font: { weight: 'bold' },
                formatter: (v) => (v != null && !isNaN(v) && Number(v) !== 0 ? Math.round(v) : '')
              }
            },
            {
              label: 'Puntaje',
              type: 'bar',
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              borderRadius: 4,
              yAxisID: 'y1',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#7f1d1d',
                font: { weight: 'bold' },
                formatter: (v) => {
                  if (v == null || isNaN(v) || Number(v) === 0) return '';
                  const n = Number(v);
                  return Number.isInteger(n) ? String(n) : n.toFixed(2);
                }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { bottom: 40 } },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: {
              display: false,
              formatter: () => '',
              clamp: true,
              clip: false
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: false,
                text: 'Ventas'
              },
              grid: { display: false, drawTicks: false },
              border: { display: false },
              ticks: { display: false, callback: () => '' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { display: false, drawOnChartArea: false, drawTicks: false },
              border: { display: false },
              title: {
                display: false,
                text: 'Puntaje'
              },
              ticks: { display: false, callback: () => '' },
              min: 0,
              max: 100
            },
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                display: false,
                callback: () => ''
              },
              title: { display: false, text: '' }
            }
          },
          elements: {
            point: {
              radius: 0,
              hoverRadius: 0
            }
          }
        }
      });
    } catch (error) {
      console.error('Error al inicializar la gráfica de ventas y puntaje:', error);
      return null;
    }
  }

  // Función para inicializar la gráfica de ventas por producto
  function inicializarGraficaVentasProducto() {
    try {
      const ctx = document.getElementById('ventasProductoChart');
      if (!ctx) {
        console.log('No se encontró el elemento canvas para la gráfica de ventas por producto');
        return null;
      }
      
      // Asegurarse de que el contenedor tenga un tamaño adecuado
      const container = ctx.parentElement;
      container.style.width = '100%';
      container.style.height = '400px';
      
      // Retornar null ya que no vamos a inicializar esta gráfica por ahora
      console.log('Gráfica de ventas por producto no inicializada (comentada)');
      return null;
    } catch (error) {
      console.error('Error al inicializar la gráfica de ventas por producto:', error);
      return null;
    }
  }

  // Verificar si el usuario es de Team Líneas
  function isTeamLineasUser() {
    try {
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const username = (userData.username || '').toLowerCase();
      const role = (userData.role || '').toLowerCase();
      return role === 'teamlineas' || username.startsWith('lineas-');
    } catch (e) {
      return false;
    }
  }

  // La función initializeApp ha sido movida más abajo en el archivo

  // LÓGICA PRINCIPAL - Se ejecuta cuando el DOM está completamente cargado
  document.addEventListener("DOMContentLoaded", async function() {
    // No cargar datos si el usuario es de Team Líneas
    if (isTeamLineasUser()) {
      console.log('Usuario de Team Líneas detectado, omitiendo carga de datos en lead.html');
      return;
    }
    console.log('DOM cargado, inicializando...');
    
    try {
      // Inicializar la aplicación (protegida contra múltiples ejecuciones)
      initializeApp();
      
    } catch (error) {
      console.error('Error durante la inicialización de la página:', error);
    }
    
    // --- INICIALIZACIÓN DE ELEMENTOS ---
    const selects = {};
    const selectIds = ["team", "agent", "producto", "cuenta", "puntaje"];
    
    // Inicializar solo los selects que existen en el DOM (opcionales en esta página)
    selectIds.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        selects[id] = element;
      } else {
        // Son elementos opcionales; reducir severidad del log para no llenar la consola
        console.info(`Elemento opcional con ID '${id}' no encontrado en el DOM`);
      }
    });
    
    // Obtener referencias a los elementos del DOM
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const applyFilter = document.getElementById('apply-filter');
    const resetFilter = document.getElementById('reset-filter');

    // --- DATOS PARA LOS SELECTS ---
    const data = {
      teams: {
        "Team Irania": ["Irania", "Michael", "Giselle"],
        "Team Pleitez": ["Pleitez", "Kevin", "Nelson"],
        "Team Roberto": ["Roberto", "Santos", "Erick"],
        "Team Lineas": ["Dania", "Genesis", "Ofelia"],
        "Team Randal": ["Randal", "Josue", "Elian"],
        "Team Marisol": ["Marisol", "Isabella", "Naidelyn"],
      },
      productos: [], // Se llenará dinámicamente con fetch
      cuentas: ["Nueva", "Winback", "Agregado"]
    };
    
    // Hacer que los datos estén disponibles globalmente
    window.data = data;

    // Inicializar los selectores de fecha
    setCurrentDate();
    
    // Configurar event listeners para los filtros
    if (monthSelect) monthSelect.addEventListener('change', updateDaysDropdown);
    if (yearSelect) yearSelect.addEventListener('change', updateDaysDropdown);
    if (applyFilter) applyFilter.addEventListener('click', cargarDatosConFiltro);
    if (resetFilter) {
      resetFilter.addEventListener('click', () => {
        setCurrentDate();
        cargarDatosConFiltro();
      });
    }
    
    // --- LLENADO DE SELECTS DEL FORMULARIO ---
    async function llenarProductosDinamicamente() {
      try {
        // Usar la misma lista de productos que está definida en el backend
        const PRODUCTOS_FIJOS = [
          "ATT AIR",
          "FRONTIER 5 GIG",
          "INTERNET + TELEFONO + TV",
          "FRONTIER",
          "FRONTIER INTERNET SERVICIOS"
        ];
        
        // Actualizar el select de productos
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">Seleccione Producto</option>' + 
            PRODUCTOS_FIJOS.map(p => `<option value="${p}">${p}</option>`).join('');
          window.LISTA_PRODUCTOS = PRODUCTOS_FIJOS;
        }
      } catch (e) {
        console.error('Error al cargar productos:', e);
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">(Error cargando productos)</option>';
        }
        window.LISTA_PRODUCTOS = [];
      }
    }

    // Función para llenar los selects
    async function llenarSelects() {
      try {
        // Verificar que window.data existe
        if (!window.data) {
          console.warn('No se encontró el objeto window.data');
          return;
        }

        // Llenar select de equipos si existe
        if (selects.team) {
          // Limpiar el select
          selects.team.innerHTML = '<option value="">Seleccione Equipo</option>';
          
          // Verificar que data.teams existe y tiene datos
          if (window.data.teams && typeof window.data.teams === 'object') {
            // Llenar el select de equipos
            Object.keys(window.data.teams).forEach(team => {
              selects.team.add(new Option(team, team));
            });
            
            // Agregar event listener para el cambio de equipo
            selects.team.addEventListener("change", function () {
              if (this.value && window.data.teams[this.value] && selects.agent) {
                // Actualizar el select de agentes cuando cambia el equipo
                selects.agent.innerHTML = '<option value="">Seleccione Agente</option>';
                window.data.teams[this.value].forEach(agent => {
                  selects.agent.add(new Option(agent, agent));
                });
              }
            });
          } else {
            console.warn('No se encontraron datos de equipos');
          }
        }
        
        // Llenar select de cuentas si existe
        if (selects.cuenta) {
          // Limpiar el select
          selects.cuenta.innerHTML = '<option value="">Seleccione Cuenta</option>';
          
          // Verificar que data.cuentas existe y es un array
          if (Array.isArray(window.data.cuentas) && window.data.cuentas.length > 0) {
            // Llenar el select de cuentas
            window.data.cuentas.forEach(cuenta => {
              selects.cuenta.add(new Option(cuenta, cuenta));
            });
          } else {
            console.warn('No se encontraron datos de cuentas');
          }
        }
        
        // Inicializar el select de agentes si existe
        if (selects.agent) {
          selects.agent.innerHTML = '<option value="">Seleccione Agente</option>';
        }
      } catch (error) {
        console.error('Error al llenar los selects:', error);
      }
    }
    
    // Llenar los selects
    llenarSelects();
    
    // Llenar productos dinámicamente
    llenarProductosDinamicamente();

    // Establecer fecha actual en el campo de fecha
    const fechaLead = document.getElementById('fecha-lead');
    if (fechaLead) {
      fechaLead.value = new Date().toISOString().slice(0, 10);
    }
    
    // Inicializar las gráficas
    try {
      console.log('Inicializando gráficas...');
      
      // Asegurarse de que los contenedores de las gráficas estén visibles
      const graphContainers = document.querySelectorAll('.graph-container');
      graphContainers.forEach(container => {
        container.style.display = 'block';
      });
      
      // Inicializar gráfica principal solo una vez
      ventasPuntajeChart = inicializarGraficaVentasPuntaje();
      
      // Pintar inmediatamente desde caché (con TTL) o datos de ejemplo y luego refrescar en segundo plano
      try {
        const key = typeof getVentasCacheKey === 'function' ? getVentasCacheKey() : 'ventasPuntajeCache';
        const cacheStr = localStorage.getItem(key);
        let cache = null;
        try { cache = cacheStr ? JSON.parse(cacheStr) : null; } catch (_) { cache = null; }
        const fresh = cache && Array.isArray(cache.datos) && cache.datos.length &&
                      typeof cache.savedAt === 'number' && (Date.now() - cache.savedAt) < (window.VENTAS_CACHE_TTL_MS || 4*60*60*1000);
        if (fresh) {
          console.log('Pintando gráfica inmediatamente desde caché válida');
          await procesarDatosGrafica(cache.datos);
          // Marcar que ya se cargaron datos iniciales para evitar recarga adicional
          window.__chartsInitialDataLoaded = true;
        } else if (typeof generarDatosPrueba === 'function') {
          console.log('Pintando gráfica inmediatamente con datos de ejemplo');
          const demo = [
            { fecha: '2025-08-06', ventas: 5, puntaje: 25 },
            { fecha: '2025-08-07', ventas: 8, puntaje: 40 },
            { fecha: '2025-08-08', ventas: 12, puntaje: 60 },
            { fecha: '2025-08-09', ventas: 7, puntaje: 35 },
            { fecha: '2025-08-10', ventas: 15, puntaje: 75 },
            { fecha: '2025-08-11', ventas: 10, puntaje: 50 },
            { fecha: '2025-08-12', ventas: 18, puntaje: 90 }
          ];
          await procesarDatosGrafica(demo);
          // Marcar que ya se cargaron datos iniciales para evitar recarga adicional
          window.__chartsInitialDataLoaded = true;
        }
        // Refrescar en segundo plano sin bloquear la UI
        if (!fresh) {
          actualizarGraficaVentasPuntaje().catch(err => console.error('Error al refrescar datos iniciales:', err));
        }
      } catch (e) {
        console.warn('No se pudo pintar inmediatamente la gráfica:', e);
      }
    } catch (error) {
      console.error('Error al inicializar gráficas:', error);
    }
    
    // Actualizar gráficas cada 5 minutos (300000 ms)
    if (window.__ventasChartIntervalId) {
      clearInterval(window.__ventasChartIntervalId);
    }
    window.__ventasChartIntervalId = setInterval(async () => {
      // Evitar solapamiento de actualizaciones
      if (window.__ventasChartUpdating) return;
      window.__ventasChartUpdating = true;
      try {
        await actualizarGraficaVentasPuntaje();
      } catch (e) {
        console.error('Error al actualizar la gráfica periódicamente:', e);
      } finally {
        window.__ventasChartUpdating = false;
      }
    }, 300000);
    
    // --- LÓGICA DE FORMULARIO ---
    const crmForm = document.getElementById('crmForm');
    if (crmForm) {
      // Función para mostrar notificación
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Desaparecer después de 5 segundos
        setTimeout(() => {
          notification.remove();
        }, 5000);
      }

      // Función auxiliar para obtener el valor de un campo con manejo de errores
      function getFieldValue(id, required = false) {
        const element = document.getElementById(id);
        if (!element && required) {
          throw new Error(`Campo requerido no encontrado: ${id}`);
        }
        return element ? element.value : '';
      }

      // Función para obtener el valor de un radio button
      function getRadioValue(name, required = false) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        if (!selected && required) {
          throw new Error(`Debe seleccionar una opción en: ${name}`);
        }
        return selected ? selected.value : '';
      }

      /**
       * Normaliza un número de teléfono eliminando todos los caracteres no numéricos
       * Ejemplos:
       *   (848) 299-7246  →  8482997246
       *   848-299-7246    →  8482997246
       *   848.299.7246    →  8482997246
       *   848 299 7246    →  8482997246
       */
      function normalizePhone(phone) {
        if (phone == null || phone === '') {
          return '';
        }
        // Eliminar todos los caracteres que no sean dígitos
        return String(phone).replace(/\D+/g, '');
      }

      /**
       * Obtiene la fecha actual en formato YYYY-MM-DD en la zona horaria local
       * Evita problemas de conversión UTC que causan que la fecha sea un día anterior
       */
      function getTodayLocalDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // Función para manejar el envío del formulario
      async function handleFormSubmit(e) {
        e.preventDefault();
        console.log('=== INICIANDO ENVÍO DE FORMULARIO ===');
        
        // Obtener el botón de envío
        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitButton ? submitButton.innerHTML : 'Enviar';
        
        // Deshabilitar el botón y mostrar indicador de carga
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        }
        
        try {
        console.log('=== VALIDANDO CAMPOS DEL FORMULARIO ===');
        
        // Detectar si aplica modo Team Líneas (1 o 2)
        const isTeamLineas = (function(){
          try {
            if (document.body && document.body.classList && document.body.classList.contains('team-lineas')) return true;
            const norm = (s)=>{ try { return String(s||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');} catch { return ''; } };
            const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
            const user = JSON.parse(userStr||'{}');
            const tk = (window.Teams && typeof window.Teams.getTeamForUser==='function') ? norm(window.Teams.getTeamForUser(user) || '') : '';
            return (tk === 'team lineas' || tk === 'team lineas 1' || tk === 'team lineas 2');
          } catch { return false; }
        })();

        // Validar campos requeridos (dinámico según el modo)
        let requiredFields = [
          { id: 'nombre-cliente', name: 'Nombre del Cliente' },
          { id: 'telefono-principal', name: 'Teléfono Principal' },
          { id: 'tipo-servicio', name: 'Tipo de Servicio' },
          { id: 'dia-venta', name: 'Día de Venta' },
          { id: 'sistema', name: 'Sistema' },
          { id: 'supervisor', name: 'Supervisor' },
          { id: 'direccion', name: 'Dirección' },
          { id: 'mercado', name: 'Mercado' },
          { id: 'riesgo', name: 'Riesgo' },
          { id: 'puntaje', name: 'Puntaje' },
          { id: 'servicios', name: 'Servicios' },
          { id: 'motivo-llamada', name: 'Motivo de la Llamada' }
        ];
        if (isTeamLineas) {
          const omit = new Set(['tipo-servicio','sistema','riesgo','puntaje','servicios','motivo-llamada']);
          requiredFields = requiredFields.filter(f => !omit.has(f.id));
        }
          
          // Validar campos requeridos
          const missingFields = [];
          for (const field of requiredFields) {
            const value = field.id === 'motivo-llamada' 
              ? getRadioValue('motivo-llamada')
              : getFieldValue(field.id);
              
            console.log(`Campo ${field.id}:`, value || 'Vacío');
            
            if (!value) {
              missingFields.push(field.name);
            }
          }
          
          if (missingFields.length > 0) {
            throw new Error(`Los siguientes campos son requeridos: ${missingFields.join(', ')}`);
          }
          
          const puntajeVal = getFieldValue('puntaje') || '0';
          
          // Obtener valores una sola vez para evitar múltiples llamadas al DOM
          const nombreCliente = getFieldValue('nombre-cliente');
          const telefonoPrincipal = normalizePhone(getFieldValue('telefono-principal'));
          const telefonoAlterno = normalizePhone(getFieldValue('telefono-alterno') || getFieldValue('telefono-secundario'));
          const email = getFieldValue('email');
          const diaVenta = getFieldValue('dia-venta');
          const fechaInstalacionElement = document.getElementById('dia-instalacion');
          console.log('Elemento del campo dia-instalacion:', fechaInstalacionElement);
          console.log('Valor del campo dia-instalacion (directo):', fechaInstalacionElement ? fechaInstalacionElement.value : 'No encontrado');
          
          const fechaInstalacion = getFieldValue('dia-instalacion');
          console.log('Valor del campo dia-instalacion (via getFieldValue):', fechaInstalacion);
          const tipoServicio = getFieldValue('tipo-servicio');
          const producto = getFieldValue('producto');
          // Texto visible en mayúsculas para tipo-servicio
          const tipoServicioSelect = document.getElementById('tipo-servicio');
          const tipoServicioText = tipoServicioSelect && tipoServicioSelect.selectedIndex >= 0
            ? (tipoServicioSelect.options[tipoServicioSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Texto visible en mayúsculas para producto
          const productoSelect = document.getElementById('producto');
          const productoText = productoSelect && productoSelect.selectedIndex >= 0
            ? (productoSelect.options[productoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Capturar SERVICIOS: valor y texto visible
          const serviciosVal = getFieldValue('servicios');
          const serviciosSelect = document.getElementById('servicios');
          const serviciosText = serviciosSelect && serviciosSelect.selectedIndex >= 0
            ? (serviciosSelect.options[serviciosSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Obtener y validar el campo sistema (usar el TEXTO visible para evitar códigos internos)
          const sistemaElement = document.getElementById('sistema');
          console.log('Elemento del campo sistema:', sistemaElement);
          console.log('Opciones del select sistema:', sistemaElement ? Array.from(sistemaElement.options).map(o => o.value) : 'No encontrado');
          console.log('Valor seleccionado en sistema:', sistemaElement ? sistemaElement.value : 'No encontrado');
          // Texto visible seleccionado (SARA, OPUS, B.O, N/A, CHUZO)
          const sistemaText = (function() {
            if (!sistemaElement) return '';
            const idx = sistemaElement.selectedIndex;
            const txt = idx >= 0 ? (sistemaElement.options[idx]?.text || '') : '';
            return (txt || '').trim().toUpperCase();
          })();
          console.log('Texto visible en sistema (normalizado):', sistemaText);
          // Value seleccionado (por ejemplo: 'sara', 'bo', etc.)
          const sistemaVal = sistemaElement ? (sistemaElement.value || '').trim() : '';
          console.log('Value de sistema a enviar:', sistemaVal);

          // Validación explícita: el sistema es obligatorio (solo si NO es Team Líneas)
        if (!isTeamLineas) {
          if (!sistemaVal) {
            throw new Error('Debe seleccionar un SISTEMA antes de enviar.');
          }
        }
          
          const supervisor = getFieldValue('supervisor');
          // Obtener el TEXTO visible del select de supervisor
          const supervisorSelect = document.getElementById('supervisor');
          const supervisorText = supervisorSelect && supervisorSelect.selectedIndex >= 0
            ? (supervisorSelect.options[supervisorSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          const direccion = getFieldValue('direccion');
          const ciudad = getFieldValue('ciudad');
          const estado = getFieldValue('estado');
          const zipCode = getFieldValue('zip-code');
          const mercado = getFieldValue('mercado');
          // Obtener el TEXTO visible del select de mercado
          const mercadoSelect = document.getElementById('mercado');
          const mercadoText = mercadoSelect && mercadoSelect.selectedIndex >= 0
            ? (mercadoSelect.options[mercadoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Riesgo: obtener texto visible en mayúsculas
          const riesgoSelect = document.getElementById('riesgo');
          const riesgoText = riesgoSelect && riesgoSelect.selectedIndex >= 0
            ? (riesgoSelect.options[riesgoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Autopago: obtener valor, texto visible y mapear a boolean
          const autopagoVal = getFieldValue('autopago');
          const autopagoSelect = document.getElementById('autopago');
          const autopagoText = autopagoSelect && autopagoSelect.selectedIndex >= 0
            ? (autopagoSelect.options[autopagoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          const autopagoBool = (autopagoVal || '').toString().toLowerCase() === 'si' || (autopagoText === 'SI');
          const numeroCuenta = getFieldValue('numero-cuenta');
          const comentario = getFieldValue('comentario');
          const motivoLlamada = getRadioValue('motivo-llamada');
          const status = document.querySelector('input[name="status"]:checked')?.value || 'PENDING';
          
          // Validar y formatear el puntaje
          let puntajeFinal = 0;
          if (puntajeVal && puntajeVal !== "Sin Puntaje" && puntajeVal !== "Seleccione Puntaje") {
            puntajeFinal = parseFloat(puntajeVal) || 0;
          }
          
          // Datos para la colección crm_agente
          // Asegurarse de que los nombres de los campos coincidan exactamente con los esperados por el servidor
          const leadData = {
            // Información básica del cliente
            nombre_cliente: nombreCliente,
            telefono_principal: telefonoPrincipal,
            telefono_alterno: telefonoAlterno || '',
            telefono: telefonoPrincipal, // Mantener compatibilidad con campos antiguos
            email: email || '',
            
            // Información de la venta
            dia_venta: diaVenta || getTodayLocalDate(),
            dia_instalacion: fechaInstalacion || '',
            // Mantener compatibilidad con campos antiguos
            fecha_instalacion: fechaInstalacion || '',
            tipo_servicio: tipoServicioText || 'INTERNET',
            tipo_servicios: tipoServicioText || 'INTERNET', // Mantener compatibilidad
            producto: productoText || producto || '',
            sistema: sistemaVal,
            sistema_texto: sistemaText,
            supervisor: supervisorText || supervisor || '',
            agente: 'Agente', // Se debe obtener del usuario autenticado
            
            // Dirección y ubicación
            direccion: direccion || '',
            ciudad: ciudad || '',
            estado: estado || '',
            zip_code: zipCode || '',
            
            // Detalles adicionales
            mercado: mercadoText,
            puntaje: puntajeFinal,
            numero_cuenta: numeroCuenta || '',
            
            // Estado y seguimiento
            status: status,
            comentario: comentario || '',
            motivo_llamada: motivoLlamada || '',
            
            // Metadatos
            creadoEn: new Date().toISOString(),
            actualizadoEn: new Date().toISOString(),
            
            // Campos adicionales para compatibilidad
            servicios: serviciosVal || tipoServicio || 'INTERNET',
            servicios_texto: serviciosText || '',
            riesgo: riesgoText,
            autopago: autopagoText // Guardar texto visible en leadData
          };
          
          // Asegurar que los campos requeridos tengan valores por defecto
          if (!leadData.telefono_principal && leadData.telefono) {
            leadData.telefono_principal = leadData.telefono;
          }

          // Datos para la colección customers (solo los campos solicitados)
          const customerData = {
            // Información del cliente (campos requeridos)
            nombre_cliente: nombreCliente,
            telefono: telefonoPrincipal,
            telefono_alterno: telefonoAlterno || '',
            direccion: direccion,
            tipo_servicio: tipoServicioText || 'INTERNET',
            producto: productoText || producto || '',
            // Incluir servicios (valor y texto visible)
            servicios: serviciosVal || '',
            servicios_texto: serviciosText || '',
            // Incluir el sistema seleccionado (texto visible en mayúsculas)
            sistema: sistemaVal,
            sistema_texto: sistemaText,
            // Incluir el mercado seleccionado (texto visible en mayúsculas)
            mercado: mercadoText,
            // Incluir riesgo (texto visible en mayúsculas)
            riesgo: riesgoText,
            // Autopago booleano para backend
            autopago: autopagoBool,
            
            // Información de la venta
            dia_venta: diaVenta || getTodayLocalDate(),
            team: supervisorText || 'TEAM IRANIA',
            supervisor: supervisorText || 'TEAM IRANIA',
            agente: 'Agente', // Debería obtenerse del usuario logueado
            dia_instalacion: fechaInstalacion || '',
            puntaje: puntajeFinal || 0,
            zip: zipCode || '',
            
            // Metadatos adicionales
            creadoEn: new Date().toISOString(),
            actualizadoEn: new Date().toISOString(),
            producto_contratado: serviciosText || tipoServicioText || tipoServicio || 'INTERNET',
            fecha_contratacion: diaVenta || getTodayLocalDate(),
            equipo: supervisorText || supervisor || 'TEAM IRANIA',
            fecha_creacion: new Date().toISOString(),
            status: status === 'PENDING' ? 'pendiente' : 'activo',
            comentario: comentario || '',
            motivo_llamada: motivoLlamada || '',
            numero_cuenta: numeroCuenta || ''
          };
          
          console.log('Datos del formulario validados correctamente');
          console.log('Datos a enviar:', customerData);
          
          // Continuar con el envío...
          const headers = { 
            "Content-Type": "application/json"
          };

          try {
            console.log('Enviando datos a las bases de datos...');
            
            // Usar la URL base actual (para soportar tanto desarrollo como producción)
            const baseUrl = window.location.origin;
            // Función auxiliar para hacer peticiones con manejo de errores
            const makeRequest = async (endpoint, data) => {
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const headers = { 
                  "Content-Type": "application/json"
                };
                
                if (token) {
                  headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${baseUrl}${endpoint}`, { 
                  method: "POST", 
                  headers: headers,
                  body: JSON.stringify(data)
                });
                
                const responseData = await response.json().catch(() => ({}));
                
                // Considerar exitosas las respuestas 200 y 201
                if (response.ok || response.status === 200 || response.status === 201) {
                  return responseData;
                }
                
                // Para cualquier otro código de error, lanzar un error
                throw new Error(responseData.message || `Error en la petición: ${response.status}`);
              } catch (error) {
                console.error(`Error en makeRequest (${endpoint}):`, error);
                throw error; // Relanzar el error para manejarlo en el catch externo
              }
            };
            
            // Depuración: Mostrar datos que se enviarán
          console.log('=== DATOS A ENVIAR ===');
          console.log('Lead Data:', JSON.stringify(leadData, null, 2));
          console.log('Customer Data:', JSON.stringify(customerData, null, 2));
          console.log('=== DATOS A ENVIAR ===');
          console.log('Lead Data:', JSON.stringify(leadData, null, 2));
          console.log('Customer Data:', JSON.stringify(customerData, null, 2));
            
            // Solo enviar a una base de datos (customers)
            console.log('Enviando datos al endpoint de customers...');
            
            // Asegurarse de que los datos tengan el formato correcto
            const customerDataToSend = { ...customerData };
            
            // Asegurar que el teléfono esté en el formato correcto
            if (customerDataToSend.telefono && !customerDataToSend.telefono_principal) {
              customerDataToSend.telefono_principal = customerDataToSend.telefono;
            }
            
            // Detectar equipo del usuario actual y ramificar envío
            let teamKey = '';
            try {
              const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
              const userObj = JSON.parse(userStr || '{}');
              if (window.Teams && typeof window.Teams.getTeamForUser === 'function') {
                teamKey = (window.Teams.getTeamForUser(userObj) || '').toLowerCase();
              }
            } catch (_) {}

            let customerResponse = null;
            let leadResponse = { success: true };

            if (teamKey === 'team lineas') {
              console.log('Equipo detectado: Team Líneas. Enviando a /api/lineas');
              // Construir payload específico para Team Líneas
              const getVal = (sel) => (sel ? (sel.value || '').trim() : '');
              const getTextUpper = (sel) => {
                if (!sel) return '';
                const idx = sel.selectedIndex;
                const txt = idx >= 0 ? (sel.options[idx]?.text || '') : '';
                return (txt || '').trim().toUpperCase();
              };
              // Elementos
              const elNombre = document.querySelector('[name="nombre_cliente"]');
              const elTelPrin = document.querySelector('[name="telefono_principal"]');
              const elNumCuenta = document.querySelector('[name="numero_cuenta"]');
              const elAutopay = document.querySelector('[name="autopay"]');
              const elPin = document.querySelector('[name="pin_seguridad"]');
              const elDir = document.querySelector('[name="direccion"]');
              const elServicios = document.getElementById('servicios') || document.getElementById('tipo-servicio');
              const elDiaVenta = document.querySelector('[name="dia_venta"]');
              const elDiaInst = document.querySelector('[name="dia_instalacion"]');
              const elStatus = document.querySelector('input[name="status"]:checked');
              const elCant = document.getElementById('cantidad_lineas');
              const elTel1 = document.getElementById('telefono_1');
              const elTel2 = document.getElementById('telefono_2');
              const elTel3 = document.getElementById('telefono_3');
              const elTel4 = document.getElementById('telefono_4');
              const elTel5 = document.getElementById('telefono_5');
              const elID = document.getElementById('id');
              const elMercado = document.getElementById('mercado');
              const elSupervisor = document.getElementById('supervisor');

              // Compilar servicios como arreglo (si múltiple no aplica, será arreglo de un string)
              let serviciosArr = [];
              if (elServicios) {
                if (elServicios.multiple) {
                  serviciosArr = Array.from(elServicios.selectedOptions).map(o => o.value || o.textContent || '').filter(Boolean);
                } else {
                  const v = getVal(elServicios);
                  if (v) serviciosArr = [v];
                }
              }

              const lineasData = {
                nombre_cliente: (elNombre?.value || '').trim(),
                telefono_principal: normalizePhone((elTelPrin?.value || '').trim()),
                numero_cuenta: (elNumCuenta?.value || '').trim(),
                autopay: getVal(elAutopay), // si | no
                pin_seguridad: (elPin?.value || '').trim(),
                direccion: (elDir?.value || '').trim(),
                servicios: serviciosArr,
                dia_venta: getVal(elDiaVenta),
                dia_instalacion: getVal(elDiaInst),
                status: (elStatus?.value || '').trim(),
                cantidad_lineas: getVal(elCant),
                telefono_1: normalizePhone((elTel1?.value || '').trim()),
                telefono_2: normalizePhone((elTel2?.value || '').trim()),
                telefono_3: normalizePhone((elTel3?.value || '').trim()),
                telefono_4: normalizePhone((elTel4?.value || '').trim()),
                telefono_5: normalizePhone((elTel5?.value || '').trim()),
                id: (elID?.value || '').trim(),
                mercado: getVal(elMercado) || getTextUpper(elMercado),
                supervisor: (getVal(elSupervisor) || getTextUpper(elSupervisor)),
              };

              // Enviar a /api/lineas
              customerResponse = await makeRequest('/api/lineas', lineasData);
            } else {
              // Envío estándar a /api/leads
              customerResponse = await makeRequest("/api/leads", customerDataToSend);
            }
          
          console.log('=== RESPUESTAS DEL SERVIDOR ===');
          console.log('Lead Response:', leadResponse);
          console.log('Customer Response:', customerResponse);
            
            console.log('Respuesta de leads:', leadResponse);
            console.log('Respuesta de customers:', customerResponse);
            
            // Verificar que la respuesta sea exitosa
            if (customerResponse && customerResponse.success) {
              showNotification("Datos guardados exitosamente", 'success');
              crmForm.reset();
              
              // Forzar una actualización de la gráfica con los datos más recientes
              try {
                console.log('Actualizando gráficas después de enviar lead...');
                await actualizarGraficas();
                console.log('Gráficas actualizadas exitosamente');
              } catch (error) {
                console.error('Error al actualizar las gráficas:', error);
              }
              
              // Opcional: Redirigir o actualizar la tabla de clientes
              if (window.location.pathname.includes('Costumer.html')) {
                try {
                  const leads = await fetchLeadsAgente();
                  renderCostumerTable(leans);
                  updateSummaryCards(leads);
                } catch (error) {
                  console.error('Error al actualizar la tabla de clientes:', error);
                }
              }
            } else {
              throw new Error('Error al guardar los datos del cliente');
            }
          } catch (error) {
            console.error('Error al enviar los datos:', error);
            showNotification(`Error: ${error.message}`, 'error');
          } finally {
            // Restaurar el botón en cualquier caso
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.innerHTML = originalButtonText;
            }
          }
        } catch (error) {
          console.error('Error inesperado:', error);
          showNotification('Ocurrió un error inesperado', 'error');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        }
      }

      // Agregar el manejador de eventos al formulario
      function initializeForm() {
        const crmForm = document.getElementById('crmForm');
        if (crmForm) {
          crmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              await handleFormSubmit(e);
            } catch (error) {
              console.error('Error inesperado en el manejador del formulario:', error);
              showNotification('Ocurrió un error inesperado al procesar el formulario', 'error');
              const submitButton = e.target.querySelector('button[type="submit"]');
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Enviar';
              }
            }
          });
        }
      }
      
      // Función para manejar la lógica de cantidad de líneas
      function setupCantidadLineasLogic() {
        const cantidadLineasSelect = document.getElementById('cantidad_lineas');
        if (!cantidadLineasSelect) return;

        // Función para mostrar/ocultar campos de teléfonos según cantidad
        function toggleTelefonosFields(cantidad) {
          const telefonosFields = [
            'telefono_1', 'telefono_2', 'telefono_3', 'telefono_4', 'telefono_5'
          ];
          
          telefonosFields.forEach((fieldName, index) => {
            const fieldGroup = document.querySelector(`[data-field="${fieldName}"]`);
            if (fieldGroup) {
              if (index < cantidad) {
                fieldGroup.style.display = 'block';
                // Hacer requerido el campo si está visible
                const input = fieldGroup.querySelector('input');
                if (input) input.required = true;
              } else {
                fieldGroup.style.display = 'none';
                // Limpiar y quitar requerimiento si está oculto
                const input = fieldGroup.querySelector('input');
                if (input) {
                  input.value = '';
                  input.required = false;
                }
                // Limpiar también los radio buttons de servicio
                const radioButtons = fieldGroup.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => radio.checked = false);
              }
            }
          });
        }

        // Event listener para el cambio de cantidad de líneas
        cantidadLineasSelect.addEventListener('change', function() {
          const cantidad = parseInt(this.value) || 0;
          toggleTelefonosFields(cantidad);
        });

        // Inicializar estado al cargar la página
        const initialCantidad = parseInt(cantidadLineasSelect.value) || 0;
        toggleTelefonosFields(initialCantidad);
      }

      // Inicializar el formulario cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          initializeForm();
          setupCantidadLineasLogic();
        });
      } else {
        initializeForm();
        setupCantidadLineasLogic();
      }
    } // Cierre de la función principal
    
    // La inicialización de la aplicación ya se maneja arriba y está protegida
  
  // Contenedor para notificaciones
  const notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  document.body.appendChild(notificationContainer);
  
  // Crear y agregar estilos dinámicamente
  const style = document.createElement('style');
  style.textContent = `
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }
    
    .success {
      background-color: #4CAF50;
    }
    
    .error {
      background-color: #F44336;
    }
    
    .warning {
      background-color: #FF9800;
    }
    
    .info {
      background-color: #2196F3;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Función para verificar si el usuario es de Team Líneas
  function isTeamLineasUser() {
    try {
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const username = (userData.username || '').toLowerCase();
      const role = (userData.role || '').toLowerCase();
      return role === 'teamlineas' || username.startsWith('lineas-');
    } catch (e) {
      console.error('Error al verificar usuario de Team Líneas:', e);
      return false;
    }
  }

  // Función para inicializar la aplicación (definición inferior protegida)
  function initializeApp() {
      // Si ya se inicializó por la definición superior, no hacer nada
      if (window.__leadAppInitialized) {
        console.warn('initializeApp() invocado nuevamente (definición inferior). Omitiendo.');
        return;
      }
      window.__leadAppInitialized = true;

      console.log('Inicializando aplicación (definición inferior)...');
      
      // No hacer nada si el usuario es de Team Líneas
      if (isTeamLineasUser()) {
        console.log('Usuario de Team Líneas detectado, omitiendo inicialización en lead.html');
        return;
      }
      
      // Inicializar datepickers u otros componentes si es necesario
      const fechaLead = document.getElementById('fecha-lead');
      if (fechaLead) {
        fechaLead.value = new Date().toISOString().slice(0, 10);
      }
      
      // Inicialización mínima de la gráfica sin crear intervalos duplicados
      try {
        const chartCanvas = document.getElementById('ventasPuntajeChart');
        if (chartCanvas && !ventasPuntajeChart) {
          ventasPuntajeChart = inicializarGraficaVentasPuntaje();
          if (!window.__chartsInitialDataLoaded) {
            window.__chartsInitialDataLoaded = true;
            actualizarGraficaVentasPuntaje().catch(() => actualizarGraficaVentasPuntaje(datosPrueba));
          }
        }
      } catch (error) {
        console.error('Error en inicialización mínima de la gráfica:', error);
      }
    }
    
  // initializeApp ya fue registrado/protegido previamente
}); // Cierre del event listener principal

// Forzar la visualización del sidebar
document.addEventListener('DOMContentLoaded', function() {
  // Asegurarse de que el sidebar esté visible
  const sidebar = document.querySelector('.sidebar.sidebar-inicio');
  if (sidebar) {
    sidebar.style.display = 'flex';
    sidebar.style.visibility = 'visible';
    sidebar.style.opacity = '1';
    sidebar.style.transform = 'translateX(0)';
  }
  
  // Manejar el menú en dispositivos móviles
  const menuToggle = document.getElementById('menuToggle');
  // Usar la variable sidebar ya declarada
  
  // Mostrar/ocultar menú en móviles
  function checkScreenSize() {
    if (window.innerWidth <= 768) {
      menuToggle.style.display = 'block';
      sidebar.classList.remove('active');
    } else {
      menuToggle.style.display = 'none';
      sidebar.classList.add('active');
    }
  }
  
  // Verificar tamaño de pantalla al cargar y al redimensionar
  checkScreenSize();
  window.addEventListener('resize', checkScreenSize);
  
  // Alternar menú al hacer clic en el botón
  menuToggle.addEventListener('click', function() {
    sidebar.classList.toggle('active');
  });
  
  // Cerrar menú al hacer clic en un enlace
  document.querySelectorAll('.sidebar .btn-sidebar').forEach(link => {
    link.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('active');
      }
    });
  });
  
  // Normalizar números de teléfono automáticamente mientras el usuario escribe
  const phoneFields = [
    'telefono-principal',
    'telefono-alterno',
    'telefono-secundario',
    'telefono_1',
    'telefono_2',
    'telefono_3',
    'telefono_4',
    'telefono_5'
  ];
  
  phoneFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      // Normalizar cuando el usuario termina de escribir (pierde el foco)
      field.addEventListener('blur', function() {
        const normalized = this.value.replace(/\D+/g, '');
        if (this.value !== normalized) {
          this.value = normalized;
          console.log(`[Teléfono normalizado] ${fieldId}: ${normalized}`);
        }
      });
      
      // También normalizar mientras escribe (opcional, más agresivo)
      field.addEventListener('input', function() {
        const cursorPosition = this.selectionStart;
        const oldLength = this.value.length;
        const normalized = this.value.replace(/\D+/g, '');
        
        if (this.value !== normalized) {
          this.value = normalized;
          // Ajustar la posición del cursor
          const newPosition = cursorPosition - (oldLength - normalized.length);
          this.setSelectionRange(newPosition, newPosition);
        }
      });
    }
  });
  
  // ========== SISTEMA DE PUNTACIÓN AUTOMÁTICA ==========
  console.log('[PUNTAJE] Inicializando sistema de puntación automática');
  
  // Definir el sistema de scoring si no existe
  if (!window.ScoringSystem) {
    window.ScoringSystem = {
      calculateScore: function(serviceKey, riskLevel) {
        const SCORING_TABLE = {
          'video-directv-internet': { byRisk: { low: 1.0, medium: 0.35, high: 0.35, na: 1.0 } },
          'video-directv-satelite': { base: 1.0 },
          'video-select-spectrum': { base: 1.0 },
          'att-air': { base: 0.35 },
          'att-18-25-mb': { base: 0.25 },
          'att-50-100-mb': { base: 0.35 },
          'att-300-500-mb': { base: 1.25 },
          'att-1g-plus': { base: 1.5 },
          'xfinity-100-299': { base: 0.35 },
          'xfinity-300': { base: 0.35 },
          'xfinity-500-plus': { base: 0.75 },
          'xfinity-double-play': { base: 0.95 },
          'xfinity-ultimate-tv': { base: 0.75 },
          'xfinity-unlimited-voip': { base: 0.75 },
          'frontier-200-mb': { base: 1.0 },
          'frontier-500-mb': { base: 1.0 },
          'frontier-1g': { base: 1.25 },
          'frontier-2g-plus': { base: 1.5 },
          'internet-earthlink': { base: 1.0 },
          'internet-ziply-fiber': { base: 0.35 },
          'internet-windstream': { base: 1.25 },
          'brightspeed-10-100': { base: 0.35 },
          'brightspeed-100-900': { base: 1.0 },
          'spectrum-500': { base: 0.75 },
          'spectrum-1g': { base: 1.0 },
          'spectrum-2g': { base: 1.25 },
          'double-play-spectrum': { base: 1.0 },
          'mobility-spectrum': { base: 0.5 },
          'sim-spectrum': { base: 0.5 }
        };
        
        if (!serviceKey) return 0;
        const normalizedRisk = (riskLevel || 'na').toLowerCase();
        const serviceConfig = SCORING_TABLE[serviceKey];
        if (!serviceConfig) return 0;
        if (serviceConfig.base !== undefined) return serviceConfig.base;
        if (serviceConfig.byRisk) return serviceConfig.byRisk[normalizedRisk] || serviceConfig.byRisk.low || 0;
        return 0;
      },
      getScoreInfo: function(serviceKey, riskLevel) {
        const score = this.calculateScore(serviceKey, riskLevel);
        return { score: score, serviceKey: serviceKey, riskLevel: riskLevel };
      }
    };
    console.log('[PUNTAJE] Sistema de scoring inicializado');
  }
  
  const serviciosSelect = document.getElementById('servicios');
  const riesgoSelect = document.getElementById('riesgo');
  const puntajeInput = document.getElementById('puntaje');
  const puntajeHidden = document.getElementById('puntaje-value');
  
  /**
   * Calcula y actualiza el puntaje basándose en el servicio y riesgo seleccionados
   */
  function actualizarPuntajeAutomatico() {
    if (!serviciosSelect || !riesgoSelect || !puntajeInput) {
      console.warn('[PUNTAJE] Elementos del formulario no encontrados');
      return;
    }
    
    const servicioSeleccionado = serviciosSelect.value;
    const riesgoSeleccionado = riesgoSelect.value;
    
    // Si no hay servicio seleccionado, limpiar el puntaje
    if (!servicioSeleccionado) {
      puntajeInput.value = '';
      if (puntajeHidden) puntajeHidden.value = '';
      console.log('[PUNTAJE] Servicio no seleccionado, puntaje limpiado');
      return;
    }
    
    // Si no hay riesgo seleccionado, mostrar mensaje
    if (!riesgoSeleccionado) {
      puntajeInput.value = 'Selecciona riesgo';
      if (puntajeHidden) puntajeHidden.value = '';
      console.log('[PUNTAJE] Riesgo no seleccionado');
      return;
    }
    
    // Verificar que el sistema de scoring esté disponible
    if (!window.ScoringSystem || typeof window.ScoringSystem.calculateScore !== 'function') {
      console.error('[PUNTAJE] Sistema de scoring no disponible');
      puntajeInput.value = 'Error: Sistema no disponible';
      return;
    }
    
    // Calcular el puntaje
    const puntaje = window.ScoringSystem.calculateScore(servicioSeleccionado, riesgoSeleccionado);
    const scoreInfo = window.ScoringSystem.getScoreInfo(servicioSeleccionado, riesgoSeleccionado);
    
    // Actualizar el campo visible
    puntajeInput.value = puntaje.toFixed(2);
    
    // Actualizar el campo oculto (para envío del formulario)
    if (puntajeHidden) {
      puntajeHidden.value = puntaje;
    }
    
    // Log detallado
    console.log('[PUNTAJE] Calculado:', {
      servicio: servicioSeleccionado,
      riesgo: riesgoSeleccionado,
      puntaje: puntaje,
      dependeDeRiesgo: scoreInfo.dependsOnRisk
    });
    
    // Indicador visual si el servicio depende del riesgo
    if (scoreInfo.dependsOnRisk) {
      puntajeInput.style.borderLeft = '4px solid #f59e0b'; // Naranja
      puntajeInput.title = 'Este servicio tiene puntajes diferentes según el riesgo';
    } else {
      puntajeInput.style.borderLeft = '4px solid #10b981'; // Verde
      puntajeInput.title = 'Este servicio tiene puntaje fijo';
    }
  }
  
  // Escuchar cambios en el select de servicios
  if (serviciosSelect) {
    serviciosSelect.addEventListener('change', function() {
      console.log('[PUNTAJE] Servicio cambiado:', this.value);
      actualizarPuntajeAutomatico();
    });
  }
  
  // Escuchar cambios en el select de riesgo
  if (riesgoSelect) {
    riesgoSelect.addEventListener('change', function() {
      console.log('[PUNTAJE] Riesgo cambiado:', this.value);
      actualizarPuntajeAutomatico();
    });
  }
  
  // Calcular puntaje inicial si ya hay valores seleccionados
  setTimeout(() => {
    if (serviciosSelect?.value && riesgoSelect?.value) {
      actualizarPuntajeAutomatico();
    }
  }, 500);
  
  console.log('[PUNTAJE] Sistema de puntación automática inicializado correctamente');
});

// SCRIPT PARA FORZAR ACTUALIZACIÓN DEL DROPDOWN SUPERVISOR
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    const supervisorSelect = document.getElementById('supervisor');
    if (supervisorSelect) {
      // Limpiar opciones existentes
      supervisorSelect.innerHTML = '';
      
      // Recrear opciones sin RANDAL
      const opciones = [
        { value: '', text: 'Seleccione' },
        { value: 'IRANIA', text: 'IRANIA' },
        { value: 'ROBERTO', text: 'ROBERTO' },
        { value: 'MARISOL', text: 'MARISOL' },
        { value: 'PLEITEZ', text: 'PLEITEZ' },
        { value: 'JOHANA', text: 'JOHANA' },
        { value: 'JONATHAN', text: 'JONATHAN' }
      ];
      
      opciones.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        supervisorSelect.appendChild(option);
      });
      
      console.log('✅ Dropdown supervisor actualizado - RANDAL eliminado');
    }
  }, 500); // Esperar 500ms para que cargue todo
});
</script>
</body>
</html>