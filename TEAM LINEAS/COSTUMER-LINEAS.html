<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer - Team Líneas</title>
  <script>
    (function guard(){
      try{
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const role = String(user.role||'').toLowerCase();
        const team = String(user.team||'').toLowerCase();
        const ok = /lineas/.test(team) || /lineas/.test(role) || role.includes('supervisor');
        if(!ok){ window.location.replace('/inicio.html'); }
      }catch(e){ window.location.replace('/inicio.html'); }
    })();
  </script>
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/sidebar.css" />
  <link rel="stylesheet" href="/css/sidebar-inicio.css" />
  <link rel="stylesheet" href="/css/sidebar-shared.css" />
  <link rel="stylesheet" href="/css/costumer-table-clean.css" />
  <link rel="stylesheet" href="/css/costumer-table-actions.css" />
  <link rel="stylesheet" href="/css/costumer-table-comments.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    .filters { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(220px, 360px)); gap:16px; justify-content:space-between; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>
    <main class="main-content">
      <div style="max-width:100%; margin:16px auto 0;">
        <h1 style="margin:0 0 12px;">Customer - Team Líneas</h1>

        <div class="toolbar" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="q" class="form-control" placeholder="Buscar (nombre, teléfono, cuenta, dirección, ID)" style="min-width:320px;" />
            <select id="qs" class="form-control" style="min-width:140px;">
              <option value="">STATUS: Todos</option>
              <option value="pending">PENDING</option>
              <option value="repro">REPRO</option>
            </select>
          </div>
          
        </div>

        <!-- Sin formularios: solo barra rápida arriba y tabla debajo -->

        <section style="margin-top:16px;">
          <div class="costumer-table-container">
            <div class="costumer-table-header">
              <h2 class="costumer-table-title">Lista de Clientes</h2>
              <div class="costumer-table-actions"></div>
            </div>
            <div class="table-responsive">
              <table class="costumer-table">
                <thead id="costumer-thead">
                  <tr>
                    <th>Cliente</th>
                    <th>Teléfono</th>
                    <th>Cuenta</th>
                    <th>Cant. líneas</th>
                    <th>Líneas</th>
                    <th>STATUS</th>
                    <th>Día venta</th>
                    <th>Día instalación</th>
                    <th>ID</th> 
                    <th>Mercado</th>
                    <th>Supervisor</th>
                    <th>ACCIÓN</th>
                  </tr>
                </thead>
                <tbody id="costumer-tbody"></tbody>
              </table>
            </div>
            <div id="scrollbarMirror" class="scrollbar-mirror"><div id="scrollbarMirrorInner" style="height:1px;"></div></div>
          </div>
        </section>
      </div>
    </main>
  </div>
  <script src="/js/fetch-interceptor.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="/js/sidebar-loader.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.loadSidebar) window.loadSidebar();

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      // Configuración de actualización de STATUS
      const STATUS_ENDPOINT = '/api/lineas-team/status'; // Ajustar si tu ruta es distinta
      const STATUS_METHOD = 'PUT';
      const STATUS_OPTIONS = [
        { val: 'pending', label: 'Pending' },
        { val: 'hold', label: 'Hold' },
        { val: 'cancelled', label: 'Cancelled' },
        { val: 'rescheduled', label: 'Rescheduled' },
        { val: 'completed', label: 'Completed' }
      ];
      function getUserRole(){
        try{ const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}'); return String(u.role||'').toLowerCase(); }catch{ return ''; }
      }
      function canEditStatus(){
        const r = getUserRole();
        return r.includes('admin') || r.includes('administrador') || r.includes('backoffice');
      }

      function normalizeDigits(v){ return String(v||'').replace(/\D+/g,''); }

      async function fetchData(){
        const resp = await fetch(`/api/lineas-team?t=${Date.now()}`,{ credentials:'include' });
        const j = await resp.json();
        return Array.isArray(j?.data) ? j.data : [];
      }

      function buildHeaders(){
        const thead = document.getElementById('costumer-thead');
        if (!thead) return;
        thead.innerHTML = `
          <tr>
            <th>Cliente</th>
            <th>Teléfono</th>
            <th>Cuenta</th>
            <th>Cant. líneas</th>
            <th>Líneas</th>
            <th>STATUS</th>
            <th>Día venta</th>
            <th>Día instalación</th>
            <th>ID</th>
            <th>Mercado</th>
            <th>Supervisor</th>
            <th>ACCIÓN</th>
          </tr>`;
      }

      function applyFilters(items){
        const query = ($('#q')?.value || '').trim().toUpperCase();
        const qstatus = ($('#qs')?.value || '').trim().toLowerCase();
        const nombre = '';
        const tel = '';
        const cuenta = '';
        const autopay = '';
        const pin = '';
        const dir = '';
        const servs = [];
        let status = '';
        if (qstatus) status = qstatus;
        const dventa = '';
        const dinst = '';
        const cant = '';
        const idv = '';
        const mercado = [];
        let sup = '';
        if (!sup && defaultSupervisor) sup = defaultSupervisor;

        return items.filter(it=>{
          if (query) {
            const blob = [
              String(it.nombre_cliente||'').toUpperCase(),
              normalizeDigits(it.telefono_principal),
              String(it.numero_cuenta||'').toUpperCase(),
              String(it.direccion||'').toUpperCase(),
              String(it.id||'').toUpperCase()
            ].join(' | ');
            if (!blob.includes(query)) return false;
          }
          if (nombre && !(String(it.nombre_cliente||'').toUpperCase().includes(nombre))) return false;
          if (tel && !(normalizeDigits(it.telefono_principal).includes(tel))) return false;
          if (cuenta && !(String(it.numero_cuenta||'').includes(cuenta))) return false;
          if (autopay && String(it.autopay||'').toLowerCase()!==autopay) return false;
          if (pin && !(String(it.pin_seguridad||'').includes(pin))) return false;
          if (dir && !(String(it.direccion||'').toUpperCase().includes(dir))) return false;
          if (servs.length && !servs.some(s=> (it.servicios||[]).includes(s))) return false;
          if (status && String(it.status||'').toLowerCase()!==status) return false;
          if (dventa && String(it.dia_venta||'')!==dventa) return false;
          if (dinst && String(it.dia_instalacion||'')!==dinst) return false;
          if (cant && Number(it.cantidad_lineas||0)!== Number(cant)) return false;
          if (idv && !(String(it.id||'').includes(idv))) return false;
          if (mercado.length && !mercado.includes(String(it.mercado||''))) return false;
          if (sup && !String(it.supervisor||'').toUpperCase().includes(sup.toUpperCase())) return false;
          return true;
        });
      }

      function renderTable(items){
        buildHeaders();
        const tb = document.getElementById('costumer-tbody');
        const editable = canEditStatus();
        tb.innerHTML = items.map(it=>{
          const servArr = Array.isArray(it.servicios) ? it.servicios : (typeof it.servicios_texto==='string' ? it.servicios_texto.split(/[,;]+/).map(s=>s.trim()).filter(Boolean) : []);
          const tels = Array.isArray(it.telefonos) ? it.telefonos : [];
          const maxLen = Math.max(servArr.length, tels.length);
          const pairs = Array.from({length: maxLen}).map((_,i)=>{
            const s = servArr[i] || '';
            const t = tels[i] || '';
            return (s||t) ? `${s}${s&&t?': ':''}${t}` : '';
          }).filter(Boolean);
          const cant = (it.cantidad_lineas!=null) ? it.cantidad_lineas : (Array.isArray(it.telefonos) ? it.telefonos.length : '');
          const statusLower = String(it.status||'').toLowerCase();
          const statusCell = editable
            ? `<select class="status-select" data-id="${it.id||it._id||''}" style="min-width:140px;">
                 ${STATUS_OPTIONS.map(o=>`<option value="${o.val}" ${o.val===statusLower?'selected':''}>${o.label}</option>`).join('')}
               </select>`
            : String(it.status||'').toUpperCase();
          return `<tr>
            <td>${it.nombre_cliente||''}</td>
            <td>${it.telefono_principal||''}</td>
            <td>${it.numero_cuenta||''}</td>
            <td>${cant}</td>
            <td>${pairs.length ? pairs.map(p=>`<div>${p}</div>`).join('') : ''}</td>
            <td>${statusCell}</td>
            <td>${it.dia_venta||''}</td>
            <td>${it.dia_instalacion||''}</td>
            <td>${it.id||''}</td>
            <td>${it.mercado||''}</td>
            <td>${it.supervisor||''}</td>
            <td><button class="btn btn-small" data-id="${it.id||it._id||''}" onclick="alert('Abrir detalle: '+this.getAttribute('data-id'))">Ver</button></td>
          </tr>`;
        }).join('');
        // Ajustar espejo si existe util
        if (window.rebuildStickyHead) try{ window.rebuildStickyHead(); }catch{}
      }

      let allItems = [];
      async function load(){
        allItems = await fetchData();
        renderTable(applyFilters(allItems));
      }

      const btnBuscar = document.getElementById('btnBuscar');
      if (btnBuscar) btnBuscar.addEventListener('click', ()=>{ renderTable(applyFilters(allItems)); });
      const btnReset = document.getElementById('btnReset');
      if (btnReset) btnReset.addEventListener('click', ()=>{
        if ($('#q')) $('#q').value = '';
        if ($('#qs')) $('#qs').value = '';
        renderTable(allItems);
      });

      // No hay campos de formulario adicionales

      // Live filtering from quick controls
      const q = $('#q');
      const qs = $('#qs');
      if (q) q.addEventListener('input', ()=> renderTable(applyFilters(allItems)) );
      if (qs) qs.addEventListener('change', ()=> renderTable(applyFilters(allItems)) );

      // Detect supervisor por usuario y marcar por defecto
      let defaultSupervisor = '';
      try {
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const name = String(user.supervisor||user.username||'').toUpperCase();
        if (name.includes('JONATHAN')) defaultSupervisor = 'JONATHAN F';
        else if (name.includes('GUTIERREZ') || name.includes('LUIS')) defaultSupervisor = 'LUIS G';
      } catch {}
      // Prefiltro aplicado en applyFilters sin mostrar controles

      // Toggle filters panel
      // No hay panel de filtros
      buildHeaders();

      // Guardar cambios de STATUS (delegado)
      const tbody = document.getElementById('costumer-tbody');
      if (tbody) {
        tbody.addEventListener('change', async (e)=>{
          const sel = e.target.closest('select.status-select');
          if (!sel) return;
          if (!canEditStatus()) { alert('No tienes permisos para cambiar el STATUS.'); return; }
          const id = sel.getAttribute('data-id');
          const status = sel.value;
          const prev = sel.getAttribute('data-prev') || '';
          sel.disabled = true;
          try{
            const res = await fetch(STATUS_ENDPOINT, {
              method: STATUS_METHOD,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, status, statusUpper: String(status||'').toUpperCase() })
            });
            if (!res.ok) throw new Error('HTTP '+res.status);
            sel.setAttribute('data-prev', status);
            // Refetch para asegurar persistencia real al recargar
            await load();
          }catch(err){
            console.error('[STATUS] error', err);
            alert('No se pudo actualizar el STATUS');
            if (prev) sel.value = prev;
          }finally{
            sel.disabled = false;
          }
        });
      }

      load();
    });
  </script>
</body>
</html>
