<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer - Team Líneas</title>
  <script>
    (function guard(){
      try{
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const role = String(user.role||'').toLowerCase();
        const team = String(user.team||'').toLowerCase();
        const ok = role==='teamlineas' || role==='lineas-agentes' || role==='supervisor team lineas' || (role==='supervisor' && team.includes('lineas')) || team.includes('lineas') || username.startsWith('lineas-');
        if(!ok){ window.location.replace('/inicio.html'); }
      }catch(e){ window.location.replace('/inicio.html'); }
    })();
  </script>
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/sidebar.css" />
  <link rel="stylesheet" href="/css/sidebar-inicio.css" />
  <link rel="stylesheet" href="/css/sidebar-shared.css" />
  <link rel="stylesheet" href="/css/costumer-table-clean.css" />
  <link rel="stylesheet" href="/css/costumer-table-actions.css" />
  <link rel="stylesheet" href="/css/costumer-table-comments.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    .filters { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(220px, 360px)); gap:16px; justify-content:space-between; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>
    <main class="main-content">
      <div style="max-width:100%; margin:16px auto 0;">
        <h1 style="margin:0 0 12px;">Customer - Team Líneas</h1>

        <!-- Barra de filtros principal -->
        <div class="toolbar" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="q" class="form-control" placeholder="Buscar (nombre, teléfono, cuenta, dirección, ID)" style="min-width:320px;" />
            <select id="qs" class="form-control" style="min-width:140px;">
              <option value="">STATUS: Todos</option>
              <option value="pending">PENDING</option>
              <option value="repro">REPRO</option>
            </select>
            <select id="agentFilter" class="form-control" style="min-width:180px;">
              <option value="">AGENTE: Todos</option>
            </select>
          </div>
          <div id="admin-actions" style="display:none; margin-left: auto;">
            <button id="btn-seed-data" style="background-color: #dc2626; color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;">Crear Datos de Prueba</button>
          </div>
        </div>

        <section style="margin-top:16px;">
          <div class="costumer-table-container">
            <div class="costumer-table-header">
              <h2 class="costumer-table-title">Lista de Clientes</h2>
              <div class="costumer-table-actions"></div>
            </div>
            <div class="table-responsive">
              <table class="costumer-table">
                <thead id="costumer-thead">
                  <tr>
                    <th>Cliente</th>
                    <th>Teléfono</th>
                    <th>Cuenta</th>
                    <th>Cant. líneas</th>
                    <th>Líneas</th>
                    <th>STATUS</th>
                    <th>Día venta</th>
                    <th>Día instalación</th>
                    <th>ID</th> 
                    <th>Mercado</th>
                    <th>Supervisor</th>
                    <th>ACCIÓN</th>
                  </tr>
                </thead>
                <tbody id="costumer-tbody"></tbody>
              </table>
            </div>
            <div id="scrollbarMirror" class="scrollbar-mirror"><div id="scrollbarMirrorInner" style="height:1px;"></div></div>
          </div>
        </section>
      </div>
    </main>
  </div>
  <script src="/js/fetch-interceptor.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="/js/sidebar-loader.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.loadSidebar) window.loadSidebar();

      // Lógica para el botón de seeding
      const userRole = getUserRole();
      if (userRole === 'admin' || userRole === 'administrador') {
        document.getElementById('admin-actions').style.display = 'block';
      }

      // Para agentes de Team Líneas: ocultar filtros avanzados (STATUS / AGENTE)
      if (!userRole.includes('supervisor')) {
        try {
          document.querySelectorAll('#qs').forEach(el => { el.style.display = 'none'; });
          document.querySelectorAll('#agentFilter').forEach(el => { el.style.display = 'none'; });
        } catch (_) {}
      }

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      // Función global para mostrar notificaciones con diseño mejorado
      function showNotification(message, type = 'success') {
        // Remover notificación anterior si existe
        const existing = document.querySelector('.custom-notification');
        if (existing) existing.remove();
        
        const colors = {
          success: { bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: '#059669' },
          error: { bg: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', border: '#dc2626' },
          warning: { bg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', border: '#d97706' },
          info: { bg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: '#2563eb' }
        };
        
        const currentColor = colors[type] || colors.success;
        
        const notification = document.createElement('div');
        notification.className = 'custom-notification';
        notification.style.cssText = `
          position: fixed;
          top: 24px;
          right: 24px;
          background: ${currentColor.bg};
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          border-left: 4px solid ${currentColor.border};
          box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
          z-index: 10001;
          font-size: 14px;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 12px;
          min-width: 300px;
          max-width: 500px;
          animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          backdrop-filter: blur(10px);
        `;
        
        const icons = {
          success: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
          error: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
          warning: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
          info: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        
        const icon = icons[type] || icons.success;
        
        notification.innerHTML = `
          <div style="flex-shrink: 0;">${icon}</div>
          <div style="flex: 1; line-height: 1.5;">${message}</div>
          <button class="notification-close" style="background: transparent; border: none; color: white; cursor: pointer; padding: 4px; display: flex; align-items: center; opacity: 0.8; transition: opacity 0.2s;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        `;
        
        // Agregar animaciones CSS si no existen
        if (!document.querySelector('#notification-styles')) {
          const style = document.createElement('style');
          style.id = 'notification-styles';
          style.textContent = `
            @keyframes slideInBounce {
              0% {
                transform: translateX(120%) scale(0.9);
                opacity: 0;
              }
              60% {
                transform: translateX(-10px) scale(1.02);
                opacity: 1;
              }
              100% {
                transform: translateX(0) scale(1);
                opacity: 1;
              }
            }
            @keyframes slideOutFade {
              0% {
                transform: translateX(0) scale(1);
                opacity: 1;
              }
              100% {
                transform: translateX(120%) scale(0.9);
                opacity: 0;
              }
            }
            .notification-close:hover {
              opacity: 1 !important;
              transform: rotate(90deg);
              transition: all 0.3s ease;
            }
            @keyframes fadeIn {
              from {
                opacity: 0;
              }
              to {
                opacity: 1;
              }
            }
            @keyframes scaleIn {
              0% {
                transform: scale(0.9);
                opacity: 0;
              }
              100% {
                transform: scale(1);
                opacity: 1;
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(notification);
        
        // Botón de cerrar
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
          notification.style.animation = 'slideOutFade 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        });
        
        // Auto-remover después de 4 segundos
        setTimeout(() => {
          if (document.body.contains(notification)) {
            notification.style.animation = 'slideOutFade 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
          }
        }, 4000);
      }

      // Función para mostrar confirmación personalizada
      function showConfirm(title, message) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.2s ease-out;
            backdrop-filter: blur(4px);
          `;
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
          `;
          
          modal.innerHTML = `
            <div style="padding: 24px 24px 20px; border-bottom: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                </div>
                <h3 style="margin: 0; color: #0f172a; font-size: 18px; font-weight: 700;">${title}</h3>
              </div>
            </div>
            <div style="padding: 20px 24px;">
              <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.6;">${message}</p>
            </div>
            <div style="display: flex; gap: 12px; padding: 20px 24px; background: #f8f9fa; border-top: 1px solid #e5e7eb;">
              <button class="confirm-cancel" style="flex: 1; background: white; color: #64748b; border: 1px solid #e5e7eb; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                Cancelar
              </button>
              <button class="confirm-accept" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
                Aceptar
              </button>
            </div>
          `;
          
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
          
          // Agregar efectos hover
          const cancelBtn = modal.querySelector('.confirm-cancel');
          const acceptBtn = modal.querySelector('.confirm-accept');
          
          cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f8f9fa';
            cancelBtn.style.borderColor = '#cbd5e1';
          });
          cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#e5e7eb';
          });
          
          acceptBtn.addEventListener('mouseenter', () => {
            acceptBtn.style.transform = 'translateY(-2px)';
            acceptBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
          });
          acceptBtn.addEventListener('mouseleave', () => {
            acceptBtn.style.transform = 'translateY(0)';
            acceptBtn.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.3)';
          });
          
          // Event listeners
          cancelBtn.addEventListener('click', () => {
            overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
            setTimeout(() => {
              overlay.remove();
              resolve(false);
            }, 200);
          });
          
          acceptBtn.addEventListener('click', () => {
            overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
            setTimeout(() => {
              overlay.remove();
              resolve(true);
            }, 200);
          });
          
          // Cerrar al hacer clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
              setTimeout(() => {
                overlay.remove();
                resolve(false);
              }, 200);
            }
          });
        });
      }

      // Configuración de actualización de STATUS
      const STATUS_ENDPOINT = '/api/lineas-team/status'; // Ajustar si tu ruta es distinta
      const STATUS_METHOD = 'PUT';
      const STATUS_OPTIONS = [
        { val: 'pending', label: 'Pending' },
        { val: 'hold', label: 'Hold' },
        { val: 'cancelled', label: 'Cancelled' },
        { val: 'rescheduled', label: 'Rescheduled' },
        { val: 'completed', label: 'Completed' }
      ];
      function getUserRole(){
        try{ const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}'); return String(u.role||'').toLowerCase(); }catch{ return ''; }
      }
      function canEditStatus(){
        const r = getUserRole();
        return r.includes('admin') || r.includes('administrador') || r.includes('backoffice') || r.includes('supervisor');
      }

      function normalizeDigits(v){ return String(v||'').replace(/\D+/g,''); }

      async function fetchData(){
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = {};
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const resp = await fetch(`/api/lineas-team?t=${Date.now()}`, { 
          credentials: 'include',
          headers: headers
        });
        const j = await resp.json();
        return Array.isArray(j?.data) ? j.data : [];
      }

      function buildHeaders(){
        const thead = document.getElementById('costumer-thead');
        if (!thead) return;
        thead.innerHTML = `
          <tr>
            <th>Cliente</th>
            <th>Teléfono</th>
            <th>Cuenta</th>
            <th>Cant. líneas</th>
            <th>Líneas</th>
            <th>STATUS</th>
            <th>Día venta</th>
            <th>Día instalación</th>
            <th>ID</th>
            <th>Mercado</th>
            <th>Supervisor</th>
            <th>ACCIÓN</th>
          </tr>`;
      }

      function applyFilters(items){
        const query = ($('#q')?.value || '').trim().toUpperCase();
        const qstatus = ($('#qs')?.value || '').trim().toLowerCase();
        const qagent = ($('#agentFilter')?.value || '').trim().toUpperCase();
        const nombre = '';
        const tel = '';
        const cuenta = '';
        const autopay = '';
        const pin = '';
        const dir = '';
        const servs = [];
        let status = '';
        if (qstatus) status = qstatus;
        const dventa = '';
        const dinst = '';
        const cant = '';
        const idv = '';
        const mercado = [];
        let sup = '';
        if (!sup && defaultSupervisor) sup = defaultSupervisor;

        return items.filter(it=>{
          if (query) {
            const blob = [
              String(it.nombre_cliente||'').toUpperCase(),
              normalizeDigits(it.telefono_principal),
              String(it.numero_cuenta||'').toUpperCase(),
              String(it.direccion||'').toUpperCase(),
              String(it.id||'').toUpperCase()
            ].join(' | ');
            if (!blob.includes(query)) return false;
          }
          if (nombre && !(String(it.nombre_cliente||'').toUpperCase().includes(nombre))) return false;
          if (tel && !(normalizeDigits(it.telefono_principal).includes(tel))) return false;
          if (cuenta && !(String(it.numero_cuenta||'').includes(cuenta))) return false;
          if (autopay && String(it.autopay||'').toLowerCase()!==autopay) return false;
          if (pin && !(String(it.pin_seguridad||'').includes(pin))) return false;
          if (dir && !(String(it.direccion||'').toUpperCase().includes(dir))) return false;
          if (servs.length && !servs.some(s=> (it.servicios||[]).includes(s))) return false;
          if (status && String(it.status||'').toLowerCase()!==status) return false;
          if (dventa && String(it.dia_venta||'')!==dventa) return false;
          if (dinst && String(it.dia_instalacion||'')!==dinst) return false;
          if (cant && Number(it.cantidad_lineas||0)!== Number(cant)) return false;
          if (idv && !(String(it.id||'').includes(idv))) return false;
          if (mercado.length && !mercado.includes(String(it.mercado||''))) return false;
          if (sup && !String(it.supervisor||'').toUpperCase().includes(sup.toUpperCase())) return false;
          // Filtro por agente asignado
          if (qagent && !(String(it.agenteAsignado||'').toUpperCase().includes(qagent) || 
                          String(it.agenteNombre||'').toUpperCase().includes(qagent) ||
                          String(it.agente||'').toUpperCase().includes(qagent))) return false;
          return true;
        });
      }

      function renderTable(items){
        buildHeaders();
        const tb = document.getElementById('costumer-tbody');
        const editable = canEditStatus();
        tb.innerHTML = items.map((it, idx)=>{
          const servArr = Array.isArray(it.servicios) ? it.servicios : (typeof it.servicios_texto==='string' ? it.servicios_texto.split(/[,;]+/).map(s=>s.trim()).filter(Boolean) : []);
          const tels = Array.isArray(it.telefonos) ? it.telefonos : [];
          const lines = Array.isArray(it.lines) ? it.lines : [];
          const maxLen = Math.max(servArr.length, tels.length, lines.length);
          
          const pairs = Array.from({length: maxLen}).map((_,i)=>{
            const s = servArr[i] || '';
            const t = tels[i] || '';
            return (s||t) ? `${s}${s&&t?': ':''}${t}` : '';
          }).filter(Boolean);
          
          const cant = (it.cantidad_lineas!=null) ? it.cantidad_lineas : (Array.isArray(it.telefonos) ? it.telefonos.length : '');
          const hasMultipleLines = cant > 1;
          const statusLower = String(it.status||'').toLowerCase();
          const docId = it._id || it.id || '';
          const statusCell = editable
            ? `<select class="status-select" data-id="${docId}" data-prev="${statusLower}" style="min-width:140px;">
                 ${STATUS_OPTIONS.map(o=>`<option value="${o.val}" ${o.val===statusLower?'selected':''}>${o.label}</option>`).join('')}
               </select>`
            : String(it.status||'').toUpperCase();
          
          let mainRow = `<tr class="${hasMultipleLines ? 'expandable-row' : ''}" data-row-index="${idx}" style="${hasMultipleLines ? 'cursor:pointer;' : ''}">
            <td>${it.nombre_cliente||''}${hasMultipleLines ? ' <span style="color:#22b3ec;">▼</span>' : ''}</td>
            <td>${it.telefono_principal||''}</td>
            <td>${it.numero_cuenta||''}</td>
            <td>${cant}</td>
            <td>${pairs.length ? pairs.map(p=>`<div>${p}</div>`).join('') : ''}</td>
            <td>${statusCell}</td>
            <td>${it.dia_venta||''}</td>
            <td>${it.dia_instalacion||''}</td>
            <td>${it.id||''}</td>
            <td>${it.mercado||''}</td>
            <td>${it.supervisor||''}</td>
            <td>
              <div style="display:flex; gap:4px; justify-content:center;">
                <button class="btn-edit-client" data-id="${docId}" style="background:#3b82f6; color:#fff; border:none; padding:6px 10px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:4px;" title="Editar cliente">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Editar
                </button>
                <button class="btn-delete-client" data-id="${docId}" style="background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:4px;" title="Eliminar cliente">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                  Eliminar
                </button>
              </div>
            </td>
          </tr>`;
          
          // Fila expandible con detalles de todas las líneas
          if (hasMultipleLines) {
            let detailsHTML = `<tr class="details-row" data-row-index="${idx}" style="display:none; background:#f8f9fa;">
              <td colspan="12" style="padding:20px;">
                <div style="background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
                  <h4 style="margin:0 0 16px; color:#0f172a; font-size:16px;">Detalle Completo - ${it.nombre_cliente||''}</h4>
                  
                  <!-- Información General del Cliente -->
                  <div style="background:#f8f9fa; border:1px solid #e5e7eb; border-radius:6px; padding:16px; margin-bottom:16px;">
                    <div style="font-weight:700; color:#0f172a; margin-bottom:12px; font-size:15px;">Información del Cliente</div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; font-size:14px;">
                      <div>
                        <span style="color:#64748b; font-size:12px;">Cliente:</span><br>
                        <span style="font-weight:600;">${it.nombre_cliente||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Teléfono Principal:</span><br>
                        <span style="font-weight:600;">${it.telefono_principal||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Número de Cuenta:</span><br>
                        <span style="font-weight:600;">${it.numero_cuenta||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Cantidad de Líneas:</span><br>
                        <span style="font-weight:600;">${cant}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">STATUS:</span><br>
                        <span style="font-weight:600; color:${statusLower === 'pending' ? '#f59e0b' : statusLower === 'completed' ? '#059669' : '#64748b'};">${String(it.status||'').toUpperCase()}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Día de Venta:</span><br>
                        <span style="font-weight:600;">${it.dia_venta||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Día de Instalación:</span><br>
                        <span style="font-weight:600;">${it.dia_instalacion||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">ID:</span><br>
                        <span style="font-weight:600;">${it.id||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Mercado:</span><br>
                        <span style="font-weight:600;">${it.mercado||'N/A'}</span>
                      </div>
                      <div>
                        <span style="color:#64748b; font-size:12px;">Supervisor:</span><br>
                        <span style="font-weight:600;">${it.supervisor||'N/A'}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Detalle de Líneas -->
                  <div style="font-weight:700; color:#0f172a; margin-bottom:12px; font-size:15px;">Detalle de Líneas</div>
                  <div style="display:grid; gap:12px;">`;
            
            // Mostrar cada línea con su información completa
            for (let i = 0; i < maxLen; i++) {
              const lineData = lines[i] || {};
              const telefono = tels[i] || lineData.telefono || '';
              const servicio = servArr[i] || lineData.servicio || '';
              
              // Leer notas desde lineas_notas en lugar de lines
              const lineasNotas = it.lineas_notas || {};
              const notas = lineasNotas[i] || [];
              
              console.log(`Cliente ${it.nombre_cliente}, Línea ${i}:`, {
                telefono: telefono,
                servicio: servicio,
                notas: notas,
                notasLength: notas.length
              });
              
              detailsHTML += `
                <div style="border:1px solid #e5e7eb; border-radius:6px; padding:12px; background:#fafbfc;">
                  <div style="font-weight:700; color:#0f172a; margin-bottom:8px;">Línea ${i+1}</div>
                  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; font-size:14px; margin-bottom:12px;">
                    <div>
                      <span style="color:#64748b; font-size:12px;">Teléfono:</span><br>
                      <span style="font-weight:600;">${telefono || 'N/A'}</span>
                    </div>
                    <div>
                      <span style="color:#64748b; font-size:12px;">Servicio:</span><br>
                      <span style="font-weight:600;">${servicio || 'N/A'}</span>
                    </div>
                  </div>
                  
                  <!-- Sección de Notas -->
                  <div style="border-top:1px solid #e5e7eb; padding-top:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                      <span style="color:#64748b; font-size:12px; font-weight:600;">Notas:</span>
                      <button class="btn-add-note" data-client-id="${docId}" data-line-index="${i}" style="background:#10b981; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <span style="font-size:14px;">+</span> Agregar Nota
                      </button>
                    </div>
                    
                    <!-- Formulario para agregar nota (inicialmente oculto) -->
                    <div class="note-form" data-line-index="${i}" style="display:none; background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:12px; margin-bottom:12px;">
                      <textarea class="note-textarea" placeholder="Agregar nueva nota..." style="width:100%; min-height:80px; padding:8px; border:1px solid #e5e7eb; border-radius:4px; font-size:13px; resize:vertical; font-family:inherit;"></textarea>
                      <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn-save-note" style="background:#10b981; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:600;">
                          + Agregar Nota
                        </button>
                        <button class="btn-cancel-note" style="background:#64748b; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-size:12px; cursor:pointer;">
                          Cancelar
                        </button>
                      </div>
                    </div>
                    
                    <!-- Lista de notas existentes -->
                    <div class="notes-list" data-line-index="${i}" style="display:flex; flex-direction:column; gap:8px;">
                      ${notas.length > 0 ? notas.map((nota, nIdx) => {
                        const textoNota = nota.texto || nota;
                        let fechaNota = '';
                        if (nota.fecha) {
                          const fecha = new Date(nota.fecha);
                          fechaNota = fecha.toLocaleString('es-ES', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                          });
                        }
                        const autor = nota.autor || '';
                        return `
                        <div class="note-item" data-note-index="${nIdx}" style="background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:8px; position:relative;">
                          <div style="display:flex; justify-content:space-between; align-items:start; gap:8px;">
                            <div style="flex:1;">
                              <div class="note-text" style="color:#0f172a; font-size:13px;">${textoNota}</div>
                              ${fechaNota ? `<div style="color:#94a3b8; font-size:11px; margin-top:4px;">${fechaNota}${autor ? ' - ' + autor : ''}</div>` : ''}
                            </div>
                            <div style="display:flex; gap:4px;">
                              <button class="btn-edit-note" data-client-id="${docId}" data-line-index="${i}" data-note-index="${nIdx}" style="background:#3b82f6; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:2px;" title="Editar nota">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                              </button>
                              <button class="btn-delete-note" data-client-id="${docId}" data-line-index="${i}" data-note-index="${nIdx}" style="background:#ef4444; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:2px;" title="Eliminar nota">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <polyline points="3 6 5 6 21 6"></polyline>
                                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>`;
                      }).join('') : '<div style="color:#94a3b8; font-size:12px; padding:8px 0;">No hay notas agregadas</div>'}
                    </div>
                  </div>
                </div>`;
            }
            
            detailsHTML += `
                  </div>
                </div>
              </td>
            </tr>`;
            
            mainRow += detailsHTML;
          }
          
          return mainRow;
        }).join('');
        
        // Agregar event listeners para expandir/colapsar
        document.querySelectorAll('.expandable-row').forEach(row => {
          row.addEventListener('click', function(e) {
            // No expandir si se hace clic en el select o botón
            if (e.target.closest('select') || e.target.closest('button')) return;
            
            const rowIndex = this.getAttribute('data-row-index');
            const detailsRow = document.querySelector(`.details-row[data-row-index="${rowIndex}"]`);
            const arrow = this.querySelector('span');
            
            if (detailsRow) {
              const isVisible = detailsRow.style.display !== 'none';
              detailsRow.style.display = isVisible ? 'none' : 'table-row';
              if (arrow) arrow.textContent = isVisible ? '▼' : '▲';
            }
          });
        });
        
        // Event listeners para botones de agregar nota
        document.querySelectorAll('.btn-add-note').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const lineIndex = this.getAttribute('data-line-index');
            const detailsRow = this.closest('.details-row');
            const noteForm = detailsRow.querySelector(`.note-form[data-line-index="${lineIndex}"]`);
            if (noteForm) {
              noteForm.style.display = noteForm.style.display === 'none' ? 'block' : 'none';
              if (noteForm.style.display === 'block') {
                const textarea = noteForm.querySelector('.note-textarea');
                if (textarea) textarea.focus();
              }
            }
          });
        });
        
        // Event listeners para agregar nota
        document.querySelectorAll('.btn-save-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const noteForm = this.closest('.note-form');
            const textarea = noteForm.querySelector('.note-textarea');
            const noteText = textarea.value.trim();
            
            if (!noteText) {
              showNotification('Por favor escribe una nota', 'error');
              return;
            }
            
            const lineIndex = parseInt(noteForm.getAttribute('data-line-index'));
            const detailsRow = noteForm.closest('.details-row');
            const rowIndex = detailsRow.getAttribute('data-row-index');
            const clientData = allItems[parseInt(rowIndex)];
            const clientId = clientData._id || clientData.id;
            
            // Guardar en el backend
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/notes', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  clientId: clientId,
                  lineIndex: lineIndex,
                  noteText: noteText
                })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al guardar la nota');
              }
              
              // Actualizar el objeto lineas_notas en allItems
              if (!clientData.lineas_notas) {
                clientData.lineas_notas = {};
              }
              if (!clientData.lineas_notas[lineIndex]) {
                clientData.lineas_notas[lineIndex] = [];
              }
              clientData.lineas_notas[lineIndex].push(result.data);
              
              // Agregar la nota visualmente
              const notesList = detailsRow.querySelector(`.notes-list[data-line-index="${lineIndex}"]`);
              const fecha = new Date(result.data.fecha).toLocaleString('es-ES', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              const autor = result.data.autor || '';
              
              // Remover mensaje "No hay notas"
              const noNotesMsg = notesList.querySelector('div[style*="No hay notas"]');
              if (noNotesMsg) noNotesMsg.remove();
              
              // Agregar nueva nota
              const newNote = document.createElement('div');
              newNote.style.cssText = 'background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:8px; font-size:13px;';
              newNote.innerHTML = `
                <div style="color:#0f172a;">${result.data.texto}</div>
                <div style="color:#94a3b8; font-size:11px; margin-top:4px;">${fecha}${autor ? ' - ' + autor : ''}</div>
              `;
              notesList.appendChild(newNote);
              
              // Limpiar y ocultar formulario
              textarea.value = '';
              noteForm.style.display = 'none';
              
              // Mostrar notificación de éxito
              showNotification('Nota guardada correctamente', 'success');
            } catch (error) {
              console.error('Error al guardar nota:', error);
              showNotification('Error al guardar la nota: ' + error.message, 'error');
            }
          });
        });
        
        // Event listeners para cancelar nota
        document.querySelectorAll('.btn-cancel-note').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const noteForm = this.closest('.note-form');
            const textarea = noteForm.querySelector('.note-textarea');
            textarea.value = '';
            noteForm.style.display = 'none';
          });
        });
        
        // Event listeners para editar nota
        document.querySelectorAll('.btn-edit-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const clientId = this.getAttribute('data-client-id');
            const lineIndex = parseInt(this.getAttribute('data-line-index'));
            const noteIndex = parseInt(this.getAttribute('data-note-index'));
            
            const noteItem = this.closest('.note-item');
            const noteTextDiv = noteItem.querySelector('.note-text');
            const currentText = noteTextDiv.textContent;
            
            // Crear textarea para editar
            const editArea = document.createElement('textarea');
            editArea.value = currentText;
            editArea.style.cssText = 'width:100%; min-height:60px; padding:6px; border:1px solid #e5e7eb; border-radius:4px; font-size:13px; font-family:inherit; resize:vertical;';
            
            // Crear botones de guardar/cancelar
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex; gap:6px; margin-top:6px;';
            btnContainer.innerHTML = `
              <button class="btn-save-edit" style="background:#10b981; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer; font-weight:600;">Guardar</button>
              <button class="btn-cancel-edit" style="background:#64748b; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer;">Cancelar</button>
            `;
            
            // Reemplazar contenido con textarea
            const originalContent = noteTextDiv.parentElement.innerHTML;
            noteTextDiv.parentElement.innerHTML = '';
            noteTextDiv.parentElement.appendChild(editArea);
            noteTextDiv.parentElement.appendChild(btnContainer);
            editArea.focus();
            
            // Cancelar edición
            btnContainer.querySelector('.btn-cancel-edit').addEventListener('click', function() {
              noteTextDiv.parentElement.innerHTML = originalContent;
              // Re-agregar event listeners
              renderTable(applyFilters(allItems));
            });
            
            // Guardar edición
            btnContainer.querySelector('.btn-save-edit').addEventListener('click', async function() {
              const newText = editArea.value.trim();
              if (!newText) {
                showNotification('La nota no puede estar vacía', 'error');
                return;
              }
              
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch('/api/lineas-team/notes/edit', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    clientId: clientId,
                    lineIndex: lineIndex,
                    noteIndex: noteIndex,
                    noteText: newText
                  })
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                  throw new Error(result.message || 'Error al editar la nota');
                }
                
                // Actualizar en allItems
                const detailsRow = noteItem.closest('.details-row');
                const rowIndex = detailsRow.getAttribute('data-row-index');
                const clientData = allItems[parseInt(rowIndex)];
                if (clientData.lineas_notas && clientData.lineas_notas[lineIndex]) {
                  clientData.lineas_notas[lineIndex][noteIndex].texto = newText;
                  clientData.lineas_notas[lineIndex][noteIndex].editado = new Date().toISOString();
                }
                
                showNotification('Nota actualizada correctamente', 'success');
                
                // Re-renderizar la tabla
                renderTable(applyFilters(allItems));
              } catch (error) {
                console.error('Error al editar nota:', error);
                showNotification('Error al editar la nota: ' + error.message, 'error');
              }
            });
          });
        });
        
        // Event listeners para eliminar nota
        document.querySelectorAll('.btn-delete-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            
            const confirmed = await showConfirm(
              'Eliminar Nota',
              '¿Estás seguro de que deseas eliminar esta nota? Esta acción no se puede deshacer.'
            );
            
            if (!confirmed) return;
            
            const clientId = this.getAttribute('data-client-id');
            const lineIndex = parseInt(this.getAttribute('data-line-index'));
            const noteIndex = parseInt(this.getAttribute('data-note-index'));
            
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/notes/delete', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  clientId: clientId,
                  lineIndex: lineIndex,
                  noteIndex: noteIndex
                })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al eliminar la nota');
              }
              
              // Actualizar en allItems
              const noteItem = this.closest('.note-item');
              const detailsRow = noteItem.closest('.details-row');
              const rowIndex = detailsRow.getAttribute('data-row-index');
              const clientData = allItems[parseInt(rowIndex)];
              
              if (clientData.lineas_notas && clientData.lineas_notas[lineIndex]) {
                clientData.lineas_notas[lineIndex].splice(noteIndex, 1);
              }
              
              showNotification('Nota eliminada correctamente', 'success');
              
              // Re-renderizar la tabla
              renderTable(applyFilters(allItems));
            } catch (error) {
              console.error('Error al eliminar nota:', error);
              showNotification('Error al eliminar la nota: ' + error.message, 'error');
            }
          });
        });
        
        // Event listeners para editar cliente
        document.querySelectorAll('.btn-edit-client').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const clientId = this.getAttribute('data-id');
            
            // Encontrar el cliente en allItems
            const clientData = allItems.find(item => (item._id || item.id) === clientId);
            if (!clientData) {
              showNotification('Cliente no encontrado', 'error');
              return;
            }
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
              background: white;
              border-radius: 12px;
              padding: 24px;
              max-width: 600px;
              width: 90%;
              max-height: 80vh;
              overflow-y: auto;
            `;
            
            modalContent.innerHTML = `
              <h3 style="margin:0 0 20px; color:#0f172a; font-size:18px;">Editar Cliente</h3>
              <form id="edit-client-form">
                <div style="display:grid; gap:16px;">
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Nombre Cliente</label>
                    <input type="text" name="nombre_cliente" value="${clientData.nombre_cliente||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Teléfono Principal</label>
                    <input type="text" name="telefono_principal" value="${clientData.telefono_principal||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Número de Cuenta</label>
                    <input type="text" name="numero_cuenta" value="${clientData.numero_cuenta||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Cantidad de Líneas</label>
                    <input type="number" name="cantidad_lineas" value="${clientData.cantidad_lineas||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Status</label>
                    <select name="status" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                      ${STATUS_OPTIONS.map(o => `<option value="${o.val}" ${o.val === (clientData.status||'').toLowerCase() ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Día de Venta</label>
                    <input type="text" name="dia_venta" value="${clientData.dia_venta||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Día de Instalación</label>
                    <input type="text" name="dia_instalacion" value="${clientData.dia_instalacion||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:20px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel-modal" style="background:#64748b; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-size:13px; cursor:pointer;">
                    Cancelar
                  </button>
                  <button type="submit" style="background:#10b981; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-size:13px; cursor:pointer; font-weight:600;">
                    Guardar Cambios
                  </button>
                </div>
              </form>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                modal.remove();
              }
            });
            
            // Botón cancelar
            modalContent.querySelector('.btn-cancel-modal').addEventListener('click', function() {
              modal.remove();
            });
            
            // Guardar cambios
            modalContent.querySelector('#edit-client-form').addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const formData = new FormData(e.target);
              const updateData = {
                id: clientId,
                nombre_cliente: formData.get('nombre_cliente'),
                telefono_principal: formData.get('telefono_principal'),
                numero_cuenta: formData.get('numero_cuenta'),
                cantidad_lineas: parseInt(formData.get('cantidad_lineas')) || 0,
                status: formData.get('status'),
                dia_venta: formData.get('dia_venta'),
                dia_instalacion: formData.get('dia_instalacion')
              };
              
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch('/api/lineas-team/update', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                  throw new Error(result.message || 'Error al actualizar el cliente');
                }
                
                showNotification('Cliente actualizado correctamente', 'success');
                modal.remove();
                
                // Recargar datos
                await load();
              } catch (error) {
                console.error('Error al actualizar cliente:', error);
                showNotification('Error al actualizar el cliente: ' + error.message, 'error');
              }
            });
          });
        });
        
        // Event listeners para eliminar cliente
        document.querySelectorAll('.btn-delete-client').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            
            const clientId = this.getAttribute('data-id');
            const clientData = allItems.find(item => (item._id || item.id) === clientId);
            const clientName = clientData?.nombre_cliente || 'este cliente';
            
            const confirmed = await showConfirm(
              'Eliminar Cliente',
              `¿Estás seguro de que deseas eliminar a <strong>${clientName}</strong>?<br><br>Esta acción no se puede deshacer y se perderán todos los datos asociados.`
            );
            
            if (!confirmed) return;
            
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/delete', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: clientId })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al eliminar el cliente');
              }
              
              showNotification('Cliente eliminado correctamente', 'success');
              
              // Recargar datos
              await load();
            } catch (error) {
              console.error('Error al eliminar cliente:', error);
              showNotification('Error al eliminar el cliente: ' + error.message, 'error');
            }
          });
        });
        
        // Ajustar espejo si existe util
        if (window.rebuildStickyHead) try{ window.rebuildStickyHead(); }catch{}
      }

      let allItems = [];
      async function load(){
        allItems = await fetchData();
        renderTable(applyFilters(allItems));
      }

      const btnBuscar = document.getElementById('btnBuscar');
      if (btnBuscar) btnBuscar.addEventListener('click', ()=>{ renderTable(applyFilters(allItems)); });
      const btnReset = document.getElementById('btnReset');
      if (btnReset) btnReset.addEventListener('click', ()=>{
        if ($('#q')) $('#q').value = '';
        if ($('#qs')) $('#qs').value = '';
        renderTable(allItems);
      });

      // No hay campos de formulario adicionales

      // Live filtering from quick controls
      const q = $('#q');
      const qs = $('#qs');
      const agentFilter = $('#agentFilter');
      if (q) q.addEventListener('input', ()=> renderTable(applyFilters(allItems)) );
      if (qs) qs.addEventListener('change', ()=> renderTable(applyFilters(allItems)) );
      if (agentFilter) agentFilter.addEventListener('change', ()=> renderTable(applyFilters(allItems)) );

      // Detect supervisor por usuario y marcar por defecto
      let defaultSupervisor = '';
      let agentsList = [];
      try {
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const name = String(user.supervisor||user.username||'').toUpperCase();
        const role = String(user.role||'').toLowerCase();
        
        if (name.includes('JONATHAN')) {
          defaultSupervisor = 'JONATHAN F';
          agentsList = ['VICTOR HURTADO','EDWARD RAMIREZ','CRISTIAN RIVERA','OSCAR RIVERA','JOCELYN REYES','NANCY LOPEZ'];
        } else if (name.includes('GUTIERREZ') || name.includes('LUIS')) {
          defaultSupervisor = 'LUIS G';
          agentsList = ['DANIEL DEL CID','FERNANDO BELTRAN','KARLA RODRIGUEZ','JOCELYN REYES','JONATHAN GARCIA','NANCY LOPEZ'];
        }
        
        // Poblar filtro de agentes si es supervisor
        if (role.includes('supervisor') && agentFilter && agentsList.length > 0) {
          agentFilter.innerHTML = '<option value="">AGENTE: Todos</option>' + 
            agentsList.map(a => `<option value="${a}">${a}</option>`).join('');
        }
      } catch {}
      // Prefiltro aplicado en applyFilters sin mostrar controles

      // Toggle filters panel
      // No hay panel de filtros
      buildHeaders();

      // Guardar cambios de STATUS (delegado)
      const tbody = document.getElementById('costumer-tbody');
      if (tbody) {
        tbody.addEventListener('change', async (e)=>{
          const sel = e.target.closest('select.status-select');
          if (!sel) return;
          if (!canEditStatus()) { alert('No tienes permisos para cambiar el STATUS.'); return; }
          const id = sel.getAttribute('data-id');
          const status = sel.value;
          const prev = sel.getAttribute('data-prev') || '';
          console.log('[STATUS UPDATE] Enviando:', { id, status, prev });
          if (!id) { alert('Error: ID del registro no encontrado'); return; }
          sel.disabled = true;
          try{
            const res = await fetch(STATUS_ENDPOINT, {
              method: STATUS_METHOD,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, status, statusUpper: String(status||'').toUpperCase() })
            });
            if (!res.ok) {
              const errData = await res.json().catch(()=>({}));
              console.error('[STATUS] Response error:', errData);
              throw new Error(errData.message || 'HTTP '+res.status);
            }
            sel.setAttribute('data-prev', status);
            // Refetch para asegurar persistencia real al recargar
            await load();
          }catch(err){
            console.error('[STATUS] error', err);
            alert('No se pudo actualizar el STATUS');
            if (prev) sel.value = prev;
          }finally{
            sel.disabled = false;
          }
        });
      }

      load();
    });
  </script>
</body>
</html>
