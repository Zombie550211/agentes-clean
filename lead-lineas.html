<!DOCTYPE html>
<html lang="es">
<head>
  <script>
    // Verificar autenticación y permisos
    (function() {
      try {
        // Verificar si el usuario está autenticado
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        // Verificar si el usuario es de Team Líneas
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const username = (userData.username || '').toLowerCase();
        const role = (userData.role || '').toLowerCase();
        
        // Si el usuario no es de Team Líneas, redirigir a la página de inicio
        if (role !== 'teamlineas' && !username.startsWith('lineas-')) {
          window.location.href = '/inicio.html';
        }
      } catch (e) {
        console.error('Error de autenticación:', e);
        window.location.href = '/login.html';
      }
    })();
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Agente - Team Líneas</title>
  
  <!-- Interceptor de API para manejo de permisos -->
  <script src="js/api-interceptor.js"></script>
  <script>
    // Versionado para romper caché
    window.__APP_VERSION__ = '20250915-1200';
    console.info('[lead-lineas.html] version', window.__APP_VERSION__);
  </script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Hojas de estilo -->
  <link rel="stylesheet" href="css/theme.css?v=20250915-1200" />
  <link rel="stylesheet" href="css/sidebar.css?v=20250915-1200" />
  <link rel="stylesheet" href="css/sidebar-inicio.css?v=20250915-1200" />
  <link rel="stylesheet" href="css/costumer-page.css?v=20250915-1200" />
  
  <!-- Scripts de terceros -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
  
  <!-- Scripts de la aplicación -->
  <script>
    // Verificación de autenticación
    window.authChecked = true;
    
    // Opción para silenciar logs
    (function() {
      try {
        const shouldSilence = typeof localStorage !== 'undefined' && localStorage.getItem('silenceLogs') === '1';
        if (shouldSilence && typeof console !== 'undefined') {
          const noop = function(){};
          console.log = noop;
          console.info = noop;
        }
      } catch (e) {
        // Ignorar si localStorage no está disponible
      }
    })();
  </script>
  
  <!-- Scripts locales -->
  <script src="agentes/js/auth-check.js?v=20250915-1200"></script>
  <script src="/js/logout-handler.js?v=20250915-1200"></script>
  <script src="/js/user-info.js?v=20250915-1200"></script>
  <script src="/js/sidebar-loader.js?v=20250915-1200"></script>
  <script src="/utils/teams.js?v=20250915-1200"></script>
  
  <!-- Estilos específicos para Team Líneas -->
  <style>
    /* Asegurar que el contenido principal no se solape con el sidebar */
    body { 
      padding-left: 0 !important;
      overflow-x: hidden !important;
    }
    
    .main-content {
      margin-left: 260px !important;
      width: calc(100% - 260px) !important;
      padding: 0 !important;
    }
    
    /* Ajustes para móviles */
    @media (max-width: 768px) {
      body { padding-left: 0 !important; }
      .main-content {
        margin-left: 0 !important;
        width: 100% !important;
      }
      .sidebar.sidebar-inicio {
        transform: translateX(-100%) !important;
      }
      .sidebar.sidebar-inicio.active {
        transform: translateX(0) !important;
      }
    }
    
    /* Estilos adicionales para el botón de menú móvil */
    .menu-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: #3498db;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .menu-toggle:hover {
      background: #2980b9;
    }

    /* Estilos profesionales para el formulario de Team Líneas */
    .form-section {
      flex: 1;
      max-width: 600px;
      margin: 20px 0 20px 0;
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08), 0 8px 16px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
    }
    
    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
    }
    
    .form-section h2 {
      color: #1e293b;
      margin-bottom: 2rem;
      text-align: left;
      font-size: 2rem;
      font-weight: 700;
      position: relative;
      padding-bottom: 1rem;
    }
    
    .form-section h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      border-radius: 2px;
    }
    
    .form-fields-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      max-height: 75vh;
      overflow-y: auto;
      padding: 1rem 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    .form-fields-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .form-fields-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .form-group {
      margin-bottom: 0;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.6rem;
      font-weight: 600;
      color: #374151;
      font-size: 0.95rem;
      letter-spacing: 0.025em;
    }
    
    .form-group label::after {
      content: ' *';
      color: #ef4444;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      background: #ffffff;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: #fefefe;
    }
    
    .form-control:hover {
      border-color: #cbd5e1;
    }
    
    .form-control::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }
    
    /* Estilos específicos para diferentes tipos de input */
    input[type="date"].form-control,
    input[type="tel"].form-control,
    input[type="password"].form-control {
      font-family: inherit;
    }
    
    select.form-control {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.75rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: block;
      width: auto;
      min-width: 200px;
      margin: 2.5rem auto 0 auto;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      letter-spacing: 0.025em;
    }
    
    .btn-submit:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-submit:active {
      transform: translateY(0);
    }
    
    .btn-submit:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Estilos para el contenedor de teléfonos dinámicos */
    .telefonos-container {
      grid-column: 1 / -1;
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .telefonos-container h4 {
      color: #374151;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .telefono-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
      margin-bottom: 1.5rem;
      padding: 1.2rem;
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .telefono-item:last-child {
      margin-bottom: 0;
    }
    
    /* Estilos para radio buttons */
    .radio-group {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      color: #374151;
      transition: color 0.2s ease;
    }
    
    .radio-label:hover {
      color: #3b82f6;
    }
    
    .radio-label input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      cursor: pointer;
    }
    
    /* Estilos para campos que ocupan todo el ancho */
    .form-group[style*="grid-column"] {
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    /* Mejoras para el textarea de comentarios */
    .form-group[style*="grid-column"] textarea {
      background: #ffffff;
      border: 2px solid #e2e8f0;
    }
    
    .form-group[style*="grid-column"] label {
      color: #374151;
      font-weight: 600;
      margin-bottom: 0.8rem;
    }
    
    /* Estilos para la sección de gráfica */
    .chart-section {
      flex: 1;
      max-width: 1000px;
      height: fit-content;
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      padding: 1.8rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08), 0 8px 16px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .chart-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
    }
    
    .chart-section h3 {
      color: #1e293b;
      margin-bottom: 1rem;
      text-align: left;
      font-size: 1.4rem;
      font-weight: 700;
      position: relative;
      padding-bottom: 0.5rem;
    }
    
    .chart-section h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      border-radius: 2px;
    }
    
    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }
    
    /* Responsive para la gráfica */
    @media (max-width: 1200px) {
      .lead-content-row {
        flex-direction: column !important;
      }
      
      .chart-section {
        max-width: none;
        margin-top: 20px;
      }
    }
  </style>
</head>
<body class="team-lineas">
<div class="layout">
  <!-- SIDEBAR (contenido estático como respaldo) -->
  <nav class="sidebar sidebar-inicio" data-active="lead">
    <!-- Usuario -->
    <div class="user-info">
      <div class="avatar"><i class="fas fa-user-circle"></i></div>
      <div class="user-details">
        <span id="user-name" class="user-name">Usuario</span>
        <span id="user-role" class="user-role">Team Líneas</span>
      </div>
    </div>

    <!-- Menú principal -->
    <ul class="menu">
      <li><a href="inicio.html" class="btn btn-sidebar"><i class="fas fa-home"></i>Inicio</a></li>
      <li><a href="lead-lineas.html" class="btn btn-sidebar"><i class="fas fa-user-plus"></i>Lead</a></li>
      <li><a href="Costumer.html" class="btn btn-sidebar"><i class="fas fa-users"></i>Customer</a></li>
      <li><a href="facturacion.html" class="btn btn-sidebar"><i class="fas fa-file-invoice"></i>Facturación</a></li>
      <li><a href="Estadisticas.html" class="btn btn-sidebar"><i class="fas fa-chart-bar"></i>Estadísticas</a></li>
      <li><a href="#" id="logoutBtn" data-logout-button class="btn btn-sidebar btn-logout"><i class="fas fa-sign-out-alt"></i>Cerrar sesión</a></li>
    </ul>

    <!-- Frase al pie -->
    <div class="sidebar-footer-quote">"Conectando tu éxito, un cliente a la vez"</div>
  </nav>
  
  <main class="main-content">
    <div class="lead-content-row" style="display: flex; gap: 25px; align-items: flex-start;">
      <!-- FORMULARIO TEAM LÍNEAS -->
      <section class="form-section" id="form-panel">
        <h2>Formulario Team Líneas</h2>
        <form id="crmLineasForm">
          <!-- Contenedor de campos con scroll -->
          <div class="form-fields-container">
            <!-- 1. NOMBRE CLIENTE (EN MAYÚSCULAS) -->
            <div class="form-group">
              <label for="nombre-cliente">NOMBRE CLIENTE</label>
              <input type="text" id="nombre-cliente" name="nombre_cliente" class="form-control" placeholder="Ingrese el nombre completo" style="text-transform: uppercase;" required>
            </div>
            
            <!-- 2. TELÉFONO PRINCIPAL (sin espacios, sin signos de puntuación) -->
            <div class="form-group">
              <label for="telefono-principal">TELÉFONO PRINCIPAL</label>
              <input type="tel" id="telefono-principal" name="telefono_principal" class="form-control" placeholder="1234567890" pattern="[0-9]{10}" maxlength="10" required>
            </div>
            
            <!-- 3. NÚMERO DE CUENTA (De la orden) -->
            <div class="form-group">
              <label for="numero-cuenta">NÚMERO DE CUENTA (De la orden)</label>
              <input type="text" id="numero-cuenta" name="numero_cuenta" class="form-control" placeholder="Ingrese el número de cuenta" required>
            </div>
            
            <!-- 4. AUTOPAGO -->
            <div class="form-group">
              <label for="autopay">AUTOPAGO</label>
              <select id="autopay" name="autopay" class="form-control" required>
                <option value="">Seleccione una opción</option>
                <option value="SI">SÍ</option>
                <option value="NO">NO</option>
              </select>
            </div>
            
            <!-- 5. PIN DE SEGURIDAD (De la orden) -->
            <div class="form-group">
              <label for="pin-seguridad">PIN DE SEGURIDAD (De la orden)</label>
              <input type="password" id="pin-seguridad" name="pin_seguridad" class="form-control" placeholder="••••" maxlength="4" required>
            </div>
            
            <!-- 6. DIRECCIÓN -->
            <div class="form-group">
              <label for="direccion">DIRECCIÓN</label>
              <input type="text" id="direccion" name="direccion" class="form-control" placeholder="Calle, número, colonia, ciudad" required>
            </div>
            
            
            <!-- 8. DÍA DE VENTA -->
            <div class="form-group">
              <label for="dia-venta">DÍA DE VENTA</label>
              <input type="date" id="dia-venta" name="dia_venta" class="form-control" required>
            </div>
            
            <!-- 9. DÍA DE INSTALACIÓN -->
            <div class="form-group">
              <label for="dia-instalacion">DÍA DE INSTALACIÓN</label>
              <input type="date" id="dia-instalacion" name="dia_instalacion" class="form-control" required>
            </div>
            
            <!-- 10. STATUS -->
            <div class="form-group">
              <label>STATUS</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="status" value="PENDING" checked required>
                  <span>PENDIENTE</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="status" value="REPRO">
                  <span>REPRO</span>
                </label>
              </div>
            </div>
            
            <!-- 11. CANTIDAD DE LÍNEAS -->
            <div class="form-group">
              <label for="cantidad-lineas">CANTIDAD DE LÍNEAS</label>
              <select id="cantidad-lineas" name="cantidad_lineas" class="form-control" required>
                <option value="">Seleccione cantidad</option>
                <option value="1">1 Línea</option>
                <option value="2">2 Líneas</option>
                <option value="3">3 Líneas</option>
                <option value="4">4 Líneas</option>
                <option value="5">5 Líneas</option>
              </select>
            </div>
            
            <!-- Contenedor para todos los teléfonos (se llenará dinámicamente) -->
            <div id="telefonos-container" class="telefonos-container">
              <h4>Teléfonos de las Líneas</h4>
              <div id="telefonos-lista">
                <!-- Los campos de teléfono se agregarán aquí dinámicamente -->
              </div>
            </div>
            
            <!-- 12. ID -->
            <div class="form-group">
              <label for="id-cliente">ID</label>
              <input type="text" id="id-cliente" name="id_cliente" class="form-control" placeholder="Ingrese ID del cliente" required>
            </div>
            
            
            
            <!-- 14. SUPERVISOR -->
            <div class="form-group">
              <label for="supervisor">SUPERVISOR</label>
              <select id="supervisor" name="supervisor" class="form-control" required>
                <option value="">Seleccione supervisor</option>
                <option value="JONATHAN">JONATHAN</option>
                <option value="LUIS">LUIS</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="dia-venta">Día de Venta</label>
              <input type="date" id="dia-venta" name="dia_venta" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="dia-instalacion">Día de Instalación</label>
              <input type="date" id="dia-instalacion" name="dia_instalacion" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="mercado">Mercado</label>
              <select id="mercado" name="mercado" class="form-control" required>
                <option value="">Seleccione mercado</option>
                <option value="ICON">ICON</option>
                <option value="BAMO">BAMO</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="supervisor">Supervisor</label>
              <select id="supervisor" name="supervisor" class="form-control" required>
                <option value="">Seleccione supervisor</option>
                <option value="JONATHAN">JONATHAN</option>
                <option value="LUIS">LUIS</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Status</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="status" value="PENDING" checked required>
                  <span>PENDIENTE</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="status" value="REPRO">
                  <span>REPRO</span>
                </label>
              </div>
            </div>
            
            
          </div>
          
          <button type="submit" class="btn-submit">Guardar Registro</button>
        </form>
      </section>
      
      <!-- GRÁFICA DE VENTAS -->
      <section class="chart-section">
        <h3>Ventas Diarias</h3>
        <div class="chart-container">
          <canvas id="ventasChart"></canvas>
        </div>
      </section>
    </div>
  </main>
</div>

  <!-- Script para manejar el sidebar -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Crear botón de menú para móviles
      const menuToggle = document.createElement('button');
      menuToggle.className = 'menu-toggle';
      menuToggle.id = 'menuToggle';
      menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
      menuToggle.style.display = 'none';
      document.body.insertBefore(menuToggle, document.querySelector('.layout'));
      
      const sidebar = document.querySelector('.sidebar.sidebar-inicio');
      
      // Función para manejar el tamaño de pantalla
      function checkScreenSize() {
        if (window.innerWidth <= 768) {
          menuToggle.style.display = 'block';
          sidebar.classList.remove('active');
        } else {
          menuToggle.style.display = 'none';
          sidebar.classList.add('active');
        }
      }
      
      // Verificar tamaño inicial y al redimensionar
      checkScreenSize();
      window.addEventListener('resize', checkScreenSize);
      
      // Alternar menú al hacer clic
      menuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('active');
      });
      
      // Cerrar menú al hacer clic en un enlace (móviles)
      document.querySelectorAll('.sidebar .btn-sidebar').forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('active');
          }
        });
      });
      
      // Manejar logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = 'login.html';
          }
        });
      }
      
      // Activar el botón correspondiente según la página actual
      function setActiveMenuItem() {
        const currentPage = window.location.pathname.split('/').pop();
        const menuItems = document.querySelectorAll('.sidebar .btn-sidebar');
        
        console.log('Página actual:', currentPage);
        console.log('Elementos del menú encontrados:', menuItems.length);
        
        // Remover clases active e is-active de todos los elementos
        menuItems.forEach(item => {
          item.classList.remove('active', 'is-active');
        });
        
        // Agregar clase is-active al elemento correspondiente
        menuItems.forEach(item => {
          const href = item.getAttribute('href');
          console.log('Verificando enlace:', href);
          if (currentPage === 'lead-lineas.html' && href === 'lead-lineas.html') {
            item.classList.add('is-active');
            console.log('Botón Lead activado');
          } else if (currentPage === href) {
            item.classList.add('is-active');
            console.log('Botón activado para:', href);
          }
        });
      }
      
      // Ejecutar al cargar la página
      setActiveMenuItem();
    });
  </script>
  
  <script>
  // Función para verificar permisos del usuario
  function checkUserPermissions() {
    try {
      // Obtener datos del usuario
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const username = (userData.username || '').toLowerCase();
      const role = (userData.role || '').toLowerCase();
      
      // Verificar si es usuario de Team Líneas
      const isTeamLineas = role === 'teamlineas' || username.startsWith('lineas-');
      
      // Si es Team Líneas, forzar el rol correspondiente
      if (isTeamLineas) {
        userData.role = 'teamlineas';
        localStorage.setItem('user', JSON.stringify(userData));
      }
      
      return {
        isTeamLineas: isTeamLineas,
        username: username,
        role: isTeamLineas ? 'teamlineas' : role
      };
    } catch (e) {
      console.error('Error al verificar permisos:', e);
      return { isTeamLineas: false, username: '', role: '' };
    }
  }

  // Función para mostrar mensaje de error
  function showError(message) {
    alert(message);
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Verificar permisos al cargar la página
    const { isTeamLineas, username } = checkUserPermissions();
    if (!isTeamLineas) {
      showError('No tienes permisos para acceder a esta página.');
      window.location.href = '/inicio.html';
      return;
    }
    // Inicializar la fecha actual en los campos de fecha
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dia-venta').value = today;
    
    // Referencias a los elementos del formulario
    const cantidadLineasSelect = document.getElementById('cantidad-lineas');
    const telefonosContainer = document.getElementById('telefonos-container');
    const telefonosLista = document.getElementById('telefonos-lista');
    
    // Función para actualizar los campos de teléfonos adicionales
    const actualizarCamposTelefonicos = () => {
      const cantidad = parseInt(cantidadLineasSelect.value) || 0;
      
      // Limpiar lista de teléfonos
      telefonosLista.innerHTML = '';
      
      if (cantidad > 0) {
        // Mostrar contenedor de teléfonos
        telefonosContainer.style.display = 'block';
        
        // Agregar campos para todos los teléfonos (desde 1 hasta la cantidad seleccionada)
        for (let i = 1; i <= cantidad; i++) {
          const telefonoDiv = document.createElement('div');
          telefonoDiv.className = 'telefono-item';
          telefonoDiv.innerHTML = `
            <div class="form-group">
              <label for="telefono-${i}">Teléfono ${i}</label>
              <input type="tel" id="telefono-${i}" name="telefono_${i}" class="form-control" placeholder="(000) 000-0000" required>
            </div>
            <div class="form-group">
              <label for="servicio-${i}">Tipo de Servicio</label>
              <select id="servicio-${i}" name="servicio_${i}" class="form-control" required>
                <option value="">Seleccione tipo</option>
                <option value="SIM WIRELESS">SIM WIRELESS</option>
                <option value="WIRELESS">WIRELESS</option>
              </select>
            </div>
          `;
          telefonosLista.appendChild(telefonoDiv);
        }
      } else {
        // Ocultar contenedor si solo es 1 línea o ninguna
        telefonosContainer.style.display = 'none';
      }
    };
    
    // Inicializar los campos según el valor por defecto
    actualizarCamposTelefonicos();
    
    // Escuchar cambios en el selector de cantidad de líneas
    cantidadLineasSelect.addEventListener('change', actualizarCamposTelefonicos);
    
    // La funcionalidad se movió a la función actualizarCamposTelefonicos()
    
    // Función para enviar el formulario
    async function submitForm() {
      // Validar formulario
      if (!form.checkValidity()) {
        showError('Por favor complete todos los campos requeridos.');
        return false;
      }
      
      // Mostrar indicador de carga
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        // Recolectar datos del formulario
        const formData = new FormData(form);
        const data = {};
        
        // Convertir FormData a objeto
        formData.forEach((value, key) => {
          data[key] = value;
        });
        
        // Recolectar todos los teléfonos
        const telefonos = [];
        const cantidadLineas = parseInt(cantidadLineasSelect.value) || 1;
        
        for (let i = 1; i <= cantidadLineas; i++) {
          const telefono = document.getElementById(`telefono-${i}`)?.value;
          const servicio = document.getElementById(`servicio-${i}`)?.value;
          
          if (telefono && servicio) {
            telefonos.push({
              numero: telefono,
              servicio: servicio,
              posicion: i
            });
          }
        }
        
        // Agregar todos los teléfonos al objeto de datos
        if (telefonos.length > 0) {
          data.telefonos = telefonos;
        }
        
        // Verificar permisos antes de enviar
        const { isTeamLineas, username } = checkUserPermissions();
        if (!isTeamLineas) {
          throw new Error('No tienes permisos para realizar esta acción.');
        }
        
        // Agregar información del usuario
        data.agente = username;
        data.equipo = 'TEAM LINEAS';
        
        // Obtener token de autenticación
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          throw new Error('No se encontró el token de autenticación. Por favor, inicia sesión nuevamente.');
        }
        
        // Configurar headers
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'X-User-Role': 'teamlineas' // Especificar el rol para el backend
        };
        
        console.log('Datos a enviar:', data);
        
        // Enviar datos al servidor
        const response = await fetch('/api/lineas', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.message || 'Error al enviar el formulario');
        }
        
        // Mostrar mensaje de éxito
        alert('¡Registro guardado exitosamente!');
        
        // Limpiar el formulario
        form.reset();
        actualizarCamposTelefonicos();
        
        return true;
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json',
        //     'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
        //   },
        //   body: JSON.stringify(data)
        // });
        // 
        // if (!response.ok) {
        //   throw new Error('Error al guardar el registro');
        // }
        
        // Simular éxito
        
      } catch (error) {
        console.error('Error al enviar el formulario:', error);
        showError('Error al enviar el formulario: ' + (error.message || 'Error desconocido'));
        return false;
      } finally {
        // Restaurar el botón
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      }
    }
    
    // Manejar el envío del formulario
    const form = document.getElementById('crmLineasForm');
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      await submitForm();
    });
  });
  
  // Función para crear la gráfica de ventas
  function crearGraficaVentas() {
    const ctx = document.getElementById('ventasChart').getContext('2d');
    
    // Datos de ejemplo para la gráfica
    const datos = {
      labels: ['Lun 11', 'Mar 12', 'Mié 13', 'Jue 14', 'Vie 15', 'Sáb 16', 'Dom 17'],
      datasets: [{
        label: 'Ventas',
        data: [23, 24, 17, 11, 16, 21, 7],
        backgroundColor: '#3b82f6',
        borderColor: '#2563eb',
        borderWidth: 2,
        borderRadius: 4,
        borderSkipped: false,
      }]
    };
    
    const config = {
      type: 'bar',
      data: datos,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: '#1e293b',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#3b82f6',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: false,
            callbacks: {
              label: function(context) {
                return `Ventas: ${context.parsed.y}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#e5e7eb',
              drawBorder: false
            },
            ticks: {
              color: '#6b7280',
              font: {
                size: 12,
                weight: '500'
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              color: '#6b7280',
              font: {
                size: 12,
                weight: '500'
              }
            }
          }
        },
        elements: {
          bar: {
            borderRadius: 4
          }
        }
      }
    };
    
    new Chart(ctx, config);
  }
  
  // Inicializar la gráfica cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco para asegurar que Chart.js esté cargado
    setTimeout(crearGraficaVentas, 100);
  });
</script>

</body>
</html>
