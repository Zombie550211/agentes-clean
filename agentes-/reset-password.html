<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer contraseña - CRM Agente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">
  <script>
    // Proteger: solo ADMIN usando sesión por cookie
    (async function() {
      try {
        const res = await fetch('/api/protected', { method: 'GET', credentials: 'include' });
        if (!res.ok) { location.href = 'login.html'; return; }
        const data = await res.json();
        const role = ((data && data.user && data.user.role) || '').toLowerCase();
        if (role !== 'admin') { location.href = 'inicio.html'; return; }
      } catch (e) { location.href = 'login.html'; }
    })();
  </script>
  <script src="agentes/js/auth-check.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="js/sidebar-loader.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(34,179,236,.08), transparent 60%),
        radial-gradient(600px 300px at 90% 20%, rgba(14,165,233,.07), transparent 60%),
        linear-gradient(135deg, #f8fbff 0%, #eef3f9 100%);
    }
    /* Layout con sidebar a la izquierda, contenido centrado */
    .container { margin-left: 260px; padding: 40px 48px; min-height: 100vh; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }

    /* Tarjeta (Neumorphism) */
    .card { width: 100%; max-width: 640px; background:#eef3f9; border:0; border-radius:20px; 
      box-shadow: 12px 12px 24px #d0d7e2, -12px -12px 24px #ffffff; padding:30px; position: relative; overflow: hidden; margin: 0 24px; }
    .card::before {
      content: '';
      position: absolute; inset: 0 0 auto 0; height: 5px;
      background: linear-gradient(90deg, rgba(34,179,236,.9), rgba(56,189,248,.9), rgba(34,179,236,.9));
      opacity: .35; /* más sutil para combinar con neumorphism */
    }
    .card h1 { font-size:22px; margin:8px 0 8px; display:flex; align-items:center; gap:10px; color:#0f172a; }
    .card h1 i { background:#ecfeff; color:#0891b2; border:1px solid #cffafe; width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; }
    .card .subhead { display:flex; align-items:center; gap:10px; justify-content: space-between; padding-bottom: 14px; border-bottom: 1px solid #e5e7eb; margin-bottom: 18px; }
    .badge { display:inline-block; font-size:12px; font-weight:700; color:#0f172a; background:#e0f2fe; border:1px solid #bae6fd; padding:4px 10px; border-radius:999px; }
    .card p.help { color:#6b7280; margin:0; font-size:14px; }

    /* Formularios */
    .form-group { margin: 12px 0 16px; }
    .form-group label { display:block; font-weight:700; margin-bottom:6px; color:#111827; font-size:14px; }
    .form-control { width:100%; border:1px solid rgba(15,23,42,.03); border-radius:12px; padding:10px 12px !important; font-size:14px !important; background:#eef3f9; transition: box-shadow .2s ease, background .2s ease, border-color .2s ease; min-height: 40px !important;
      box-shadow: inset 6px 6px 12px #d0d7e2, inset -6px -6px 12px #ffffff; }
    .form-control::placeholder { color:#94a3b8; }
    .form-control:focus { border-color: rgba(34,179,236,.45); outline:none; background:#eef3f9;
      box-shadow: inset 8px 8px 16px #c8d0db, inset -8px -8px 16px #ffffff, 0 0 0 3px rgba(34,179,236,.12); }

    /* Grilla ordenada para contraseñas */
    .form-grid { display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:12px; }

    /* Input con icono */
    .input-icon { position: relative; }
    .input-icon i.leading {
      position:absolute; left:12px; top:0; bottom:0; transform:none;
      color:#64748b; display:flex; align-items:center; justify-content:center;
      width:28px; font-size:16px; line-height:1; pointer-events:none;
    }
    .input-icon input.form-control { padding-left: 44px !important; }

    /* Acciones */
    .actions { display:flex; justify-content:center; margin-top: 8px; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:none; border-radius:14px; padding:10px 16px !important; cursor:pointer; font-weight:700; font-size:14px !important; transition: box-shadow .2s ease, transform .1s ease, background .2s ease; }
    .btn-primary { background:#22b3ec; color:#0f172a; box-shadow: 6px 6px 12px #c7d0dd, -6px -6px 12px #ffffff; }
    .btn-primary:hover { background:#1aa7df; box-shadow: inset 6px 6px 12px #c7d0dd, inset -6px -6px 12px #ffffff; }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }

    /* Mensajes */
    .msg { display:none; margin-top:12px; padding:12px 14px; border-radius:10px; font-size:14px; }
    .msg.success { display:block; background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .msg.error { display:block; background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    /* Campo con icono ojo centrado respecto al input */
    .field { position: relative; }
    .field .eye {
      position:absolute; right:12px; top:50%; transform: translateY(-50%);
      display:flex; align-items:center; justify-content:center;
      color:#6b7280; cursor:pointer; width:26px; height:26px;
    }
    .field .eye i { line-height:1; display:block; font-size:16px; }
    .field > .form-control { padding-right: 38px; }

    /* Margen lateral sutil para evitar pegarse al borde en pantallas amplias */
    .container { margin-left: 260px; padding: 40px 48px; }

    @media (max-width: 720px) {
      .container { margin-left: 0; padding: 16px 20px; }
      .card { border-radius: 14px; padding: 22px; margin: 0 24px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar sidebar-inicio" data-active=""></nav>
    <main class="container">
      <div class="card">
        <h1><i class="fas fa-key"></i> Restablecer contraseña</h1>
        <div class="subhead">
          <p class="help">Solo administradores. Ingresa el usuario (username) y la nueva contraseña.</p>
          <span class="badge">Solo Admin</span>
        </div>
        <form id="resetForm">
          <div class="form-group input-icon">
            <label for="username">Usuario (username)</label>
            <i class="fas fa-user leading" aria-hidden="true"></i>
            <input type="text" id="username" class="form-control" placeholder="Ej. jdoe" required />
          </div>
          <div class="form-grid">
            <div class="form-group toggle">
              <label for="newPassword">Nueva contraseña</label>
              <div class="field">
                <input type="password" id="newPassword" class="form-control" minlength="8" placeholder="Mínimo 8 caracteres" required />
                <span class="eye" data-eye="newPassword"><i class="fas fa-eye"></i></span>
              </div>
            </div>
            <div class="form-group toggle">
              <label for="confirmPassword">Confirmar contraseña</label>
              <div class="field">
                <input type="password" id="confirmPassword" class="form-control" minlength="8" required />
                <span class="eye" data-eye="confirmPassword"><i class="fas fa-eye"></i></span>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary"><i class="fas fa-rotate"></i> Restablecer</button>
          </div>
          <div id="message" class="msg"></div>
        </form>
      </div>
    </main>
  </div>
  <script>
    function setMsg(type, text) {
      const el = document.getElementById('message');
      el.className = `msg ${type}`;
      el.textContent = text;
      el.style.display = 'block';
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.eye');
      if (!btn) return;
      const id = btn.getAttribute('data-eye');
      const input = document.getElementById(id);
      if (!input) return;
      if (input.type === 'password') { input.type = 'text'; btn.firstElementChild.className = 'fas fa-eye-slash'; }
      else { input.type = 'password'; btn.firstElementChild.className = 'fas fa-eye'; }
    });

    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validaciones básicas
      if (!username) { setMsg('error', 'Ingresa el username.'); return; }
      if (newPassword.length < 8) { setMsg('error', 'La nueva contraseña debe tener al menos 8 caracteres.'); return; }
      if (newPassword !== confirmPassword) { setMsg('error', 'Las contraseñas no coinciden.'); return; }

      // Estado de carga en el botón
      const btn = e.target.querySelector('button[type="submit"]');
      const prevText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
      try {
        const resp = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ username, newPassword })
        });
        const data = await resp.json().catch(()=>({ success:false, message:'Respuesta inválida del servidor'}));
        if (!resp.ok || data.success === false) {
          const msg = data.message || `Error ${resp.status}: No se pudo restablecer la contraseña`;
          setMsg('error', msg);
          return;
        }
        // Éxito
        setMsg('success', data.message || 'Contraseña restablecida correctamente');
        // Limpiar campos
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch (err) {
        setMsg('error', 'Error de red o del servidor. Inténtalo nuevamente.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = prevText;
      }
    });
  </script>
</body>
</html>
