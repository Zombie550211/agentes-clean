<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - EstadÃ­sticas</title>

  <!-- Estilos base y sidebar -->
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">

  <!-- LibrerÃ­as -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Scripts de app -->
  <!-- Cargar primero las dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <!-- Eliminado kit de Font Awesome (403). Se usa el CSS 5.15.4 ya cargado arriba. -->
  
  <!-- Luego cargar los scripts de la aplicaciÃ³n -->
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="/utils/teams.js"></script>
  <script src="js/sidebar-loader.js"></script>
  
  <!-- Script de inicializaciÃ³n de grÃ¡ficos -->
  <script>
    // Verificar que Chart.js estÃ© disponible
    if (typeof Chart === 'undefined') {
      console.error('Error: No se pudo cargar Chart.js');
    } else {
      console.log('Chart.js cargado correctamente');
      // Registrar el plugin de etiquetas si estÃ¡ disponible
      if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
        console.log('Plugin de etiquetas registrado');
      }
    }
  </script>

  <style>
    /* Layout general consistente con otras pÃ¡ginas */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #1e293b; }

    .layout { display: flex; min-height: 100vh; }

    .main-content {
      flex: 1;
      padding: 20px;
      margin-left: 260px; /* Ancho del sidebar-inicio */
      width: calc(100vw - 260px);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .page-title { font-size: 1.8rem; font-weight: 800; margin: 0; }
    .page-actions { display: flex; gap: 8px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 24px;
      max-width: 95%;
      margin: 0 auto;
      padding: 0 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 24px;
      box-sizing: border-box;
      width: 100%;
      margin: 0;
    }

    .chart-card { grid-column: span 12; }
    @media (min-width: 900px) {
      .chart-card.half { grid-column: span 6; }
    }

    .card h3 { margin: 0 0 12px 0; font-size: 1.05rem; color: #1e293b; }
    
    /* Estilos para la tabla de calificaciones */
    .ventas-diarias-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 10px;
      width: 100%;
    }
    
    .ventas-diarias-card {
      background: white;
      border-radius: 4px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 100%;
    }
    
    .ventas-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin: 0 auto;
    }
    
    .ventas-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      table-layout: fixed;
    }
    
    .ventas-table th,
    .ventas-table td {
      padding: 14px 20px;
      text-align: left;
      border: 1px solid #dee2e6;
      font-family: Arial, sans-serif;
      line-height: 1.5;
    }
    
    .ventas-table th {
      background: #1f3b63;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      text-align: center;
      padding: 16px 20px;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    
    .ventas-table td:first-child {
      width: 65%;
      padding-left: 16px;
    }
    
    .ventas-table td:last-child {
      width: 35%;
      text-align: center;
      font-weight: bold;
      padding-right: 16px;
    }
    .chart-wrapper { position: relative; height: 320px; }

    /* Responsive para mÃ³vil: sidebar superior */
    @media (max-width: 768px) {
      .main-content { margin-left: 0; width: 100%; padding: 15px; margin-top: 70px; }
    }
    /* Tabla de conversiÃ³n por equipo */
    .conversion-grid { 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 8px; 
      font-family: Arial, sans-serif;
    }
    .conversion-card { 
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      padding: 12px; 
      border: 1px solid #dee2e6;
    }
    .conversion-title { 
      font-weight: 800; 
      margin: 0 0 8px 0; 
      color: #000; 
      font-size: 1rem;
      text-align: center;
      background: #fff9c2;
      padding: 6px 4px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .conversion-subtitle { 
      display: none; 
    }
    .sales-table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.85rem;
      margin-bottom: 0;
    }
    .sales-table th, 
    .sales-table td { 
      padding: 4px 6px; 
      text-align: center; 
      border: 1px solid #dee2e6;
      font-family: Arial, sans-serif;
      height: 28px;
    }
    .sales-table th { 
      background: #1f3b63; 
      color: #fff; 
      font-weight: 700; 
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 4px;
    }
    .sales-table td:first-child, 
    .sales-table th:first-child { 
      text-align: left; 
      padding-left: 8px;
      width: 40%;
    }
    .sales-table .total-row { 
      background: #0b5ed7; 
      color: #fff;
      font-weight: 800; 
      font-size: 0.9rem;
    }
    .sales-table .score-col { 
      background: #ffeb7a; 
      font-weight: 800; 
      color: #000;
    }
    /* Layout mejorado para conversiÃ³n: tabla + panel LINEAS */
    .conv-two-col { display: flex; gap: 28px; align-items: flex-start; width: 100%; }
    .conv-left { flex: 1 1 0; min-width: 0; max-height: 520px; overflow-y: auto; overflow-x: hidden; padding-right: 4px; }
    .conv-right { flex: 0 0 320px; align-self: stretch; }
    .mini-card { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 8px; }
    .mini-card .mini-table { width: 100%; }
    .mini-card .mini-table th { padding: 12px; font-size: 0.9rem; }
    .mini-card .mini-table td { padding: 10px 12px; font-size: 1rem; text-align: center; }
    @media (max-width: 900px) { .conv-two-col { flex-direction: column; } .conv-left { min-width: 0; } .conv-right { order: -1; width: 100%; min-width: 0; } }
    .mini-table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.85rem;
      margin-top: 15px;
    }
    .mini-table th, 
    .mini-table td { 
      padding: 4px 6px; 
      text-align: center; 
      border: 1px solid #dee2e6;
      font-family: Arial, sans-serif;
      height: 28px;
    }
    .mini-table th { 
      background: #1f3b63; 
      color: #fff; 
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 4px;
    }
    .mini-table .total { 
      background: #0b5ed7; 
      color: #fff; 
      font-weight: 800;
      font-size: 0.9rem;
    }
    @media (max-width: 900px) { 
      .conversion-grid { 
        grid-template-columns: 1fr; 
      }
      .ventas-diarias-grid { 
        grid-template-columns: 1fr; 
      }
    }
    
    /* Estilos para la secciÃ³n de Ventas Diarias */
    .ventas-diarias-grid {
      display: grid;
      gap: 16px;
      margin-top: 10px;
    }
    
    .ventas-diarias-card {
      background: white;
      border-radius: 4px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .ventas-title {
      font-weight: 800;
      margin: 0 0 10px 0;
      color: #000;
      font-size: 1rem;
      text-align: center;
      background: #fff9c2;
      padding: 6px 4px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ventas-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-bottom: 15px;
    }
    
    .ventas-table th,
    .ventas-table td {
      padding: 6px 8px;
      text-align: center;
      border: 1px solid #dee2e6;
      font-family: Arial, sans-serif;
    }
    
    .ventas-table th {
      background: #1f3b63;
      color: #fff;
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 4px;
    }
    
    .ventas-table td:first-child {
      text-align: left;
      padding-left: 10px;
    }
    
    .ventas-table .total-row {
      background: #0b5ed7;
      color: #fff;
      font-weight: 800;
      font-size: 0.9rem;
    }
    
    .ventas-table .score-col {
      background: #ffeb7a;
      font-weight: 800;
      color: #000;
    }
    
    /* Estilos para grÃ¡ficos */
    .chart-card {
      grid-column: 1 / -1;
      margin-bottom: 20px;
    }
    
    .chart-wrapper {
      position: relative;
      height: 400px;
      width: 100%;
      min-height: 300px;
    }
    
    .chart-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      text-align: center;
      color: #666;
    }
    
    .chart-loading .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR (cargado dinÃ¡micamente) -->
    <nav class="sidebar sidebar-inicio" data-active="estadisticas"></nav>

    <main class="main-content">
      <header class="page-header">
        <h1 class="page-title"><i class="fas fa-chart-line" style="color:#22b3ec; margin-right:8px;"></i> Estadísticas</h1>
        <div class="page-actions">
          <button id="btn-refresh" class="btn-refresh" style="background:#22b3ec;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer;">Actualizar</button>
        </div>
      </header>

      <section class="stats-grid">
        <div class="card chart-card">
          <h3>Ventas por equipo</h3>
          <div class="chart-wrapper">
            <canvas id="chart-ventas-dia"></canvas>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; grid-column: 1 / -1; width: 100%; margin: 0; padding: 0;">
          <div class="card">
            <h3></h3>
            <div id="conversion-table" class="conversion-grid"></div>
          </div>

          <div class="card">
            <div class="ventas-diarias-grid">
              <div id="ventas-dia-card" class="ventas-diarias-card"><!-- Renderizado por JS --></div>
            </div>
          </div>
        </div>
      </div>
      </section>
    </main>
  </div>

  <script>
    // Datos de ejemplo para visualizaciÃ³n inicial (puedes reemplazar por datos reales)
    function rand(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }

    async function renderConversionTable(root) {
      try {
        console.log('Iniciando renderConversionTable con root:', root);
        if (!root) {
          console.error('Error: No se proporcionÃ³ un elemento raÃ­z vÃ¡lido');
          return;
        }
        
        // Verificar autenticaciÃ³n
        if (!checkAuth()) return;
        
        // Mostrar indicador de carga
        root.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p class="mt-2">Cargando datos de equipos...</p></div>';
        
        // Forzar SIEMPRE el mes actual
        let fechaInicio = '';
        let fechaFin = '';
        {
          const now = new Date();
          const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
          const yyyyS = start.getUTCFullYear();
          const mmS = String(start.getUTCMonth() + 1).padStart(2, '0');
          const ddS = String(start.getUTCDate()).padStart(2, '0');
          const yyyyE = now.getUTCFullYear();
          const mmE = String(now.getUTCMonth() + 1).padStart(2, '0');
          const ddE = String(now.getUTCDate()).padStart(2, '0');
          fechaInicio = `${yyyyS}-${mmS}-${ddS}`;
          fechaFin = `${yyyyE}-${mmE}-${ddE}`;
        }
        
        // Construir URL con parÃ¡metros
        let url = '/api/equipos/estadisticas';
        const params = new URLSearchParams();
        
        if (fechaInicio) params.append('fechaInicio', fechaInicio);
        if (fechaFin) params.append('fechaFin', fechaFin);
        
        // Si no se especifica rango, usar el DÍA ACTUAL por defecto
        if (!fechaInicio && !fechaFin) params.append('scope','day');
        if (params.toString()) url += `?${params.toString()}`;
        
        console.log('Solicitando datos a:', url);
        
        // Realizar petición a la API usando la función fetchWithAuth
        console.log('Realizando petición a la API...');
        const response = await fetchWithAuth(url);
        console.log('Respuesta recibida:', response);
        
        if (!response) {
          console.error('No se recibiÃ³ respuesta de la API (posible error de autenticaciÃ³n)');
          return; // Error de autenticaciÃ³n ya manejado
        }
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error en la respuesta:', {
            status: response.status,
            statusText: response.statusText,
            error: errorText
          });
          throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
        }
        
        let data = await response.json();
        let usedAllFallback = false;
        console.log('Datos recibidos de la API (MES):', {
          success: data.success,
          message: data.message,
          total: data.total,
          data: data.data ? `Array de ${data.data.length} elementos` : 'No hay datos'
        });
        
        // Eliminado fallback all=1 para mostrar solo datos del MES ACTUAL
        
        if (!data.success) {
          console.error('Formato de respuesta invÃ¡lido:', data);
          throw new Error('Formato de respuesta invÃ¡lido');
        }

        
        // Si no hay datos, mostrar mensaje de "sin datos" con tabla vacÃ­a
        let teamData = [];
        if (!data.data || data.data.length === 0) {
          console.log('No hay datos disponibles para el día actual');
          teamData = [];
        } else {
          // Mapear datos de la API al formato esperado (mantener Puntaje como nÃºmero)
          teamData = data.data.map(equipo => ({
            name: equipo.TEAM || 'Sin equipo',
            ICON: parseFloat(equipo.ICON || 0),
            BAMO: parseFloat(equipo.BAMO || 0),
            Total: parseFloat(equipo.Total || 0),
            Puntaje: parseFloat(equipo.Puntaje || 0)
          }));
        }
        // Separar TEAM LINEAS a tabla aparte y mantener principal sin LINEA(S)
        const lineasData = Array.isArray(data.lineas) ? data.lineas.map(r => ({
          name: r.name || r.TEAM || 'SIN NOMBRE',
          ICON: parseFloat(r.ICON || 0)
        })) : [];
        const lineasTotalICON = typeof data.lineasTotalICON === 'number' ? data.lineasTotalICON : lineasData.reduce((acc, r) => acc + (r.ICON || 0), 0);
        const excludeNames = new Set(['TEAM LINEA','TEAM LINEAS']);
        let fallbackTeamData = teamData.filter(t => !excludeNames.has((t.name || '').toUpperCase()));
        // Fallback: si principal queda vacío y hay datos en LINEAS, mostrarlos en principal
        if (fallbackTeamData.length === 0 && lineasData.length > 0) {
          const totalIcon = lineasData.reduce((acc, r) => acc + (r.ICON || 0), 0);
          fallbackTeamData = [{ name: 'TEAM LINEAS', ICON: totalIcon, BAMO: 0, Total: totalIcon, Puntaje: 0 }];
        }
        
        // Calcular totales
        const totals = teamData.reduce((acc, r) => ({
          ICON: acc.ICON + (r.ICON || 0),
          BAMO: acc.BAMO + (r.BAMO || 0),
          Total: acc.Total + (r.Total || 0),
          Puntaje: acc.Puntaje + parseFloat(r.Puntaje || 0)
        }), { ICON: 0, BAMO: 0, Total: 0, Puntaje: 0 });

        // Encabezado: mostrar MES (mm/yyyy) cuando es rango mensual; si no, día actual (dd/mm/yyyy)
        const hoy = new Date();
        const diaTexto = `${String(hoy.getDate()).padStart(2,'0')}/${String(hoy.getMonth()+1).padStart(2,'0')}/${hoy.getFullYear()}`;
        const mesTexto = `${String(hoy.getMonth()+1).padStart(2,'0')}/${hoy.getFullYear()}`;
        const esMes = (fechaInicio && fechaFin && fechaInicio !== fechaFin);
        const encabezadoTitulo = esMes
          ? `VENTAS POR MERCADO Y PUNTAJE DEL MES (${mesTexto})`
          : `VENTAS POR MERCADO Y PUNTAJE DEL DÍA (${diaTexto})`;

        // Generar HTML de la tabla de equipos
        let html = `
          <div class="conversion-card">
            <div class="conversion-title">${encabezadoTitulo}</div>
            <div class="conv-two-col">
              <div class="conv-left">
                <table class="sales-table">
                  <thead>
                    <tr>
                      <th>EQUIPO</th>
                      <th>ICON</th>
                      <th>BAMO</th>
                      <th>TOTAL</th>
                      <th>PUNTAJE</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${fallbackTeamData.length === 0 ? `
                      <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                          No hay datos disponibles para la fecha seleccionada
                        </td>
                      </tr>
                    ` : fallbackTeamData.map(team => `
                      <tr>
                        <td>${team.name}</td>
                        <td>${team.ICON || 0}</td>
                        <td>${team.BAMO || 0}</td>
                        <td>${team.Total || 0}</td>
                        <td class="score-col">${parseFloat(team.Puntaje || 0).toFixed(2)}</td>
                      </tr>
                    `).join('')}
                    ${fallbackTeamData.length > 0 ? `
                      <tr class="total-row">
                        <td>TOTAL</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.ICON || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.BAMO || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.Total || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + parseFloat(t.Puntaje || 0), 0).toFixed(2)}</td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </div>
              <div class="conv-right">
                <div class="mini-card">
                  <table class="mini-table">
                    <thead>
                      <tr>
                        <th>TEAM LINEAS</th>
                        <th>ICON</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${lineasData.map(r => `
                        <tr>
                          <td>${r.name}</td>
                          <td>${r.ICON || 0}</td>
                        </tr>
                      `).join('')}
                      <tr class="total">
                        <td>TOTAL</td>
                        <td class="total-icon">${lineasTotalICON}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Asignar el HTML generado al elemento raíz
        root.innerHTML = html;

        // Ahora, renderizar el gráfico de dona con los datos de los equipos
        renderVentasPorEquipoChart(fallbackTeamData);
        
        // Filtro eliminado: no se requiere manejar eventos de filtrado
      } catch (e) {
        console.error('Error renderizando tabla de conversiÃ³n', e);
        console.log('Usando datos de prueba para la tabla de conversiÃ³n...');
        
        // Datos de prueba cuando falla la API
        const hoy = new Date();
        const fecha = hoy.toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric' });
        const fallbackTeamData = [
          { name: 'TEAM IRANIA', ICON: 8, BAMO: 7, Total: 15, Puntaje: '8.5' },
          { name: 'TEAM ROBERTO VELASQUEZ', ICON: 12, BAMO: 11, Total: 23, Puntaje: '9.2' },
          { name: 'TEAM BRYAN PLEITEZ', ICON: 9, BAMO: 9, Total: 18, Puntaje: '7.8' },
          { name: 'TEAM MARISOL BELTRAN', ICON: 6, BAMO: 6, Total: 12, Puntaje: '7.1' },
          { name: 'TEAM RANDAL MARTINEZ', ICON: 11, BAMO: 9, Total: 20, Puntaje: '8.9' },
          { name: 'TEAM LINEA', ICON: 4, BAMO: 4, Total: 8, Puntaje: '6.5' }
        ];

        // Generar HTML de la tabla con datos de prueba
        let html = `
          <div class="conversion-card">
            <div class="conversion-title">VENTAS POR MERCADO Y PUNTAJE DEL MES</div>
            <div class="conv-two-col">
              <div class="conv-left">
                <table class="sales-table">
                  <thead>
                    <tr>
                      <th>EQUIPO</th>
                      <th>ICON</th>
                      <th>BAMO</th>
                      <th>TOTAL</th>
                      <th>PUNTAJE</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${fallbackTeamData.length === 0 ? `
                      <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                          No hay datos disponibles para la fecha seleccionada
                        </td>
                      </tr>
                    ` : fallbackTeamData.map(team => `
                      <tr>
                        <td>${team.name}</td>
                        <td>${team.ICON || 0}</td>
                        <td>${team.BAMO || 0}</td>
                        <td>${team.Total || 0}</td>
                        <td class="score-col">${parseFloat(team.Puntaje || 0).toFixed(2)}</td>
                      </tr>
                    `).join('')}
                    ${fallbackTeamData.length > 0 ? `
                      <tr class="total-row">
                        <td>TOTAL</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.ICON || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.BAMO || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.Total || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + parseFloat(t.Puntaje || 0), 0).toFixed(2)}</td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </div>
              ${true ? `
              <div class="conv-right">
                <div class="mini-card">
                  <table class="mini-table">
                    <thead>
                      <tr>
                        <th>TEAM LINEAS</th>
                        <th>ICON</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${lineasData.map(r => `
                        <tr>
                          <td>${r.name}</td>
                          <td>${r.ICON || 0}</td>
                        </tr>
                      `).join('')}
                      <tr class="total">
                        <td>TOTAL</td>
                        <td class="total-icon">${lineasTotalICON}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              ` : ''}
            </div>DÃA (${fecha})</div>
            <div class="alert alert-warning mb-3" style="padding: 10px; margin-bottom: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404; font-size: 0.9rem;">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Mostrando datos de prueba (Error de conexiÃ³n con la base de datos)
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; grid-column: 1 / -1; width: 100%; margin: 0; padding: 0;">
              <div class="card">
                <h3></h3>
                <div id="conversion-table" class="conversion-grid">
                  <table class="sales-table">
                    <thead>
                      <tr>
                        <th>EQUIPO</th>
                        <th>ICON</th>
                        <th>BAMO</th>
                        <th>TOTAL</th>
                        <th>PUNTAJE</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${fallbackTeamData.map(team => `
                        <tr>
                          <td>${team.name}</td>
                          <td>${team.ICON || 0}</td>
                          <td>${team.BAMO || 0}</td>
                          <td>${team.Total || 0}</td>
                          <td class="score-col">${team.Puntaje || '0.0'}</td>
                        </tr>
                      `).join('')}
                      <tr class="total-row">
                        <td>TOTAL</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.ICON || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.BAMO || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + (t.Total || 0), 0)}</td>
                        <td>${fallbackTeamData.reduce((sum, t) => sum + parseFloat(t.Puntaje || 0), 0).toFixed(1)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card">
                <div class="ventas-diarias-grid">
                  <div id="ventas-dia-card" class="ventas-diarias-card"><!-- Tabla del día renderizada por JS --></div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Asignar el HTML generado al elemento raÃ­z
        root.innerHTML = html;
        
        // Agregar evento al botÃ³n de filtrar
        const btnFiltrar = document.getElementById('btnFiltrarEquipos');
        if (btnFiltrar) {
          btnFiltrar.addEventListener('click', () => {
            renderConversionTable(root);
          });
        }
      }
    }

    // Variable para mantener la referencia al grÃ¡fico
    let ventasChart = null;
    
    // Función para verificar autenticación
    function checkAuth() {
      // Verificar si hay un usuario en sessionStorage o localStorage
      const user = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || 'null');
      if (!user) {
        console.error('No se encontró sesión de usuario activa');
        window.location.href = '/login.html';
        return false;
      }
      // Validar rol permitido para ver Estadísticas
      const allowed = ['admin','backoffice','b:o','b.o','b-o','bo'];
      const role = String(user.role || user.rol || user.Role || '').toLowerCase();
      if (!allowed.includes(role)) {
        console.warn('Acceso denegado: rol no autorizado para Estadísticas ->', role);
        // Redirigir a inicio si no tiene permisos
        window.location.href = '/inicio.html';
        return false;
      }
      return true;
    }
    
    // FunciÃ³n para realizar peticiones autenticadas
    async function fetchWithAuth(url, options = {}) {
      if (!checkAuth()) return null;
      
      const defaultHeaders = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };
      
      const response = await fetch(url, {
        ...options,
        headers: {
          ...defaultHeaders,
          ...(options.headers || {})
        },
        credentials: 'include' // Importante para enviar las cookies de autenticaciÃ³n
      });
      
      if (response.status === 401) {
        // No autorizado - redirigir al login
        console.error('Error de autenticaciÃ³n - Redirigiendo al login');
        window.location.href = '/login.html';
        return null;
      }
      
      return response;
    }
    
    function renderVentasPorEquipoChart(teamData) {
      const ctx = document.getElementById('chart-ventas-dia');
      if (!ctx) return;

      // Filtrar equipos sin ventas para no saturar el gráfico
      // Filtrar equipos para fines de semana: solo mostrar si Total > 0
      const today = new Date();
      const isWeekend = today.getDay() === 0 || today.getDay() === 6; // 0 = domingo, 6 = sábado
      const filteredDayTeams = isWeekend ? teamData.filter(team => team.Total > 0) : teamData;
      const labels = filteredDayTeams.map(t => t._id || 'SIN EQUIPO');
      const data = filteredDayTeams.map(t => t.Total);

      // Paleta de colores atractiva (más colores si es necesario)
      const colors = [
        '#22b3ec', '#3498db', '#5dade2', '#85c1e9', '#aed6f1',
        '#36c2cf', '#48c9b0', '#76d7c4', '#a3e4d7', '#d1f2eb',
        '#f39c12', '#e67e22', '#e74c3c', '#9b59b6', '#34495e'
      ];

      // Destruir el grÃ¡fico anterior si existe para evitar conflictos
      if (window.ventasPorEquipoChart) {
        window.ventasPorEquipoChart.destroy();
      }

      window.ventasPorEquipoChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventas por Equipo',
            data: data,
            backgroundColor: colors.slice(0, data.length),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed !== null) {
                    label += context.parsed;
                  }
                  return label + ' ventas';
                }
              }
            }
          }
        }
      });
    }

    async function initCharts(){
      // Esta funciÃ³n se deja vacÃ­a intencionalmente para dar paso al nuevo grÃ¡fico de dona.
      console.log('initCharts ya no renderiza el grÃ¡fico de barras diario.');
    }
    
    // FunciÃ³n para renderizar el grÃ¡fico de ventas diarias
    function renderVentasDiarias(container, labels, data, isFallback) {
      if (!container) return;
      
      const warningHtml = isFallback ? `
        <div class="alert alert-warning mb-3" style="padding: 10px; margin-bottom: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Mostrando datos de prueba (Error de conexiÃ³n con la base de datos)
        </div>
      ` : '';
      
      container.innerHTML = `
        ${warningHtml}
        <canvas id="chart-ventas-diarias"></canvas>
      `;
      
      const canvas = container.querySelector('#chart-ventas-diarias');
      if (!canvas) {
        console.error('No se pudo crear el canvas para el grÃ¡fico de ventas diarias');
        return;
      }
      
      // Destruir grÃ¡fico anterior si existe
      if (window.ventasDiariasChart) {
        window.ventasDiariasChart.destroy();
      }
      
      // ConfiguraciÃ³n del grÃ¡fico
      const config = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventas',
            data: data,
            backgroundColor: 'rgba(34, 179, 236, 0.8)',
            borderColor: 'rgba(26, 144, 193, 1)',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Ventas: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'NÃºmero de ventas',
                font: {
                  weight: 'bold'
                }
              },
              ticks: {
                stepSize: 1,
                precision: 0
              }
            },
            x: {
              title: {
                display: true,
                text: 'Fechas',
                font: {
                  weight: 'bold'
                }
              }
            }
          }
        }
      };
      
      // Crear el grÃ¡fico
      window.ventasDiariasChart = new Chart(canvas, config);
    }
    

    // FunciÃ³n auxiliar para renderizar el grÃ¡fico
    function renderChart(container, labels, data, isFallback) {
      if (!container) return;
      
      const warningHtml = isFallback ? `
        <div class="alert alert-warning mb-3" style="padding: 10px; margin-bottom: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Mostrando datos de prueba (Error de conexiÃ³n con la base de datos)
        </div>
      ` : '';
      
      container.innerHTML = `
        ${warningHtml}
        <canvas id="chart-ventas-canvas"></canvas>
      `;
      
      const canvas = container.querySelector('#chart-ventas-canvas');
      if (!canvas) {
        console.error('No se pudo crear el canvas');
        return;
      }
      
      // Destruir grÃ¡fico anterior si existe
      if (window.ventasChart) {
        window.ventasChart.destroy();
      }
      
      // Crear nuevo grÃ¡fico
      const chartConfig = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventas',
            backgroundColor: '#22b3ec',
            borderColor: '#1a90c1',
            borderWidth: 1,
            borderRadius: 6,
            data: data
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Ventas: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'NÃºmero de ventas',
                font: { weight: 'bold' }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Equipos',
                font: { weight: 'bold' }
              },
              ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      };
      
      try {
        window.ventasChart = new Chart(canvas, chartConfig);
        console.log('GrÃ¡fico creado exitosamente');
      } catch (error) {
        console.error('Error al crear el grÃ¡fico:', error);
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error al crear el grÃ¡fico: ${error.message}
          </div>
        `;
      }

      // Renderizar tabla de ConversiÃ³n por equipo
      console.log('Buscando elemento con ID conversion-table...');
      const convRoot = document.getElementById('conversion-table');
      console.log('Elemento encontrado:', convRoot);
      if (convRoot) {
        console.log('Elemento conversion-table encontrado, procediendo a renderizar...');
        // Establecer fechas por defecto (Ãºltimos 30 dÃ­as)
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setDate(fechaInicio.getDate() - 30);
        
        // Formatear fechas para los inputs
        const fechaInicioInput = document.getElementById('fechaInicio');
        const fechaFinInput = document.getElementById('fechaFin');
        
        if (fechaInicioInput) fechaInicioInput.valueAsDate = fechaInicio;
        if (fechaFinInput) fechaFinInput.valueAsDate = fechaFin;
        
        // Cargar datos
        renderConversionTable(convRoot);
      }

      const rendCtx = document.getElementById('chart-rendimiento-mes');
      if (rendCtx) {
        new Chart(rendCtx, {
          type: 'line',
          data: {
            labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
            datasets: [{
              label: 'Puntos',
              data: Array.from({length: 12}, () => rand(10, 40)),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16,185,129,0.12)',
              fill: true,
              tension: 0.35
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
    }

    function initializeApp() {
      console.log('Inicializando aplicación...');
      
      // Verificar que Chart esté disponible
      if (typeof Chart === 'undefined') {
        console.error('Error: Chart.js no se ha cargado correctamente');
        const chartContainer = document.querySelector('.chart-wrapper');
        if (chartContainer) {
          chartContainer.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Error: No se pudo cargar la biblioteca de gráficos. Por favor, recarga la página.
            </div>
          `;
        }
        return;
      }
      
      console.log('Chart.js cargado correctamente:', Chart.version);
      
      // Inicializar gráficos
      initCharts();
      
      // Configurar botón de actualización
      const btn = document.getElementById('btn-refresh');
      if (btn) {
        btn.addEventListener('click', () => {
          console.log('Actualizando gráficos...');
          initCharts();
        });
      }

      // Inicializar tabla de conversión después de que el DOM esté listo
      setTimeout(() => {
        initConversionTable();
        loadDayData();
      }, 200); // Delay para asegurar que el DOM esté listo
    }

    // FunciÃ³n para inicializar la tabla de conversiÃ³n
    function initConversionTable() {
      console.log('Inicializando tabla de conversiÃ³n...');
      const convRoot = document.getElementById('conversion-table');
      if (convRoot) {
        console.log('Elemento conversion-table encontrado, renderizando...');
        renderConversionTable(document.getElementById('conversion-table'));
      } else {
        console.error('No se encontrÃ³ el elemento con ID conversion-table');
      }
    }

    // Función para cargar y renderizar la tabla del Día con el mismo diseño que la del Mes
    async function loadDayData() {
      console.log('Cargando datos del día actual...');
      const container = document.getElementById('ventas-dia-card');
      if (!container) {
        console.error('No se encontró el contenedor #ventas-dia-card');
        return;
      }

      // Encabezado de fecha del día
      const hoy = new Date();
      const diaTexto = `${String(hoy.getDate()).padStart(2,'0')}/${String(hoy.getMonth()+1).padStart(2,'0')}/${hoy.getFullYear()}`;

      // Placeholder de carga
      container.innerHTML = `
        <div class="text-center" style="padding: 12px; color:#666;">Cargando datos del día...</div>
      `;

      try {
        const response = await fetchWithAuth('/api/equipos/estadisticas?scope=day');
        if (!response) return;

        const data = await response.json();
        const dayData = (data && data.success && Array.isArray(data.data))
          ? data.data.map(equipo => ({
              name: equipo.TEAM || 'Sin equipo',
              ICON: parseFloat(equipo.ICON || 0),
              BAMO: parseFloat(equipo.BAMO || 0),
              Total: parseFloat(equipo.Total || 0),
              Puntaje: parseFloat(equipo.Puntaje || 0)
            }))
          : [];

        // Separar LINEAS para panel derecho y excluirlas de la tabla principal
        const isLinea = (n) => /LINEA/i.test(String(n || ''));
        const lineasData = dayData.filter(t => isLinea(t.name)).map(r => ({ name: r.name, ICON: r.ICON || 0 }));
        const lineasTotalICON = lineasData.reduce((acc, r) => acc + (r.ICON || 0), 0);
        const excludeNames = new Set(dayData.filter(t => isLinea(t.name)).map(t => String(t.name).toUpperCase()));
        const mainData = dayData.filter(t => !excludeNames.has(String(t.name).toUpperCase()));

        // Construir HTML con el mismo diseño (conversion-card + sales-table) incluyendo panel LINEAS a la derecha
        const tablaHtml = mainData.length === 0
          ? `
            <div class="conversion-card">
              <div class="conversion-title">VENTAS POR MERCADO Y PUNTAJE DEL DÍA (${diaTexto})</div>
              <div class="conv-two-col">
                <div class="conv-left">
                  <table class="sales-table">
                    <thead>
                      <tr>
                        <th>EQUIPO</th>
                        <th>ICON</th>
                        <th>BAMO</th>
                        <th>TOTAL</th>
                        <th>PUNTAJE</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" style="text-align:center; padding:16px; color:#666; font-style:italic;">No hay datos disponibles para el día actual</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="conv-right">
                  <div class="mini-card">
                    <table class="mini-table">
                      <thead>
                        <tr>
                          <th>TEAM LINEAS</th>
                          <th>ICON</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${(lineasData || []).map(r => `
                          <tr>
                            <td>${r.name}</td>
                            <td>${r.ICON || 0}</td>
                          </tr>
                        `).join('')}
                        <tr class="total">
                          <td>TOTAL</td>
                          <td class="total-icon">${lineasTotalICON}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `
          : `
            <div class="conversion-card">
              <div class="conversion-title">VENTAS POR MERCADO Y PUNTAJE DEL DÍA (${diaTexto})</div>
              <div class="conv-two-col">
                <div class="conv-left">
                  <table class="sales-table">
                    <thead>
                      <tr>
                        <th>EQUIPO</th>
                        <th>ICON</th>
                        <th>BAMO</th>
                        <th>TOTAL</th>
                        <th>PUNTAJE</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${mainData.map(team => `
                        <tr>
                          <td>${team.name}</td>
                          <td>${team.ICON || 0}</td>
                          <td>${team.BAMO || 0}</td>
                          <td>${team.Total || 0}</td>
                          <td class="score-col">${parseFloat(team.Puntaje || 0).toFixed(2)}</td>
                        </tr>
                      `).join('')}
                      <tr class="total-row">
                        <td>TOTAL</td>
                        <td>${mainData.reduce((sum, t) => sum + (t.ICON || 0), 0)}</td>
                        <td>${mainData.reduce((sum, t) => sum + (t.BAMO || 0), 0)}</td>
                        <td>${mainData.reduce((sum, t) => sum + (t.Total || 0), 0)}</td>
                        <td>${mainData.reduce((sum, t) => sum + parseFloat(t.Puntaje || 0), 0).toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="conv-right">
                  <div class="mini-card">
                    <table class="mini-table">
                      <thead>
                        <tr>
                          <th>TEAM LINEAS</th>
                          <th>ICON</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${(lineasData || []).map(r => `
                          <tr>
                            <td>${r.name}</td>
                            <td>${r.ICON || 0}</td>
                          </tr>
                        `).join('')}
                        <tr class="total">
                          <td>TOTAL</td>
                          <td class="total-icon">${lineasTotalICON}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `;

        container.innerHTML = tablaHtml;
      } catch (e) {
        console.error('Error cargando datos del día:', e);
        container.innerHTML = `
          <div class="conversion-card">
            <div class="conversion-title">VENTAS POR MERCADO Y PUNTAJE DEL DÍA (${diaTexto})</div>
            <div class="conv-two-col">
              <div class="conv-left">
                <table class="sales-table">
                  <thead>
                    <tr>
                      <th>EQUIPO</th>
                      <th>ICON</th>
                      <th>BAMO</th>
                      <th>TOTAL</th>
                      <th>PUNTAJE</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5" style="text-align:center; padding:16px; color:#666; font-style:italic;">Error de conexión</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
    }

    // Esperar a que todo el DOM y recursos estÃ©n cargados
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
        initConversionTable();
      });
    } else {
      initializeApp();
      initConversionTable();
    }
  </script>
</body>
</html>
