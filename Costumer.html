<!DOCTYPE html>
<html lang="es">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>CRM Agente - Costumer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/costumer-table-clean.css">
  <link rel="stylesheet" href="css/costumer-table-actions.css">
  <link rel="stylesheet" href="css/costumer-table-comments.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">
  <!-- Protecci√≥n de autenticaci√≥n en frontend -->
  <script src="agentes/js/auth-check.js"></script>
  <style>
    /* Estilos del sidebar unificados en css/sidebar.css */
    /* Estilos para la informaci√≥n del usuario en la barra lateral */
    .user-info {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
      padding: 0 20px;
    }
    
    .user-info .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 40px;
      color: #4a5568;
    }
    
    .user-details {
      margin-top: 10px;
    }
    
    .user-name {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #2d3748;
      font-size: 1.1em;
    }
    
    .user-role {
      display: inline-block;
      font-size: 0.8em;
      color: white;
      background: #4a5568;
      padding: 3px 12px;
      border-radius: 12px;
      margin-top: 5px;
      font-weight: 500;
    }

    /* Estilos generales */
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --border: #e0e0e0;
      --background: #f5f7fa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      position: relative;
      top: 0;
    }

    /* Sidebar Styles: Usar reglas unificadas desde css/sidebar.css */
    /* Estilos para el contenido principal */
    .main-content {
      margin-left: 260px; /* Igual que el ancho del sidebar-inicio */
      padding: 30px;
      width: calc(100% - 260px);
      min-height: 100vh;
      background-color: #f8fafc;
      position: relative;
    }
    
    /* Estilos para el men√∫ desplegable */
    .has-submenu {
      position: relative;
    }
    
    .submenu {
      display: none;
      padding-left: 20px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-in-out;
    }
    
    .submenu.active {
      display: block;
      max-height: 200px;
    }
    
    .submenu li {
      margin: 0;
    }
    
    .submenu a {
      padding: 10px 15px 10px 30px !important;
      font-size: 0.9em !important;
      opacity: 0.9;
    }
    
    .submenu a:hover {
      background: rgba(34, 179, 236, 0.2) !important;
      transform: none !important;
      padding-left: 35px !important;
    }
    
    .submenu-toggle {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    
    .submenu-icon {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      margin-left: 5px;
    }
    
    .has-submenu.active .submenu-icon {
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin: 0 0 0 260px;
      padding: 20px;
      background-color: var(--background);
      min-height: 100vh;
      position: relative;
      width: calc(100% - 260px);
    }

    /* Estilos para las tarjetas de resumen */
    .summary-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin: 0;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .summary-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    
    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-content {
      padding: 20px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #4a5568;
      margin: 0;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #718096;
    }
    
    .card-footer i {
      margin-right: 6px;
    }
    
    /* Estilos espec√≠ficos para cada tarjeta */
    .sales-today .card-icon {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
    }
    
    .sales-month .card-icon {
      background: linear-gradient(135deg, #2196f3, #42a5f5);
    }
    
    .pending .card-icon {
      background: linear-gradient(135deg, #ff9800, #ffa726);
    }
    
    .cancelled .card-icon {
      background: linear-gradient(135deg, #f44336, #ef5350);
    }
    
    /* Estilos para la tabla de clientes */
    .costumer-table-container {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(2, 8, 20, 0.06);
      overflow: hidden;
      margin-top: 24px;
      border: 1px solid #e6eef5;
      max-width: 100%;
      /* Fijar el √°rea de tabla para que solo el listado haga scroll */
      display: flex;
      flex-direction: column;
      /* Ajusta el valor seg√∫n tu layout (altura visible menos tarjetas/m√°rgenes) */
      height: calc(100vh - 280px);
    }
    
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      /* Permitir scroll vertical SOLO dentro del listado */
      overflow-y: auto;
      flex: 1 1 auto;
      position: relative;
    }
    
    .costumer-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .costumer-table-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }
    
    .costumer-table-actions {
      display: flex;
      gap: 12px;
    }
    
    .costumer-filter-input {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 250px;
    }
    
    .costumer-filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .costumer-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
      min-width: 100%;
      background: #fff;
    }
    
    .costumer-table th,
    .costumer-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      white-space: normal;
      word-wrap: break-word;
      min-width: 120px;
      max-width: 360px;
      vertical-align: middle;
      font-size: 14px;
      color: #334155;
    }
    
    .costumer-table th {
      background: linear-gradient(180deg, #f9fbff 0%, #f3f6fb 100%);
      font-weight: 600;
      color: #1f2937;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.04em;
      border-bottom: 1px solid #e6eef5;
      box-shadow: 0 2px 0 rgba(226, 232, 240, 0.5);
      backdrop-filter: saturate(120%) blur(2px);
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .costumer-table th {
      text-align: left;
      padding: 14px 18px;
      white-space: nowrap;
    }
    
    .costumer-table td {
      padding: 14px 18px;
      border-bottom: 1px solid #eef2f7;
      color: #334155;
      background-color: #fff;
    }

    /* Zebra striping */
    .costumer-table tbody tr:nth-child(even) td {
      background-color: #fbfdff;
    }

    /* Hover sin l√≠neas laterales */
    .costumer-table tbody tr:hover td {
      background-color: #f6fafe;
      box-shadow: none;
    }
    
    .costumer-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success {
      background-color: #e6f7ed;
      color: #10b981;
    }
    
    .badge-warning {
      background-color: #fffbeb;
      color: #f59e0b;
    }
    
    .badge-danger {
      background-color: #fdecea;
      color: #e53935;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background-color: #f1f5f9;
      color: var(--primary);
    }
    
    .action-btn i {
      font-size: 16px;
    }

    /* Toggle para modo compacto */
    .action-btn.toggle {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px 10px;
      color: #475569;
      background: #fff; 
    }
    .action-btn.toggle.active {
      background-color: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    /* Modo compacto: reduce paddings y tama√±o de fuente */
    body.compact .costumer-table th,
    body.compact .costumer-table td {
      padding: 8px 10px;
      font-size: 12px;
    }
    body.compact .costumer-filter-input {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .summary-cards-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      /* Reglas del sidebar unificadas en css/sidebar.css */
      
      .summary-cards-container {
        grid-template-columns: 1fr;
      }
    }
    /* Composer (comentarios) */
    .comment-composer { display:flex; gap:10px; align-items:flex-end; }
    .composer-avatar { width:40px; height:40px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .composer-input-wrap { position:relative; flex:1; display:flex; align-items:center; }
    .composer-textarea { width:100%; border:1px solid #ced4da; border-radius:22px; padding:10px 96px 10px 14px; min-height:40px; max-height:140px; resize:vertical; outline:none; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .composer-textarea:focus { border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .composer-actions { position:absolute; right:8px; bottom:8px; display:flex; gap:6px; align-items:center; }
    .emoji-btn { width:28px; height:28px; border-radius:14px; border:1px solid #e2e8f0; background:#fff; color:#111827; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(0,0,0,.05); font-size:16px; }
    .emoji-btn:hover { background:#f8fafc; }
    .composer-send { border:none; background:transparent; color:#0d6efd; font-weight:600; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .composer-send:hover { color:#0b5ed7; text-decoration: underline; }
    .emoji-picker { position:absolute; right:10px; bottom:48px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.08); padding:8px; width:260px; z-index:10; }
    .emoji-picker .title { font-size:12px; color:#6b7280; margin:2px 4px 6px; }
    .emoji-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; font-size:18px; }
    .emoji-item { border:none; background:none; cursor:pointer; line-height:1; padding:4px; border-radius:6px; }
    .emoji-item:hover { background:#f3f4f6; }
  </style>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <nav class="sidebar sidebar-inicio">
      <!-- Informaci√≥n del Usuario -->
      <div class="user-info">
        <div class="avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-details">
          <span id="user-name" class="user-name">Usuario</span>
          <span id="user-role" class="user-role">Rol</span>
        </div>
      </div>
      
      <h3>Men√∫</h3>
      <ul class="menu">
        <li><a href="inicio.html" class="btn btn-sidebar"><i class="fas fa-home"></i> <span>Inicio</span></a></li>
        <li><a href="lead.html" class="btn btn-sidebar"><i class="fas fa-user-plus"></i> <span>Nuevo Lead</span></a></li>
        <li><a href="Costumer.html" class="btn btn-sidebar is-active"><i class="fas fa-users"></i> <span>Clientes</span></a></li>
        <li>
          <a href="#" id="logoutBtn" data-logout-button class="btn btn-sidebar btn-logout">
            <i class="fas fa-sign-out-alt"></i> <span>Cerrar sesi√≥n</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Tarjetas de Resumen -->
      <div class="summary-cards-container">
        <!-- Ventas Hoy -->
        <div class="summary-card sales-today">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h3 class="card-title">Ventas Hoy</h3>
            </div>
            <div class="card-value" id="costumer-ventas-hoy">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-day"></i> Actualizado ahora
            </div>
          </div>
        </div>

        <!-- Ventas del Mes -->
        <div class="summary-card sales-month">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 class="card-title">Ventas del Mes</h3>
            </div>
            <div class="card-value" id="costumer-ventas-mes">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-alt"></i> Mes actual
            </div>
          </div>
        </div>

        <!-- Pendientes -->
        <div class="summary-card pending">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-clock"></i>
              </div>
              <h3 class="card-title">Pendientes</h3>
            </div>
            <div class="card-value" id="costumer-pendientes">0</div>
            <div class="card-footer">
              <i class="fas fa-info-circle"></i> Por atender
            </div>
          </div>
        </div>

        <!-- Cancelados -->
        <div class="summary-card cancelled">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 class="card-title">Cancelados</h3>
            </div>
            <div class="card-value" id="costumer-cancelados">0</div>
            <div class="card-footer">
              <i class="fas fa-exclamation-triangle"></i> Este mes
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Clientes -->
      <div class="costumer-table-container">
        <div class="costumer-table-header">
          <h2 class="costumer-table-title">Lista de Clientes</h2>
          <div class="costumer-table-actions">
            <input type="text" class="costumer-filter-input" id="costumer-search" placeholder="Buscar cliente...">
            <button id="toggle-compact" class="action-btn toggle" title="Alternar modo compacto">
              <i class="fas fa-compress-alt"></i>
            </button>
            <button id="refresh-table" class="action-btn" title="Refrescar">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="costumer-table">
            <thead>
              <tr>
                <th>Nombre cliente</th>
                <th>Tel√©fono principal</th>
                <th>Tel√©fono alterno</th>
                <th>Numero de cuenta</th>
                <th>Autopago</th>
                <th>Direcci√≥n</th>
                <th>Tipo de servicios</th>
                <th>Sistema</th>
                <th>Riesgo</th>
                <th>Dia de venta</th>
                <th>D√≠a de instalaci√≥n</th>
                <th>Status</th>
                <th>Servicios</th>
                <th>Mercado</th>
                <th>Supervisor</th>
                <th>Comentario</th>
                <th>Motivo llamada</th>
                <th>ZIP CODE</th>
                <th>Puntaje</th>
                <th>
                  <div style="display: flex; flex-direction: column; align-items: center;">
                    <div>Comentarios sobre la Venta</div>
                    <button onclick="abrirComentarios()" class="action-btn" style="margin-top: 5px; padding: 4px 8px; font-size: 12px;">
                      <i class="fas fa-comment"></i> Gestionar
                    </button>
                  </div>
                </th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="costumer-tbody">
              <!-- Las filas se llenar√°n din√°micamente con JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Comentarios -->
  <div id="comentariosModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div style="position: absolute; right: 0; top: 0; width: 500px; height: 100%; background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
      <!-- Encabezado del modal -->
      <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa;">
        <div>
          <h3 style="margin: 0; color: #333; font-size: 18px;">Comentarios</h3>
          <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Agrega comentarios sobre el cliente</p>
        </div>
        <button onclick="cerrarComentarios()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      
      <!-- Lista de comentarios -->
      <div id="comentariosContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Los comentarios se cargar√°n aqu√≠ din√°micamente -->
      </div>
      
      <!-- √Årea para nuevo comentario -->
      <div style="padding: 15px; border-top: 1px solid #eaeaea; background-color: #f8f9fa;">
        <div class="comment-composer" style="margin-bottom:10px;">
          <div class="composer-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="composer-input-wrap">
            <textarea id="nuevoComentario" class="composer-textarea" placeholder="Escribe un comentario..."></textarea>
            <div class="composer-actions">
              <button id="emojiToggleBtn" class="emoji-btn" onclick="toggleEmojiPicker(event)" title="Emojis">üòä</button>
              <button class="composer-send" onclick="agregarComentario()">Enviar</button>
            </div>
            <!-- Picker compacto -->
            <div id="emojiPicker" class="emoji-picker" style="display:none;">
              <div class="title">Emojis</div>
              <div class="emoji-grid">
                <button class="emoji-item" onclick="insertEmoji('üòÄ')">üòÄ</button>
                <button class="emoji-item" onclick="insertEmoji('üòÅ')">üòÅ</button>
                <button class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</button>
                <button class="emoji-item" onclick="insertEmoji('ü§£')">ü§£</button>
                <button class="emoji-item" onclick="insertEmoji('üòä')">üòä</button>
                <button class="emoji-item" onclick="insertEmoji('üòç')">üòç</button>
                <button class="emoji-item" onclick="insertEmoji('üòé')">üòé</button>
                <button class="emoji-item" onclick="insertEmoji('ü•≥')">ü•≥</button>
                <button class="emoji-item" onclick="insertEmoji('üëç')">üëç</button>
                <button class="emoji-item" onclick="insertEmoji('üôè')">üôè</button>
                <button class="emoji-item" onclick="insertEmoji('üëè')">üëè</button>
                <button class="emoji-item" onclick="insertEmoji('üí™')">üí™</button>
                <button class="emoji-item" onclick="insertEmoji('üî•')">üî•</button>
                <button class="emoji-item" onclick="insertEmoji('‚ú®')">‚ú®</button>
                <button class="emoji-item" onclick="insertEmoji('‚úÖ')">‚úÖ</button>
                <button class="emoji-item" onclick="insertEmoji('‚ùó')">‚ùó</button>
                <button class="emoji-item" onclick="insertEmoji('üìû')">üìû</button>
                <button class="emoji-item" onclick="insertEmoji('üìÖ')">üìÖ</button>
                <button class="emoji-item" onclick="insertEmoji('üíº')">üíº</button>
                <button class="emoji-item" onclick="insertEmoji('üè∑Ô∏è')">üè∑Ô∏è</button>
                <button class="emoji-item" onclick="insertEmoji('üöÄ')">üöÄ</button>
                <button class="emoji-item" onclick="insertEmoji('‚è≥')">‚è≥</button>
                <button class="emoji-item" onclick="insertEmoji('üïô')">üïô</button>
                <button class="emoji-item" onclick="insertEmoji('üìç')">üìç</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Manejador de errores global
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Error global detectado:', {
        message: message,
        source: source,
        lineno: lineno,
        colno: colno,
        error: error
      });
      return true; // Previene el manejador de errores por defecto
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script>
    // Funci√≥n para verificar el rol del usuario y mostrar/ocultar elementos seg√∫n corresponda
    function checkUserRole() {
      try {
        const teamMenuItem = document.getElementById('teamMenuItem');
        if (teamMenuItem) {
          teamMenuItem.style.display = 'none';
        }

        // Obtener y normalizar rol
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();

        // Roles permitidos para ver Team: admin, supervisor, backoffice (y variantes)
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);

        if (teamMenuItem && allowed.has(role)) {
          // li por defecto es list-item; usar block para asegurar visibilidad
          teamMenuItem.style.display = 'block';
        }
      } catch (error) {
        console.error('Error al verificar el rol del usuario:', error);
      }
    }
    
    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      checkUserRole();
    });
  </script>
  <script src="js/core/script.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <!-- Eliminada la referencia a costumer-comments.js que no existe -->
  <script>
    // Inicializaci√≥n de UI: toggle compacto y refrescar tabla
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggle-compact');
      const refreshBtn = document.getElementById('refresh-table');

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          document.body.classList.toggle('compact');
          toggleBtn.classList.toggle('active');
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
          const icon = refreshBtn.querySelector('i');
          const prev = icon.className;
          icon.className = 'fas fa-spinner fa-spin';
          try { await fetchLeadsAgente(); }
          finally { icon.className = prev; }
        });
      }

      // Cargar datos iniciales
      if (typeof cargarDatosIniciales === 'function') {
        cargarDatosIniciales();
      } else if (typeof fetchLeadsAgente === 'function') {
        fetchLeadsAgente();
      }
    });
  </script>
  <script>
    // Variables globales
    let leadActual = null;

    // Helper: detectar si el usuario actual es Irania Serrano
    function esIrania() {
      try {
        // 1) Intentar desde local/session storage
        const userRaw = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userRaw) {
          const u = JSON.parse(userRaw || '{}');
          const nombre = (u.name || u.fullName || u.username || u.email || u.usuario?.name || '').toString();
          if (normalizarTexto(nombre) === normalizarTexto('Irania Serrano')) return true;
        }
        // 2) Intentar desde token JWT
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (token && token.split('.').length === 3) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]) || '{}');
            const nombreTok = (payload.username || payload.name || payload.fullName || payload.email || '').toString();
            if (normalizarTexto(nombreTok) === normalizarTexto('Irania Serrano')) return true;
          } catch(_) {}
        }
      } catch(_) {}
      return false;
    }

    // Helper: quitar prefijo "team" del supervisor para mostrar limpio
    function limpiarSupervisor(displayName) {
      try {
        const s = (displayName || '').toString();
        return s.replace(/^\s*team\s+/i, '').trim();
      } catch { return displayName || ''; }
    }
  
    // Funciones para el manejo de comentarios
    function abrirComentarios(leadId) {
      leadActual = leadId;
      document.getElementById('comentariosModal').style.display = 'block';
      cargarComentarios(leadId);
    }

    function cerrarComentarios() {
      document.getElementById('comentariosModal').style.display = 'none';
      document.getElementById('nuevoComentario').value = '';
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
      leadActual = null;
    }

    async function cargarComentarios(leadId) {
      const container = document.getElementById('comentariosContainer');
      container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <div style="text-align: center;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p style="margin-top: 10px; color: #666;">Cargando comentarios...</p>
          </div>
        </div>
      `;
      
      try {
        console.log('Solicitando comentarios para leadId:', leadId);
        
        let comments = [];
        
        // 1) Intentar obtener del backend si existe endpoint
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/comments?leadId=${encodeURIComponent(leadId)}`, {
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
          });
          if (resp.ok) {
            const data = await resp.json();
            if (data && Array.isArray(data.comments)) {
              comments = data.comments;
            }
          }
        } catch (e) {
          console.warn('Fallo al obtener comentarios del backend, se usar√° cache/local:', e);
        }

        // 2) Mezclar con comentarios locales en cache (optimista)
        const cacheKey = `comments_cache_${leadId}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        if (Array.isArray(cached) && cached.length) {
          comments = [...comments, ...cached];
        }

        // 3) Si vac√≠o, intentar inferir √∫ltimo comentario textual del lead para mostrar algo
        if ((!comments || comments.length === 0) && Array.isArray(window.ultimaListaLeads)) {
          const lead = window.ultimaListaLeads.find(l => (l._id || '') === leadId);
          if (lead && lead.comentarios_venta) {
            comments = [{
              autor: 'Sistema',
              fecha: new Date().toISOString(),
              texto: String(lead.comentarios_venta)
            }];
          }
        }

        // Normalizaci√≥n y render tipo chat
        const usuario = obtenerUsuarioActual();
        const mensajes = (comments || []).map(c => ({
          autor: c.autor || c.user || 'Desconocido',
          fecha: c.fecha || c.createdAt || new Date().toISOString(),
          texto: (c.texto ?? c.comment ?? '').toString()
        }));

        // ...
        let html = '';
        
        // Ordenar comentarios por fecha (m√°s antiguos primero para chat natural)
        const comentariosOrdenados = [...mensajes].sort((a, b) => 
          new Date(a.fecha) - new Date(b.fecha)
        );
        
        // Render de cada burbuja estilo chat
        comentariosOrdenados.forEach(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          const esAgente = normalizarTexto(comentario.autor) === normalizarTexto(usuario);
          const lado = esAgente ? 'me' : 'other';
          const iniciales = obtenerIniciales(comentario.autor);
          html += `
            <div class="chat-message ${lado}" style="display:flex; gap:10px; margin-bottom:12px; align-items:flex-end; ${lado==='me' ? 'justify-content:flex-end;' : ''}">
              ${lado==='other' ? `
                <div class="chat-avatar" title="${escapeHtml(comentario.autor)}" style="width:28px; height:28px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6c757d; flex-shrink:0;">${escapeHtml(iniciales)}</div>
              ` : ''}
              <div class="chat-bubble ${lado}" style="max-width:70%; padding:10px 12px; border-radius:14px; ${lado==='me' ? 'background:#e3f2fd; color:#0d47a1; border-top-right-radius:4px;' : 'background:#f1f3f5; color:#333; border-top-left-radius:4px;'}">
                <div class="chat-author-time" style="font-size:11px; color:${lado==='me' ? '#1565c0' : '#6c757d'}; margin-bottom:4px;">
                  ${escapeHtml(comentario.autor)} ‚Ä¢ ${fechaFormateada}
                </div>
                <div class="chat-text" style="white-space:pre-wrap; word-wrap:break-word;">${escapeHtml(comentario.texto)}</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html || `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
            <div>
              <i class="fas fa-comments" style="font-size:28px; opacity:0.6;"></i>
              <p style="margin-top:8px;">Sin comentarios a√∫n. ¬°S√© el primero en comentar!</p>
            </div>
          </div>
        `;

        // Hacer scroll al final (√∫ltimo mensaje visible)
        setTimeout(() => {
          try { container.scrollTop = container.scrollHeight; } catch(_e) {}
        }, 50);
  
      } catch (error) {
        console.error('Error al cargar comentarios:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      }
    }

    async function agregarComentario() {
      const comentario = document.getElementById('nuevoComentario').value.trim();
      if (!comentario) return;
      
      const btnEnviar = document.querySelector('#comentariosModal button[onclick="agregarComentario()"]');
      const btnOriginalText = btnEnviar.innerHTML;
      const comentarioInput = document.getElementById('nuevoComentario');
      
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        console.log('Enviando comentario para leadId:', leadActual);
        const usuario = obtenerUsuarioActual();
        const nuevo = {
          autor: usuario || 'Yo',
          fecha: new Date().toISOString(),
          texto: comentario
        };

        // Optimista: agregar a cache local
        const cacheKey = `comments_cache_${leadActual}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        cached.push(nuevo);
        localStorage.setItem(cacheKey, JSON.stringify(cached));

        // Intentar enviar al backend si existe endpoint REST
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/leads/${encodeURIComponent(leadActual)}/comentarios`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(nuevo)
          });
          if (!resp.ok) {
            console.warn('POST /api/leads/:id/comentarios no disponible. Se mantiene en cache local.');
          }
        } catch (e) {
          console.warn('Fallo al enviar comentario al backend, se mantiene en cache local:', e);
        }

        // Limpiar input y recargar lista
        comentarioInput.value = '';
        await cargarComentarios(leadActual);

        // Actualizar columna de "Comentarios sobre la Venta" en la tabla
        if (typeof actualizarUltimoComentarioEnTabla === 'function') {
          actualizarUltimoComentarioEnTabla(leadActual, nuevo.texto);
        }
      } catch(error) {
        console.error('Error al agregar comentario:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = btnOriginalText;
      }
    }

    // Soporte de Emoji Picker
    function toggleEmojiPicker(event) {
      try {
        event?.stopPropagation?.();
        const picker = document.getElementById('emojiPicker');
        if (!picker) return;
        const isOpen = picker.style.display === 'block';
        picker.style.display = isOpen ? 'none' : 'block';
      } catch (e) {
        console.warn('toggleEmojiPicker error:', e);
      }
    }

    function insertAtCursor(textarea, text) {
      try {
        const start = textarea.selectionStart ?? textarea.value.length;
        const end = textarea.selectionEnd ?? textarea.value.length;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
      } catch (e) {
        // Fallback: append
        textarea.value = (textarea.value || '') + text;
      }
    }

    function insertEmoji(emoji) {
      const ta = document.getElementById('nuevoComentario');
      if (!ta) return;
      ta.focus();
      insertAtCursor(ta, emoji);
      // cerrar picker tras insertar
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
    }

    // Cerrar picker al hacer click fuera
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const toggleBtn = document.getElementById('emojiToggleBtn');
      if (!picker || picker.style.display !== 'block') return;
      const clickedInsidePicker = picker.contains(e.target);
      const clickedToggle = toggleBtn && (e.target === toggleBtn || toggleBtn.contains(e.target));
      if (!clickedInsidePicker && !clickedToggle) {
        picker.style.display = 'none';
      }
    });

    // Funci√≥n para actualizar el √∫ltimo comentario en la tabla
    function actualizarUltimoComentarioEnTabla(leadId, comentario) {
      // Encontrar la fila del lead
      const filas = document.querySelectorAll('#costumer-tbody tr');
      
      filas.forEach(fila => {
        const botonEditar = fila.querySelector('button[onclick^="editarLead"]');
        if (botonEditar) {
          const idEnFila = botonEditar.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (idEnFila === leadId) {
            // Actualizar la celda de comentarios
            const celdaComentarios = fila.querySelector('td:nth-last-child(2)');
            if (celdaComentarios) {
              // Mostrar solo los primeros 50 caracteres del comentario
              const textoCorto = comentario.length > 50 ? comentario.substring(0, 50) + '...' : comentario;
              celdaComentarios.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="new-comment-dot" style="display: inline-block; width: 8px; height: 8px; background-color: #3498db; border-radius: 50%;"></span>
                    <span>${textoCorto}</span>
                  </div>
                  <button onclick="event.stopPropagation(); abrirComentarios('${leadId}')" class="action-btn" style="margin-top: 5px; padding: 2px 6px; font-size: 11px;">
                    <i class="fas fa-comment"></i> Ver todo
                  </button>
                </div>
              `;
            }
          }
        }
      });
    }

    // Cerrar el modal al hacer clic fuera del contenido
    window.onclick = function(event) {
      const modal = document.getElementById('comentariosModal');
      if (event.target == modal) {
        cerrarComentarios();
      }
    }

    // Variable global para almacenar los leads
    window.ultimaListaLeads = [];
    
    // Normalizaci√≥n de leads desde el backend a la estructura usada en frontend
    function escapeAttr(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      } catch { return ''; }
    }
    function toISODateString(d) {
      try {
        if (!d) return '';
        if (d instanceof Date) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0)).toISOString().split('T')[0];
        if (typeof d === 'string') {
          // Intentar YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
          const dt = new Date(d);
          if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
        }
      } catch (e) {
        console.warn('toISODateString error:', e, d);
      }
      return '';
    }

    // Helpers de identificadores
    function extractLeadId(raw) {
      if (!raw) return '';
      // Casos: {_id: '...'} | {_id: {$oid: '...'}} | {id: '...'}
      const _id = raw._id;
      if (typeof _id === 'string') return _id;
      if (_id && typeof _id === 'object') {
        if (typeof _id.$oid === 'string') return _id.$oid;
        if (typeof _id.oid === 'string') return _id.oid;
      }
      if (typeof raw.id === 'string') return raw.id;
      return '';
    }

    // Helper global utilizado por atributos inline
    function getLeadId(lead) {
      try {
        if (!lead) return '';
        const id = extractLeadId(lead);
        return typeof id === 'string' ? id : '';
      } catch {
        return '';
      }
    }

    function normalizeLead(raw) {
      const lead = raw || {};
      // Mapear campos comunes provenientes del backend en MAY√öSCULAS u otras variantes
      const fechaVenta = lead.dia_venta || lead.FECHA || lead.fecha_venta || lead.fecha || '';
      const fechaInst = lead.dia_instalacion || lead.FECHA_INSTALACION || lead.fecha_instalacion || '';
      const puntaje = lead.puntaje ?? lead.PUNTAJE ?? lead.score ?? 0;
      const supervisor = lead.supervisor ?? lead.SUPERVISOR ?? lead.team ?? '';
      const tipoServicio = lead.tipo_servicios ?? lead.tipo_servicio ?? lead.SERVICIO ?? lead.producto ?? '';
      const id = extractLeadId(lead);

      return {
        // Campos de tabla esperados
        _id: id,
        nombre_cliente: lead.nombre_cliente || lead.NOMBRE || lead.cliente || lead.nombre || 'N/A',
        telefono_principal: lead.telefono_principal || lead.TELEFONO || lead.celular || lead.telefono || 'N/A',
        telefono_alterno: lead.telefono_alterno || lead.TELEFONO_ALTERNO || lead.telefono2 || '',
        numero_cuenta: lead.numero_cuenta || lead.CUENTA || lead.account || '',
        autopago: lead.autopago ?? lead.AUTOPAGO ?? '',
        direccion: lead.direccion || lead.DIRECCION || lead.address || '',
        tipo_servicios: tipoServicio || '',
        sistema: lead.sistema || lead.SISTEMA || '',
        riesgo: lead.riesgo || lead.RIESGO || '',
        dia_venta: fechaVenta ? toISODateString(fechaVenta) : '',
        dia_instalacion: fechaInst ? toISODateString(fechaInst) : '',
        status: lead.status || lead.STATUS || lead.estado || 'N/A',
        servicios: lead.servicios || lead.SERVICIOS || tipoServicio || '',
        mercado: lead.mercado || lead.MERCADO || '',
        supervisor: supervisor || '',
        comentario: lead.comentario || lead.COMENTARIO || '',
        motivo_llamada: lead.motivo_llamada || lead.MOTIVO || '',
        zip_code: lead.zip_code || lead.ZIP || lead.cp || '',
        puntaje: Number(puntaje) || 0,
        comentarios_venta: lead.comentarios_venta || lead.COMENTARIOS || lead.comentarios || '',
        // Identificadores
        _id: id,
        id: id,
      };
    }

    function normalizeLeads(arr) {
      if (!Array.isArray(arr)) return [];
      return arr.map(normalizeLead);
    }

    // Helper: obtener fecha YYYY-MM-DD de un lead para gr√°ficas y conteos
    function getDateFromLead(lead) {
      try {
        if (!lead) return '';
        const raw = lead.dia_venta || lead.FECHA || lead.fecha_venta || lead.fecha || null;
        if (!raw) return '';
        let d;
        if (raw instanceof Date) {
          d = raw;
        } else if (typeof raw === 'string') {
          // Si viene en formato YYYY-MM-DD, forzar a UTC para evitar desfases
          if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
            const [y, m, day] = raw.split('-').map(Number);
            d = new Date(Date.UTC(y, m - 1, day));
          } else {
            d = new Date(raw);
          }
        } else {
          d = new Date(String(raw));
        }
        if (isNaN(d)) return '';
        // Normalizar a medianoche UTC para obtener YYYY-MM-DD estable
        const iso = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString();
        return iso.split('T')[0];
      } catch {
        return '';
      }
    }

    // Cargar leads del agente desde backend y actualizar UI
    async function fetchLeadsAgente() {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          console.error('No se encontr√≥ el token de autenticaci√≥n');
          mostrarMensajeSinDatos();
          return [];
        }
        
        // Construir URL con filtro por agente para garantizar filtrado en backend
        let url = '/api/customers';
        try {
          const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
          if (userStr) {
            const user = JSON.parse(userStr);
            const params = new URLSearchParams();
            // Si el usuario es agente, forzar su propio agenteId
            if (user && user.role === 'agent') {
              const uid = user.id || user._id || user.userId || user.uid;
              if (uid) params.set('agenteId', uid.toString());
              else {
                const uname = user.username || user.name || user.fullName || user.nombre;
                if (uname) params.set('agente', uname.toString());
              }
            }
            // Para otros roles podr√≠amos permitir filtros desde UI; por ahora no forzamos nada
            const qs = params.toString();
            if (qs) url = `/api/customers?${qs}`;
          }
        } catch (e) {
          console.warn('No se pudo construir el filtro de agente:', e?.message);
        }

        // Hacer la petici√≥n al servidor (usar endpoint existente de customers)
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error al cargar los leads:', response.status, errorData);
          throw new Error(`Error ${response.status}: ${errorData.message || 'Error al cargar los leads'}`);
        }

        const data = await response.json();
        console.log('Datos de leads recibidos:', data);

        // Aceptar tanto { leads: [] } como [] directamente
        const leadsRaw = Array.isArray(data) ? data : (data && Array.isArray(data.leads) ? data.leads : []);
        if (!Array.isArray(leadsRaw)) {
          console.error('Formato de datos inesperado:', data);
          throw new Error('Formato de datos inesperado del servidor');
        }

        // Normalizar y guardar los leads para uso posterior
        const normalizedLeads = normalizeLeads(leadsRaw);
        window.ultimaListaLeads = normalizedLeads;

        // Actualizar la interfaz
        renderCostumerTable(normalizedLeads);
        updateSummaryCards(normalizedLeads);

        return normalizedLeads;
      } catch (error) {
        console.error('Error en fetchLeadsAgente:', error);
        mostrarMensajeSinDatos();
        return [];
      }
    }

    // Funci√≥n para manejar la ausencia de datos
    function mostrarMensajeSinDatos() {
      const tableBody = document.querySelector('#costumer-tbody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px;">
              <p>No se encontraron datos disponibles.</p>
              <p>Por favor, verifica tu conexi√≥n o contacta al administrador.</p>
            </td>
          </tr>
        `;
      }
      
      // Actualizar las tarjetas de resumen con valores en cero
      updateSummaryCards([]);
    }

    // Funci√≥n para cargar los datos iniciales
    async function cargarDatosIniciales() {
      console.log('[DEBUG] Iniciando cargarDatosIniciales...');
      // Mostrar indicador de carga si existe
      const loadingIndicator = document.getElementById('loading-indicator');
      
      try {
        console.log('[DEBUG] Iniciando carga de datos...');
        
        if (loadingIndicator) {
          console.log('[DEBUG] Mostrando indicador de carga');
          loadingIndicator.style.display = 'block';
        }
        
        // Cargar datos del servidor usando fetchLeadsAgente
        console.log('[DEBUG] Llamando a fetchLeadsAgente...');
        const leads = await fetchLeadsAgente();
        console.log('[DEBUG] fetchLeadsAgente completado, leads:', leads);
        
        if (leads && leads.length > 0) {
          console.log('[DEBUG] Datos de clientes cargados correctamente:', leads.length, 'registros');
          console.log('[DEBUG] Primer lead de ejemplo:', JSON.stringify(leads[0], null, 2));
          // No es necesario llamar a renderCostumerTable ni updateSummaryCards aqu√≠
          // porque ya se llaman dentro de fetchLeadsAgente
        } else {
          console.warn('[DEBUG] No se encontraron leads o el arreglo est√° vac√≠o');
          mostrarMensajeSinDatos();
        }
      } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        mostrarMensajeSinDatos();
      } finally {
        // Ocultar indicador de carga si existe
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }
    }
    


    // Manejar b√∫squeda
    document.getElementById('costumer-search').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#costumer-tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });

    // Funci√≥n para formatear fechas con el formato 'd√≠a_de_la_semana n√∫mero_del_d√≠a' (ej: 'mi√© 13')
    function formatearFechaSinDesfase(fechaStr) {
      try {
        let fecha;
        
        // Si la fecha ya es un objeto Date
        if (fechaStr instanceof Date) {
          fecha = fechaStr;
        } 
        // Si es un string, convertirlo a objeto Date
        else if (typeof fechaStr === 'string') {
          // Si ya est√° en formato YYYY-MM-DD, crear la fecha en UTC para evitar problemas de zona horaria
          if (/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
            const [year, month, day] = fechaStr.split('-').map(Number);
            fecha = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
          } else {
            // Para otros formatos, intentar convertir directamente
            fecha = new Date(fechaStr);
          }
        } else {
          console.warn('Tipo de fecha no soportado:', typeof fechaStr, fechaStr);
          return 'Fecha inv√°lida';
        }
        
        // Verificar si la fecha es v√°lida
        if (isNaN(fecha.getTime())) {
          console.warn('Fecha inv√°lida:', fechaStr);
          return 'Fecha inv√°lida';
        }
        
        // Obtener el d√≠a de la semana (0=domingo, 1=lunes, ..., 6=s√°bado)
        const diasSemana = ['dom', 'lun', 'mar', 'mi√©', 'jue', 'vie', 's√°b'];
        const diaSemana = diasSemana[fecha.getDay()];
        
        // Obtener el d√≠a del mes
        const diaMes = fecha.getDate();
        
        // Formatear como 'd√≠a_semana d√≠a_mes' (ej: 'mi√© 13')
        return `${diaSemana} ${diaMes}`;
        
      } catch (error) {
        console.error('Error al formatear fecha:', error, 'Valor:', fechaStr);
        return 'Fecha inv√°lida';
      }
    }
    
    // Helper (local): obtener rol actual normalizado
    // NOTA: Renombrado a getUserRole_local para no sobreescribir la versi√≥n global de script.js
    function getUserRole_local() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return (user.role || '').toString().trim().toLowerCase();
      } catch { return ''; }
    }

    // Helper (local): verificar si el usuario puede editar status (Administrador / B.O)
    // NOTA: Renombrado a canEditStatus_local para no sobreescribir la versi√≥n global de script.js
    function canEditStatus_local() {
      const r = getUserRole_local();
      // Aceptar variantes comunes desde frontend (referencial, no usada por la tabla)
      return ['admin','administrador','backoffice','b:o','b.o','b-o','bo'].includes(r);
    }

    // Helper: normalizar status hacia las 5 opciones y devolver etiqueta capitalizada
    function normalizeStatusLabel(s) {
      const allowed = ['pending','hold','cancelled','rescheduled','completed'];
      const v = (s || '').toString().trim();
      const lower = v.toLowerCase();
      const pick = allowed.includes(lower)
        ? lower
        : (v.toLowerCase().includes('pend') ? 'pending' : null) ||
          (v.toLowerCase().includes('hold') ? 'hold' : null) ||
          (v.toLowerCase().includes('cancel') ? 'cancelled' : null) ||
          (v.toLowerCase().includes('reprogram') || v.toLowerCase().includes('reagend') || v.toLowerCase().includes('resched') ? 'rescheduled' : null) ||
          (v.toLowerCase().includes('compl') || v.toLowerCase().includes('termin') ? 'completed' : null) ||
          'pending';
      return pick.charAt(0).toUpperCase() + pick.slice(1);
    }

    // Helper: clase de badge seg√∫n nuevo set de estados
    function statusToBadgeClass(label) {
      const lower = (label||'').toString().toLowerCase();
      if (lower === 'pending') return 'badge-warning';
      if (lower === 'hold') return 'badge-info';
      if (lower === 'cancelled') return 'badge-danger';
      if (lower === 'rescheduled') return 'badge-primary';
      if (lower === 'completed') return 'badge-success';
      return 'badge-info';
    }

    // Llamada al backend para actualizar el status (local)
    // NOTA: Renombrado a updateLeadStatusLocal para no sobreescribir la versi√≥n global de script.js
    async function updateLeadStatusLocal(selectEl, leadId) {
      try {
        // Validar ID antes de continuar
        if (!leadId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('No se pudo determinar el ID del lead. Recarga la p√°gina e int√©ntalo nuevamente.');
          return;
        }
        // Sanitizar y normalizar ID
        const cleanId = String(leadId).trim();
        if (!cleanId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('ID de lead vac√≠o o inv√°lido.');
          return;
        }
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          alert('No hay token de autenticaci√≥n. Inicia sesi√≥n nuevamente.');
          return;
        }
        const newVal = selectEl.value; // Etiqueta capitalizada
        // Deshabilitar durante la petici√≥n
        const prevDisabled = selectEl.disabled; selectEl.disabled = true;
        try {
          const url = `/api/leads/${encodeURIComponent(cleanId)}/status`;
          console.debug('[updateLeadStatus] PUT', { id: cleanId, url, status: newVal });
          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ status: newVal })
          });
          let data = {};
          try { data = await res.json(); } catch { data = {}; }
          if (!res.ok || !data?.success) {
            // Manejo espec√≠fico por c√≥digos comunes
            if (res.status === 401) throw new Error('No autorizado (401). Verifica el token de sesi√≥n.');
            if (res.status === 403) throw new Error('Permisos insuficientes (403). Solo admin/supervisor pueden actualizar.');
            if (res.status === 404) throw new Error(data?.message || 'Lead no encontrado (404). Verifica que el ID exista en la base de datos.');
            throw new Error(data?.message || `Error ${res.status || ''}: No se pudo actualizar el estado`);
          }
          // Actualizar badge visual si existe al lado del select
          const badge = selectEl.closest('td')?.querySelector('span.badge');
          if (badge) {
            badge.textContent = newVal;
            badge.className = `badge ${statusToBadgeClass(newVal)}`;
          }
        } catch(err) {
          console.error('Error al actualizar status:', err);
          alert(`Error: ${err.message}`);
          // Revertir valor si falla
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
        } finally {
          // Guardar nuevo previo
          selectEl.setAttribute('data-prev', selectEl.value);
          selectEl.disabled = prevDisabled;
        }
      } catch(e) {
        console.error(e);
      }
    }

    // Funci√≥n para renderizar la tabla de clientes
    function renderCostumerTable(leads) {
      console.log('renderCostumerTable llamada con leads:', leads);
      
      // Asegurarse de que leads sea un array
      const leadsArray = Array.isArray(leads) 
        ? leads 
        : (leads && leads.leads && Array.isArray(leads.leads)) 
          ? leads.leads 
          : [];
          
      console.log('Datos a renderizar (array):', leadsArray);
      
      const tbody = document.getElementById('costumer-tbody');
      console.log('Elemento tbody encontrado:', tbody);
      if (!tbody) {
        console.error('No se encontr√≥ el elemento con ID costumer-tbody');
        return;
      }
      
      tbody.innerHTML = '';
      console.log('Contenido de tbody limpiado');
      
      // Funci√≥n interna para a√±adir una fila de lead manteniendo el orden y estilos
      function appendLeadRow(lead) {
        const tr = document.createElement('tr');
        
        // Normalizar estado al conjunto requerido y su clase
        const statusLabel = normalizeStatusLabel(lead.status);
        const statusClass = statusToBadgeClass(statusLabel);
        const editable = canEditStatus();
        
        const fullComment = typeof lead.comentarios_venta === 'string' ? lead.comentarios_venta : '';
        const displayComment = fullComment ? (fullComment.length > 40 ? fullComment.substring(0, 40) + '...' : fullComment) : 'Ver comentarios';
        const titleAttr = fullComment ? escapeAttr(fullComment) : 'Ver comentarios';

        tr.innerHTML = `
          <td>${lead.nombre_cliente || 'N/A'}</td>
          <td>${lead.telefono_principal || 'N/A'}</td>
          <td>${lead.telefono_alterno || 'N/A'}</td>
          <td>${lead.numero_cuenta || 'N/A'}</td>
          <td>${lead.autopago || 'N/A'}</td>
          <td>${lead.direccion || 'N/A'}</td>
          <td>${lead.tipo_servicios || 'N/A'}</td>
          <td>${lead.sistema || 'N/A'}</td>
          <td>${lead.riesgo || 'N/A'}</td>
          <td>${lead.dia_venta ? formatearFechaSinDesfase(lead.dia_venta) : 'N/A'}</td>
          <td>${lead.dia_instalacion ? formatearFechaSinDesfase(lead.dia_instalacion) : 'N/A'}</td>
          <td>
            ${editable ? `
              <select class="status-select" data-prev="${statusLabel}" onchange="updateLeadStatus('${getLeadId(lead)}', this.value)" style="padding:6px 8px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; font-size:12px;">
                ${['Pending','Hold','Cancelled','Rescheduled','Completed'].map(opt => `
                  <option value="${opt.toLowerCase()}" ${opt===statusLabel?'selected':''}>${opt}</option>
                `).join('')}
              </select>
            ` : `
              <span class="badge ${statusClass}">${statusLabel}</span>
            `}
          </td>
          <td>${lead.servicios || 'N/A'}</td>
          <td>${lead.mercado || 'N/A'}</td>
          <td>${lead.supervisor || 'N/A'}</td>
          <td>${lead.comentario || 'N/A'}</td>
          <td>${lead.motivo_llamada || 'N/A'}</td>
          <td>${lead.zip_code || 'N/A'}</td>
          <td>${lead.puntaje || 'N/A'}</td>
          <td>
            <div style="display: flex; flex-direction: column; align-items: flex-start;">
              ${fullComment 
                ? `
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="new-comment-dot" style="display: inline-block; width: 8px; height: 8px; background-color: #3498db; border-radius: 50%;"></span>
                    <span title="${titleAttr}">${displayComment}</span>
                  </div>
                `
                : 'Sin comentarios'
              }
              <button 
                onclick="event.stopPropagation(); abrirComentarios('${getLeadId(lead)}')" 
                class="action-btn" 
                style="margin-top: 5px; padding: 2px 6px; font-size: 11px; align-self: flex-start;"
              >
                <i class="fas fa-comment"></i> ${lead.comentarios_venta ? 'Gestionar' : 'Agregar'}
              </button>
            </div>
          </td>
          <td>
            <button class="action-btn" title="Editar" onclick="editarLead('${getLeadId(lead)}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn" title="Eliminar" onclick="eliminarLead('${getLeadId(lead)}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Si es Irania, agrupar por supervisor con encabezados por agente
      if (typeof esIrania === 'function' && esIrania()) {
        // Agrupar
        const grupos = new Map();
        leadsArray.forEach(l => {
          const sup = (l && l.supervisor) ? l.supervisor : 'Sin asignar';
          if (!grupos.has(sup)) grupos.set(sup, []);
          grupos.get(sup).push(l);
        });

        // Orden por nombre de supervisor
        const clavesOrdenadas = Array.from(grupos.keys()).sort((a,b) => a.localeCompare(b, 'es', {sensitivity:'base'}));

        clavesOrdenadas.forEach(sup => {
          const headerTr = document.createElement('tr');
          const display = (typeof limpiarSupervisor === 'function') ? limpiarSupervisor(sup) : sup;
          headerTr.innerHTML = `
            <td colspan="21" style="background: #f0f4ff; color:#1f3a8a; font-weight:600; padding:10px 12px; border-top:2px solid #c7d2fe; border-bottom:1px solid #dbeafe;">
              <i class="fas fa-user" style="margin-right:8px;"></i> Agente: ${escapeHtml ? escapeHtml(display) : display}
            </td>
          `;
          tbody.appendChild(headerTr);
          grupos.get(sup).forEach(appendLeadRow);
        });
      } else {
        // Render plano por defecto
        leadsArray.forEach(appendLeadRow);
      }
    }

    // Funci√≥n para actualizar las tarjetas de resumen
    function updateSummaryCards(leads) {
      // Obtener referencias a los elementos del DOM primero
      const ventasHoyElement = document.getElementById('costumer-ventas-hoy');
      const ventasMesElement = document.getElementById('costumer-ventas-mes');
      const pendientesElement = document.getElementById('costumer-pendientes');
      const canceladosElement = document.getElementById('costumer-cancelados');
      
      // Establecer valores por defecto
      let ventasHoy = 0;
      let ventasMes = 0;
      let pendientes = 0;
      let cancelados = 0;
      
      // Verificar si hay datos para procesar
      if (!leads || !Array.isArray(leads) || leads.length === 0) {
        console.log('No hay datos para mostrar en los gr√°ficos');
      } else {
        console.log('Procesando estad√≠sticas con', leads.length, 'leads');
        
        const hoy = new Date();
        const diaActual = hoy.getDate();
        const mesActual = hoy.getMonth();
        const a√±oActual = hoy.getFullYear();
        
        console.log('Fecha actual:', hoy.toLocaleDateString());
        
        // Procesar cada lead
        leads.forEach(lead => {
          try {
            // Verificar si el lead tiene status (normalizado)
            const status = normalizarTexto(lead.status || '');
            
            // Contar pendientes
            if (status.includes('pendiente') || status.includes('pending')) {
              pendientes++;
            }
            
            // Contar cancelados (soportar variantes y subcadenas)
            if (
              status.includes('cancel') ||    // engloba canceled/cancelled/cancelado
              status.includes('anulad') ||    // espa√±ol alternativo
              status.includes('no instalado') // posibles estados combinados
            ) {
              cancelados++;
            }
            
            // Verificar fecha de venta
            if (lead.dia_venta) {
              const fechaVenta = new Date(lead.dia_venta);
              
              // Verificar ventas de hoy
              if (fechaVenta.getDate() === diaActual && 
                  fechaVenta.getMonth() === mesActual && 
                  fechaVenta.getFullYear() === a√±oActual) {
                ventasHoy++;
              }
              
              // Verificar ventas del mes
              if (fechaVenta.getMonth() === mesActual && 
                  fechaVenta.getFullYear() === a√±oActual) {
                ventasMes++;
              }
            }
          } catch (e) {
            console.error('Error procesando lead:', lead, e);
          }
        });
        
        console.log('Estad√≠sticas calculadas:', {
          ventasHoy,
          ventasMes,
          pendientes,
          cancelados
        });
      }
      
      // Actualizar el DOM con los valores calculados
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy:', ventasHoy);
      }
      
      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes:', ventasMes);
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes:', pendientes);
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados:', cancelados);
      }
      
      // Las variables de los elementos del DOM ya est√°n declaradas al inicio de la funci√≥n
      
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy en el DOM');
      }
      
      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes en el DOM');
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes en el DOM');
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados en el DOM');
      }
      
      // Datos para el gr√°fico de ventas por semana
      const ultimos7Dias = Array.from({ length: 7 }, (_, i) => {
        const fecha = new Date();
        fecha.setDate(fecha.getDate() - (6 - i));
        return fecha.toISOString().split('T')[0];
      });

      // Etiquetas: d√≠as de la semana
      const diasSemanaEtiquetas = ['dom', 'lun', 'mar', 'mi√©', 'jue', 'vie', 's√°b'];
      const labelsDias = ultimos7Dias.map(f => {
        const d = new Date(f + 'T12:00:00');
        return diasSemanaEtiquetas[d.getDay()];
      });

      const ventasPorDia = ultimos7Dias.map(fechaISO => {
        return leads.filter(lead => getDateFromLead(lead) === fechaISO).length;
      });

      // Puntaje total por d√≠a (no promedio)
      const puntajesPorDia = ultimos7Dias.map(fechaISO => {
        return leads.reduce((sum, lead) => {
          if (getDateFromLead(lead) === fechaISO) {
            return sum + (parseFloat(lead.puntaje) || 0);
          }
          return sum;
        }, 0);
      });
      
      // Datos para el gr√°fico de distribuci√≥n por producto
      const productos = {};
      leads.forEach(lead => {
        const producto = lead.tipo_servicios || 'Sin especificar';
        productos[producto] = (productos[producto] || 0) + 1;
      });
      
      const etiquetasProductos = Object.keys(productos);
      const datosProductos = Object.values(productos);
      
      // Colores para los productos
      const coloresProductos = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
        '#858796', '#5a5c69', '#3a3b45', '#1a1a1a', '#000000'
      ].slice(0, etiquetasProductos.length);
      
      // Renderizar o actualizar los gr√°ficos
      if (typeof renderizarGraficoVentas === 'function' && typeof renderizarGraficoProductos === 'function') {
        // Enviar etiquetas de d√≠as de la semana para la gr√°fica superior
        renderizarGraficoVentas(labelsDias, ventasPorDia, puntajesPorDia);
        renderizarGraficoProductos(etiquetasProductos, datosProductos, coloresProductos);
      }
    }

    // Funciones de ejemplo para editar/eliminar
    function editarLead(id) {
      console.log('Editar lead:', id);
      // Implementar l√≥gica de edici√≥n
    }

    function eliminarLead(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
        console.log('Eliminar lead:', id);
        // Implementar l√≥gica de eliminaci√≥n
      }
    }
  </script>
  <!-- Cargar primero el m√≥dulo de datos de clientes -->
  <script src="js/data/costumer-mock-data.js"></script>
  <script>
    // Funci√≥n para mostrar mensajes de depuraci√≥n
    function debugLog(message, data) {
      if (data !== undefined) {
        console.log(`[DEBUG] ${message}`, data);
      } else {
        console.log(`[DEBUG] ${message}`);
      }
    }

    // Helpers para UI de comentarios
    function escapeHtml(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      } catch { return ''; }
    }

    function normalizarTexto(s) {
      try {
        return String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu, '')
          .trim();
      } catch { return ''; }
    }

    function obtenerIniciales(nombre) {
      const n = String(nombre || '').trim();
      if (!n) return '?';
      const parts = n.split(/\s+/);
      const first = parts[0]?.[0] || '';
      const last = parts.length > 1 ? parts[parts.length - 1]?.[0] : '';
      return (first + last).toUpperCase();
    }

    function obtenerUsuarioActual() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return user.name || user.nombre || user.email || user.username || 'Yo';
      } catch {
        return 'Yo';
      }
    }

    // Funci√≥n para inicializar la p√°gina
    function initPage() {
      debugLog('Inicializando p√°gina...');
      cargarInfoUsuario();
    }
    // Funci√≥n para cargar la informaci√≥n del usuario
    function cargarInfoUsuario() {
      debugLog('Iniciando cargarInfoUsuario');
      
      try {
        // Datos de usuario de ejemplo
        const userData = {
          name: 'Usuario Demo',
          role: 'admin',
          email: 'demo@example.com'
        };
        
        debugLog('Datos de usuario a mostrar:', userData);
        
        // Actualizar la interfaz con los datos del usuario
        if (userData.name) {
          const userNameElement = document.getElementById('sidebar-user-name');
          debugLog('Elemento de nombre de usuario encontrado:', !!userNameElement);
          if (userNameElement) {
            debugLog('Actualizando nombre de usuario a:', userData.name);
            userNameElement.textContent = userData.name;
            userNameElement.style.color = '#2d3748'; // Asegurar que el color sea visible
            debugLog('Nombre de usuario actualizado correctamente');
          } else {
            debugLog('No se encontr√≥ el elemento sidebar-user-name');
          }
        }
        
        if (userData.role) {
          const userRoleElement = document.getElementById('sidebar-user-role');
          debugLog('Elemento de rol de usuario encontrado:', !!userRoleElement);
          if (userRoleElement) {
            // Formatear el rol para mostrarlo mejor
            const roleNames = {
              'admin': 'Administrador',
              'supervisor': 'Supervisor',
              'agent': 'Agente'
            };
            const rolMostrado = roleNames[userData.role] || userData.role;
            debugLog('Actualizando rol de usuario a:', rolMostrado);
            userRoleElement.textContent = rolMostrado;
            userRoleElement.style.display = 'inline-block'; // Asegurar que sea visible
            debugLog('Rol de usuario actualizado correctamente');
          } else {
            debugLog('No se encontr√≥ el elemento sidebar-user-role');
          }
        }
      } catch (error) {
        console.error('Error en cargarInfoUsuario:', error);
      }
    }

    // Configurar bot√≥n de cerrar sesi√≥n y cargar info del usuario
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM completamente cargado, inicializando p√°gina...');
      // Inicializar la p√°gina
      initPage();
      
      // Cargar datos iniciales
      cargarDatosIniciales();
      
      // Configurar bot√≥n de cerrar sesi√≥n
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          // Redirigir a la p√°gina de inicio de sesi√≥n
          window.location.href = 'index.html';
        });
      }
    });
  </script>
  
  <!-- Script de cierre de sesi√≥n unificado -->
  <script src="js/auth-logout.js"></script>
</body>
</html>

