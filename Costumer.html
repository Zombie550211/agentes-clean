<!DOCTYPE html>
v   <html lang="es">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>CRM Agente - Costumer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/costumer-table-clean.css">
  <link rel="stylesheet" href="css/costumer-table-actions.css">
  <link rel="stylesheet" href="css/costumer-table-comments.css">`n  <link rel="stylesheet" href="css/costumer-calendar.css">
  <link rel="stylesheet" href="css/sidebar-shared.css">
  <!-- Guard temporal ANTES de cargar scripts: bloquear redirecciones a inicio -->
  <script>
    // Sincronizar barra espejo con la tabla
    (function(){
      function initMirror(){
        const wrap = document.querySelector('.table-responsive');
        const table = document.querySelector('.costumer-table');
        const mirror = document.getElementById('scrollbarMirror');
        const inner = document.getElementById('scrollbarMirrorInner');
        if(!wrap || !table || !mirror || !inner) return;
        const updateWidth = () => {
          const scrollW = Math.max(table.scrollWidth, 1);
          inner.style.width = scrollW + 'px';
          mirror.scrollLeft = wrap.scrollLeft;
        };
        // Sticky header builder
        function rebuildStickyHead(){
          try{
            const container = document.querySelector('.costumer-table-container');
            if(!container || !table) return;
            // remove previous
            const prev = container.querySelector('.sticky-head-wrapper');
            if(prev) prev.remove();
            // create wrapper and cloned head
            const head = table.querySelector('thead');
            if(!head) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'sticky-head-wrapper';
            const headTable = document.createElement('table');
            headTable.className = 'costumer-table';
            const clonedHead = head.cloneNode(true);
            headTable.appendChild(clonedHead);
            wrapper.appendChild(headTable);
            // insert before scrollable wrap
            container.insertBefore(wrapper, wrap);
            // match column widths
            const origTh = Array.from(head.querySelectorAll('th'));
            const cloneTh = Array.from(clonedHead.querySelectorAll('th'));
            const widths = origTh.map(th => th.getBoundingClientRect().width);
            cloneTh.forEach((th,i)=>{ const w = widths[i]||160; th.style.minWidth = w+'px'; th.style.maxWidth = w+'px'; th.style.width = w+'px'; });
            // ajustar ancho visible del wrapper al del contenedor con scroll
            const adjustWrapper = ()=>{ wrapper.style.width = wrap.clientWidth + 'px'; };
            adjustWrapper();
            // sync horizontal scroll con transform para evitar saltos
            const sync = ()=>{ headTable.style.transform = 'translateX(' + (-wrap.scrollLeft) + 'px)'; };
            sync();
            wrap.removeEventListener('scroll', sync); // prevent duplicates
            wrap.addEventListener('scroll', sync, { passive:true });
            window.addEventListener('resize', adjustWrapper, { passive:true });
          }catch(e){ console.warn('[StickyHead] error:', e?.message); }
        }
        // expose globally to re-run after rendering
        window.rebuildStickyHead = rebuildStickyHead;

    // Edición por clave local cuando el lead no tiene _id/id (por ejemplo, datos inyectados temporalmente)
    window.editarLeadKey = function(key) {
      try {
        if (!key) { alert('Error: No se proporcionó clave local'); return; }
        const map = window.__leadKeyMap instanceof Map ? window.__leadKeyMap : null;
        if (!map || !map.has(key)) { alert('Error: No se encontró el registro local'); return; }
        const lead = map.get(key);
        abrirModalEdicion(lead);
      } catch (e) {
        console.error('editarLeadKey error:', e);
        alert('Error al abrir el registro local: ' + (e?.message || e));
      }
    };
        const sync = (src, dst) => () => { dst.scrollLeft = src.scrollLeft; };
        wrap.addEventListener('scroll', sync(wrap, mirror));
        mirror.addEventListener('scroll', sync(mirror, wrap));
        // Botones de desplazamiento
        const btnL = document.getElementById('scroll-left');
        const btnR = document.getElementById('scroll-right');
        const step = 400; // px por clic
        if (btnL) btnL.addEventListener('click', ()=>{ wrap.scrollLeft = Math.max(0, wrap.scrollLeft - step); });
        if (btnR) btnR.addEventListener('click', ()=>{ wrap.scrollLeft = Math.min(wrap.scrollWidth, wrap.scrollLeft + step); });
        // Rueda del mouse/trackpad: forzar desplazamiento horizontal
        wrap.addEventListener('wheel', (e) => {
          try {
            const horiz = Math.abs(e.deltaX) > Math.abs(e.deltaY);
            if (horiz || e.shiftKey) {
              e.preventDefault();
              wrap.scrollLeft += (horiz ? e.deltaX : e.deltaY);
            }
          } catch {}
        }, { passive: false });
        // Drag to scroll (click y arrastrar)
        let isDown = false, startX = 0, startLeft = 0;
        wrap.addEventListener('mousedown', (e) => {
          isDown = true; startX = e.pageX; startLeft = wrap.scrollLeft; wrap.classList.add('grabbing');
        });
        window.addEventListener('mouseup', () => { isDown = false; wrap.classList.remove('grabbing'); });
        window.addEventListener('mousemove', (e) => {
          if (!isDown) return; e.preventDefault();
          const dx = e.pageX - startX; wrap.scrollLeft = startLeft - dx;
        });
        window.addEventListener('resize', updateWidth);
        // Evitar 'ResizeObserver loop' usando requestAnimationFrame y un flag de pendiente
        let __roPending = false;
        const roSafeCallback = () => {
          if (__roPending) return;
          __roPending = true;
          requestAnimationFrame(() => { try { updateWidth(); } finally { __roPending = false; } });
        };
        const ro = window.ResizeObserver ? new ResizeObserver(roSafeCallback) : null;
        if (ro) ro.observe(table);
        updateWidth();
        // build once
        rebuildStickyHead();
      }
      window.addEventListener('DOMContentLoaded', initMirror);
    })();
  </script>
  <script>
    // Mostrar scroll vertical solo cuando el puntero está sobre el sidebar
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.querySelector('.sidebar');
      if (!sidebar) return;
      document.body.classList.add('hide-main-scroll');
      sidebar.addEventListener('mouseenter', () => {
        document.body.classList.add('show-main-scroll');
        document.body.classList.remove('hide-main-scroll');
      });
      sidebar.addEventListener('mouseleave', () => {
        document.body.classList.add('hide-main-scroll');
        document.body.classList.remove('show-main-scroll');
      });
    });
  </script>
  <script>
    // Auto-ocultar sidebar y mostrarlo al pasar por el borde izquierdo
    document.addEventListener('DOMContentLoaded', () => {
      // Añadir clase global para activar el modo auto-hide
      document.body.classList.add('auto-hide-sidebar');

      // Insertar zona de hover si no existe
      if (!document.querySelector('.sidebar-hover-zone')) {
        const zone = document.createElement('div');
        zone.className = 'sidebar-hover-zone';
        document.body.appendChild(zone);
      }

      const zone = document.querySelector('.sidebar-hover-zone');
      const sidebar = document.querySelector('.sidebar');
      let hideTO = null;

      const show = () => {
        clearTimeout(hideTO);
        document.body.classList.add('show-sidebar');
      };
      const scheduleHide = () => {
        clearTimeout(hideTO);
        hideTO = setTimeout(() => {
          document.body.classList.remove('show-sidebar');
        }, 200); // pequeño delay para evitar parpadeos
      };

      zone?.addEventListener('mouseenter', show);
      zone?.addEventListener('mouseleave', scheduleHide);
      sidebar?.addEventListener('mouseenter', show);
      sidebar?.addEventListener('mouseleave', scheduleHide);
    });
  </script>
  
  <script>
    // Renderizador con soporte Team Líneas
    (function(){
      function isTeamLineas(){
        try{
          const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
          const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();
          
          // Debug: mostrar valores para diagnosticar
          console.log('[Team Líneas Debug] role:', role, 'username:', username, 'body.team-lineas:', document.body.classList.contains('team-lineas'));
          
          // Detectar Team Líneas por múltiples criterios
          const isTeam = document.body.classList.contains('team-lineas') || 
                        role==='teamlineas' || 
                        username.startsWith('lineas-') ||
                        username.includes('lineas') ||
                        role.includes('lineas');
          
          console.log('[Team Líneas Debug] Resultado:', isTeam);
          return isTeam;
        }catch(e){ 
          console.warn('[Team Líneas Debug] Error:', e);
          return false; 
        }
      }
      function maskPin(v){
        const s = String(v || '');
        return s ? '•'.repeat(Math.min(4, s.length)) : '';
      }
      function serviciosResumen(l){
        const arr = Array.isArray(l.telefonos)? l.telefonos:[];
        if(arr.length){ const m=new Map(); arr.forEach(t=>{ const k=(t?.servicio||t?.tipo||'').toString().trim()||'SERVICIO'; m.set(k,(m.get(k)||0)+1);}); return [...m.entries()].map(([k,v])=> v>1?`${k} x${v}`:k).join('; '); }
        return l.servicios_texto||l.tipo_servicios||l.servicios||l.producto||'';
      }
      // normDate ahora se carga desde js/date-formatter.js
      function teamHeader(){ return ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÓN','DÍA DE VENTA','DÍA DE INSTALACIÓN','STATUS','CANTIDAD DE LÍNEAS','TELÉFONOS DE LAS LÍNEAS','ID','SUPERVISOR','MERCADO']; }
      // Normalización de nombres de agente (alias -> canónico)
      function __normStrAgent(s){
        try {
          return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/\s+/g,'').replace(/\./g,'');
        } catch { return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
      }
      function agentCanonicalName(name){
        const n = __normStrAgent(name);
        const map = {
          'eduardor': 'Eduardo Rivas',
          'eduardorivas': 'Eduardo Rivas',
          'eduardorrivas': 'Eduardo Rivas',
          'alexanderhernandez': 'Riquelmi Torres',
          'julioMejia': 'Julio Chavez',
          'juliomejia': 'Julio Chavez'
        };
        return map[n] || (name || '');
      }
      function agentName(l){
        const raw = l.agenteNombre||l.nombreAgente||l.agente||l.agent||l.ownerName||l.vendedor||l.seller||'';
        return agentCanonicalName(raw);
      }
      function applyHeader(){ const thead=document.querySelector('.costumer-table thead'); if(!thead) return; const hs=teamHeader(); thead.innerHTML=`<tr>${hs.map(h=>`<th>${h}</th>`).join('')}</tr>`; }
      function renderRows(list){ const tbody=document.getElementById('costumer-tbody'); if(!tbody) return; tbody.innerHTML=''; (list||[]).forEach(l=>{ const autop=(l.autopay??l.autopago); const autopTxt=typeof autop==='boolean'?(autop?'Sí':'No'):(String(autop||'').toUpperCase()==='SI'?'Sí':(String(autop||'').toUpperCase()==='NO'?'No':String(autop||''))); const cant=(l.cantidad_lineas!=null)?l.cantidad_lineas:(Array.isArray(l.telefonos)?l.telefonos.length:''); const cells=[ l.nombre_cliente||'', l.telefono_principal||'', l.numero_cuenta||'', autopTxt||'', maskPin(l.pin_seguridad)||'', l.direccion||'', normDate(l.dia_venta||l.fecha_contratacion||l.fecha||''), normDate(l.dia_instalacion||''), (l.status||'').toString().toUpperCase(), cant||'', serviciosResumen(l)||'', (l.id_cliente||l._id||l.id||''), l.supervisor||'', l.mercado||'' ]; const tr=document.createElement('tr'); tr.innerHTML=cells.map(v=>`<td>${v==null?'':v}</td>`).join(''); tbody.appendChild(tr); }); }
      // Guardar referencia al renderizador anterior
      const originalRenderer = window.renderCostumerTable;
      
      // Sobrescribir con nuestro renderizador Team Líneas
      window.renderCostumerTable = function(leads){ 
        console.log('[Team Líneas] Interceptando renderCostumerTable, leads:', leads?.length || 0);
        try{ 
          if(isTeamLineas()){ 
            console.log('[Team Líneas] Aplicando vista Team Líneas');
            applyHeader(); 
            const arr = Array.isArray(leads)?leads:(Array.isArray(leads?.leads)?leads.leads:[]); 
            renderRows(arr); 
            return; 
          } 
        }catch(e){ 
          console.warn('[Team Líneas render] error', e);
        } 
        
        // Si no es Team Líneas, usar renderizador original
        if(typeof originalRenderer==='function'){ 
          console.log('[Team Líneas] Usando renderizador original');
          return originalRenderer(leads);
        }
      };
    })();
  </script>
  <script>
    (function(){
      try {
        const blockMs = 12000; // ventana de protección ampliada
        const isInicio = (u) => {
          try {
            const s = (u||'').toString().toLowerCase();
            return s.includes('/inicio.html') || s.endsWith('inicio.html');
          } catch { return false; }
        };
        const origAssign = window.location.assign ? window.location.assign.bind(window.location) : null;
        const origReplace = window.location.replace ? window.location.replace.bind(window.location) : null;
        const origHrefDesc = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
        if (origAssign) window.location.assign = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio'); return; } return origAssign(u); };
        if (origReplace) window.location.replace = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio'); return; } return origReplace(u); };
        if (origHrefDesc && origHrefDesc.set) {
          Object.defineProperty(window.location, 'href', {
            configurable: true,
            get: origHrefDesc.get ? origHrefDesc.get.bind(window.location) : function(){ return document.URL; },
            set: function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio (href)'); return; } return origHrefDesc.set.call(window.location, u); }
          });
        }
        // Interceptar document.location y parent/top
        try { Object.defineProperty(document, 'location', { configurable: true, get: () => window.location, set: v => { if (!isInicio(v)) window.location.href = v; else console.warn('[Costumer] Bloqueada redirección via document.location'); } }); } catch {}
        try { if (window.top && window.top.location) { const t = window.top.location; const oa = t.assign?.bind(t); if (oa) t.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.assign bloqueado'); oa(u); }; const orp = t.replace?.bind(t); if (orp) t.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.replace bloqueado'); orp(u); }; } } catch {}
        try { if (window.parent && window.parent.location) { const p = window.parent.location; const pa = p.assign?.bind(p); if (pa) p.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.assign bloqueado'); pa(u); }; const pr = p.replace?.bind(p); if (pr) p.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.replace bloqueado'); pr(u); }; } } catch {}
        // Interceptar history
        try {
          const hps = history.pushState.bind(history);
          history.pushState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] pushState a inicio bloqueado'); return; } return hps(state, title, url); };
          const hrs = history.replaceState.bind(history);
          history.replaceState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] replaceState a inicio bloqueado'); return; } return hrs(state, title, url); };
        } catch {}
        // Eliminar meta refresh a inicio si existiera
        try { document.querySelectorAll('meta[http-equiv="refresh"]').forEach(m=>{ const c=(m.getAttribute('content')||'').toLowerCase(); if (c.includes('inicio.html')) { m.parentNode.removeChild(m); console.warn('[Costumer] meta refresh eliminado'); } }); } catch{}
        setTimeout(function(){
          try { if (origAssign) window.location.assign = origAssign; } catch{}
          try { if (origReplace) window.location.replace = origReplace; } catch{}
          try { if (origHrefDesc) Object.defineProperty(window.location, 'href', origHrefDesc); } catch{}
        }, blockMs);
      } catch(e){ console.warn('[Costumer] Guard no pudo instalarse:', e); }
    })();
  </script>
  <!-- Protección de autenticación en frontend -->

  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="js/sidebar-loader.js"></script>
  <!-- <script src="js/monthly-cutoff.js"></script> -->
  <!-- Date Formatter - DEBE CARGARSE ANTES DE TEAMS.JS -->
  <!-- <script src="js/date-formatter.js?v=20251024"></script> -->
  <!-- Teams API: definición de equipos, supervisores y agentes -->
  <script src="utils/teams.js?v=20251024b"></script>
  <style>
    /* Estilos del sidebar unificados en css/sidebar-shared.css */
    /* Nota: Estilos del bloque de usuario del sidebar se definen en css/sidebar-inicio.css
       (clases: .sidebar.sidebar-inicio .user-info, .avatar, .user-name, .user-role). */

    /* Estilos generales */
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --border: #e0e0e0;
      --background: #f5f7fa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Ocultar scrollbar vertical principal por defecto y mostrar solo al pasar por la barra lateral */
    body.hide-main-scroll { overflow-y: hidden; }
    body.hide-main-scroll::-webkit-scrollbar { width: 0; height: 0; }
    body.show-main-scroll { overflow-y: auto; }

    .container {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      position: relative;
      top: 0;
    }

    /* ===== AUTO-HIDE SIDEBAR ===== */
    :root { --sidebar-width: 240px; --sidebar-peek: 12px; }
    .sidebar {
      transition: transform 0.25s ease-in-out;
      will-change: transform;
      z-index: 100;
    }
    /* Estado colapsado por defecto */
    body.auto-hide-sidebar .sidebar {
      transform: translateX(calc(var(--sidebar-width) * -1 + var(--sidebar-peek)));
    }
    /* Mostrar al activar (hover en zona izquierda) */
    body.auto-hide-sidebar.show-sidebar .sidebar {
      transform: translateX(0);
    }
    /* Zona sutil para detectar hover y mostrar el sidebar */
    .sidebar-hover-zone {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-peek);   /* ancho mínimo para activar */
      height: 100vh;
      z-index: 150;
      cursor: ew-resize;
    }
    /* Evitar que el contenido principal quede tapado por la zona */
    .sidebar-hover-zone { pointer-events: auto; }
    /* Desactivar auto-hide en pantallas pequeñas */
    @media (max-width: 900px) {
      body.auto-hide-sidebar .sidebar { transform: translateX(0); }
      .sidebar-hover-zone { display: none; }
    }

    /* Estilos para el contenido principal */
    .main-content {
      padding: 30px;
      min-height: 100vh;
      background-color: #f8fafc;
      position: relative;
      transition: margin-left 0.25s ease-in-out;
    }

    /* Expandir contenido cuando el sidebar esté oculto */
    body.auto-hide-sidebar .main-content {
      margin-left: calc(var(--sidebar-peek) + 8px) !important;
    }
    /* Restaurar margen cuando el sidebar esté mostrado */
    body.auto-hide-sidebar.show-sidebar .main-content {
      margin-left: var(--sidebar-width) !important;
    }
    
    /* Estilos para el men¨² desplegable */
    .has-submenu {
      position: relative;
    }
    
    .submenu {
      display: none;
      padding-left: 20px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-in-out;
    }
    
    .submenu.active {
      display: block;
      max-height: 200px;
    }
    
    .submenu li {
      margin: 0;
    }
    
    .submenu a {
      padding: 10px 15px 10px 30px !important;
      font-size: 0.9em !important;
      opacity: 0.9;
    }
    
    .submenu a:hover {
      background: rgba(34, 179, 236, 0.2) !important;
      transform: none !important;
      padding-left: 35px !important;
    }
    
    .submenu-toggle {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    
    .submenu-icon {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      margin-left: 5px;
    }
    
    .has-submenu.active .submenu-icon {
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      background-color: var(--background);
      min-height: 100vh;
      position: relative;
    }

    /* Estilos para las tarjetas de resumen */
    .summary-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin: 0;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .summary-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    
    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-content {
      padding: 20px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #4a5568;
      margin: 0;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #718096;
    }
    
    .card-footer i {
      margin-right: 6px;
    }
    
    /* Estilos espec¨ªficos para cada tarjeta */
    .sales-today .card-icon {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
    }
    
    .sales-month .card-icon {
      background: linear-gradient(135deg, #2196f3, #42a5f5);
    }
    
    .pending .card-icon {
      background: linear-gradient(135deg, #ff9800, #ffa726);
    }
    
    .cancelled .card-icon {
      background: linear-gradient(135deg, #f44336, #ef5350);
    }
    
    /* Estilos para la tabla de clientes */
    .costumer-table-container {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(2, 8, 20, 0.06);
      /* No ocultar overflow para no cortar la barra de scroll horizontal del contenedor interno */
      overflow: visible;
      margin-top: 24px;
      border: 1px solid #e6eef5;
      max-width: 100%;
      /* Fijar el ¨¢rea de tabla para que solo el listado haga scroll */
      display: flex;
      flex-direction: column;
      /* Ajusta el valor seg¨²n tu layout (altura visible menos tarjetas/m¨¢rgenes) */
      height: calc(100vh - 280px);
    }
    
    .table-responsive {
      width: 100%;
      /* Scroll horizontal y vertical dentro del contenedor de tabla */
      overflow-x: scroll; /* fuerza a mostrar barra horizontal */
      -webkit-overflow-scrolling: touch;
      /* Permitir scroll vertical SOLO dentro del listado */
      overflow-y: auto;
      flex: 1 1 auto;
      position: relative;
      /* Reservar espacio para que la barra sea visible en Windows/macOS */
      padding-bottom: 10px;
      scrollbar-gutter: stable both-edges;
      /* Forzar que el scrollbar sea visible (Firefox/Edge/Chromium) */
      scrollbar-width: auto; /* Firefox */
    }

    /* Estilos de scrollbar (WebKit/Blink) */
    .table-responsive::-webkit-scrollbar { height: 10px; }
    .table-responsive::-webkit-scrollbar-track { background: #eef2f7; }
    .table-responsive::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    .table-responsive::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Barra espejo dentro del contenedor de la tabla */
    .scrollbar-mirror {
      height: 18px;
      overflow-x: scroll;
      overflow-y: hidden;
      background: #e5e7eb;
      border-top: 1px solid #cbd5e1;
      position: sticky; /* pegada al borde inferior del card */
      bottom: 0;
      z-index: 11;
      margin-top: 6px;
    }
    .scrollbar-mirror::-webkit-scrollbar { height: 12px; }
    .scrollbar-mirror::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    .scrollbar-mirror::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    /* Sticky header wrapper (deshabilitado) */
    .sticky-head-wrapper { display: none; }
    .sticky-head-wrapper table { border-collapse: separate; border-spacing: 0; width: max-content; background: #fff; }
    
    .costumer-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .costumer-table-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }
    
    .costumer-table-actions {
      display: flex;
      gap: 12px;
    }
    
    .costumer-filter-input {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 250px;
    }
    
    .costumer-filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .costumer-table {
      /* Forzar overflow horizontal en todos los casos */
      width: 6000px !important;
      min-width: 6000px !important;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed; /* respetar anchos y min-width de columnas */
      background: #fff;
    }
    
    .costumer-table th,
    .costumer-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      white-space: nowrap; /* no permitir salto de línea, así se conserva el ancho */
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 240px; /* ampliar base por columna para provocar overflow */
      max-width: 360px;
      vertical-align: middle;
      font-size: 14px;
      color: #334155;
    }

    /* ===== Columnas compactas específicas ===== */
    /* Dirección = columna 6 */
    .costumer-table th:nth-child(6),
    .costumer-table td:nth-child(6) {
      max-width: 180px;
      min-width: 120px;
      padding: 4px 6px;
      font-size: 12.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Status = columna 9 */
    .costumer-table th:nth-child(9),
    .costumer-table td:nth-child(9) {
      width: 1% !important;           /* que tome solo el espacio del contenido */
      min-width: 70px !important;
      padding: 2px 4px !important;
      text-align: left !important;
      white-space: nowrap !important;
    }
    /* Si existe badge de status, hacerlo compacto */
    .costumer-table td:nth-child(9) .status-badge,
    .costumer-table td:nth-child(9) .badge-status {
      display: inline-block;
      padding: 2px 6px !important;
      font-size: 11.5px !important;
      line-height: 1.1;
      border-radius: 9px;
      font-weight: 700;
      width: auto; /* que se ajuste al texto */
      max-width: 100%;
    }

    /* Select de STATUS: pequeño y ajustado al texto */
    .costumer-table td:nth-child(9) select {
      width: auto !important;
      min-width: 84px;
      max-width: 160px;
      padding: 2px 6px !important;
      font-size: 12px !important;
      line-height: 1.2 !important;
      display: inline-block;
    }

    /* Forzar estilo por clase (más específico y robusto) */
    .costumer-table .status-col { padding: 2px 4px !important; text-align: left; width: 1% !important; white-space: nowrap !important; }
    .costumer-table .status-select {
      width: -moz-fit-content !important;
      width: fit-content !important;
      display: inline-flex !important;
      padding: 2px 6px !important;
      font-size: 12px !important;
      line-height: 1.2 !important;
      min-width: 72px;
      max-width: 140px;
    }

    /* Versión aún más compacta cuando el contenedor está en modo compacto */
    .costumer-table-container.compact .costumer-table th:nth-child(6),
    .costumer-table-container.compact .costumer-table td:nth-child(6) {
      max-width: 160px;
      min-width: 100px;
      font-size: 12px;
      padding: 4px 5px;
    }
    .costumer-table-container.compact .costumer-table th:nth-child(9),
    .costumer-table-container.compact .costumer-table td:nth-child(9) {
      width: auto !important;
      min-width: 70px !important;
      padding: 3px 5px !important;
    }
    .costumer-table-container.compact .costumer-table td:nth-child(9) .status-badge,
    .costumer-table-container.compact .costumer-table td:nth-child(9) .badge-status {
      padding: 2px 6px;
      font-size: 11.5px;
      border-radius: 9px;
    }

    .costumer-table-container.compact .costumer-table td:nth-child(9) select {
      min-width: 72px;
      max-width: 120px;
      padding: 2px 5px !important;
      font-size: 11.5px !important;
    }

    /* ===== MODO COMPACTO (sin scroll horizontal) ===== */
    .costumer-table-container.compact .table-responsive {
      overflow-x: hidden; /* ocultar barra horizontal */
    }
    .costumer-table-container.compact .costumer-table {
      width: 100% !important;
      min-width: 0 !important;
      table-layout: auto; /* que se ajuste al contenido */
    }
    .costumer-table-container.compact .costumer-table th,
    .costumer-table-container.compact .costumer-table td {
      white-space: normal;  /* permitir saltos de línea */
      word-break: break-word;
      text-overflow: clip;
      min-width: auto;
      max-width: none;
      padding: 8px 10px;    /* reducir padding */
      font-size: 13px;      /* más compacto */
    }
    
    /* Encabezado: sticky solo en las celdas th */
    .costumer-table thead { position: static; }
    .costumer-table thead tr { position: static; }
    .costumer-table th {
      background: linear-gradient(180deg, #f9fbff 0%, #f3f6fb 100%);
      font-weight: 600;
      color: #1f2937;
      position: sticky !important;
      top: 0;
      z-index: 50; /* por encima de separadores y filas */
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.04em;
      border-bottom: 1px solid #e6eef5;
      background-clip: padding-box;
      background: #f7fafc;
    }
    /* Evitar que separadores tapen el header */
    .costumer-table tr.costumer-month-separator td { position: relative; z-index: 1; }

    /* removed sticky-head-wrapper override: se usa solo thead sticky nativo */

    /* Acomodar últimas columnas para evitar cortes de palabra en encabezados */
    /* Orden final esperado: ... | ZIP CODE | PUNTAJE | COMENTARIOS | ACCIÓN */
    .costumer-table th:nth-last-child(4) { min-width: 110px; white-space: nowrap; }
    .costumer-table th:nth-last-child(3) { min-width: 100px; white-space: nowrap; }
    .costumer-table th:last-child      { min-width: 110px; white-space: nowrap; text-align: center; }
    /* Celdas correspondientes */
    .costumer-table td:nth-last-child(4) { min-width: 110px; white-space: nowrap; }
    .costumer-table td:nth-last-child(3) { min-width: 100px; white-space: nowrap; text-align: center; }
    .costumer-table td:last-child       { min-width: 110px; white-space: nowrap; text-align: center; }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    /* Separador mensual */
    .costumer-table tr.costumer-month-separator td {
      background-color: #e2e8f0 !important;
      color: #0f172a !important;
      font-weight: 700;
      padding: 12px 18px;
      border-top: 2px solid #cbd5e1;
      border-bottom: 1px solid #cbd5e1;
      border-left: 4px solid #1976d2;
      text-transform: none;
    }
    
    .costumer-table th {
      text-align: left;
      padding: 14px 18px;
      white-space: nowrap;
    }
    
    .costumer-table td {
      padding: 14px 18px;
      border-bottom: 1px solid #eef2f7;
      color: #334155;
      background-color: #fff;
      /* Evita que el contenido se parta en varias líneas y fuerza overflow horizontal */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Zebra striping */
    .costumer-table tbody tr:nth-child(even) td {
      background-color: #fbfdff;
    }

    /* Hover sin l¨ªneas laterales */
    .costumer-table tbody tr:hover td {
      background-color: #f6fafe;
      box-shadow: none;
    }
    
    .costumer-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success {
      background-color: #e6f7ed;
      color: #10b981;
    }
    
    .badge-warning {
      background-color: #fffbeb;
      color: #f59e0b;
    }
    
    .badge-danger {
      background-color: #fdecea;
      color: #e53935;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background-color: #f1f5f9;
      color: var(--primary);
    }
    
    .action-btn i {
      font-size: 16px;
    }

    /* Toggle para modo compacto */
    .action-btn.toggle {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px 10px;
      color: #475569;
      background: #fff; 
    }
    .action-btn.toggle.active {
      background-color: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    /* Modo compacto: reduce paddings y tama?o de fuente */
    body.compact .costumer-table th,
    body.compact .costumer-table td {
      padding: 8px 10px;
      font-size: 12px;
    }
    body.compact .costumer-filter-input {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .summary-cards-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      /* Reglas del sidebar unificadas en css/sidebar.css */
      
      .summary-cards-container {
        grid-template-columns: 1fr;
      }
    }
    /* Composer (comentarios) */
    .comment-composer { display:flex; gap:10px; align-items:flex-end; }
    .composer-avatar { width:40px; height:40px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .composer-input-wrap { position:relative; flex:1; display:flex; align-items:center; }
    .composer-textarea { width:100%; border:1px solid #ced4da; border-radius:22px; padding:10px 96px 10px 14px; min-height:40px; max-height:140px; resize:vertical; outline:none; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .composer-textarea:focus { border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .composer-actions { position:absolute; right:8px; bottom:8px; display:flex; gap:6px; align-items:center; }
    .emoji-btn { width:28px; height:28px; border-radius:14px; border:1px solid #e2e8f0; background:#fff; color:#111827; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(0,0,0,.05); font-size:16px; }
    .emoji-btn:hover { background:#f8fafc; }
    .composer-send { border:none; background:transparent; color:#0d6efd; font-weight:600; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .composer-send:hover { color:#0b5ed7; text-decoration: underline; }
    .emoji-picker { position:absolute; right:10px; bottom:48px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.08); padding:8px; width:260px; z-index:10; }
    .emoji-picker .title { font-size:12px; color:#6b7280; margin:2px 4px 6px; }
    .emoji-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; font-size:18px; }
    .emoji-item { border:none; background:none; cursor:pointer; line-height:1; padding:4px; border-radius:6px; }
    .emoji-item:hover { background:#f3f4f6; }

    /* Edit Modal Enhancements */
    #editarModal .edit-modal-card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    #editarModal .edit-grid { display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:12px 16px; align-items:start; }
    #editarModal .edit-section-title { font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:.06em; margin:0 0 10px; }
    #editarModal label { display:block; margin:6px 0 4px; color:#111; font-weight:600; }
    #editarModal input, #editarModal select, #editarModal textarea { width:100% !important; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; background:#f9fafb; }
    #editarModal input:focus, #editarModal select:focus, #editarModal textarea:focus { outline:none; border-color:#93c5fd; box-shadow:0 0 0 2px rgba(59,130,246,.15); background:#fff; }
    #editarModal .edit-actions { display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    #editarModal .btn-primary { background:#0ea5e9; color:#fff; border:none; padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; }
    #editarModal .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
    #editarModal .tv-grid { display:grid; grid-template-columns: repeat(2, minmax(120px, 1fr)); gap:8px 10px; }
    #editarModal .tv-field label { margin:0 0 6px; font-weight:600; }
    /* Agemni-like theme tokens */
    :root {
      --agemni-primary: #0ea5e9;
      --agemni-primary-600: #0284c7;
      --agemni-bg: #f8fafc;
      --agemni-surface: #ffffff;
      --agemni-border: #e5e7eb;
      --agemni-text: #0f172a;
      --agemni-muted: #64748b;
      --agemni-radius: 12px;
    }
    /* Apply tokens */
    .costumer-table-container { border-color: var(--agemni-border); border-radius: var(--agemni-radius); }
    .costumer-table th { background: #f7fafc; color: var(--agemni-text); }
    .costumer-table th + th { box-shadow: inset 1px 0 0 var(--agemni-border); }
    .costumer-table td { color: #334155; }
    .action-btn.toggle, .action-btn { border-color: var(--agemni-border); }
    #editarModal .btn-primary { background: var(--agemni-primary); }
    #editarModal .btn-primary:hover { background: var(--agemni-primary-600); }
    #editarModal input[disabled], #editarModal select[disabled], #editarModal textarea[disabled] { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
    /* Notes (comentarios) cards */
    #editarModal .note-card { background: var(--agemni-surface); border:1px solid var(--agemni-border); border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 2px rgba(2,8,20,.06); }
    #editarModal .note-card + .note-card { margin-top: 10px; }
    #editarModal .note-card:hover { box-shadow: 0 2px 8px rgba(2,8,20,.08); border-color: #dbe2ea; }
    #editarModal .note-header { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    #editarModal .note-meta { font-size: 13px; font-weight: 700; color: var(--agemni-text); }
    #editarModal .note-actions { display:flex; gap:8px; }
    #editarModal .note-btn { width: 32px; height: 32px; border: none; border-radius: 16px; color:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,.12); transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease; }
    #editarModal .note-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(14,165,233,.25); }
    #editarModal .note-btn.edit { background: var(--agemni-primary); }
    #editarModal .note-btn.edit:hover { background: var(--agemni-primary-600); transform: translateY(-1px); }
    #editarModal .note-btn.delete { background: #ef4444; }
    #editarModal .note-btn.delete:hover { background: #dc2626; transform: translateY(-1px); }
    #editarModal .note-content { background:#f9fafb; border:1px solid var(--agemni-border); border-radius: 10px; padding: 12px; font-size: 12px; color:#374151; line-height: 1.6; white-space: pre-wrap; }
  </style>
<body>
  <div class="layout">
    <!-- SIDEBAR (cargado din¨¢micamente) -->
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Tarjetas de Resumen -->
      <div class="summary-cards-container">
        <!-- Ventas Hoy -->
        <div class="summary-card sales-today">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h3 class="card-title">Ventas Hoy</h3>
            </div>
            <div class="card-value" id="costumer-ventas-hoy">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-day"></i> Actualizado ahora
            </div>
          </div>
        </div>

        <!-- Ventas del Mes -->
        <div class="summary-card sales-month">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 class="card-title">Ventas del Mes</h3>
            </div>
            <div class="card-value" id="costumer-ventas-mes">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-alt"></i> Mes actual
            </div>
          </div>
        </div>

        <!-- Pendientes -->
        <div class="summary-card pending">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-clock"></i>
              </div>
              <h3 class="card-title">Pendientes</h3>
            </div>
            <div class="card-value" id="costumer-pendientes">0</div>
            <div class="card-footer">
              <i class="fas fa-info-circle"></i> Por atender
            </div>
          </div>
        </div>

        <!-- Cancelados -->
        <div class="summary-card cancelled">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 class="card-title">Cancelados</h3>
            </div>
            <div class="card-value" id="costumer-cancelados">0</div>
            <div class="card-footer">
              <i class="fas fa-exclamation-triangle"></i> Este mes
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Clientes -->
      <div class="costumer-table-container compact">
        <div class="costumer-table-header">
          <h2 class="costumer-table-title">Lista de Clientes</h2>
          <div class="costumer-table-actions">
            <input type="text" class="costumer-filter-input" id="costumer-search" placeholder="Buscar cliente...">
            <button id="scroll-left" class="action-btn" title="Desplazar a la izquierda">
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button id="scroll-right" class="action-btn" title="Desplazar a la derecha">
              <i class="fas fa-angle-double-right"></i>
            </button>

            <button id="refresh-table" class="action-btn" title="Refrescar">
              <i class="fas fa-sync-alt"></i>
            </button>
            <!-- Bot¨®n para alternar ver todos/mis clientes (solo visible para admin/supervisor/backoffice) -->
            <button id="toggle-forceall" class="action-btn" title="Ver todos" style="display:none">
              <i class="fas fa-users"></i>
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="costumer-table">
            <thead>
              <tr>
                <th>Nombre cliente</th>
                <th>Tel&eacute;fono principal</th>
                <th>Tel&eacute;fono alterno</th>
                <th>N&uacute;mero de cuenta</th>
                <th>Autopago</th>
                <th>Direcci&oacute;n</th>
                <th>Tipo de servicios</th>
                <th>Sistema</th>
                <th>Riesgo</th>
                <th>D&iacute;a de venta</th>
                <th>D&iacute;a de instalaci&oacute;n</th>
                <th>Status</th>
                <th>Servicios</th>
                <th>Mercado</th>
                <th>Supervisor</th>
                <th>Comentario</th>
                <th>Motivo llamada</th>
                <th>ZIP CODE</th>
                <th>Puntaje</th>
                <th>Acci&oacute;n</th>
              </tr>
            </thead>
            <tbody id="costumer-tbody">
              <!-- Las filas se llenar¨¢n din¨¢micamente con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="scrollbarMirror" class="scrollbar-mirror"><div id="scrollbarMirrorInner" style="width:1px;height:1px;"></div></div>
        <!-- Controles de paginación -->
        <div id="paginationControls" style="display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:8px 12px;">
          <button id="pagePrev" class="action-btn" title="Página anterior"><i class="fas fa-chevron-left"></i></button>
          <span id="pageInfo" style="font-size:12px; color:#475569; min-width:120px; text-align:center;">Página 1</span>
          <button id="pageNext" class="action-btn" title="Página siguiente"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Comentarios -->
  <div id="comentariosModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div style="position: absolute; right: 0; top: 0; width: 500px; height: 100%; background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
      <!-- Encabezado del modal -->
      <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa;">
        <div>
          <h3 style="margin: 0; color: #333; font-size: 18px;">Comentarios</h3>
          <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Agrega comentarios sobre el cliente</p>
        </div>
        <button onclick="cerrarComentarios()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      
      <!-- Lista de comentarios -->
      <div id="comentariosContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Los comentarios se cargar¨¢n aqu¨ª din¨¢micamente -->
      </div>
      
      <!-- ?rea para nuevo comentario -->
      <div style="padding: 15px; border-top: 1px solid #eaeaea; background-color: #f8f9fa;">
        <div class="comment-composer" style="margin-bottom:10px;">
          <div class="composer-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="composer-input-wrap">
            <textarea id="nuevoComentario" class="composer-textarea" placeholder="Escribe un comentario..."></textarea>
            <div class="composer-actions">
              <button id="emojiToggleBtn" class="emoji-btn" onclick="toggleEmojiPicker(event)" title="Emojis">?</button>
              <button class="composer-send" onclick="agregarComentario()">Enviar</button>
            </div>
            <!-- Picker compacto -->
            <div id="emojiPicker" class="emoji-picker" style="display:none;">
              <div class="title">Emojis</div>
              <div class="emoji-grid">
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('??')">??</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Lead -->
  <div id="editarModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow: auto; padding: 24px;">
    <div style="position: relative; margin: 0 auto; width: 100%; max-width: 1200px; background: linear-gradient(135deg, #a8d8ea 0%, #88c0d0 100%); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
      <!-- Contenedor blanco interno con formulario -->
      <div class="edit-modal-card" style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <!-- Header con ID del lead -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
          <h3 id="edit-lead-title" style="margin: 0; font-size: 18px; font-weight: 700; color: #111;">
            # LEAD <span id="edit-lead-id-display">00000</span>
          </h3>
          <button onclick="cerrarModalEdicion()" style="background: #e2e8f0; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #64748b; transition: all 0.2s;" onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">&times;</button>
        </div>
        
        <input type="hidden" id="edit-id">
        
        <!-- Grid compacto 3 columnas -->
        <div class="edit-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 20px; font-size: 13px; align-items: start;">
          <div>
            <div class="edit-section-title">Datos del cliente</div>
            <label style="display: block; margin-bottom: 4px; color: #111; font-weight: 600;">Teléfono</label>
            <input type="tel" id="edit-telefono" style="width: 280px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Teléfono Alterno</label>
            <input type="tel" id="edit-telefono-alt" style="width: 280px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Nombres</label>
            <input type="text" id="edit-nombres" style="width: 340px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Apellidos</label>
            <input type="text" id="edit-apellidos" style="width: 340px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Dirección</label>
            <input type="text" id="edit-direccion" style="width: 420px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">ZIP</label>
            <input type="text" id="edit-zip-code" style="width: 120px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 36px 0 4px; color: #111; font-weight: 600;">Documento</label>
            <input type="text" id="edit-documento" style="width: 230px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 24px 0 4px; color: #111; font-weight: 600;">Email</label>
            <input type="email" id="edit-email" style="width: 420px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
          </div>
          <div>
            <div class="edit-section-title">Servicios</div>
            <label>Servicios</label>
            <input type="text" id="edit-tipo-servicios" style="width: 320px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb; display:block; margin: 0 0 8px;">
            
            <label style="margin-top:12px;">Autopago</label>
            <select id="edit-autopago" style="width: 180px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
              <option value="">Seleccionar...</option>
              <option value="SI">Sí</option>
              <option value="NO">No</option>
            </select>
            <label style="margin-top:12px;">Idioma</label>
            <select id="edit-idioma" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb; display:block;">
              <option value="">Seleccionar...</option>
              <option value="Español">Español</option>
              <option value="English">English</option>
            </select>
            <label style="margin-top:12px;">Riesgo</label>
            <select id="edit-riesgo" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb; display:block;">
              <option value="">Seleccionar...</option>
              <option value="LOW">LOW</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="HIGH">HIGH</option>
              <option value="N/A">N/A</option>
            </select>
            <label style="margin-top:12px;">Status</label>
            <select id="edit-status" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb; display:block;">
              <option value="">Seleccionar...</option>
              <option value="PENDING">PENDING</option>
              <option value="ACTIVE">ACTIVE</option>
              <option value="CANCELED">CANCELED</option>
            </select>
            <label style="margin-top:12px;">Sistema</label>
            <select id="edit-sistema" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb; display:block;">
              <option value="">Seleccionar...</option>
              <option value="SARA">SARA</option>
              <option value="N/A">N/A</option>
            </select>
            <label style="margin-top:12px;">Puntaje</label>
            <input type="number" step="0.01" id="edit-puntaje" style="width: 120px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f3f4f6;" readonly>
          </div>
          <div>
            <div class="edit-section-title">Administrativo</div>
            <label style="display: block; margin-bottom: 4px; color: #111; font-weight: 600;">Mercado</label>
            <input type="text" id="edit-mercado" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Representante</label>
            <input type="text" id="edit-representante" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Sup</label>
            <input type="text" id="edit-supervisor" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Fecha de Venta</label>
            <input type="date" id="edit-dia-venta" style="width: 160px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Fecha de Instalación</label>
            <input type="date" id="edit-dia-instalacion" style="width: 160px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 24px 0 4px; color: #111; font-weight: 600;">ACCOUNT</label>
            <input type="text" id="edit-numero-cuenta" style="width: 220px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Motivo de llamada</label>
            <input type="text" id="edit-motivo-llamada" style="width: 320px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;">
            <label style="display: block; margin: 12px 0 4px; color: #111; font-weight: 600;">Comentario</label>
            <textarea id="edit-comentario" style="width: 100%; min-height: 70px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: #f9fafb;"></textarea>
          </div>
        </div>
        <div class="edit-actions">
          <button onclick="guardarCambiosLead()" class="btn-primary">Guardar cambios</button>
        </div>
      </div>
      
      <!-- Sección de Notas / Historial -->
      <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <!-- Input para nueva nota (arriba fijo en la sección) -->
        <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 15px;">
          <textarea id="edit-nueva-nota" placeholder="Agregar nueva nota..." style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; min-height: 80px; resize: vertical; background: #f9fafb; font-family: inherit;"></textarea>
          <button onclick="agregarNotaCliente()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">
            <i class="fas fa-plus"></i> Agregar Nota
          </button>
        </div>
        <!-- Contenedor de notas que se llenará dinámicamente debajo (scroll interno) -->
        <div id="edit-notas-container" style="margin-bottom: 15px; max-height: 360px; overflow-y: auto; border-top: 1px solid #e5e7eb; padding-top: 10px;">
          <!-- Las notas se cargarán aquí dinámicamente -->
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Helper: obtener leads por agentId desde backend (fallback para vista Supervisor)
    // Cache global de leads por agente para evitar reconsultas
    if (!window.__agentLeadsCache) window.__agentLeadsCache = new Map();
    let __currentFetchController = null;
    async function fetchLeadsByAgentId(agentId) {
      try {
        if (!agentId) return [];
        // Cache inmediato
        if (window.__agentLeadsCache.has(agentId)) {
          const cached = window.__agentLeadsCache.get(agentId);
          console.debug('[fetchLeadsByAgentId] usando cache para', agentId, 'items=', cached.length);
          return cached.slice();
        }
        const fetchOpts = { method: 'GET', credentials: 'include', headers: { 'Content-Type': 'application/json' } };
        // Solo las claves robustas que el backend soporta de forma directa
        const qParams = [
          ['agenteId', agentId],
          ['agentId', agentId]
        ];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        // Abort de fetches previos si el usuario cambia de chip r¨¢pidamente
        if (__currentFetchController) { try { __currentFetchController.abort(); } catch(_) {} }
        __currentFetchController = new AbortController();
        const { signal } = __currentFetchController;
        // Intentar primero agenteId, si no hay datos probar agentId inmediatamente despu¨¦s
        const tryOnce = async ([key, val]) => {
          const url = `/api/leads?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
          const res = await fetch(url, { ...fetchOpts, signal });
          if (!res.ok) { console.warn('[fetchLeadsByAgentId] HTTP', res.status, 'para', key); return []; }
          const data = await res.json();
          const leads = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
          console.log(`[fetchLeadsByAgentId] ${key} -> recibidos=${leads.length}`);
          return leads;
        };
        let acc = await tryOnce(qParams[0]);
        if (!acc.length) acc = await tryOnce(qParams[1]);
        // Cachear
        window.__agentLeadsCache.set(agentId, acc.slice());
        console.log('[fetchLeadsByAgentId] total =', acc.length);
        return acc;
      } catch (e) {
        console.warn('fetchLeadsByAgentId error:', e);
        return [];
      }
    }
    // Helper: obtener leads por nombre de agente desde backend (varias claves)
    async function fetchLeadsByAgentName(agentName) {
      try {
        if (!agentName) return [];
        const fetchOpts = { method: 'GET', credentials: 'include', headers: { 'Content-Type': 'application/json' } };
        const strip = (s) => s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const collapsed = strip(agentName).replace(/\s+/g,'');
        // Insertar un espacio entre nombre y apellido si viene colapsado tipo "EduardoRivas"
        const spaced = (/^[A-Za-z]+[A-Z][a-z]+$/.test(agentName))
          ? agentName.replace(/([a-z])([A-Z])/g, '$1 $2')
          : agentName;
        const nameVariants = Array.from(new Set([
          agentName,
          spaced,
          collapsed
        ].map(v => String(v).trim()).filter(Boolean)));
        const keys = ['agenteNombre','nombreAgente','agente','salesAgent','vendedor','atendioPor','asignadoA','asignadoPor'];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        const seen = new Set();
        const acc = [];
        for (const key of keys) {
          for (const val of nameVariants) {
            try {
              const url = `/api/leads?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
              const res = await fetch(url, fetchOpts);
              if (!res.ok) { console.warn('[fetchLeadsByAgentName] HTTP', res.status, 'para', key, 'val', val); continue; }
              const data = await res.json();
              const leads = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
              for (const l of leads) {
                const id = normalizeId(l._id) || normalizeId(l.id) || normalizeId(l.leadId) || JSON.stringify(l).length;
                if (!seen.has(id)) { seen.add(id); acc.push(l); }
              }
              console.log(`[fetchLeadsByAgentName] ${key}=${val} -> recibidos=${leads.length} | acumulados=${acc.length}`);
            } catch (e) {
              console.warn('[fetchLeadsByAgentName] error con', key, 'val', val, e);
            }
          }
        }
        console.log('[fetchLeadsByAgentName] total combinados =', acc.length);
        return acc;
      } catch(e) {
        console.warn('fetchLeadsByAgentName error:', e);
        return [];
      }
    }
    // Manejador de errores global
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Error global detectado:', {
        message: message,
        source: source,
        lineno: lineno,
        colno: colno,
        error: error
      });
      return true; // Previene el manejador de errores por defecto
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="utils/teams.js"></script>
  <script>
    // Función para crear toolbar de supervisor
    window.createSupervisorToolbar = function(leads) {
      // Deshabilitado temporalmente: no renderizar barra de filtros por agente para supervisores
      return;
    };
  </script>
  <script>
    // Funci¨®n para verificar el rol del usuario y mostrar/ocultar elementos seg¨²n corresponda
    function checkUserRole() {
      try {
        const teamMenuItem = document.getElementById('teamMenuItem');
        if (teamMenuItem) {
          teamMenuItem.style.display = 'none';
        }

    // Helper GLOBAL: matcher para agente seleccionado (can¨®nico y heur¨ªsticas)
    if (!window.matchSelectedAgent) {
      window.matchSelectedAgent = function(l, selectedCanon) {
        try {
          if (!selectedCanon) return true;
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const collapse = s => norm(s).replace(/[^a-z0-9]/g, '');
          const canonFrom = name => {
            try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : norm(name); } catch { return norm(name); }
          };
          const selectedDisplay = (teamsApi && typeof teamsApi.getDisplayName==='function') ? teamsApi.getDisplayName(selectedCanon) : selectedCanon;
          const selCanonCollapsed = collapse(selectedCanon);
          const selDisplayCollapsed = collapse(selectedDisplay);
          // Intentar poblar __agentCanon usando el helper universal (usa mapa de IDs)
          try { if (typeof getAgentCanonUniversal === 'function') { const c0 = getAgentCanonUniversal(l); if (c0) l.__agentCanon = c0; } } catch(_) {}
          const c1 = (l && l.__agentCanon) ? l.__agentCanon : '';
          if (c1 && (c1 === selectedCanon || collapse(c1) === selCanonCollapsed)) return true;
          const candidates = [
            l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
            l?.vendedor, l?.seller, l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
            l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
            l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente,
            l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
            l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy,
            l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to
          ];
          for (const v of candidates) {
            if (!v) continue;
            const c = canonFrom(v);
            if (c && (c === selectedCanon || collapse(c) === selCanonCollapsed)) return true;
            const col = collapse(v);
            if (col && (col === selDisplayCollapsed || col === selCanonCollapsed)) return true;
          }
          const toks = selectedCanon.split(' ').filter(Boolean);
          const txt = norm(JSON.stringify(l||{}));
          if (toks.every(t => txt.includes(t))) return true;
          return false;
        } catch { return false; }
      };
    }

        // Obtener y normalizar rol
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();

        // Roles permitidos para ver Team: admin, supervisor, backoffice (y variantes)
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);

        if (teamMenuItem && allowed.has(role)) {
          // li por defecto es list-item; usar block para asegurar visibilidad
          teamMenuItem.style.display = 'block';
        }
      } catch (error) {
        console.error('Error al verificar el rol del usuario:', error);
      }
    }
    
    // Inicializar cuando el DOM est¨¦ listo
    document.addEventListener('DOMContentLoaded', function() {
      checkUserRole();
    });
  </script>
  <!-- Override DESPUÉS de script.js para Team Líneas -->
  <script>
    // Override para Team Líneas después de cargar script.js
    (function() {
      const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
      const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
      const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();
      const isTeamLineas = role==='teamlineas' || username.startsWith('lineas-') || username.includes('lineas');
      
      if (isTeamLineas) {
        console.log('[Team Líneas OVERRIDE] Usuario Team Líneas detectado, sobrescribiendo renderCostumerTable');
        
        // Sobrescribir renderCostumerTable DESPUÉS de que script.js lo defina
        window.renderCostumerTable = function(leads) {
          console.log('[Team Líneas INTERCEPTOR] Renderizando con interceptor');
          
          // Aplicar encabezado Team Líneas
          const thead = document.querySelector('.costumer-table thead');
          if (thead) {
            const headers = ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÓN','DÍA DE VENTA','DÍA DE INSTALACIÓN','STATUS','CANTIDAD DE LÍNEAS','TELÉFONOS DE LAS LÍNEAS','ID','SUPERVISOR','MERCADO'];
            thead.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
          }
          
          // Renderizar filas Team Líneas
          const tbody = document.getElementById('costumer-tbody');
          if (tbody) {
            tbody.innerHTML = '';
            const arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);
            
            arr.forEach(l => {
              const autop = (l.autopay ?? l.autopago);
              const autopTxt = typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : 
                              (String(autop||'').toUpperCase() === 'SI' ? 'Sí' : 
                              (String(autop||'').toUpperCase() === 'NO' ? 'No' : String(autop||'')));
              
              const cant = (l.cantidad_lineas != null) ? l.cantidad_lineas : 
                          (Array.isArray(l.telefonos) ? l.telefonos.length : '');
              
              // Servicios resumen
              let servicios = '';
              const arr = Array.isArray(l.telefonos) ? l.telefonos : [];
              if (arr.length) {
                const m = new Map();
                arr.forEach(t => {
                  const k = (t?.servicio || t?.tipo || '').toString().trim() || 'SERVICIO';
                  m.set(k, (m.get(k) || 0) + 1);
                });
                servicios = [...m.entries()].map(([k,v]) => v > 1 ? `${k} x${v}` : k).join('; ');
              } else {
                servicios = l.servicios_texto || l.tipo_servicios || l.servicios || l.producto || '';
              }
              
              // PIN enmascarado
              const pin = l.pin_seguridad ? '•'.repeat(Math.min(4, String(l.pin_seguridad).length)) : '';
              
              // Fecha normalizada (parseo local para evitar desfase UTC)
              function normDate(v) {
                try {
                  if (!v) return '';
                  const s = String(v);
                  // Si ya es YYYY-MM-DD, devolverlo tal cual
                  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                  // Si es otro formato, intentar parsear como local
                  const match = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
                  if (match) {
                    const [_, y, m, d] = match;
                    return `${y}-${m}-${d}`;
                  }
                  const d = new Date(s);
                  if (isNaN(d)) return s;
                  const y = d.getFullYear();
                  const m = String(d.getMonth()+1).padStart(2,'0');
                  const day = String(d.getDate()).padStart(2,'0');
                  return `${y}-${m}-${day}`;
                } catch {
                  return String(v||'');
                }
              }
              
              const cells = [
                l.nombre_cliente || '',
                l.telefono_principal || '',
                l.numero_cuenta || '',
                autopTxt || '',
                pin || '',
                l.direccion || '',
                normDate(l.dia_venta || l.fecha_contratacion || l.fecha || ''),
                normDate(l.dia_instalacion || ''),
                (l.status || '').toString().toUpperCase(),
                cant || '',
                servicios || '',
                (l.id_cliente || l._id || l.id || ''),
                l.supervisor || '',
                l.mercado || ''
              ];
              
              const tr = document.createElement('tr');
              tr.innerHTML = cells.map(v => `<td>${v == null ? '' : v}</td>`).join('');
              tbody.appendChild(tr);
            });
          }
        };
      }
    })();
  </script>
  <!-- Eliminada la referencia a costumer-comments.js que no existe -->
  <script>
    // Inicializaci¨®n de UI: toggle compacto y refrescar tabla
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggle-compact');
      const refreshBtn = document.getElementById('refresh-table');
      const forceAllBtn = document.getElementById('toggle-forceall');

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          document.body.classList.toggle('compact');
          toggleBtn.classList.toggle('active');
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
          const icon = refreshBtn.querySelector('i');
          const prev = icon.className;
          icon.className = 'fas fa-spinner fa-spin';
          try {
            if (typeof cargarDatosDesdeServidor === 'function') {
              await cargarDatosDesdeServidor();
            } else if (typeof fetchLeadsAgente === 'function') {
              await fetchLeadsAgente();
            }
          }
          finally { icon.className = prev; }
        });
      }

      // Conmutador Ver todos / Mis clientes
      function getRole() {
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          return (userData.role || userData?.usuario?.role || '').toString().toLowerCase().trim();
        } catch { return ''; }
      }
      

      
      function getForceAll() {
        const usp = new URLSearchParams(window.location.search);
        const v = (usp.get('forceAll') || '').toString().toLowerCase();
        return v === '1' || v === 'true' || v === 'yes';
      }
      function setForceAll(enabled) {
        const url = new URL(window.location.href);
        if (enabled) url.searchParams.set('forceAll', '1');
        else url.searchParams.delete('forceAll');
        window.location.href = url.toString();
      }
      // Mostrar bot¨®n solo para admin/supervisor/backoffice (no para agent)
      const role = getRole();
      // admin/backoffice/supervisor pueden ver el bot¨®n
      const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);
      if (forceAllBtn) {
        if (allowed.has(role)) {
          forceAllBtn.style.display = 'inline-flex';
          const isForceAll = getForceAll();
          forceAllBtn.title = isForceAll ? 'Mis clientes' : 'Ver todos';
          if (isForceAll) forceAllBtn.classList.add('active');
          forceAllBtn.addEventListener('click', function() {
            setForceAll(!getForceAll());
          });
        } else {
          // Agente: oculto y aseguramos que no quede activo por URL
          forceAllBtn.style.display = 'none';
        }
      }

      // Resetear filtros residuales antes de cargar datos (evita listas reducidas por estados previos)
      try { window.supervisorAgentFilter = null; } catch(_) {}
      try { window.adminTeamFilter = null; } catch(_) {}

      // Cargar datos iniciales
      console.log('[INIT] Cargando datos desde el servidor...');
      if (typeof fetchLeadsAgente === 'function') {
        fetchLeadsAgente().catch(err => {
          console.error('[INIT] Error cargando datos:', err);
        });
      } else {
        console.error('[INIT] fetchLeadsAgente no está disponible');
      }
    });
  </script>
  <script>
    // Variables globales
    let leadActual = null;

    // Helper: detectar si el usuario actual es Irania Serrano
    function esIrania() {
      try {
        // 1) Intentar desde local/session storage
        const userRaw = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userRaw) {
          const u = JSON.parse(userRaw || '{}');
          const nombre = (u.name || u.fullName || u.username || u.email || u.usuario?.name || '').toString();
          if (normalizarTexto(nombre) === normalizarTexto('Irania Serrano')) return true;
        }
        // 2) Intentar desde token JWT
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (token && token.split('.').length === 3) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]) || '{}');
            const nombreTok = (payload.username || payload.name || payload.fullName || payload.email || '').toString();
            if (normalizarTexto(nombreTok) === normalizarTexto('Irania Serrano')) return true;
          } catch(_) {}
        }
      } catch(_) {}
      return false;
    }

    // Helper: quitar prefijo "team" del supervisor para mostrar limpio
    function limpiarSupervisor(displayName) {
      try {
        const s = (displayName || '').toString();
        return s.replace(/^\s*team\s+/i, '').trim();
      } catch { return displayName || ''; }
    }

    // Helper: detectar si el usuario es admin o backoffice
    function esAdminOBackoffice() {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);
        // Solo admin o backoffice/variantes, no supervisor
        if (role === 'admin') return true;
        if (allowed.has(role) && role !== 'supervisor') return true;
        return false;
      } catch { return false; }
    }

    // Helper: detectar si el usuario es supervisor
    function esSupervisor() {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();
        return role === 'supervisor';
      } catch { return false; }
    }
  
        // Funci¨®n para verificar si el usuario puede editar el estado de un lead
    function canEditStatus() {
      try {
        // Obtener datos del usuario desde localStorage o sessionStorage
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const userRole = (userData.role || '').toLowerCase();
        
        // Permitir edici¨®n a administradores y supervisores
        return ['admin', 'supervisor', 'backoffice'].includes(userRole);
      } catch (error) {
        console.error('Error al verificar permisos de edici¨®n:', error);
        return false; // Por defecto, no permitir edici¨®n si hay un error
      }
    }

    // Funciones para el manejo de comentarios - Asegurar que estén en scope global
    window.abrirComentarios = function(leadId) {
      leadActual = leadId;
      document.getElementById('comentariosModal').style.display = 'block';
      cargarComentarios(leadId);
    };

    function cerrarComentarios() {
      document.getElementById('comentariosModal').style.display = 'none';
      document.getElementById('nuevoComentario').value = '';
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
      leadActual = null;
    }

    async function cargarComentarios(leadId) {
      const container = document.getElementById('comentariosContainer');
      container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <div style="text-align: center;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p style="margin-top: 10px; color: #666;">Cargando comentarios...</p>
          </div>
        </div>
      `;
      
      try {
        console.log('Solicitando comentarios para leadId:', leadId);
        
        let comments = [];
        
        // 1) Intentar obtener del backend si existe endpoint
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/comments?leadId=${encodeURIComponent(leadId)}`, {
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
          });
          if (resp.ok) {
            const data = await resp.json();
            if (data && Array.isArray(data.comments)) {
              comments = data.comments;
            }
          }
        } catch (e) {
          console.warn('Fallo al obtener comentarios del backend, se usar¨¢ cache/local:', e);
        }

        // 2) Mezclar con comentarios locales en cache (optimista)
        const cacheKey = `comments_cache_${leadId}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        if (Array.isArray(cached) && cached.length) {
          comments = [...comments, ...cached];
        }

        // 3) Si vac¨ªo, intentar inferir ¨²ltimo comentario textual del lead para mostrar algo
        if ((!comments || comments.length === 0) && Array.isArray(window.ultimaListaLeads)) {
          const lead = window.ultimaListaLeads.find(l => (l._id || '') === leadId);
          if (lead && lead.comentarios_venta) {
            comments = [{
              autor: 'Sistema',
              fecha: new Date().toISOString(),
              texto: String(lead.comentarios_venta)
            }];
          }
        }

        // Normalizaci¨®n y render tipo chat
        const usuario = obtenerUsuarioActual();
        const mensajes = (comments || []).map(c => ({
          autor: c.autor || c.user || 'Desconocido',
          fecha: c.fecha || c.createdAt || new Date().toISOString(),
          texto: (c.texto ?? c.comment ?? '').toString()
        }));

        // ...
        let html = '';
        
        // Ordenar comentarios por fecha (m¨¢s antiguos primero para chat natural)
        const comentariosOrdenados = [...mensajes].sort((a, b) => 
          new Date(a.fecha) - new Date(b.fecha)
        );
        
        // Render de cada burbuja estilo chat
        comentariosOrdenados.forEach(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          const esAgente = normalizarTexto(comentario.autor) === normalizarTexto(usuario);
          const lado = esAgente ? 'me' : 'other';
          const iniciales = obtenerIniciales(comentario.autor);
          html += `
            <div class="chat-message ${lado}" style="display:flex; gap:10px; margin-bottom:12px; align-items:flex-end; ${lado==='me' ? 'justify-content:flex-end;' : ''}">
              ${lado==='other' ? `
                <div class="chat-avatar" title="${escapeHtml(comentario.autor)}" style="width:28px; height:28px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6c757d; flex-shrink:0;">${escapeHtml(iniciales)}</div>
              ` : ''}
              <div class="chat-bubble ${lado}" style="max-width:70%; padding:10px 12px; border-radius:14px; ${lado==='me' ? 'background:#e3f2fd; color:#0d47a1; border-top-right-radius:4px;' : 'background:#f1f3f5; color:#333; border-top-left-radius:4px;'}">
                <div class="chat-author-time" style="font-size:11px; color:${lado==='me' ? '#1565c0' : '#6c757d'}; margin-bottom:4px;">
                  ${escapeHtml(comentario.autor)} ? ${fechaFormateada}
                </div>
                <div class="chat-text" style="white-space:pre-wrap; word-wrap:break-word;">${escapeHtml(comentario.texto)}</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html || `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
            <div>
              <i class="fas fa-comments" style="font-size:28px; opacity:0.6;"></i>
              <p style="margin-top:8px;">Sin comentarios a¨²n. ?S¨¦ el primero en comentar!</p>
            </div>
          </div>
        `;

        // Hacer scroll al final (¨²ltimo mensaje visible)
        setTimeout(() => {
          try { container.scrollTop = container.scrollHeight; } catch(_e) {}
        }, 50);
  
      } catch (error) {
        console.error('Error al cargar comentarios:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      }
    }

    async function agregarComentario() {
      const comentario = document.getElementById('nuevoComentario').value.trim();
      if (!comentario) return;
      
      const btnEnviar = document.querySelector('#comentariosModal button[onclick="agregarComentario()"]');
      const btnOriginalText = btnEnviar.innerHTML;
      const comentarioInput = document.getElementById('nuevoComentario');
      
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        console.log('Enviando comentario para leadId:', leadActual);
        const usuario = obtenerUsuarioActual();
        const nuevo = {
          autor: usuario || 'Yo',
          fecha: new Date().toISOString(),
          texto: comentario
        };

        // Optimista: agregar a cache local
        const cacheKey = `comments_cache_${leadActual}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        cached.push(nuevo);
        localStorage.setItem(cacheKey, JSON.stringify(cached));

        // Intentar enviar al backend si existe endpoint REST
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/leads/${encodeURIComponent(leadActual)}/comentarios`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(nuevo)
          });
          if (!resp.ok) {
            console.warn('POST /api/leads/:id/comentarios no disponible. Se mantiene en cache local.');
          }
        } catch (e) {
          console.warn('Fallo al enviar comentario al backend, se mantiene en cache local:', e);
        }

        // Limpiar input y recargar lista
        comentarioInput.value = '';
        await cargarComentarios(leadActual);

        // Actualizar columna de "Comentarios sobre la Venta" en la tabla
        if (typeof actualizarUltimoComentarioEnTabla === 'function') {
          actualizarUltimoComentarioEnTabla(leadActual, nuevo.texto);
        }
      } catch(error) {
        console.error('Error al agregar comentario:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = btnOriginalText;
      }
    }

    // Soporte de Emoji Picker
    function toggleEmojiPicker(event) {
      try {
        event?.stopPropagation?.();
        const picker = document.getElementById('emojiPicker');
        if (!picker) return;
        const isOpen = picker.style.display === 'block';
        picker.style.display = isOpen ? 'none' : 'block';
      } catch (e) {
        console.warn('toggleEmojiPicker error:', e);
      }
    }

    function insertAtCursor(textarea, text) {
      try {
        const start = textarea.selectionStart ?? textarea.value.length;
        const end = textarea.selectionEnd ?? textarea.value.length;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
      } catch (e) {
        // Fallback: append
        textarea.value = (textarea.value || '') + text;
      }
    }

    function insertEmoji(emoji) {
      const ta = document.getElementById('nuevoComentario');
      if (!ta) return;
      ta.focus();
      insertAtCursor(ta, emoji);
      // cerrar picker tras insertar
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
    }

    // Cerrar picker al hacer click fuera
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const toggleBtn = document.getElementById('emojiToggleBtn');
      if (!picker || picker.style.display !== 'block') return;
      const clickedInsidePicker = picker.contains(e.target);
      const clickedToggle = toggleBtn && (e.target === toggleBtn || toggleBtn.contains(e.target));
      if (!clickedInsidePicker && !clickedToggle) {
        picker.style.display = 'none';
      }
    });

    // Funci¨®n para actualizar el ¨²ltimo comentario en la tabla
    function actualizarUltimoComentarioEnTabla(leadId, comentario) {
      // Encontrar la fila del lead
      const filas = document.querySelectorAll('#costumer-tbody tr');
      
      filas.forEach(fila => {
        const botonEditar = fila.querySelector('button[onclick^="editarLead"]');
        if (botonEditar) {
          const idEnFila = botonEditar.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (idEnFila === leadId) {
            // Actualizar la celda de comentarios
            const celdaComentarios = fila.querySelector('td:nth-last-child(2)');
            if (celdaComentarios) {
              // Mostrar solo los primeros 50 caracteres del comentario
              const textoCorto = comentario.length > 50 ? comentario.substring(0, 50) + '...' : comentario;
              celdaComentarios.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="new-comment-dot" style="display: inline-block; width: 8px; height: 8px; background-color: #3498db; border-radius: 50%;"></span>
                    <span>${textoCorto}</span>
                  </div>
                  <button onclick="event.stopPropagation(); abrirComentarios('${leadId}')" class="action-btn" style="margin-top: 5px; padding: 2px 6px; font-size: 11px;">
                    <i class="fas fa-comment"></i> Ver todo
                  </button>
                </div>
              `;
            }
          }
        }
      });
    }

    // Cerrar el modal al hacer clic fuera del contenido
    window.onclick = function(event) {
      const modal = document.getElementById('comentariosModal');
      if (event.target == modal) {
        cerrarComentarios();
      }
    }

    // Variable global para almacenar los leads
    window.ultimaListaLeads = [];
    
    // Normalizaci¨®n de leads desde el backend a la estructura usada en frontend
    function escapeAttr(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      } catch { return ''; }
    }
    function toISODateString(d) {
      try {
        if (!d) return '';
        if (d instanceof Date) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0)).toISOString().split('T')[0];
        if (typeof d === 'string') {
          // Intentar YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
          const dt = new Date(d);
          if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
        }
      } catch (e) {
        console.warn('toISODateString error:', e, d);
      }
      return '';
    }

    // Helpers de identificadores
    function extractLeadId(raw) {
      if (!raw) return '';
      // Casos: {_id: '...'} | {_id: {$oid: '...'}} | {id: '...'}
      const _id = raw._id;
      if (typeof _id === 'string') return _id;
      if (_id && typeof _id === 'object') {
        if (typeof _id.$oid === 'string') return _id.$oid;
        if (typeof _id.oid === 'string') return _id.oid;
      }
      if (typeof raw.id === 'string') return raw.id;
      return '';
    }

    // Helper global utilizado por atributos inline
    function getLeadId(lead) {
      try {
        if (!lead) return '';
        const id = extractLeadId(lead);
        return typeof id === 'string' ? id : '';
      } catch {
        return '';
      }
    }

    // Helper: obtener propiedad por nombre (case-insensitive) desde obj y su _raw
    function getPropCI(obj, propName) {
      try {
        if (!obj || !propName) return undefined;
        const p = String(propName);
        if (p in obj) return obj[p];
        const lower = p.toLowerCase();
        const keys = Object.keys(obj || {});
        const hit = keys.find(k => k.toLowerCase() === lower);
        if (hit) return obj[hit];
        return undefined;
      } catch { return undefined; }
    }
    // Helper: b¨²squeda profunda por clave (case-insensitive). Escanea objetos/arrays.
    function deepFindByKey(obj, candidates, opts = {}) {
      const MAX_DEPTH = typeof opts.maxDepth === 'number' ? opts.maxDepth : 4;
      const seen = new WeakSet();
      const candSet = new Set((candidates || []).map(c => String(c).toLowerCase()));
      function matchKey(k) {
        const kl = String(k).toLowerCase();
        if (candSet.has(kl)) return true;
        // Tambi¨¦n coincide si la variante upper/lower/cap es igual
        for (const c of candSet) {
          if (kl === c || kl === c.toUpperCase() || kl === c.toLowerCase()) return true;
        }
        return false;
      }
      function dfs(node, depth) {
        if (!node || depth > MAX_DEPTH) return undefined;
        if (typeof node !== 'object') return undefined;
        if (seen.has(node)) return undefined;
        seen.add(node);
        if (Array.isArray(node)) {
          for (const it of node) {
            const r = dfs(it, depth + 1);
            if (r != null && String(r).trim() !== '') return r;
          }
          return undefined;
        }
        // node es objeto
        for (const [k, v] of Object.entries(node)) {
          if (matchKey(k)) {
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        for (const [, v] of Object.entries(node)) {
          const r = dfs(v, depth + 1);
          if (r != null && String(r).trim() !== '') return r;
        }
        return undefined;
      }
      return dfs(obj, 0);
    }
    function pickField(obj, candidates) {
      try {
        const tryList = [];
        (candidates || []).forEach(n => {
          tryList.push(n, String(n).toUpperCase(), String(n).toLowerCase(), n && (String(n).charAt(0).toUpperCase() + String(n).slice(1).toLowerCase()));
        });
        // Explorar objeto directo y su _raw si existe
        for (const name of tryList) {
          const v = getPropCI(obj, name);
          if (v != null && String(v).trim() !== '') return v;
        }
        if (obj && obj._raw) {
          for (const name of tryList) {
            const v = getPropCI(obj._raw, name);
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        // B¨²squeda profunda como ¨²ltimo recurso (obj y _raw)
        const deep1 = deepFindByKey(obj, candidates);
        if (deep1 != null && String(deep1).trim() !== '') return deep1;
        if (obj && obj._raw) {
          const deep2 = deepFindByKey(obj._raw, candidates);
          if (deep2 != null && String(deep2).trim() !== '') return deep2;
        }
        return '';
      } catch { return ''; }
    }

    function normalizeLead(raw) {
      const lead = raw || {};
      // Mapear campos comunes provenientes del backend en MAY?SCULAS u otras variantes
      const fechaVenta = pickField(lead, ['dia_venta','FECHA','fecha_venta','fecha']);
      const fechaInst = pickField(lead, ['dia_instalacion','FECHA_INSTALACION','fecha_instalacion']);
      const puntaje = pickField(lead, ['puntaje','PUNTAJE','score']) || 0;
      const supervisor = pickField(lead, ['supervisor','SUPERVISOR','team','Team']);
      const tipoServicio = pickField(lead, ['tipo_servicios','tipo_servicio','SERVICIO','producto']);
      const id = extractLeadId(lead);
      // Intentar derivar "agente" desde varios posibles campos del backend
      const agente = (
        lead.agente ?? lead.AGENTE ?? lead.agent ?? lead.AGENT ??
        lead.vendedor ?? lead.VENDEDOR ?? lead.asesor ?? lead.ASESOR ??
        lead.owner ?? lead.OWNER ??
        ((lead.createdBy && (lead.createdBy.name || lead.createdBy.username)) ?? '')
      );

      return {
        // Campos de tabla esperados
        _id: id,
        nombre_cliente: lead.nombre_cliente || lead.NOMBRE || lead.cliente || lead.nombre || 'N/A',
        telefono_principal: lead.telefono_principal || lead.TELEFONO || lead.celular || lead.telefono || 'N/A',
        telefono_alterno: lead.telefono_alterno || lead.TELEFONO_ALTERNO || lead.telefono2 || '',
        numero_cuenta: lead.numero_cuenta || lead.CUENTA || lead.account || '',
        autopago: lead.autopago ?? lead.AUTOPAGO ?? '',
        direccion: lead.direccion || lead.DIRECCION || lead.address || '',
        tipo_servicios: (tipoServicio || ''),
        sistema: (pickField(lead, ['sistema','Sistema','SISTEMA','system','System']) || ''),
        riesgo: (pickField(lead, ['riesgo','Riesgo','RIESGO','risk','RISK']) || ''),
        dia_venta: fechaVenta ? toISODateString(fechaVenta) : '',
        dia_instalacion: fechaInst ? toISODateString(fechaInst) : '',
        status: lead.status || lead.STATUS || lead.estado || 'N/A',
        servicios: lead.servicios || lead.SERVICIOS || tipoServicio || '',
        mercado: (pickField(lead, ['mercado','Mercado','MERCADO','market','MARKET']) || ''),
        supervisor: supervisor || '',
        agente: agente || '',
        comentario: lead.comentario || lead.COMENTARIO || '',
        motivo_llamada: lead.motivo_llamada || lead.MOTIVO || '',
        zip_code: lead.zip_code || lead.zip || lead.ZIP || lead.cp || lead.codigo_postal || lead.postalCode || '',
        puntaje: Number(puntaje) || 0,
        comentarios_venta: lead.comentarios_venta || lead.COMENTARIOS || lead.comentarios || '',
        // Identificadores
        _id: id,
        id: id,
        // Preservar crudo para diagn¨®stico/agrupaci¨®n posterior
        _raw: lead,
        // Pasar posibles campos de IDs de agente y variantes (sin transformar) para facilitar detecci¨®n aguas abajo
        agenteId: lead.agenteId || lead.AGENTEID || lead.agente_id || lead.AGENTE_ID || lead.idAgente || lead.IDAGENTE || lead.agentId || lead.AGENTID || lead.creadoPor || lead.CREADO_POR || lead.creado_por || lead.createdBy || lead.ownerId || lead.assignedId || '',
        agente_id: lead.agente_id || lead.AGENTE_ID || '',
        idAgente: lead.idAgente || lead.IDAGENTE || '',
        agentId: lead.agentId || lead.AGENTID || '',
        creadoPor: lead.creadoPor || lead.CREADO_POR || lead.creado_por || '',
        createdBy: lead.createdBy || '',
        ownerId: lead.ownerId || '',
        assignedId: lead.assignedId || '',
        // Pasar posibles campos de nombre de agente y variantes
        agenteNombre: lead.agenteNombre || lead.AGENTE_NOMBRE || lead.nombreAgente || lead.NOMBRE_AGENTE || lead.agente || lead.Agente || lead.agent || lead.Agent || lead.vendedor || lead.seller || lead.nombre_agente || lead.agente_nombre || lead.agentName || lead.salesAgent || lead.asignadoA || lead.asignado_a || lead.assignedTo || lead.assigned_to || lead.usuario || lead.owner || lead.registeredBy || '',
      };
    }

    function normalizeLeads(arr) {
      if (!Array.isArray(arr)) return [];
      return arr.map(normalizeLead);
    }

    // Zona horaria de negocio (UTC-6). Ajusta si tu operaci¨®n usa otra TZ.
    const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // Am¨¦rica Central (UTC-6)

    // Helper: YYYY-MM-DD en TZ objetivo (no UTC/local del navegador)
    function toISOInTZ(date, tzOffsetMinutes) {
      // convertir 'date' a UTC ms
      const utcMs = date.getTime() + (date.getTimezoneOffset() * 60000);
      // aplicar offset de la TZ objetivo
      const target = new Date(utcMs + tzOffsetMinutes * 60000);
      const y = target.getUTCFullYear();
      const m = String(target.getUTCMonth() + 1).padStart(2, '0');
      const d = String(target.getUTCDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Wrapper: ISO YYYY-MM-DD usando la TZ de negocio definida (BUSINESS_TZ_OFFSET_MIN)
    function toLocalISO(date) {
      try {
        if (!date) return '';
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d)) return '';
        return toISOInTZ(d, BUSINESS_TZ_OFFSET_MIN);
      } catch (_) {
        return '';
      }
    }

    // Helper: obtener fecha YYYY-MM-DD desde múltiples campos (fallbacks)
    function getDateFromLead(lead) {
      try {
        if (!lead) return '';
        const raw = lead.dia_venta || lead.fecha_contratacion || lead.fecha || lead.createdAt || lead.created_at || (lead._raw && (lead._raw.dia_venta || lead._raw.createdAt));
        if (!raw) return '';
        const toYMD = (d) => {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
        };
        if (typeof raw === 'string') {
          const s = raw.trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
          if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
            const [d, m, y] = s.split('/').map(n => parseInt(n, 10));
            const dt = new Date(y, m - 1, d);
            return isNaN(dt) ? '' : toYMD(dt);
          }
          const dt = new Date(s);
          return isNaN(dt) ? '' : toYMD(dt);
        }
        if (raw instanceof Date) {
          return toYMD(raw);
        }
        return '';
      } catch { return ''; }
    }

    // Helpers globales para normalizar nombres de agente (disponibles fuera de IIFE)
    if (typeof window.__normStrAgent !== 'function') {
      window.__normStrAgent = function __normStrAgent(s){
        try { return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
        catch { return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
      };
    }
    if (typeof window.agentCanonicalName !== 'function') {
      window.agentCanonicalName = function agentCanonicalName(name){
        const n = window.__normStrAgent(name);
        const map = {
          'eduardor': 'Eduardo Rivas',
          'eduardorivas': 'Eduardo Rivas',
          'eduardorrivas': 'Eduardo Rivas',
          'alexanderhernandez': 'Riquelmi Torres',
          'juliomejia': 'Julio Chavez',
          'juliom': 'Julio Chavez'
        };
        return map[n] || (name || '');
      };
    }

    // Cargar leads del agente desde backend y actualizar UI
    let __page = 1;
    const __limit = 100;
    let __hasMore = true;
    async function fetchLeadsAgente(page = __page) {
      console.log('[fetchLeadsAgente] Iniciando carga de datos...');
      try {
        // Usar cookies para autenticación (método actual del sistema)
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const fetchOptions = {
          method: 'GET',
          credentials: 'include',
          headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': `Bearer ${token}` } : {})
        };

        // Detectar si es usuario Team Líneas
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const role = (function normalizeRole(r){
          if (!r) return 'agente';
          if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
          if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
          if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
          if (['backoffice','back office','back_office','bo'].includes(r)) return 'backoffice';
          return r;
        })(roleRaw);
        const username = (userData.username || userData?.usuario?.username || '').toString().trim().toLowerCase();
        const isTeamLineasUser = role === 'teamlineas' || username.startsWith('lineas-') || username.includes('lineas');

        // Construir URL según el tipo de usuario
        // IMPORTANTE: no enviar agenteId/agente al backend para evitar mismatch (ObjectId vs string)
        // Traemos un lote más grande y filtramos en frontend
        // Para evitar 404, usar siempre /api/leads y aplicar render Team Líneas solo en UI
        __page = Math.max(1, Number(page)||1);
        let url = `/api/leads?page=${__page}&limit=${__limit}`;
        let alreadyFilteredByAgent = false;
        
        console.log(`[fetchLeadsAgente] Rol: ${role}, Username: ${username}, Team Líneas: ${isTeamLineasUser}`);
        console.log(`[fetchLeadsAgente] URL: ${url}`);

        // Obtener parámetros URL
        const urlParams = new URLSearchParams(window.location.search);
        const forceAll = urlParams.get('forceAll') === '1' || urlParams.get('forceAll') === 'true';

        // Para usuarios no Team Líneas: NO filtrar por agente en backend, se hará en frontend
        if (!isTeamLineasUser) {
          console.log('[fetchLeadsAgente] Sin filtro de agente en backend. Se filtrará en frontend por role=agente');
        }

        if (forceAll) console.warn('[fetchLeadsAgente] forceAll=1 activo: NO se aplica filtrado por agente (backend ni frontend)');
        console.log('[fetchLeadsAgente] URL solicitada:', url, 'alreadyFilteredByAgent=', alreadyFilteredByAgent, 'forceAll=', forceAll);
        let response = await fetch(url, fetchOptions);
        if (response.status === 429) { await new Promise(r=>setTimeout(r, 600)); response = await fetch(url, fetchOptions); }
        console.log(`[fetchLeadsAgente] Response status: ${response.status}, headers:`, response.headers);
        
        if (!response.ok) {
          console.warn('[fetchLeadsAgente] Respuesta no OK del backend:', response.status);
          const errorText = await response.text();
          console.warn('[fetchLeadsAgente] Error response body:', errorText.substring(0, 200));
        }
        
        let data = null;
        try {
          const ct = (response.headers.get('content-type')||'').toLowerCase();
          if (ct.includes('application/json')) {
            data = await response.json();
          } else {
            const responseText = await response.text();
            console.log('[fetchLeadsAgente] Response text (first 200 chars):', responseText.substring(0, 200));
            data = JSON.parse(responseText);
          }
        } catch (e) {
          console.warn('[fetchLeadsAgente] No se pudo parsear JSON de respuesta:', e?.message);
        }
        console.log('[fetchLeadsAgente] Datos recibidos (resumen):', {
          tipo: Array.isArray(data) ? 'array' : typeof data,
          len: Array.isArray(data) ? data.length : (data && Array.isArray(data.data) ? data.data.length : 0)
        });
        
        // Extraer datos según el endpoint
        let leadsRaw = [];
        const extractArray = (d) => Array.isArray(d)
            ? d
            : (Array.isArray(d?.data) ? d.data : (Array.isArray(d?.leads) ? d.leads : []));
        if (isTeamLineasUser) {
          // /api/lineas suele responder en data.data
          leadsRaw = extractArray(data);
        } else {
          // /api/customers o /api/leads pueden responder en data, leads o array directo
          leadsRaw = extractArray(data);
        }

        // NUEVO: también cargar /api/customers y unificar con leadsRaw
        try {
          const custRes = await fetch('/api/customers?page=1&limit=1000', fetchOptions);
          if (custRes.ok) {
            const custJson = await custRes.json();
            const customers = extractArray(custJson);
            if (Array.isArray(customers) && customers.length) {
              const seen = new Set();
              const normId = (v) => {
                try { if (!v) return ''; if (typeof v === 'object') return String(v.$oid||v._id||v.id||v.value||''); return String(v); } catch { return String(v||''); }
              };
              const out = [];
              for (const a of (leadsRaw||[])) {
                const key = normId(a._id)||normId(a.id)||JSON.stringify(a).length;
                if (!seen.has(key)) { seen.add(key); out.push(a); }
              }
              for (const b of customers) {
                const key = normId(b._id)||normId(b.id)||JSON.stringify(b).length;
                if (!seen.has(key)) { seen.add(key); out.push(b); }
              }
              leadsRaw = out;
              console.log('[unify customers] Unificados leads+customers ->', leadsRaw.length);
            }
          } else {
            console.warn('[unify customers] /api/customers no OK:', custRes.status);
          }
        } catch (e) {
          console.warn('[unify customers] error:', e?.message);
        }

        // Unificar fuentes: intentar endpoints alternos solo si no llegaron datos
        if (!isTeamLineasUser && (!Array.isArray(leadsRaw) || leadsRaw.length === 0)) {
          try {
            const altUrls = [
              '/api/leads?page=1&limit=1000',
              '/api/leads?page=1&limit=1000&skipDate=1'
            ];
            let extra = [];
            for (const alt of altUrls) {
              try {
                const r = await fetch(alt, fetchOptions);
                if (!r.ok) { console.warn('[unify fetch] no OK para', alt, r.status); continue; }
                const d = await r.json();
                const arr = extractArray(d);
                console.log('[unify fetch] Resultado', alt, '->', Array.isArray(arr)?arr.length:0);
                if (Array.isArray(arr) && arr.length) { extra = arr; break; }
              } catch (e) { console.warn('[unify fetch] error', alt, e?.message); }
            }
            // Combinar únicos por _id/id
            const seen = new Set();
            const normId = (v) => {
              try { if (!v) return ''; if (typeof v === 'object') return String(v.$oid||v._id||v.id||v.value||''); return String(v); } catch { return String(v||''); }
            };
            const out = [];
            for (const a of (leadsRaw||[])) {
              const key = normId(a._id)||normId(a.id)||JSON.stringify(a).length;
              if (!seen.has(key)) { seen.add(key); out.push(a); }
            }
            for (const b of (extra||[])) {
              const key = normId(b._id)||normId(b.id)||JSON.stringify(b).length;
              if (!seen.has(key)) { seen.add(key); out.push(b); }
            }
            leadsRaw = out;
            console.log('[unify fetch] Unificados customers+leads ->', leadsRaw.length);
          } catch (e) { console.warn('[unify fetch] bloque error', e?.message); }
        }

        // Paginación: si el backend reporta más páginas, descargarlas y combinarlas
        try {
          const totalPages = Number(data?.pages || data?.pagination?.totalPages || 1);
          const currentPage = Number(data?.page || data?.pagination?.page || 1);
          const limit = Number(data?.limit || data?.pagination?.limit || 100);
          if (totalPages > currentPage) {
            console.log(`[fetchLeadsAgente] Se detectaron ${totalPages} páginas. Descargando páginas restantes...`);
            const u = new URL(url, window.location.origin);
            const baseParams = new URLSearchParams(u.search);
            baseParams.set('limit', String(limit || 100));
            for (let p = currentPage + 1; p <= totalPages; p++) {
              baseParams.set('page', String(p));
              const pageUrl = `${u.pathname}?${baseParams.toString()}`;
              try {
                const r = await fetch(pageUrl, fetchOptions);
                if (!r.ok) {
                  let errTxt = '';
                  try { errTxt = await r.text(); } catch (_) {}
                  console.warn(`[fetchLeadsAgente] Página ${p} no OK:`, r.status, errTxt);
                  continue;
                }
                const d = await r.json();
                const arr = Array.isArray(d)
                  ? d
                  : (Array.isArray(d.data) ? d.data
                    : (Array.isArray(d.data) ? d.data
                      : (Array.isArray(d.data) ? d.data : [])));
                console.log(`[fetchLeadsAgente] Página ${p} retornó ${arr.length} registros`);
                leadsRaw = leadsRaw.concat(arr);
              } catch (e) {
                console.warn(`[fetchLeadsAgente] Error descargando página ${p}:`, e?.message);
              }
            }
            console.log('[fetchLeadsAgente] Total acumulado tras paginación:', leadsRaw.length);
          }
        } catch (e) {
          console.warn('[fetchLeadsAgente] Error manejando paginación:', e?.message);
        }

        // FALLBACK DESHABILITADO: Ya no se usan datos de prueba
        // Solo se muestran datos reales de la base de datos
        if (!Array.isArray(leadsRaw) || leadsRaw.length === 0) {
          console.log('[fetchLeadsAgente] No se encontraron datos reales en la API');
          leadsRaw = [];
        }

        console.log('[fetchLeadsAgente] leadsRaw.length =', (leadsRaw && leadsRaw.length) || 0);
        let normalizedLeads = normalizeLeads(leadsRaw);
        console.log('[fetchLeadsAgente] normalizedLeads.length =', (normalizedLeads && normalizedLeads.length) || 0);

        // Fallback urgente: si no llegan datos y es Stefani, inyectar sus 6 ventas para visualización inmediata
        try {
          const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const myId = String(u.id || u._id || u?.usuario?._id || '').trim();
          const myName = String(u.username || u.name || u.nombre || '').trim().toLowerCase();
          const isStefani = myId === '68af41d0c61c405e2bb7b0c8' || myName === 'stefani martinez';
          if (isStefani && (!Array.isArray(normalizedLeads) || normalizedLeads.length === 0)) {
            const agenteId = '68af41d0c61c405e2bb7b0c8';
            const agenteNombre = 'Stefani Martinez';
            const seed = [
              { nombre_cliente:'YESSICA SOLANO', telefono_principal:'6158945285', telefono_alterno:'341292657', numero_cuenta:'', autopago:'SI', direccion:'916 Strand Fleet Dr Antioch TN 37013', tipo_servicios:'INTERNET', sistema:'SARA', riesgo:'HIGH', dia_venta:'2025-10-05', dia_instalacion:'2025-10-09', status:'ACTIVE', servicios_texto:'ATT 300 - 500 MB', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'37013', puntaje:1.25 },
              { nombre_cliente:'ALMA PELCASTRE', telefono_principal:'6303799455', telefono_alterno:'', numero_cuenta:'251013487881718', autopago:'SI', direccion:'5916 W Montrose Ave Chicago IL 60634 APT 2', tipo_servicios:'XFINTY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-13', dia_instalacion:'2025-10-17', status:'ACTIVE', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'60634', puntaje:0.75 },
              { nombre_cliente:'ANDRES VEGA', telefono_principal:'2542527389', telefono_alterno:'553864003665', numero_cuenta:'', autopago:'SI', direccion:'207 S 4th St Rosebud TX 76570', tipo_servicios:'AT&T AIR', sistema:'SARA', riesgo:'HIGH', dia_venta:'2025-10-15', dia_instalacion:'2025-10-17', status:'ACTIVE', servicios_texto:'ATT AIR', mercado:'BAMO', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'76570', puntaje:0.35 },
              { nombre_cliente:'JOSE TAVAREZ', telefono_principal:'4848388586', telefono_alterno:'4848388586', numero_cuenta:'2510204166879109', autopago:'SI', direccion:'1030 Perry St Reading PA 19604 REAR', tipo_servicios:'XFINITY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-20', dia_instalacion:'2025-10-23', status:'PENDING', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'19604', puntaje:0.75 },
              { nombre_cliente:'YOANDRIS SOL', telefono_principal:'5054486788', telefono_alterno:'5052218593', numero_cuenta:'2510214168598489', autopago:'SI', direccion:'304 Rhode Island St NE Albuquerque NM 87108 APT A', tipo_servicios:'XFINITY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-21', dia_instalacion:'2025-10-23', status:'PENDING', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'QUITAR FEE $99.00', motivo_llamada:'MUDANZA', zip_code:'87108', puntaje:0.75 },
              { nombre_cliente:'OLGA TRIGUEROS', telefono_principal:'2818653227', telefono_alterno:'4099969306', numero_cuenta:'1646522530', autopago:'SI', direccion:'6914 Highway 6 APT 1 Hitchcock TX 77563', tipo_servicios:'EARTHLINK', sistema:'SARA', riesgo:'N/A', dia_venta:'2025-10-23', dia_instalacion:'2025-11-04', status:'PENDING', servicios_texto:'INTERNET EARTHLINK 300 MB', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'77563', puntaje:1.0 }
            ].map(l => ({
              ...l,
              agenteId: agenteId,
              agenteNombre: agenteNombre,
              agente: agenteNombre,
              nombreAgente: agenteNombre,
              createdAt: l.dia_venta
            }));
            normalizedLeads = normalizeLeads(seed);
            console.warn('[fallback stefani] Inyectados 6 registros locales para visualización');
          }
        } catch (e) { console.warn('[fallback stefani] error', e?.message); }

        // Fallback: si no hay datos, intentar por agenteId y por nombre usando helpers
        if ((!Array.isArray(normalizedLeads) || normalizedLeads.length === 0) && !forceAll) {
          try {
            const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const ids = [userData._id, userData.id, userData.userId, userData.uid, userData?.usuario?._id, userData?.usuario?.id]
              .map(v => (v && String(v).trim()) || '')
              .filter(Boolean);
            const names = [userData.username, userData.name, userData.nombre, userData?.usuario?.username, userData?.usuario?.name, userData?.usuario?.nombre]
              .map(v => (v && String(v).trim()) || '')
              .filter(Boolean);
            let acc = [];
            // 1) Reintentar contra /api/leads con variantes de clave
            const variantKeys = ['agenteId','agentId','agente','agenteNombre','nombreAgente'];
            for (const key of variantKeys) {
              for (const v of (key.endsWith('Id') ? ids : names)) {
                try {
                  const u = `/api/leads?page=1&limit=100&${key}=${encodeURIComponent(v)}`;
                  const r = await fetch(u, fetchOptions);
                  if (!r.ok) { continue; }
                  const d = await r.json();
                  const arr = Array.isArray(d) ? d : (Array.isArray(d?.data) ? d.data : []);
                  if (arr.length) {
                    console.log(`[fallback /api/leads] ${key}=${v} -> ${arr.length}`);
                    acc = acc.concat(arr);
                    break; // siguiente key
                  }
                } catch (_) {}
              }
            }
            for (const id of ids) {
              const byId = await fetchLeadsByAgentId(id);
              if (Array.isArray(byId) && byId.length) acc = acc.concat(byId);
            }
            if (!acc.length) {
              for (const nm of names) {
                const byName = await fetchLeadsByAgentName(nm);
                if (Array.isArray(byName) && byName.length) { acc = acc.concat(byName); break; }
              }
            }
            if (acc.length) {
              console.warn('[fetchLeadsAgente] Fallback aplicado. Leads recuperados por id/nombre =', acc.length);
              normalizedLeads = normalizeLeads(acc);
            } else {
              console.warn('[fetchLeadsAgente] Fallback por id/nombre no encontró resultados');
            }
          } catch (e) {
            console.warn('[fetchLeadsAgente] Error en fallback por id/nombre:', e?.message);
          }
        }

        // Filtro por mes en frontend desactivado (el backend ya aplica filtro robusto)
        try { console.log('[Filtro mes actual frontend] desactivado; manteniendo', normalizedLeads.length, 'registros'); } catch(_){ }

    // Filtrar por agente si el usuario es role 'agent' SOLO si no se filtr¨® ya en el backend
    if (!alreadyFilteredByAgent && !forceAll) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const role = (function normalizeRole(r){
          if (!r) return 'agente';
          if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
          if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
          if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
          if (['backoffice','back office','back_office','bo'].includes(r)) return 'backoffice';
          return r;
        })(roleRaw);
        if (role === 'agente') {
          const norm = (s) => {
            try {
              const x = String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
              return x.replace(/[^a-z0-9]+/g,''); // quitar espacios y no alfanuméricos
            } catch {
              return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,'');
            }
          };
          const str = (v) => (v == null ? '' : String(v));
          // Candidatos de ID del usuario actual
          const myIds = [
            userData.id, userData._id, userData.userId, userData.uid,
            userData?.usuario?._id, userData?.usuario?.id,
            userData?.user?._id, userData?.user?.id,
            userData?.profile?._id, userData?.profile?.id
          ].map(str).filter(x => x.trim().length);

          // Candidatos de nombre del usuario actual
          const myNames = [
            userData.name, userData.nombre, userData.username, userData.email,
            userData?.usuario?.name, userData?.usuario?.nombre, userData?.usuario?.username
          ].map(str).filter(x => x.trim().length);

          const getId = (l) => {
            if (typeof getAgentId === 'function') return getAgentId(l);
            const raw = (
              l?.agenteId || l?._raw?.agenteId || l?.agente_id || l?._raw?.agente_id ||
              l?.idAgente || l?._raw?.idAgente || l?.agentId || l?._raw?.agentId ||
              l?.creadoPor || l?._raw?.creadoPor || l?.creado_por || l?._raw?.creado_por ||
              l?.createdBy || l?._raw?.createdBy || l?.ownerId || l?._raw?.ownerId ||
              l?.registeredById || l?._raw?.registeredById ||
              l?.assignedId || l?._raw?.assignedId || ''
            );
            try {
              if (raw && typeof raw === 'object') {
                const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
                return String(maybe || '').trim();
              }
              return String(raw || '').trim();
            } catch(_) {
              return String(raw || '').trim();
            }
          };
          const getName = (l) => {
            if (typeof getAgentName === 'function') return getAgentName(l);
            const cand = [
              l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
              l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
            ];
            const v = cand.find(x => x && String(x).trim().length);
            const raw = v ? String(v).trim() : '';
            return agentCanonicalName(raw);
          };

          const myIdsNorm = new Set(myIds.map(x => norm(x)));
          // Incluir variantes canónicas del usuario en el conjunto de comparación
          const myNamesCanon = myNames.map(n => agentCanonicalName(n));
          const myNamesNorm = new Set([...myNames, ...myNamesCanon].map(x => norm(x)));

          const beforeCount = normalizedLeads.length;
          normalizedLeads = normalizedLeads.filter(l => {
            const idMatch = (() => {
              const lid = norm(getId(l));
              if (!lid) return false;
              return myIdsNorm.has(lid);
            })();
            if (idMatch) return true;
            const nameMatch = (() => {
              const lname = norm(getName(l));
              if (!lname) return false;
              return myNamesNorm.has(lname);
            })();
            return nameMatch;
          });
          console.log(`[Filtro rol=agent] ${beforeCount} -> ${normalizedLeads.length} leads para el usuario actual (frontend)`);
        }
      } catch (e) {
        console.warn('No se pudo aplicar filtro por agente:', e?.message);
      }
    }

    // Filtrar por equipo si el usuario es 'supervisor' y NO est¨¢ activo forceAll
    if (!forceAll) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const role = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        if (role === 'supervisor' && window.Teams) {
          const supName = (userData.name || userData.nombre || userData.username || userData?.usuario?.name || userData?.usuario?.nombre || '').toString();
          const agents = (window.Teams.getAgentsBySupervisor && window.Teams.getAgentsBySupervisor(supName)) || [];
          const norm = window.Teams.norm || ((s)=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim());
          const canonicalFromName = window.Teams.canonicalFromName || ((name)=> norm(name));
          if (Array.isArray(agents) && agents.length) {
            // Conjunto de agentes can¨®nicos del supervisor
            const teamAgentsCanon = new Set((agents || []).map(a => canonicalFromName(a)));
            const getName = (l) => {
              if (typeof getAgentName === 'function') return getAgentName(l);
              const cand = [
                l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
                l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
              ];
              const v = cand.find(x => x && String(x).trim().length);
              return v ? String(v).trim() : '';
            };
            const before = normalizedLeads.length;
            normalizedLeads = normalizedLeads.filter(l => teamAgentsCanon.has(canonicalFromName(getName(l))));
            console.log(`[Filtro rol=supervisor] ${before} -> ${normalizedLeads.length} leads del equipo de`, supName);
          } else {
            console.warn('[Filtro rol=supervisor] No se encontraron agentes para el supervisor:', supName);
          }
        }
      } catch (e) {
        console.warn('[Filtro rol=supervisor] No se pudo aplicar filtro por equipo:', e?.message);
      }
    }

    window.ultimaListaLeads = normalizedLeads;
    try {
      const sample = (normalizedLeads || []).slice(0, 3).map(l => ({
        _id: l._id || l.id,
        agenteId: l.agenteId || l.agente_id || l.idAgente || l.agentId,
        agente: l.agente || l.agent || l.agenteNombre || l.nombreAgente,
        dia_venta: l.dia_venta || l.FECHA || l.fecha || l.fecha_venta
      }));
      console.log('[fetchLeadsAgente] Muestra post-filtrado:', sample);
    } catch {}

        // Actualizar la interfaz
        if (typeof window.renderCostumerTable === 'function') {
            window.renderCostumerTable(normalizedLeads);
        } else {
            console.error('La funci¨®n renderCostumerTable no est¨¢ disponible');
        }
        
        // Crear toolbar de supervisor DESPUÉS de renderizar la tabla
        if (typeof window.createSupervisorToolbar === 'function') {
            console.log('🔧 [fetchLeadsAgente] Llamando a createSupervisorToolbar...');
            console.log('🔧 [fetchLeadsAgente] Datos disponibles:', !!normalizedLeads, 'Cantidad:', normalizedLeads?.length || 0);
            window.createSupervisorToolbar(normalizedLeads);
            console.log('🔧 [fetchLeadsAgente] createSupervisorToolbar ejecutada');
        } else {
            console.error('❌ [fetchLeadsAgente] createSupervisorToolbar NO está disponible');
            console.log('🔧 [fetchLeadsAgente] Verificando funciones disponibles:', Object.keys(window).filter(k => k.includes('create')));
        }
        
        // Logs de diagn¨®stico de asignaci¨®n (por TEAM y agente)
        try { if (typeof logDiagnosticoAsignacion === 'function') logDiagnosticoAsignacion(normalizedLeads); } catch(_) {}
        updateSummaryCards(normalizedLeads);

        return normalizedLeads;
      } catch (error) {
        console.error('Error en fetchLeadsAgente:', error);
        mostrarMensajeSinDatos();
        return [];
      }
    }

    // Funci¨®n para manejar la ausencia de datos
    function mostrarMensajeSinDatos() {
      const tableBody = document.querySelector('#costumer-tbody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px;">
              <p>No se encontraron datos disponibles.</p>
              <p>Por favor, verifica tu conexi¨®n o contacta al administrador.</p>
            </td>
          </tr>
        `;
      }
      
      // Actualizar las tarjetas de resumen con valores en cero
      updateSummaryCards([]);
    }

    // Funci¨®n para cargar los datos iniciales
    async function cargarDatosIniciales() {
      console.log('[DEBUG] Iniciando cargarDatosIniciales...');
      // Mostrar indicador de carga si existe
      const loadingIndicator = document.getElementById('loading-indicator');
      
      try {
        console.log('[DEBUG] Iniciando carga de datos...');
        
        if (loadingIndicator) {
          console.log('[DEBUG] Mostrando indicador de carga');
          loadingIndicator.style.display = 'block';
        }
        // Cargar datos del servidor usando la funci¨®n unificada
        console.log('[DEBUG] Llamando a cargarDatosDesdeServidor...');
        if (typeof cargarDatosDesdeServidor === 'function') {
          await cargarDatosDesdeServidor();
          const arr = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : [];
          if (arr.length > 0) {
            console.log('[DEBUG] Datos de clientes cargados correctamente:', arr.length, 'registros');
            try { console.log('[DEBUG] Primer lead de ejemplo:', JSON.stringify(arr[0], null, 2)); } catch(_) {}
          } else {
            console.warn('[DEBUG] No se encontraron leads o el arreglo est¨¢ vac¨ªo tras cargarDatosDesdeServidor');
            mostrarMensajeSinDatos();
          }
        } else if (typeof fetchLeadsAgente === 'function') {
          // Fallback por compatibilidad, pero preferimos la ruta unificada
          console.log('[DEBUG] cargarDatosDesdeServidor no disponible, usando fallback fetchLeadsAgente');
          const leads = await fetchLeadsAgente();
          if (!leads || leads.length === 0) mostrarMensajeSinDatos();
        } else {
          console.warn('[DEBUG] No hay funci¨®n de carga disponible');
          mostrarMensajeSinDatos();
        }
      } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        mostrarMensajeSinDatos();
      } finally {
        // Ocultar indicador de carga si existe
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }
    }
    


    // Manejar b¨²squeda
    document.getElementById('costumer-search').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#costumer-tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });

    // Función para formatear fechas con el formato 'día_de_la_semana número_del_día' (ej: 'mié 13')
    function formatearFechaSinDesfase(fechaStr) {
      try {
        // Usar utilidad centralizada si está disponible
        if (window.DateUtils && window.DateUtils.formatShortDate) {
          return window.DateUtils.formatShortDate(fechaStr);
        }
        
        // Fallback: implementación manual
        if (typeof fechaStr !== 'string') {
          console.warn('Tipo de fecha no soportado:', typeof fechaStr, fechaStr);
          return 'N/A';
        }

        const fechaLimpia = fechaStr.trim();
        let day, month, year;
        
        // Intentar con formato YYYY-MM-DD
        let match = fechaLimpia.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          [_, year, month, day] = match;
        } 
        // Si no coincide, intentar con formato DD/MM/YYYY
        else if ((match = fechaLimpia.match(/^(\d{2})\/(\d{2})\/(\d{4})/))) {
          [_, day, month, year] = match;
        }
        else {
          console.warn('Formato de fecha no reconocido:', fechaLimpia);
          return 'N/A';
        }
        
        // Convertir a números y crear fecha LOCAL
        year = parseInt(year, 10);
        month = parseInt(month, 10) - 1;
        day = parseInt(day, 10);
        
        const fecha = new Date(year, month, day);
        
        if (isNaN(fecha.getTime())) {
          console.warn('Fecha inválida:', fechaLimpia);
          return 'N/A';
        }
        
        const diasSemana = ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'];
        const diaSemana = diasSemana[fecha.getDay()];
        const diaMes = fecha.getDate();
        
        return `${diaSemana} ${diaMes}`;
        
      } catch (error) {
        console.error('Error al formatear fecha:', error, 'Valor:', fechaStr);
        return 'Fecha inválida';
      }
    }
    
    // Helper (local): obtener rol actual normalizado
    // NOTA: Renombrado a getUserRole_local para no sobreescribir la versi¨®n global de script.js
    function getUserRole_local() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return (user.role || '').toString().trim().toLowerCase();
      } catch { return ''; }
    }

    // Helper (local): verificar si el usuario puede editar status (Administrador / B.O)
    // NOTA: Renombrado a canEditStatus_local para no sobreescribir la versi¨®n global de script.js
    function canEditStatus_local() {
      const r = getUserRole_local();
      // Aceptar variantes comunes desde frontend (referencial, no usada por la tabla)
      return ['admin','administrador','backoffice','b:o','b.o','b-o','bo'].includes(r);
    }

    // Helper: normalizar status hacia las 5 opciones y devolver etiqueta capitalizada
    function normalizeStatusLabel(s) {
      const allowed = ['pending','hold','cancelled','rescheduled','completed'];
      const v = (s || '').toString().trim();
      const lower = v.toLowerCase();
      const pick = allowed.includes(lower)
        ? lower
        : (v.toLowerCase().includes('pend') ? 'pending' : null) ||
          (v.toLowerCase().includes('hold') ? 'hold' : null) ||
          (v.toLowerCase().includes('cancel') ? 'cancelled' : null) ||
          (v.toLowerCase().includes('reprogram') || v.toLowerCase().includes('reagend') || v.toLowerCase().includes('resched') ? 'rescheduled' : null) ||
          (v.toLowerCase().includes('compl') || v.toLowerCase().includes('termin') ? 'completed' : null) ||
          'pending';
      return pick.charAt(0).toUpperCase() + pick.slice(1);
    }

    // Helper: clase de badge seg¨²n nuevo set de estados
    function statusToBadgeClass(label) {
      const lower = (label||'').toString().toLowerCase();
      if (lower === 'pending') return 'badge-warning';
      if (lower === 'hold') return 'badge-info';
      if (lower === 'cancelled') return 'badge-danger';
      if (lower === 'rescheduled') return 'badge-primary';
      if (lower === 'completed') return 'badge-success';
      return 'badge-info';
    }

    // Llamada al backend para actualizar el status (local)
    // NOTA: Renombrado a updateLeadStatusLocal para no sobreescribir la versi¨®n global de script.js
    async function updateLeadStatusLocal(selectEl, leadId) {
      try {
        // Validar ID antes de continuar
        if (!leadId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('No se pudo determinar el ID del lead. Recarga la p¨¢gina e int¨¦ntalo nuevamente.');
          return;
        }
        // Sanitizar y normalizar ID
        const cleanId = String(leadId).trim();
        if (!cleanId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('ID de lead vac¨ªo o inv¨¢lido.');
          return;
        }
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          alert('No hay token de autenticaci¨®n. Inicia sesi¨®n nuevamente.');
          return;
        }
        const newVal = selectEl.value; // Etiqueta capitalizada
        // Deshabilitar durante la petici¨®n
        const prevDisabled = selectEl.disabled; selectEl.disabled = true;
        try {
          const url = `/api/leads/${encodeURIComponent(cleanId)}/status`;
          console.debug('[updateLeadStatus] PUT', { id: cleanId, url, status: newVal });
          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ status: newVal })
          });
          let data = {};
          try { data = await res.json(); } catch { data = {}; }
          if (!res.ok || !data?.success) {
            // Manejo espec¨ªfico por c¨®digos comunes
            if (res.status === 401) throw new Error('No autorizado (401). Verifica el token de sesi¨®n.');
            if (res.status === 403) throw new Error('Permisos insuficientes (403). Solo admin/supervisor pueden actualizar.');
            if (res.status === 404) throw new Error(data?.message || 'Lead no encontrado (404). Verifica que el ID exista en la base de datos.');
            throw new Error(data?.message || `Error ${res.status || ''}: No se pudo actualizar el estado`);
          }
          // Actualizar badge visual si existe al lado del select
          const badge = selectEl.closest('td')?.querySelector('span.badge');
          if (badge) {
            badge.textContent = newVal;
            badge.className = `badge ${statusToBadgeClass(newVal)}`;
          }
        } catch(err) {
          console.error('Error al actualizar status:', err);
          alert(`Error: ${err.message}`);
          // Revertir valor si falla
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
        } finally {
          // Guardar nuevo previo
          selectEl.setAttribute('data-prev', selectEl.value);
          selectEl.disabled = prevDisabled;
        }
      } catch(e) {
        console.error(e);
      }
    }

    // Paginación por defecto
    if (typeof window.__limit === 'undefined') window.__limit = 100;
    if (typeof window.__page === 'undefined') window.__page = 1;

    // Función principal para renderizar la tabla de clientes
    window.renderCostumerTable = function(leads) {
      console.log('renderCostumerTable llamada con leads:', leads);
      
      // Asegurarse de que leads sea un array
      let leadsArray = Array.isArray(leads) 
        ? leads 
        : (leads && leads.leads && Array.isArray(leads.leads)) 
          ? leads.leads 
          : [];
      // Guardar la ¨²ltima lista para re-renderizados por filtros/toolbar
      try { window.ultimaListaLeads = leadsArray.slice(); } catch(_) {}
      // Paginación en cliente
      try {
        const total = leadsArray.length;
        const limit = Number(window.__limit) || 100;
        const totalPages = Math.max(1, Math.ceil(total / limit));
        if (typeof window.__page !== 'number' || window.__page < 1) window.__page = 1;
        if (window.__page > totalPages) window.__page = totalPages;
        const start = (window.__page - 1) * limit;
        const end = start + limit;
        leadsArray = leadsArray.slice(start, end);
        // Actualizar controles UI
        const info = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('pagePrev');
        const nextBtn = document.getElementById('pageNext');
        if (info) info.textContent = `Página ${window.__page} de ${totalPages} — ${total} clientes`;
        if (prevBtn) prevBtn.disabled = (window.__page <= 1);
        if (nextBtn) nextBtn.disabled = (window.__page >= totalPages);
        // Enlazar eventos una sola vez
        if (!window.__pagingBound) {
          if (prevBtn) prevBtn.addEventListener('click', function(){ if (window.__page > 1) { window.__page--; window.renderCostumerTable(window.ultimaListaLeads||[]); } });
          if (nextBtn) nextBtn.addEventListener('click', function(){ const tp = Math.max(1, Math.ceil((window.ultimaListaLeads||[]).length / (Number(window.__limit)||100))); if (window.__page < tp) { window.__page++; window.renderCostumerTable(window.ultimaListaLeads||[]); } });
          window.__pagingBound = true;
        }
      } catch(_) {}
      // Migraci¨®n de compatibilidad: renombrar filtro legado a nombre neutral
      try {
        if (window.iraniaAgentFilter != null && window.supervisorAgentFilter == null) {
          window.supervisorAgentFilter = window.iraniaAgentFilter;
        }
      } catch(_) {}
      // Construir/actualizar mapas GLOBAL: id -> can¨®nico y can¨®nico -> ids
      try {
        const teamsApi = (window && window.Teams) ? window.Teams : null;
        const canonical = (name) => {
          try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : String(name||'').toLowerCase().trim(); } catch { return String(name||'').toLowerCase().trim(); }
        };
        const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
        const extractIds = (l) => {
          const ids = [];
          const candidates = [
            l?.agenteId, l?._raw?.agenteId, l?.agente_id, l?._raw?.agente_id,
            l?.idAgente, l?._raw?.idAgente, l?.agentId, l?._raw?.agentId,
            l?.creadoPor, l?._raw?.creadoPor, l?.creado_por, l?._raw?.creado_por,
            l?.createdBy, l?._raw?.createdBy, l?.ownerId, l?._raw?.ownerId,
            l?.registeredById, l?._raw?.registeredById,
            l?.assignedId, l?._raw?.assignedId
          ];
          for (const v of candidates) {
            if (!v) continue;
            if (typeof v === 'object') {
              const oid = v.$oid || v.id || v._id || v.value;
              if (oid) ids.push(String(oid));
            } else {
              let s = String(v);
              // Normalizar formato "ObjectId('...')"
              const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/);
              if (m) s = m[1];
              ids.push(s);
            }
          }
          return ids.map(x => x && x.trim()).filter(Boolean);
        };
        const idMap = window.__idToCanonGlobal instanceof Map ? window.__idToCanonGlobal : new Map();
        (leadsArray||[]).forEach(l => {
          const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
          const canon = canonical(norm(cand));
          if (!canon) return;
          const ids = extractIds(l);
          ids.forEach(id => { try { idMap.set(id, canon); } catch(_) {} });
          try { l.__agentCanon = l.__agentCanon || canon; } catch(_) {}
        });
        // Override expl¨ªcito conocido: Eduardo Rivas (ID actualizado)
    try { idMap.set('68bb1ddd0d4d7cdcb6eb3605', 'eduardo rivas'); } catch(_) {}
    window.__idToCanonGlobal = idMap;
        console.log('[ID->Canon] Tama?o del mapa:', idMap.size);
      } catch(e) { console.warn('[ID->Canon] Error al construir mapa:', e); }
      // Flag de depuraci¨®n: si la URL contiene debugNoFilters=1, no aplicar filtros especiales ni vistas por TEAM
      let __debugNoFilters = false;
      try {
        const usp = new URLSearchParams(window.location.search || '');
        __debugNoFilters = (usp.get('debugNoFilters') === '1' || usp.get('debugNoFilters') === 'true');
      } catch(_) { __debugNoFilters = false; }

      // Construir mapa global id->agenteCan¨®nico para mejorar detecci¨®n por agenteId
      try {
        const teamsApiG = (window && window.Teams) ? window.Teams : null;
        const normG = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
        const canonicalFromNameG = (name) => {
          try { return teamsApiG && typeof teamsApiG.canonicalFromName==='function' ? teamsApiG.canonicalFromName(name) : normG(name); } catch { return normG(name); }
        };
        const getAgentIdGlobal = (l) => {
          const raw = (
            l?.agenteId || l?._raw?.agenteId ||
            l?.agente_id || l?._raw?.agente_id ||
            l?.idAgente || l?._raw?.idAgente ||
            l?.agentId || l?._raw?.agentId ||
            l?.creadoPor || l?._raw?.creadoPor ||
            l?.creado_por || l?._raw?.creado_por ||
            l?.createdBy || l?._raw?.createdBy ||
            l?.ownerId || l?._raw?.ownerId ||
            l?.assignedId || l?._raw?.assignedId || ''
          );
          try {
            if (raw && typeof raw === 'object') {
              const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
              return String(maybe || '').trim();
            }
            return String(raw || '').trim();
          } catch(_) { return String(raw || '').trim(); }
        };
        const idToCanonGlobal = new Map();
        (leadsArray||[]).forEach(l => {
          const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
          const canon = canonicalFromNameG(cand);
          const aid = getAgentIdGlobal(l);
          if (canon && aid) idToCanonGlobal.set(aid, canon);
        });
        try { window.__idToCanonGlobal = idToCanonGlobal; } catch(_) {}
      } catch(_) {}
      
      // Filtro especial: si el usuario es Irania Serrano, mostrar solo leads de su TEAM
      try {
        if (__debugNoFilters) throw new Error('DEBUG: filtros desactivados');
        const isIraniaUser = (typeof esIrania === 'function') && esIrania();
        // No aplicar el filtro de TEAM IRANIA para roles admin o supervisor
        const __role = (typeof getUserRole_local === 'function') ? (getUserRole_local() || '') : '';
        if (isIraniaUser && !['admin','supervisor'].includes((__role || '').toLowerCase())) {
          const norm = s => (s || '')
            .toString()
            .normalize('NFD')
            .replace(/\p{Diacritic}+/gu, '')
            .trim()
            .toLowerCase()
            .replace(/\s+/g, ' ');
          const teamAgents = new Set([
            'irania serrano',
            'giselle diaz',
            'josue renderos',
            'miguel nunez',
            'roxana martinez',
            'tatiana ayala'
          ]);
          const surnameToFull = new Map([
            ['serrano', 'irania serrano'],
            ['diaz', 'giselle diaz'],
            ['renderos', 'josue renderos'],
            ['nunez', 'miguel nunez'],
            ['martinez', 'roxana martinez'],
            ['ayala', 'tatiana ayala'],
          ]);
          const fullNames = Array.from(teamAgents);
          const surnames = Array.from(surnameToFull.keys());
          const teamCanon = [
            'josue renderos',
            'tatiana ayala',
            'giselle diaz',
            'miguel nunez',
            'roxana martinez',
            'irania serrano'
          ];
          const canonicalFromName = (name) => {
            const n = norm(name);
            if (!n) return '';
            if (teamCanon.includes(n)) return n;
            for (const c of teamCanon) {
              const toks = c.split(' ');
              if (toks.every(t => n.includes(t))) return c;
            }
            return '';
          };
          // Canonizaci¨®n por primer nombre (fallback) para TEAM IRANIA
          const canonicalFromFirstName = (name) => {
            const n = norm(name);
            if (!n) return '';
            const first = n.split(' ')[0];
            const dict = new Map([
              ['josue', 'josue renderos'],
              ['tatiana', 'tatiana ayala'],
              ['giselle', 'giselle diaz'],
              ['miguel', 'miguel nunez'],
              ['roxana', 'roxana martinez'],
              ['irania', 'irania serrano'],
            ]);
            return dict.get(first) || '';
          };
          
          const getAgentName = (l) => {
            // 1) Campos comunes (priorizar 'agenteNombre') e incluir _raw.* del backend
            const candidates = [
              l?.agenteNombre,
              l?.nombreAgente,
              l?._raw?.agenteNombre,
              l?._raw?.nombreAgente,
              l?.agente, l?.Agente, l?.agent, l?.Agent, l?.vendedor, l?.seller,
              l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
              l?.nombre_agente, l?.agente_nombre, l?.agentName, l?.salesAgent,
              l?._raw?.nombre_agente, l?._raw?.agente_nombre, l?._raw?.agentName, l?._raw?.salesAgent,
              l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
              l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to,
              l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
              l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy
            ];
            const foundDirect = candidates.find(v => v && v.toString().trim().length);
            if (foundDirect) {
              const n = norm(foundDirect);
              // match por nombre completo primero
              if (teamAgents.has(n)) return n;
              // si no, intenta emparejar por apellido
              const hit = surnames.find(sn => n.includes(sn));
              if (hit) return surnameToFull.get(hit);
            }
            // 1a) Fallback por primer nombre si Team/supervisor indica TEAM IRANIA
            try {
              const eq = norm(l?.equipo || l?._raw?.equipo || l?.Team || l?.team || l?._raw?.Team || l?._raw?.team || '');
              const sup = norm(l?.supervisor || l?._raw?.supervisor || '');
              if (eq.includes('team irania') || sup.includes('team irania')) {
                const nombreAg = l?.nombreAgente || l?._raw?.nombreAgente || '';
                const byFirst = canonicalFromFirstName(nombreAg);
                if (byFirst) {
                  console.log('[Filtro TEAM IRANIA] Agente detectado por primer nombre:', byFirst);
                  return byFirst;
                }
              }
            } catch(_) {}
            // 2) Escaneo amplio: buscar cualquier string que contenga nombres/apellidos
            try {
              const scan = (obj) => {
                for (const [k, v] of Object.entries(obj || {})) {
                  if (v && typeof v === 'string') {
                    const n = norm(v);
                    const hitFull = fullNames.find(fn => n.includes(fn));
                    if (hitFull) return hitFull;
                    const hitSn = surnames.find(sn => n.includes(sn));
                    if (hitSn) return surnameToFull.get(hitSn);
                  }
                }
                return '';
              };
              const fromTop = scan(l || {});
              if (fromTop) return fromTop;
              const fromRaw = scan(l?._raw || {});
              if (fromRaw) return fromRaw;
            } catch(_) {}
            return '';
          };
          // ordenAgentes ya fue declarado arriba

          // Preservar lista original para fallback si el filtro quedara vac¨ªo
          const __originalLeads = Array.isArray(leadsArray) ? leadsArray.slice() : [];

          // Log de agentes detectados antes del filtro
          try {
            const agentesDetectados = Array.from(new Set((leadsArray||[]).map(getAgentName))).filter(Boolean);
            console.log('[TEAM IRANIA] Agentes detectados (normalizados):', agentesDetectados);
          } catch(_) {}
          
          // Construir mapa agenteId -> agente can¨®nico (aceptar m¨²ltiples variantes de campo)
          const getAgentId = (l) => {
            const raw = (
              l?.agenteId || l?._raw?.agenteId ||
              l?.agente_id || l?._raw?.agente_id ||
              l?.idAgente || l?._raw?.idAgente ||
              l?.agentId || l?._raw?.agentId ||
              l?.creadoPor || l?._raw?.creadoPor ||
              l?.creado_por || l?._raw?.creado_por ||
              l?.createdBy || l?._raw?.createdBy ||
              l?.ownerId || l?._raw?.ownerId ||
              l?.assignedId || l?._raw?.assignedId || ''
            );
            try {
              if (raw && typeof raw === 'object') {
                const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
                return String(maybe || '').trim();
              }
              return String(raw || '').trim();
            } catch(_) {
              return String(raw || '').trim();
            }
          };
          // 1) Mapa est¨¢tico proporcionado (TEAM IRANIA)
          const idToCanon = new Map([
            ['68af44c3c61c405e2bb7b0cb', 'giselle diaz'],   // Giselle Diaz
            ['68af457bc61c405e2bb7b0ce', 'roxana martinez'], // Roxana Martinez
            ['68af453bc61c405e2bb7b0cd', 'miguel nunez'],    // Miguel Nunez
            ['68af44efc61c405e2bb7b0cc', 'josue renderos'],  // Josue Renderos
            ['68af4597c61c405e2bb7b0cf', 'tatiana ayala'],   // Tatiana Ayala
          ]);
          // 2) Enriquecer con un mapa din¨¢mico usando los leads con nombre detectable
          try {
            (leadsArray||[]).forEach(l => {
              const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const canon = canonicalFromName(getAgentName(l));
              const aid = getAgentId(l);
              if (canon && aid) idToCanon.set(aid, canon);
            });
            console.debug('[TEAM IRANIA] idToCanon generado:', Array.from(idToCanon.entries()));
          } catch(_) {}
          
          // Filtro ESTRICTO con canonizaci¨®n: solo los agentes del TEAM IRANIA.
          // Si no se detecta agente pero el lead pertenece al equipo TEAM IRANIA por campo `equipo`, NO lo descartamos para no perderlo.
          const filteredStrict = leadsArray.filter(l => {
            const agente = getAgentName(l);
            const canon = canonicalFromName(agente);
            if (canon) {
              try { l.__agentCanon = canon; } catch(_) {}
              console.log('[Filtro TEAM IRANIA] Agente detectado:', canon);
              return true;
            }
            // intentar por agenteId con el mapa dinamico
            try {
              const aid = getAgentId(l);
              if (aid && idToCanon.has(aid)) {
                const mcanon = idToCanon.get(aid);
                try { l.__agentCanon = mcanon; } catch(_) {}
                console.log('[Filtro TEAM IRANIA] Agente detectado por ID:', mcanon);
                return true;
              }
            } catch(_) {}
            // fallback por equipo/supervisor
            try {
              const eq = norm(l?.equipo || l?._raw?.equipo || '');
              const sup = norm(l?.supervisor || l?._raw?.supervisor || '');
              if (eq.includes('team irania') || sup.includes('team irania')) {
                console.debug('[Filtro TEAM IRANIA] Manteniendo lead sin agente detectado por pertenecer al equipo/supervisor.', { eq, sup, leadId: (typeof getLeadId==='function')?getLeadId(l):undefined });
                return true;
              }
            } catch(_) {}
            return false;
          });
          // Si el filtro deja la lista vac¨ªa, mantener la lista original para no ocultar datos
          if (!filteredStrict || filteredStrict.length === 0) {
            console.warn('[Filtro TEAM IRANIA] Resultado vac¨ªo; se mantiene lista original para no ocultar datos.');
            leadsArray = __originalLeads;
          } else {
            leadsArray = filteredStrict;
          }
          console.log('[Filtro TEAM IRANIA - estricto] Leads tras filtro:', leadsArray.length);
        }
      } catch (e) {
        console.warn('No se pudo aplicar el filtro de TEAM IRANIA:', e);
      }
          
      console.log('Datos a renderizar (array):', leadsArray);
      
      const tbody = document.getElementById('costumer-tbody');
      console.log('Elemento tbody encontrado:', tbody);
      if (!tbody) {
        console.error('No se encontr¨® el elemento con ID costumer-tbody');
        return;
      }
      
      tbody.innerHTML = '';
      // Permitir que el rol supervisor vea la tabla (se removi¨® el aviso de permisos)
      
      // Funci¨®n interna para a?adir una fila de lead manteniendo el orden y estilos 
      function appendLeadRow(lead) {
        const tr = document.createElement('tr');
        
        // Normalizar estado al conjunto requerido y su clase
        const statusLabel = normalizeStatusLabel(lead.status);
        const statusClass = statusToBadgeClass(statusLabel);
        const editable = canEditStatus();
        
        const fullComment = typeof lead.comentarios_venta === 'string' ? lead.comentarios_venta : '';
        const displayComment = fullComment ? (fullComment.length > 40 ? fullComment.substring(0, 40) + '...' : fullComment) : 'Ver comentarios';
        const titleAttr = fullComment ? escapeAttr(fullComment) : 'Ver comentarios';

        const __id = getLeadId(lead);
        const __key = (() => {
          if (__id) return __id;
          try {
            window.__leadLocalCounter = (window.__leadLocalCounter || 0) + 1;
            const k = 'local_' + window.__leadLocalCounter;
            if (!window.__leadKeyMap) window.__leadKeyMap = new Map();
            window.__leadKeyMap.set(k, lead);
            return k;
          } catch(_) {
            return 'local_tmp';
          }
        })();

        tr.innerHTML = `
          <td>${lead.nombre_cliente || 'N/A'}</td>
          <td>${lead.telefono_principal || 'N/A'}</td>
          <td>${lead.telefono_alterno || 'N/A'}</td>
          <td>${lead.numero_cuenta || 'N/A'}</td>
          <td>${(() => {
            const autop = lead.autopay ?? lead.autopago;
            return typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : 
                   (String(autop || '').toUpperCase() === 'SI' ? 'Sí' : 
                   (String(autop || '').toUpperCase() === 'NO' ? 'No' : (autop || 'N/A')));
          })()}</td>
          <td>${lead.direccion || 'N/A'}</td>
          <td>${lead.tipo_servicios || 'N/A'}</td>
          <td>${lead.sistema || 'N/A'}</td>
          <td>${lead.riesgo || 'N/A'}</td>
          <td>${(() => {
              console.log('Datos de lead:', {
                dia_venta: lead.dia_venta,
                dia_instalacion: lead.dia_instalacion,
                fecha_contratacion: lead.fecha_contratacion
              });
              return lead.dia_venta ? formatearFechaSinDesfase(lead.dia_venta) : 'N/A';
            })()}</td>
          <td>${lead.dia_instalacion ? formatearFechaSinDesfase(lead.dia_instalacion) : 'N/A'}</td>
          <td class="status-col">
            ${editable ? `
              <select class="status-select compact" data-prev="${statusLabel}" onchange="updateLeadStatus('${getLeadId(lead)}', this.value)">
                ${['Pending','Hold','Cancelled','Rescheduled','Completed'].map(opt => `
                  <option value="${opt.toLowerCase()}" ${opt===statusLabel?'selected':''}>${opt}</option>
                `).join('')}
              </select>
            ` : `
              <span class="badge ${statusClass}">${statusLabel}</span>
            `}
          </td>
          <td>${lead.servicios || 'N/A'}</td>
          <td>${lead.mercado || 'N/A'}</td>
          <td>${lead.supervisor || 'N/A'}</td>
          <td>${lead.comentario || 'N/A'}</td>
          <td>${lead.motivo_llamada || 'N/A'}</td>
          <td>${lead.zip_code || lead.zip || lead.ZIP || lead.cp || lead.codigo_postal || lead.postalCode || 'N/A'}</td>
          <td>${lead.puntaje || 'N/A'}</td>
          <td>
            <div style="display:flex; align-items:center; gap:10px;">
              <button class="action-btn" title="Editar" onclick="${__id ? `editarLead('${__id}')` : `editarLeadKey('${__key}')`}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn" title="Eliminar" onclick="eliminarLead('${getLeadId(lead)}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        // Obtener tbody localmente (evitar ReferenceError si no existe en el scope)
        const tbody = document.getElementById('costumer-tbody');
        if (!tbody) {
          console.warn('[appendLeadRow] No se encontr¨® #costumer-tbody en el DOM');
          return;
        }
        tbody.appendChild(tr);
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
      }

      // Guardar STATUS del lead (usado por el <select class="status-select">)
      function canEditStatus(){
        try{
          const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const r = String(u.role||u?.usuario?.role||'').toLowerCase();
          return r.includes('admin') || r.includes('administrador') || r.includes('backoffice') || r.includes('supervisor');
        }catch{ return false; }
      }
      window.updateLeadStatus = async function(id, newStatus){
        try{
          if (!canEditStatus()) { alert('No tienes permisos para cambiar el STATUS'); return; }
          if (!id) { alert('ID inválido'); return; }
          // Mantener idioma tal como viene del select
          const payload = { status: newStatus };
          const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
          const opts = (method, body) => ({ method, credentials: 'include', headers, body: JSON.stringify(body) });
          // Endpoint real en backend
          const target = { url: `/api/leads/${encodeURIComponent(id)}/status`, method: 'PUT', body: payload };
          let ok = false, lastErr;
          console.log('[STATUS] Guardando', { id, newStatus, endpoint: target.url });
          // feedback visual: desactivar todos los selects de esa fila
          try{
            const sel = document.querySelector(`select.status-select[onchange*="${id}"]`);
            if (sel) sel.disabled = true;
          }catch{}
          try{
            const res = await fetch(target.url, opts(target.method, target.body));
            console.log('[STATUS] Respuesta', target.method, target.url, res.status);
            if (res.ok) ok = true; else lastErr = new Error(`HTTP ${res.status} @ ${target.url}`);
          }catch(e){ lastErr = e; }
          if (!ok) { throw lastErr || new Error('No se pudo actualizar el STATUS'); }
          // Refrescar datos visibles (si hay pipeline), si no recargar página
          try {
            if (typeof window.renderCostumerTable === 'function' && Array.isArray(window.ultimaListaLeads)){
              // actualizar en memoria y re-render rápido
              const lead = (window.ultimaListaLeads||[]).find(l=>String((typeof getLeadId==='function')?getLeadId(l):l.id)===String(id));
              if (lead) { try { lead.status = newStatus; } catch(_) {} }
              window.renderCostumerTable(window.ultimaListaLeads);
            } else {
              // fallback: recargar para asegurar persistencia
              location.reload();
            }
          } catch { location.reload(); }
        }catch(e){
          console.warn('[STATUS] Falló actualización:', e);
          alert('No se pudo actualizar el STATUS: ' + (e?.message||e));
        }
      }

      // Helper: render con separadores mensuales usando getDateFromLead
      function renderWithMonthlySeparators(list) {
        const tbodyLoc = document.getElementById('costumer-tbody');
        if (!tbodyLoc) return;
        const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        // Ordenar por fecha descendente usando getDateFromLead (YYYY-MM-DD)
        const sorted = (Array.isArray(list) ? list.slice() : []).sort((a,b) => {
          const da = getDateFromLead(a); // 'YYYY-MM-DD' o ''
          const db = getDateFromLead(b);
          const ta = da ? Date.parse(da) : 0;
          const tb = db ? Date.parse(db) : 0;
          return tb - ta; // descendente
        });
        let lastKey = '';
        sorted.forEach(item => {
          const iso = getDateFromLead(item);
          let key = 'Sin fecha';
          let title = 'Sin fecha — Clientes';
          if (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) {
            const [y, m] = iso.split('-').map(Number);
            key = `${y}-${('0'+m).slice(-2)}`;
            title = `${monthNames[(m||1)-1]} ${y} — Clientes`;
          }
          if (key !== lastKey) {
            lastKey = key;
            const sep = document.createElement('tr');
            sep.className = 'costumer-month-separator';
            sep.innerHTML = `<td colspan="21" style="background:#e2e8f0;font-weight:700;border-left:4px solid #1976d2;padding:12px 18px;color:#0f172a;">${title}</td>`;
            tbodyLoc.appendChild(sep);
          }
          appendLeadRow(item);
        });
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
      }

      // Helper: obtener agente can¨®nico desde m¨²ltiples campos y escaneo amplio
      function getAgentCanonUniversal(l) {
        try {
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const canonical = (name) => {
            try {
              return teamsApi && typeof teamsApi.canonicalFromName === 'function'
                ? teamsApi.canonicalFromName(name)
                : (name||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
            } catch { return (name||'').toString().trim().toLowerCase(); }
          };
          if (l && l.__agentCanon) return l.__agentCanon;
          const candidates = [
            l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
            l?.vendedor, l?.seller, l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
            l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
            l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente,
            l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
            l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy,
            l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to
          ];
          const first = candidates.find(v => v && String(v).trim().length);
          if (first) { const c = canonical(first); try { if (c) l.__agentCanon = c; } catch(_) {} return c; }
          // Fallback por agenteId usando mapa global precalculado
          try {
            const idMap = window.__idToCanonGlobal;
            if (idMap && typeof idMap.get === 'function') {
              const raw = (
                l?.agenteId || l?._raw?.agenteId || l?.agente_id || l?._raw?.agente_id ||
                l?.idAgente || l?._raw?.idAgente || l?.agentId || l?._raw?.agentId ||
                l?.creadoPor || l?._raw?.creadoPor || l?.creado_por || l?._raw?.creado_por ||
                l?.createdBy || l?._raw?.createdBy || l?.ownerId || l?._raw?.ownerId ||
                l?.registeredById || l?._raw?.registeredById ||
                l?.assignedId || l?._raw?.assignedId || ''
              );
              const aid = (function(x){ try{ if (x && typeof x==='object') return String(x.$oid||x.id||x._id||x.value||'').trim(); let s=String(x||'').trim(); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); if(m) s=m[1]; return s; } catch{ return String(raw||'').trim(); } })(raw);
              if (aid) { const viaId = idMap.get(aid); if (viaId) { try { l.__agentCanon = viaId; } catch(_) {} return viaId; } }
            }
          } catch(_) {}
          // Escaneo amplio por strings en objetos anidados
          const scan = (obj) => {
            try {
              for (const [k,v] of Object.entries(obj||{})) {
                if (typeof v === 'string' && v) {
                  const c = canonical(v);
                  if (c) {
                    if (teamsApi && typeof teamsApi.getTeamByAgent === 'function') {
                      const t = teamsApi.getTeamByAgent(c);
                      if (t) { try { l.__agentCanon = c; } catch(_) {} return c; }
                    } else {
                      try { l.__agentCanon = c; } catch(_) {}
                      return c;
                    }
                  }
                }
              }
            } catch(_) {}
            return '';
          };
          const fromTop = scan(l);
          if (fromTop) return fromTop;
          const fromRaw = scan(l?._raw);
          if (fromRaw) return fromRaw;
          return '';
        } catch { return ''; }
      }

      // Forzar toolbar por TEAM v¨ªa query param: ?forceTeam=team%20marisol%20beltran
      try {
        const uspFT = new URLSearchParams(window.location.search || '');
        const forceTeamRaw = (uspFT.get('forceTeam') || uspFT.get('team') || '').toString();
        if (forceTeamRaw) {
          const teamsApiFT = (window && window.Teams) ? window.Teams : null;
          const normFT = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const teamKeyFT = teamsApiFT && typeof teamsApiFT.getTeamDef==='function' ? normFT(forceTeamRaw) : normFT(forceTeamRaw);
          let teamAgentsFT = [];
          if (teamsApiFT && typeof teamsApiFT.getAgentsByTeam==='function') {
            teamAgentsFT = teamsApiFT.getAgentsByTeam(teamKeyFT) || [];
          }
          // Fallback: derivar agentes desde leads si la lista viene vac¨ªa
          if ((!teamAgentsFT || teamAgentsFT.length===0) && Array.isArray(leadsArray)) {
            const setFT = new Set();
            leadsArray.forEach(l => {
              const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const c = teamsApiFT && typeof teamsApiFT.canonicalFromName==='function' ? teamsApiFT.canonicalFromName(cand) : normFT(cand);
              if (c) setFT.add(c);
            });
            teamAgentsFT = Array.from(setFT);
          }
          try {
            console.log('[Toolbar ForceTeam] teamKey =', teamKeyFT);
            console.log('[Toolbar ForceTeam] agentes (can¨®nicos) =', teamAgentsFT);
            if (teamsApiFT && typeof teamsApiFT.getDisplayName==='function') {
              console.log('[Toolbar ForceTeam] etiquetas =', teamAgentsFT.map(a=>teamsApiFT.getDisplayName(a)));
            }
          } catch(_) {}
          // Construir barra
          const tbodyElFT = document.getElementById('costumer-tbody');
          if (tbodyElFT) {
            const tableElFT = tbodyElFT.closest('table');
            const hostFT = tableElFT ? tableElFT : tbodyElFT;
            let barFT = document.getElementById('irania-agent-filter');
            if (!barFT) {
              barFT = document.createElement('div');
              barFT.id = 'irania-agent-filter';
              barFT.style.margin = '10px 0';
              barFT.style.display = 'flex';
              barFT.style.flexWrap = 'wrap';
              barFT.style.gap = '8px';
              (hostFT.parentElement || hostFT).insertBefore(barFT, hostFT);
              barFT.style.position = 'sticky';
              barFT.style.top = '0';
              barFT.style.zIndex = '10';
              barFT.style.background = '#ffffff';
              barFT.style.padding = '8px 8px';
            }
            const mkBtnFT = (label, value) => {
              const b = document.createElement('button');
              b.textContent = label;
              b.type = 'button';
              b.style.padding = '6px 10px';
              b.style.border = '1px solid #e2e8f0';
              b.style.borderRadius = '999px';
              b.style.background = '#ffffff';
              b.style.cursor = 'pointer';
              b.style.fontSize = '12px';
              const active = (window.supervisorAgentFilter || null) === value;
              if (active) { b.style.background = '#1d4ed8'; b.style.color = '#ffffff'; b.style.borderColor = '#1d4ed8'; }
              b.addEventListener('click', () => {
                window.supervisorAgentFilter = value; // null = Todos
                try { 
                    if (typeof window.renderCostumerTable === 'function') {
                        window.renderCostumerTable(window.ultimaListaLeads || []);
                    } else {
                        console.error('La funci¨®n renderCostumerTable no est¨¢ disponible');
                    }
                } catch(e) { console.error('Error al renderizar tabla:', e); }
              });
              return b;
            };
            barFT.innerHTML = '';
            barFT.appendChild(mkBtnFT('Todos', null));
            teamAgentsFT.forEach(a => {
              const label = (teamsApiFT && typeof teamsApiFT.getDisplayName==='function') ? teamsApiFT.getDisplayName(a) : a.replace(/\b\w/g, c=>c.toUpperCase());
              barFT.appendChild(mkBtnFT(label, a));
            });
          }
          // Aplicar filtro activo y render
          const teamsApi2FT = (window && window.Teams) ? window.Teams : null;
          const norm2FT = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const canonicalFromNameFT = (name) => {
            if (teamsApi2FT && typeof teamsApi2FT.canonicalFromName==='function') return teamsApi2FT.canonicalFromName(name);
            const n = norm2FT(name); if (!n) return ''; if (teamAgentsFT.includes(n)) return n; for (const c of teamAgentsFT){ const toks=c.split(' '); if (toks.every(t=>n.includes(t))) return c; } return '';
          };
          const getAgentCanonFT = (l) => getAgentCanonUniversal(l);
          try { console.debug('[ForceTeam] teamAgentsFT =', teamAgentsFT); } catch(_) {}
          const tryCanonNameFT = (l) => {
            const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
            return (teamsApi2FT && typeof teamsApi2FT.canonicalFromName==='function') ? teamsApi2FT.canonicalFromName(cand) : norm2FT(cand);
          };
          let listFT = [];
          if (Array.isArray(leadsArray)) {
            if (window.supervisorAgentFilter) {
              // Si hay agente seleccionado, filtrar directo por agente sobre todos los leads
              try { console.debug('[ForceTeam] Filtrado estricto por agente seleccionado'); } catch(_) {}
              listFT = leadsArray.filter(l => matchSelectedAgent(l, window.supervisorAgentFilter));
            } else {
              // Sin agente seleccionado, limitar por miembros del team
              listFT = leadsArray.filter(l => {
                const c1 = getAgentCanonFT(l);
                const c2 = tryCanonNameFT(l);
                return teamAgentsFT.includes(c1) || teamAgentsFT.includes(c2);
              });
            }
          }
          const selectedFT = window.supervisorAgentFilter || null;
          try { console.debug('[ForceTeam] selectedFT =', selectedFT); } catch(_) {}
          if (selectedFT) { /* ya aplicado cuando se arma listFT arriba */ }
          try {
            const sample = (listFT||[]).slice(0,5).map(l=>({id:(typeof getLeadId==='function')?getLeadId(l):undefined, canon:getAgentCanonFT(l)}));
            console.debug('[ForceTeam] sample after filter =', sample);
          } catch(_) {}
          renderWithMonthlySeparators(listFT);
          try { console.log('[Toolbar ForceTeam] Render aplicado. leads =', listFT.length); } catch(_) {}
          return;
        }
      } catch(e) { /* ignorar */ }

      // Vista especial para SUPERVISORES: mostrar lista PLANA del propio TEAM con toolbar por agente
      try {
        if (__debugNoFilters) throw new Error('DEBUG: filtros desactivados');
        // Detectar supervisor actual via Teams
        const teamsApiRoot = (window && window.Teams) ? window.Teams : null;
        const currentUserName = (typeof obtenerUsuarioActual === 'function') ? obtenerUsuarioActual() : '';
        const currentCanon = teamsApiRoot && typeof teamsApiRoot.canonicalFromName === 'function'
          ? teamsApiRoot.canonicalFromName(currentUserName)
          : (currentUserName || '').toString().trim().toLowerCase();
        // Leer usuario/rol desde storage para mejorar la detecci¨®n de supervisor
        let userObj = {};
        try { userObj = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}'); } catch { userObj = {}; }
        const rawRole = (userObj.role || userObj?.usuario?.role || '').toString().toLowerCase();
        const roleIsSupervisor = rawRole === 'supervisor';
        const teamForUser = (teamsApiRoot && typeof teamsApiRoot.getTeamForUser === 'function') ? teamsApiRoot.getTeamForUser(userObj) : '';
        const isSupervisorUser = !!(
          (teamsApiRoot && typeof teamsApiRoot.isSupervisor === 'function' && teamsApiRoot.isSupervisor(currentCanon))
          || roleIsSupervisor
          || teamForUser
        );
        try {
          console.log('===========================================');
          console.log('🔍 [DETECCIÓN SUPERVISOR] Iniciando...');
          console.log('[Toolbar Supervisor] usuarioActual =', currentUserName);
          console.log('[Toolbar Supervisor] usuarioCanon =', currentCanon);
          console.log('[Toolbar Supervisor] userObj =', userObj);
          console.log('[Toolbar Supervisor] rawRole =', rawRole);
          console.log('[Toolbar Supervisor] roleIsSupervisor =', roleIsSupervisor, '| teamForUser =', teamForUser);
          console.log('[Toolbar Supervisor] isSupervisorUser =', isSupervisorUser);
          console.log('[Toolbar Supervisor] Teams API lista =', !!teamsApiRoot);
          console.log('===========================================');
        } catch(_) {}
        
        if (!isSupervisorUser) {
          console.warn('⚠️ [Toolbar Supervisor] Usuario NO detectado como supervisor. Toolbar NO se creará.');
          console.log('[Toolbar Supervisor] Razones posibles:');
          console.log('  - roleIsSupervisor:', roleIsSupervisor);
          console.log('  - teamForUser:', teamForUser);
          console.log('  - Teams API disponible:', !!teamsApiRoot);
        }
        
        if (isSupervisorUser) {
          console.log('✅ [Toolbar Supervisor] Usuario ES supervisor. Creando toolbar...');
          // --- Toolbar de filtro por agente (TEAM SUPERVISOR) ---
          (function ensureSupervisorAgentFilterToolbar(){
            try {
              const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
              // Obtener agentes del supervisor actual usando Teams
              const teamsApi = (window && window.Teams) ? window.Teams : null;
              const supervisorCanon = currentCanon;
              let teamAgents = [];
              if (teamsApi) {
                if (teamForUser) {
                  // Si logramos deducir el team por el usuario, usarlo directamente
                  teamAgents = (typeof teamsApi.getAgentsByTeam === 'function') ? (teamsApi.getAgentsByTeam(teamForUser) || []) : [];
                }
                if (!teamAgents || teamAgents.length === 0) {
                  // Fallback por supervisor can¨®nico
                  teamAgents = teamsApi.getAgentsBySupervisor(supervisorCanon) || [];
                }
              }
              // Fallback FINAL: si seguimos sin agentes, derivarlos de los leads actuales en memoria
              try {
                if ((!teamAgents || teamAgents.length === 0) && Array.isArray(window.ultimaListaLeads)) {
                  const set = new Set();
                  const titleCase = s => String(s||'').split(' ').map(w => w? (w[0].toUpperCase()+w.slice(1).toLowerCase()):'').join(' ');
                  const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
                  const canonFrom = name => {
                    try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : norm(name); } catch { return norm(name); }
                  };
                  window.ultimaListaLeads.forEach(l => {
                    const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
                    const c = canonFrom(cand);
                    if (c) set.add(c);
                  });
                  teamAgents = Array.from(set);
                  console.log('[Toolbar Supervisor][fallback leads] Agentes derivados =', teamAgents);
                }
              } catch(_) {}
              try {
                console.log('[Toolbar Supervisor] Supervisor can¨®nico =', supervisorCanon);
                console.log('[Toolbar Supervisor] Team deducido para usuario =', teamForUser);
                console.log('[Toolbar Supervisor] Agentes del equipo (can¨®nicos) =', teamAgents);
                if (teamsApi && typeof teamsApi.getDisplayName === 'function') {
                  const labels = teamAgents.map(a => teamsApi.getDisplayName(a));
                  console.log('[Toolbar Supervisor] Etiquetas UI (getDisplayName) =', labels);
                }
              } catch(_) {}
              // Compartir lista con el bloque de render para evitar inconsistencias
              try { window.__teamAgentsCanon = Array.isArray(teamAgents) ? teamAgents.slice() : []; } catch(_) {}
              console.log('[Toolbar Supervisor] Intentando crear toolbar de filtros...');
              console.log('[Toolbar Supervisor] teamAgents =', teamAgents);
              const tbodyEl = document.getElementById('costumer-tbody');
              console.log('[Toolbar Supervisor] tbodyEl encontrado:', !!tbodyEl);
              if (!tbodyEl) {
                console.warn('[Toolbar Supervisor] No se encontró el elemento costumer-tbody, abortando creación de toolbar');
                return;
              }
              const tableEl = tbodyEl.closest('table');
              const tableResponsive = tableEl ? tableEl.closest('.table-responsive') : null;
              const host = tableResponsive || tableEl || tbodyEl;
              console.log('[Toolbar Supervisor] host para insertar toolbar:', host?.className || host?.tagName);
              
              // Crear/asegurar toolbar para filtro por agente del supervisor
              let bar = document.getElementById('supervisor-agent-filter');
              if (!bar) {
                bar = document.createElement('div');
                bar.id = 'supervisor-agent-filter';
                bar.style.margin = '10px 0';
                bar.style.display = 'flex';
                bar.style.flexWrap = 'wrap';
                bar.style.gap = '8px';
                // Insertar la barra antes del host (tabla contenedora)
                host.parentElement.insertBefore(bar, host);
                // sticky respecto al viewport principal
                bar.style.position = 'sticky';
                bar.style.top = '0';
                bar.style.zIndex = '10';
                bar.style.background = '#ffffff';
                bar.style.padding = '8px 0';
              } else {
                // Limpiar contenido antes de reconstruir
                try { bar.innerHTML = ''; } catch(_) {}
              }
              
              // Agregar título/etiqueta
              const titleSpan = document.createElement('span');
              titleSpan.textContent = 'Filtrar por agente:';
              titleSpan.style.fontWeight = '600';
              titleSpan.style.fontSize = '14px';
              titleSpan.style.color = '#334155';
              titleSpan.style.marginRight = '12px';
              bar.appendChild(titleSpan);
              
              // Selector de Mes/Año para Supervisor
              (function ensureMonthFilter(){
                try {
                  let monthBar = document.getElementById('month-filter-bar');
                  if (!monthBar) {
                    monthBar = document.createElement('div');
                    monthBar.id = 'month-filter-bar';
                    monthBar.style.display = 'flex';
                    monthBar.style.alignItems = 'center';
                    monthBar.style.gap = '8px';
                    monthBar.style.marginRight = '16px';
                    bar.appendChild(monthBar);
                  } else {
                    monthBar.innerHTML = '';
                  }
                  const monthSel = document.createElement('select');
                  const yearSel = document.createElement('select');
                  monthSel.style.padding = '6px 8px';
                  monthSel.style.border = '1px solid #e2e8f0';
                  monthSel.style.borderRadius = '8px';
                  yearSel.style.padding = '6px 8px';
                  yearSel.style.border = '1px solid #e2e8f0';
                  yearSel.style.borderRadius = '8px';
                  const now = new Date();
                  const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
                  months.forEach((m,i)=>{
                    const opt=document.createElement('option');
                    opt.value = String(i+1);
                    opt.textContent = `${String(i+1).padStart(2,'0')}`;
                    monthSel.appendChild(opt);
                  });
                  const years=[now.getFullYear()-1, now.getFullYear(), now.getFullYear()+1];
                  years.forEach(y=>{ const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); yearSel.appendChild(opt); });
                  // Selección inicial: mes/año actual
                  const sel = window.supervisorMonthFilter || { month: now.getMonth()+1, year: now.getFullYear() };
                  monthSel.value = String(sel.month);
                  yearSel.value = String(sel.year);
                  const applyChange = ()=>{
                    window.supervisorMonthFilter = { month: Number(monthSel.value), year: Number(yearSel.value) };
                    if (typeof window.renderCostumerTable === 'function') {
                      window.renderCostumerTable(window.ultimaListaLeads || []);
                    }
                  };
                  monthSel.addEventListener('change', applyChange);
                  yearSel.addEventListener('change', applyChange);
                  // Etiqueta
                  const lbl = document.createElement('span');
                  lbl.textContent = 'Mes:';
                  lbl.style.fontSize = '12px';
                  lbl.style.color = '#64748b';
                  monthBar.appendChild(lbl);
                  monthBar.appendChild(monthSel);
                  const lblY = document.createElement('span');
                  lblY.textContent = 'Año:';
                  lblY.style.fontSize = '12px';
                  lblY.style.color = '#64748b';
                  monthBar.appendChild(lblY);
                  monthBar.appendChild(yearSel);
                } catch(e) { console.warn('[Supervisor] Month filter error:', e); }
              })();
              
              const mkBtn = (label, value) => {
                const b = document.createElement('button');
                b.textContent = label;
                b.type = 'button';
                b.style.padding = '6px 10px';
                b.style.border = '1px solid #e2e8f0';
                b.style.borderRadius = '999px';
                b.style.background = '#ffffff';
                b.style.cursor = 'pointer';
                b.style.fontSize = '12px';
                const active = (window.supervisorAgentFilter || null) === value;
                if (active) {
                  b.style.background = '#1d4ed8';
                  b.style.color = '#ffffff';
                  b.style.borderColor = '#1d4ed8';
                }
                b.addEventListener('click', () => {
                  window.supervisorAgentFilter = value; // null = Todos
                  try { 
                    if (typeof window.renderCostumerTable === 'function') {
                        window.renderCostumerTable(window.ultimaListaLeads || []);
                    } else {
                        console.error('La funci¨®n renderCostumerTable no est¨¢ disponible');
                    }
                } catch(e) { console.error('Error al renderizar tabla:', e); }
                });
                return b;
              };
              console.log('[Toolbar Supervisor] Creando botón "Todos"...');
              try {
                const normTxt = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                const isCancel = (st) => {
                  const t = normTxt(st||'');
                  return t.includes('cancel') || t.includes('anulad') || t.includes('no instalado');
                };
                // Conteo total efectivo dentro del team
                const totalEfectivasTeam = (Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : []).reduce((acc,l)=>{
                  try {
                    const c = getAgentCanonUniversal(l);
                    const inTeam = teamAgents.includes(c) || teamAgents.includes(normTxt(l?.agenteNombre||l?.nombreAgente||l?.agente||l?._raw?.agenteNombre||l?._raw?.nombreAgente||l?._raw?.agente||''));
                    if (!inTeam) return acc;
                    const st = l?.status || l?._raw?.status || '';
                    return acc + (isCancel(st) ? 0 : 1);
                  } catch { return acc; }
                }, 0);
                bar.appendChild(mkBtn(`Todos (${totalEfectivasTeam})`, null));
              } catch(_) {
                bar.appendChild(mkBtn('Todos', null));
              }
              console.log('[Toolbar Supervisor] Creando botones para', teamAgents.length, 'agentes...');
              teamAgents.forEach(a => {
                const teamsApi = (window && window.Teams) ? window.Teams : null;
                const display = (teamsApi && typeof teamsApi.getDisplayName === 'function')
                  ? teamsApi.getDisplayName(a)
                  : a.replace(/\b\w/g, c => c.toUpperCase());
                // Calcular conteo de ventas efectivas por agente
                let count = 0;
                try {
                  const normTxt = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                  const isCancel = (st) => {
                    const t = normTxt(st||'');
                    return t.includes('cancel') || t.includes('anulad') || t.includes('no instalado');
                  };
                  count = (Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : []).reduce((acc,l)=>{
                    try {
                      const c = getAgentCanonUniversal(l);
                      if (c !== a) return acc;
                      const st = l?.status || l?._raw?.status || '';
                      return acc + (isCancel(st) ? 0 : 1);
                    } catch { return acc; }
                  }, 0);
                } catch(_) { count = 0; }
                const label = `${display} (${count})`;
                console.log('[Toolbar Supervisor] Creando botón para agente:', label);
                bar.appendChild(mkBtn(label, a));
              });
              console.log('[Toolbar Supervisor] ✅ Toolbar creada exitosamente con', 1 + teamAgents.length, 'botones');
              console.log('[Toolbar Supervisor] Toolbar visible:', bar.style.display !== 'none');
              // Encabezado de columnas: sin comportamiento sticky (restaurado al estado original)
            } catch(e) { console.warn('Toolbar TEAM IRANIA:', e); }
          })();
          // --- Aplicar filtro activo (si existe) y render plano  
          const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const teamsApi2 = (window && window.Teams) ? window.Teams : null;
          // Usar la misma lista de agentes que la toolbar calcul¨® (con fallbacks)
          let teamCanon = Array.isArray(window.__teamAgentsCanon) ? window.__teamAgentsCanon.slice() : [];
          if (!teamCanon || teamCanon.length === 0) {
            // Fallback de seguridad si no qued¨® poblado
            teamCanon = teamsApi2 ? (teamsApi2.getAgentsBySupervisor(currentCanon) || []) : [];
            if ((!teamCanon || teamCanon.length===0) && Array.isArray(window.ultimaListaLeads)) {
              const set = new Set();
              const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
              const canonFrom = name => {
                try { return teamsApi2 && typeof teamsApi2.canonicalFromName==='function' ? teamsApi2.canonicalFromName(name) : norm(name); } catch { return norm(name); }
              };
              window.ultimaListaLeads.forEach(l => {
                const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
                const c = canonFrom(cand);
                if (c) set.add(c);
              });
              teamCanon = Array.from(set);
              try { console.log('[Toolbar Supervisor][render fallback] teamCanon derivado de leads =', teamCanon); } catch(_) {}
            }
          }
          // Valor seleccionado (chip actual del supervisor)
          const selected = window.supervisorAgentFilter || null;
          const canonicalFromName = (name) => {
            if (teamsApi2 && typeof teamsApi2.canonicalFromName === 'function') return teamsApi2.canonicalFromName(name);
            const n = norm(name);
            if (!n) return '';
            if (teamCanon.includes(n)) return n;
            for (const c of teamCanon) { const toks = c.split(' '); if (toks.every(t => n.includes(t))) return c; }
            return '';
          };
          const getAgentCanon = (l) => getAgentCanonUniversal(l);
          // Helper: aplicar filtro por Mes/Año seleccionado (si existe)
          const applyMonthFilter = (arr) => {
            try {
              const sel = window.supervisorMonthFilter;
              if (!sel || !sel.month || !sel.year) return arr;
              const M = Number(sel.month), Y = Number(sel.year);
              return (arr||[]).filter(l => {
                try {
                  const iso = (typeof getDateFromLead==='function') ? getDateFromLead(l) : null;
                  if (!iso || typeof iso !== 'string') return false;
                  const [y,m] = iso.split('-').map(Number);
                  return y===Y && m===M;
                } catch { return false; }
              });
            } catch { return arr; }
          };
          // Limitar a leads del TEAM del supervisor actual
          try { console.debug('[Supervisor] teamCanon =', teamCanon); } catch(_) {}
          const tryCanonName = (l) => {
            const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
            return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(cand) : norm(cand);
          };
          // Asegurar que el mapa ID->Canon exista y est¨¦ poblado antes de filtrar
          try {
            if (!(window.__idToCanonGlobal instanceof Map)) window.__idToCanonGlobal = new Map();
            const idMap = window.__idToCanonGlobal;
            const canonical = (name) => {
              try { return teamsApi2 && typeof teamsApi2.canonicalFromName==='function' ? teamsApi2.canonicalFromName(name) : norm(name); } catch { return norm(name); }
            };
            (leadsArray||[]).forEach(l => {
              const nameCand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const canon = canonical(nameCand);
              const ids = (function extractIdsLocal(x){
                const ids=[]; const cands=[x?.agenteId,x?._raw?.agenteId,x?.agente_id,x?._raw?.agente_id,x?.idAgente,x?._raw?.idAgente,x?.agentId,x?._raw?.agentId,x?.creadoPor,x?._raw?.creadoPor,x?.creado_por,x?._raw?.creado_por,x?.createdBy,x?._raw?.createdBy,x?.ownerId,x?._raw?.ownerId,x?.registeredById,x?._raw?.registeredById,x?.assignedId,x?._raw?.assignedId];
                for (const v of cands){ if(!v) continue; if(typeof v==='object'){ const oid=v.$oid||v.id||v._id||v.value; if(oid) ids.push(String(oid)); } else { let s=String(v); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); if(m) s=m[1]; ids.push(s);} }
                return ids.map(s=>s&&s.trim()).filter(Boolean);
              })(l);
              if (canon) ids.forEach(id=>{ try { idMap.set(id, canon); } catch(_) {} });
            });
            // Override expl¨ªcito Eduardo Rivas (id conocido, actualizado)
            try { idMap.set('68bb1ddd0d4d7cdcb6eb3605','eduardo rivas'); } catch(_) {}
            console.log('[Supervisor][ID->Canon] Mapa listo. size=', idMap.size);
          } catch(e) { console.warn('[Supervisor] No se pudo preparar ID->Canon:', e); }
          // Construir la lista filtrada para la vista Supervisor
          let list = [];
          if (Array.isArray(leadsArray)) {
            if (window.supervisorAgentFilter) {
              // Si hay agente seleccionado, filtrar directo por agente sobre todos los leads
              try { console.debug('[Supervisor] Filtrado estricto por agente seleccionado'); } catch(_) {}
              // Diagn¨®stico: conteo por ID de Eduardo antes del filtro (incluye campos en espa?ol)
              try {
                const normId = (v) => { if(!v) return ''; if (typeof v==='object') return String(v.$oid||v.id||v._id||v.value||''); const s=String(v); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s; };
                const getAnyAgentId = (l) => normId(l?.ownerId) || normId(l?.agentId) || normId(l?.registeredById) || normId(l?.createdBy) || normId(l?.agenteId) || normId(l?.creadoPor) || normId(l?._raw?.ownerId) || normId(l?._raw?.agentId) || normId(l?._raw?.registeredById) || normId(l?._raw?.createdBy) || normId(l?._raw?.agenteId) || normId(l?._raw?.creadoPor);
                const targetId = '68bb1ddd0d4d7cdcb6eb3605';
                const countById = (leadsArray||[]).filter(l => getAnyAgentId(l) === targetId).length;
                console.log('[Supervisor][Diag eduardo rivas] leads con ID de Eduardo (antes de filtrar):', countById);
              } catch(_) {}
              list = leadsArray.filter(l => matchSelectedAgent(l, window.supervisorAgentFilter));
              // Preferir consultar al servidor antes que buscar por tokens locales
              const PREFER_SERVER_FALLBACK = true;
              // Fallback: si qued¨® vac¨ªo y NO preferimos servidor, intentar heur¨ªstica dentro del TEAM
              if (!list.length && !PREFER_SERVER_FALLBACK) {
                try {
                  const display = (teamsApi2 && typeof teamsApi2.getDisplayName==='function') ? teamsApi2.getDisplayName(window.supervisorAgentFilter) : window.supervisorAgentFilter;
                  const _norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                  const toks = _norm(display).split(/\s+/).filter(Boolean); // ej: ['eduardo','rivas']
                  const teamScoped = leadsArray.filter(l => {
                    const c1 = getAgentCanon(l); const c2 = tryCanonName(l);
                    return teamCanon.includes(c1) || teamCanon.includes(c2);
                  });
                  list = teamScoped.filter(l => {
                    const hay = _norm(JSON.stringify(l||{}));
                    return toks.every(t => hay.includes(t));
                  });
                  console.info('[Supervisor][Fallback] Estricto=0. Fallback por tokens dentro del TEAM. Resultado:', list.length);
                } catch(e) { console.warn('[Supervisor][Fallback] Error en fallback:', e); }
              }
              // Fallback de servidor: si sigue vac¨ªo, pedir al backend por agentId
              if (!list.length) {
                try {
                  const selCanon = (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(window.supervisorAgentFilter) : window.supervisorAgentFilter;
                  // Buscar agentId por can¨®nico
                  let agentId = null;
                  try {
                    const map = window.__canonToIdsGlobal;
                    if (map && typeof map.get === 'function') {
                      const set = map.get(selCanon);
                      if (set && set.size) agentId = [...set][0];
                    }
                  } catch(_) {}
                  // Fallback duro para Eduardo Rivas
                  if (!agentId && selCanon === 'eduardo rivas') agentId = '68bb1ddd0d4d7cdcb6eb3605';
                  if (agentId) {
                    fetchLeadsByAgentId(agentId).then(serverLeads => {
                      if (Array.isArray(serverLeads) && serverLeads.length) {
                        const normalizeId = (v) => {
                          if (!v) return '';
                          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
                          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
                        };
                        const normFree = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                        const getNameCanonFromLead = (l) => {
                          try {
                            const candidates = [
                              l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
                              l?.vendedor, l?.seller, l?.salesAgent, l?.atendioPor, l?.asignadoA, l?.asignadoPor,
                              l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent,
                              l?._raw?.vendedor, l?._raw?.seller, l?._raw?.salesAgent, l?._raw?.atendioPor, l?._raw?.asignadoA, l?._raw?.asignadoPor
                            ];
                            const nameCand = candidates.find(x => !!x) || '';
                            return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(nameCand) : normFree(nameCand);
                          } catch { return ''; }
                        };
                        // Diagn¨®stico: mostrar c¨®mo vienen los campos de ID y el nombre can¨®nico
                        try {
                          const diag = (serverLeads||[]).slice(0,10).map(l=>({
                            ownerId: normalizeId(l?.ownerId), agentId: normalizeId(l?.agentId),
                            registeredById: normalizeId(l?.registeredById), createdBy: normalizeId(l?.createdBy),
                            agenteId: normalizeId(l?.agenteId), creadoPor: normalizeId(l?.creadoPor),
                            _raw_ownerId: normalizeId(l?._raw?.ownerId), _raw_agentId: normalizeId(l?._raw?.agentId),
                            _raw_registeredById: normalizeId(l?._raw?.registeredById), _raw_createdBy: normalizeId(l?._raw?.createdBy),
                            _raw_agenteId: normalizeId(l?._raw?.agenteId), _raw_creadoPor: normalizeId(l?._raw?.creadoPor),
                            nameCanon: getNameCanonFromLead(l)
                          }));
                          console.log('[Supervisor][Fallback servidor][Diag primeros 10]', diag);
                        } catch(_) {}
                        // Fase 1: por ID exacto
                        const getAnyAgentId = (l) => normalizeId(l?.ownerId) || normalizeId(l?.agentId) || normalizeId(l?.registeredById) || normalizeId(l?.createdBy) || normalizeId(l?.agenteId) || normalizeId(l?.creadoPor) || normalizeId(l?._raw?.ownerId) || normalizeId(l?._raw?.agentId) || normalizeId(l?._raw?.registeredById) || normalizeId(l?._raw?.createdBy) || normalizeId(l?._raw?.agenteId) || normalizeId(l?._raw?.creadoPor);
                        let out = serverLeads.filter(l => getAnyAgentId(l) === agentId);
                        if (out.length === 0) {
                          // Fase 2: por nombre can¨®nico
                          out = serverLeads.filter(l => getNameCanonFromLead(l) === selCanon);
                          if (out.length) console.info('[Supervisor][Fallback servidor] match por nombre can¨®nico:', out.length);
                        } else {
                          console.info('[Supervisor][Fallback servidor] match por ID:', out.length);
                        }
                        // Si a¨²n no hay resultados, intentar por nombre desde backend
                        if (out.length === 0) {
                          const displayName = (teamsApi2 && typeof teamsApi2.getDisplayName==='function') ? teamsApi2.getDisplayName(selCanon) : selCanon;
                          fetchLeadsByAgentName(displayName).then(byName => {
                            let out2 = [];
                            try {
                              const normFree = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                              const nSel = selCanon;
                              const getNameCanonFromLead = (l) => {
                                try {
                                  const candidates = [
                                    l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
                                    l?.vendedor, l?.seller, l?.salesAgent, l?.atendioPor, l?.asignadoA, l?.asignadoPor,
                                    l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent,
                                    l?._raw?.vendedor, l?._raw?.seller, l?._raw?.salesAgent, l?._raw?.atendioPor, l?._raw?.asignadoA, l?._raw?.asignadoPor
                                  ];
                                  const nameCand = candidates.find(x => !!x) || '';
                                  return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(nameCand) : normFree(nameCand);
                                } catch { return ''; }
                              };
                              out2 = (byName||[]).filter(l => getNameCanonFromLead(l) === nSel);
                            } catch(_) { out2 = []; }
                            console.warn('[Supervisor][Fallback servidor][byName] resultados =', out2.length);
                            if (out2.length) {
                              try { out2.forEach(l => { try { l.__agentCanon = selCanon; } catch(_) {} }); } catch(_) {}
                              try { window.ultimaListaLeads = byName.slice(); } catch(_) {}
                              renderWithMonthlySeparators(out2);
                            } else {
                              renderWithMonthlySeparators([]);
                            }
                          }).catch(err => { console.warn('[Supervisor][Fallback servidor][byName] error:', err); renderWithMonthlySeparators([]); });
                          return;
                        }
                        if (out.length === 0) {
                          // Fase 3: por tokens dentro del objeto
                          const toks = selCanon.split(' ').filter(Boolean); // ej: ['eduardo','rivas']
                          out = serverLeads.filter(l => {
                            const hay = normFree(JSON.stringify(l||{}));
                            return toks.every(t => hay.includes(t));
                          });
                          if (out.length) console.info('[Supervisor][Fallback servidor] match por tokens JSON:', out.length);
                        }
                        // Etiquetar y actualizar mapas globales para futuras coincidencias
                        try {
                          if (!(window.__idToCanonGlobal instanceof Map)) window.__idToCanonGlobal = new Map();
                          if (!(window.__canonToIdsGlobal instanceof Map)) window.__canonToIdsGlobal = new Map();
                          const idMap = window.__idToCanonGlobal; const c2i = window.__canonToIdsGlobal;
                          out.forEach(l => {
                            const ids = [normalizeId(l.ownerId), normalizeId(l.agentId), normalizeId(l.registeredById), normalizeId(l.createdBy), normalizeId(l.agenteId), normalizeId(l.creadoPor), normalizeId(l?._raw?.ownerId), normalizeId(l?._raw?.agentId), normalizeId(l?._raw?.registeredById), normalizeId(l?._raw?.createdBy), normalizeId(l?._raw?.agenteId), normalizeId(l?._raw?.creadoPor)].filter(Boolean);
                            try { l.__agentCanon = selCanon; } catch(_) {}
                            ids.forEach(id => { try { idMap.set(id, selCanon); } catch(_) {} });
                            if (ids.length) {
                              const set = c2i.get(selCanon) || new Set();
                              ids.forEach(id => set.add(id));
                              c2i.set(selCanon, set);
                            }
                          });
                        } catch(_) {}
                        console.info('[Supervisor][Fallback servidor] leads finales =', out.length);
                        try { window.ultimaListaLeads = serverLeads.slice(); } catch(_) {}
                        const filteredOut = applyMonthFilter(out);
                        renderWithMonthlySeparators(filteredOut);
                      } else {
                        console.warn('[Supervisor][Fallback servidor] sin resultados para agentId', agentId);
                        renderWithMonthlySeparators([]);
                      }
                    }).catch(err => {
                      console.warn('[Supervisor][Fallback servidor] error:', err);
                      renderWithMonthlySeparators([]);
                    });
                    return; // no continuar, ya haremos render en el then
                  }
                } catch(e) { console.warn('[Supervisor][Fallback servidor] error preparando fetch:', e); }
              }
            } else {
              // Sin agente seleccionado, limitar por miembros del team del supervisor
              list = leadsArray.filter(l => {
                const c1 = getAgentCanon(l);
                const c2 = tryCanonName(l);
                return teamCanon.includes(c1) || teamCanon.includes(c2);
              });
            }
          }
          try {
            const selCanon = (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(selected||'') : (selected||'');
            if (selCanon === 'eduardo rivas') {
              const sampleDiag = (leadsArray||[]).slice(0,10).map(l=>({
                id: (function(x){ try{ const cand=x?.ownerId||x?.agentId||x?.registeredById||x?.createdBy; if(!cand) return ''; if(typeof cand==='object'){ return cand.$oid||cand.id||cand._id||cand.value||'';} const s=String(cand); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s; } catch{ return ''; } })(l),
                canon: getAgentCanon(l)
              }));
              console.log('[Supervisor][Diag eduardo rivas] sample ids/canon =', sampleDiag);
            }
          } catch(_) {}
          try {
            const sample = (list||[]).slice(0,5).map(l=>({id:(typeof getLeadId==='function')?getLeadId(l):undefined, canon:getAgentCanon(l)}));
            console.debug('[Supervisor] sample after filter =', sample);
          } catch(_) {}
          list = applyMonthFilter(list);
          renderWithMonthlySeparators(list);
          try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
          return; // retorno temprano para no pasar por otras agrupaciones
        }
      } catch (e) {
        console.warn('No se pudo aplicar la vista plana para Supervisor:', e);
      }

      // Vista ADMIN/BACKOFFICE: toolbar por TEAM y render plano filtrado por team
      if (!(__debugNoFilters) && typeof esAdminOBackoffice === 'function' && esAdminOBackoffice()) {
        try {
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const teams = teamsApi && typeof teamsApi.getAllTeams === 'function' ? teamsApi.getAllTeams() : [];
          const tbodyEl = document.getElementById('costumer-tbody');
          if (!tbodyEl) return;
          const tableEl = tbodyEl.closest('table');
          const host = tableEl ? tableEl : tbodyEl;
          const container = host.parentElement || host;

          // Crear/asegurar toolbar de TEAM
          let bar = document.getElementById('teams-filter-bar');
          if (!bar) {
            bar = document.createElement('div');
            bar.id = 'teams-filter-bar';
            bar.style.margin = '10px 0';
            bar.style.display = 'flex';
            bar.style.flexWrap = 'wrap';
            bar.style.gap = '8px';
            // Insertar la barra antes de la tabla directamente
            container.insertBefore(bar, host);
            // sticky del toolbar respecto al viewport principal
            bar.style.position = 'sticky';
            bar.style.top = '0';
            bar.style.zIndex = '10';
            bar.style.background = '#ffffff';
            bar.style.padding = '8px 0';
          }

          const mkBtn = (label, value) => {
            const b = document.createElement('button');
            b.textContent = label;
            b.dataset.value = value || '';
            b.style.padding = '6px 10px';
            b.style.border = '1px solid #e5e7eb';
            b.style.borderRadius = '9999px';
            b.style.background = (window.adminTeamFilter === value) ? '#1d4ed8' : '#f9fafb';
            b.style.color = (window.adminTeamFilter === value) ? '#fff' : '#111827';
            b.style.cursor = 'pointer';
            b.style.fontSize = '12px';
            b.addEventListener('click', () => {
              window.adminTeamFilter = value || null;
              try { 
                if (typeof window.renderCostumerTable === 'function') {
                  window.renderCostumerTable(window.ultimaListaLeads || []);
                } else {
                  console.error('La funci¨®n renderCostumerTable no est¨¢ disponible');
                }
              } catch(e) { console.error('Error al renderizar tabla:', e); }
            });
            return b;
          };

          // Render botones con conteo de ventas (status Completed)
          bar.innerHTML = '';
          // Conteo total de clientes (TODOS los estados)
          try {
            const totalClientes = Array.isArray(leadsArray) ? leadsArray.length : 0;
            bar.appendChild(mkBtn(`Todos (${totalClientes})`, null));
          } catch(_) {
            bar.appendChild(mkBtn('Todos', null));
          }
          teams.forEach(teamKey => {
            const def = teamsApi.getTeamDef(teamKey) || { displayName: teamKey };
            const label = def.displayName || teamKey;
            // Calcular TOTAL de clientes del TEAM (sin filtrar por estado)
            let count = 0;
            try {
              const agentsCanon = teamsApi.getAgentsByTeam(teamKey) || [];
              count = (Array.isArray(leadsArray) ? leadsArray : []).reduce((acc, l) => {
                const isAgentTeam = agentsCanon.includes((() => {
                  if (l && l.__agentCanon) return l.__agentCanon;
                  const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
                  return (teamsApi && typeof teamsApi.canonicalFromName === 'function') ? teamsApi.canonicalFromName(cand) : (cand||'').toString().trim().toLowerCase();
                })());
                return acc + (isAgentTeam ? 1 : 0);
              }, 0);
            } catch(_) { count = 0; }
            bar.appendChild(mkBtn(`${label} (${count})`, teamKey));
          });

          // Helper para obtener agente can¨®nico
          const canonicalFromName = (name) => {
            if (teamsApi && typeof teamsApi.canonicalFromName === 'function') return teamsApi.canonicalFromName(name);
            return (name || '').toString().trim().toLowerCase();
          };
          const getAgentCanon = (l) => {
            if (l && l.__agentCanon) return l.__agentCanon;
            const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
            return canonicalFromName(cand);
          };

          // Filtrar por TEAM seleccionado (por agentes del team)
          const selectedTeam = window.adminTeamFilter || null;
          let list = Array.isArray(leadsArray) ? leadsArray.slice() : [];
          if (selectedTeam) {
            const agentsCanon = teamsApi.getAgentsByTeam(selectedTeam) || [];
            try { console.debug('[Admin] selectedTeam =', selectedTeam, '| agentsCanon =', agentsCanon); } catch(_) {}
            // Mostrar TODOS los leads del team seleccionado (sin restringir a 'Completed')
            list = list.filter(l => agentsCanon.includes(getAgentCanon(l)));
          } else {
            // En 'Todos' mostrar TODOS los leads (sin restringir a 'Completed')
            // Si se requiere un filtro por ventas, esto deber¨ªa manejarse con un control separado
            list = list;
          }

          // Render con separadores mensuales
          renderWithMonthlySeparators(list);
          try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
          return; // evitar ramas siguientes
        } catch (e) { console.warn('Error en vista admin por TEAM:', e); }
      } else {
        // Render por defecto con separadores mensuales
        renderWithMonthlySeparators(leadsArray);
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
      }
    }

    // Funci¨®n para actualizar las tarjetas de resumen
    function updateSummaryCards(leads) {
      // Obtener referencias a los elementos del DOM primero
      const ventasHoyElement = document.getElementById('costumer-ventas-hoy');
      const ventasMesElement = document.getElementById('costumer-ventas-mes');
      const pendientesElement = document.getElementById('costumer-pendientes');
      const canceladosElement = document.getElementById('costumer-cancelados');
      
      // Establecer valores por defecto
      let ventasHoy = 0;
      let ventasMes = 0;
      let pendientes = 0;
      let cancelados = 0;
      
      // Verificar si hay datos para procesar
      if (!leads || !Array.isArray(leads) || leads.length === 0) {
        console.log('No hay datos para mostrar en los gr¨¢ficos');
      } else {
        console.log('Procesando estad¨ªsticas con', leads.length, 'leads');
        
        const hoy = new Date();
        const diaActual = hoy.getDate();
        const mesActual = hoy.getMonth();
        const anioActual = hoy.getFullYear();
        
        console.log('Fecha actual:', hoy.toLocaleDateString());
        
        // Normalizar fechas con la misma l¨®gica de las gr¨¢ficas (zona horaria de negocio)
        const todayISO = toISOInTZ(new Date(), BUSINESS_TZ_OFFSET_MIN); // YYYY-MM-DD
        const [yNow, mNow] = todayISO.split('-').map(Number);

        // Procesar cada lead
        leads.forEach(lead => {
          try {
            // Verificar si el lead tiene status (normalizado)
            const status = normalizarTexto(lead.status || '');
            const isCancel = /cancel/.test(status);
            const isPending = /pendient/.test(status) || /pending/.test(status);

            // Contar pendientes
            if (isPending) {
              pendientes++;
            }

            // Contar cancelados (soportar variantes y subcadenas)
            if (
              status.includes('cancel') ||    // engloba canceled/cancelled/cancelado
              status.includes('anulad') ||    // espa?ol alternativo
              status.includes('no instalado') // posibles estados combinados
            ) {
              cancelados++;
            }

            // Usar la misma extracci¨®n de fecha que el gr¨¢fico
            const leadISO = getDateFromLead(lead); // YYYY-MM-DD en TZ de negocio
            if (leadISO) {
              // Ventas hoy (solo efectivas: excluir canceladas)
              if (leadISO === todayISO && !isCancel) ventasHoy++;
              // Ventas del mes (solo efectivas)
              const [yL, mL] = leadISO.split('-').map(Number);
              if (yL === yNow && mL === mNow && !isCancel) ventasMes++;
            }
          } catch (e) {
            console.error('Error procesando lead:', lead, e);
          }
        });
        
        console.log('Estad¨ªsticas calculadas:', {
          ventasHoy,
          ventasMes,
          pendientes,
          cancelados
        });
      }
      
      // Actualizar el DOM con los valores calculados
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy:', ventasHoy);
      }
      
      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes:', ventasMes);
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes:', pendientes);
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados:', cancelados);
      }
      
      // Las variables de los elementos del DOM ya est¨¢n declaradas al inicio de la funci¨®n
      
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy en el DOM');
      }
      
      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes en el DOM');
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes en el DOM');
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados en el DOM');
      }
      
      // Datos para el gr¨¢fico de ventas por semana (fechas locales)
      const ultimos7Dias = Array.from({ length: 7 }, (_, i) => {
        const fecha = new Date();
        fecha.setHours(0,0,0,0);
        fecha.setDate(fecha.getDate() - (6 - i));
        return toLocalISO(fecha);
      });

      // Etiquetas: d¨ªas de la semana
      const diasSemanaEtiquetas = ['dom', 'lun', 'mar', 'mi¨¦', 'jue', 'vie', 's¨¢b'];
      const labelsDias = ultimos7Dias.map(f => {
        const [y, m, d] = f.split('-').map(Number);
        const loc = new Date(y, m - 1, d);
        return diasSemanaEtiquetas[loc.getDay()];
      });

      const ventasPorDia = ultimos7Dias.map(fechaISO => {
        return leads.filter(lead => getDateFromLead(lead) === fechaISO).length;
      });

      // Puntaje total por d¨ªa (no promedio)
      const puntajesPorDia = ultimos7Dias.map(fechaISO => {
        return leads.reduce((sum, lead) => {
          const status = normalizarTexto(lead.status || '');
          const isCancel = /cancel/.test(status);
          if (!isCancel && getDateFromLead(lead) === fechaISO) {
            return sum + (parseFloat(lead.puntaje) || 0);
          }
          return sum;
        }, 0);
      });
      
      // Datos para el gr¨¢fico de distribuci¨®n por producto
      const productos = {};
      leads.forEach(lead => {
        const producto = lead.tipo_servicios || 'Sin especificar';
        productos[producto] = (productos[producto] || 0) + 1;
      });
      
      const etiquetasProductos = Object.keys(productos);
      const datosProductos = Object.values(productos);
      
      // Colores para los productos
      const coloresProductos = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
        '#858796', '#5a5c69', '#3a3b45', '#1a1a1a', '#000000'
      ].slice(0, etiquetasProductos.length);
      
      // Renderizar o actualizar los gr¨¢ficos
      if (typeof renderizarGraficoVentas === 'function' && typeof renderizarGraficoProductos === 'function') {
        // Enviar etiquetas de d¨ªas de la semana para la gr¨¢fica superior
        renderizarGraficoVentas(labelsDias, ventasPorDia, puntajesPorDia);
        renderizarGraficoProductos(etiquetasProductos, datosProductos, coloresProductos);
      }
    }

    // Funciones de ejemplo para editar/eliminar - Asegurar que estén en scope global

    // Formatea un ID como 2 letras y 2 números intercalados (L N L N)
    function formatLeadIdShort(id) {
      const s = String(id || '');
      const letters = (s.match(/[a-z]/gi) || []).map(c => c.toUpperCase());
      const numbers = (s.match(/\d/g) || []);
      const l1 = letters[0] || 'X';
      const n1 = numbers[0] || '0';
      const l2 = letters[1] || 'Y';
      const n2 = numbers[1] || '0';
      return `${l1}${n1}${l2}${n2}`;
    }
    window.editarLead = async function(id) {
      console.log('Editar lead:', id);
      
      if (!id) {
        alert('Error: No se proporcionó un ID válido');
        return;
      }

      try {
        // 1) Intentar obtener el objeto directamente de la lista renderizada
        try {
          const lista = (window.ultimaListaLeads || []);
          const sameId = (v) => {
            try { return extractLeadId(v) === id; } catch { return false; }
          };
          const localLead = lista.find(sameId);
          if (localLead) {
            abrirModalEdicion(localLead);
            return;
          }
        } catch(_) {}

        // 2) Fallback: intentar obtener el lead desde el backend (customers primero)
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const tryFetch = async (url) => {
          const res = await fetch(url, {
            method: 'GET',
            headers: { 'Authorization': token ? `Bearer ${token}` : undefined, 'Content-Type': 'application/json' }
          });
          if (!res.ok) return null;
          // Evitar parseo de HTML si el backend devolvió página de error
          const txt = await res.text();
          try { return JSON.parse(txt); } catch { return null; }
        };

        let data = await tryFetch(`/api/customers/${id}`);
        if (!data) data = await tryFetch(`/api/leads/${id}`);
        if (!data) throw new Error('No se pudo obtener el registro');

        const lead = data.data || data.lead || data;
        
        if (!lead) {
          alert('Error: No se encontró el registro con ID: ' + id);
          return;
        }

        // Abrir modal de edición
        try { window.__currentEditingSource = data.source || (data.lead ? 'leads' : 'customers'); } catch(_) {}
        abrirModalEdicion(lead);
      } catch (error) {
        console.error('Error al editar lead:', error);
        alert('Error al cargar los datos del registro: ' + (error?.message || error));
      }
    };

    // Función para abrir el modal de edición
    function abrirModalEdicion(lead) {
      const modal = document.getElementById('editarModal');
      if (!modal) {
        console.error('Modal de edición no encontrado');
        return;
      }

      // Poblar campos del formulario
      const leadId = lead._id || lead.id || '';
      document.getElementById('edit-id').value = leadId;
      const idSpan = document.getElementById('edit-lead-id-display');
      if (idSpan) idSpan.textContent = formatLeadIdShort(leadId);

      const fullName = (lead.nombre_cliente || '').trim();
      const parts = fullName.split(' ');
      const nombres = parts.slice(0, Math.max(1, parts.length - 1)).join(' ');
      const apellidos = parts.length > 1 ? parts.slice(-1).join(' ') : '';
      document.getElementById('edit-nombres').value = nombres;
      document.getElementById('edit-apellidos').value = apellidos;

      document.getElementById('edit-telefono').value = lead.telefono_principal || '';
      document.getElementById('edit-telefono-alt').value = lead.telefono_alterno || '';
      document.getElementById('edit-numero-cuenta').value = lead.numero_cuenta || '';
      document.getElementById('edit-autopago').value = (lead.autopago || '').toString().toUpperCase();
      document.getElementById('edit-direccion').value = lead.direccion || '';
      document.getElementById('edit-tipo-servicios').value = lead.tipo_servicios || lead.tipo_servicio || '';
      document.getElementById('edit-sistema').value = lead.sistema || '';
      document.getElementById('edit-riesgo').value = lead.riesgo || '';
      document.getElementById('edit-dia-venta').value = (lead.dia_venta || '').slice(0,10);
      document.getElementById('edit-dia-instalacion').value = (lead.dia_instalacion || '').slice(0,10);
      document.getElementById('edit-status').value = lead.status || '';
      document.getElementById('edit-mercado').value = lead.mercado || '';
      document.getElementById('edit-supervisor').value = lead.supervisor || '';
      document.getElementById('edit-comentario').value = lead.comentario || '';
      document.getElementById('edit-motivo-llamada').value = lead.motivo_llamada || '';
      document.getElementById('edit-zip-code').value = (lead.zip_code || lead.zip || lead.ZIP || lead.cp || lead.codigo_postal || lead.postalCode || '');
      document.getElementById('edit-puntaje').value = lead.puntaje || '';

      // Poblar notas existentes
      try {
        const list = document.getElementById('edit-notes-list');
        if (list) {
          list.innerHTML = '';
          const notas = Array.isArray(lead.notas) ? lead.notas
            : Array.isArray(lead.notes) ? lead.notes
            : [];
          if (notas.length) {
            notas.forEach(n => {
              const div = document.createElement('div');
              div.className = 'note-card';
              div.textContent = (n.text || n.comentario || n) + (n.author ? ` — ${n.author}` : '') + (n.at ? ` (${new Date(n.at).toLocaleString()})` : '');
              list.appendChild(div);
            });
          } else if (lead.comentario) {
            const div = document.createElement('div');
            div.className = 'note-card';
            div.textContent = lead.comentario;
            list.appendChild(div);
          }
        }
      } catch(_) {}

      try { window.__currentEditingLead = lead; } catch(_) {}
      // Mostrar modal
      modal.style.display = 'block';
    }

    // Agregar nota desde el modal
    window.agregarNotaCliente = async function() {
      try {
        const textarea = document.getElementById('edit-nueva-nota');
        const list = document.getElementById('edit-notes-list');
        const text = (textarea?.value || '').trim();
        if (!text) return alert('Escribe una nota');
        const leadId = document.getElementById('edit-id').value;
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        let ok = false; let lastTxt = '';
        if (leadId) {
          // Intentar endpoints de notas en customers y leads
          for (const ep of [`/api/customers/${leadId}/notes`, `/api/leads/${leadId}/notes`]) {
            try {
              const r = await fetch(ep, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : undefined },
                body: JSON.stringify({ text })
              });
              if (r.ok) { ok = true; break; }
              try { lastTxt = await r.text(); } catch(_) {}
            } catch(e) { lastTxt = e?.message || String(e); }
          }
        }

        // Render inmediato en UI
        const div = document.createElement('div');
        div.className = 'note-card';
        try {
          const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const author = u.username || u.name || u.nombre || 'Usuario';
          div.textContent = `${text} — ${author} (${new Date().toLocaleString()})`;
        } catch { div.textContent = text; }
        if (list) list.prepend(div); else textarea.insertAdjacentElement('afterend', div);
        if (textarea) textarea.value = '';

        if (!ok && leadId) {
          // Fallback: guardar dentro del documento usando PUT con campo notas
          try {
            const current = (window.__currentEditingLead && (window.__currentEditingLead.notas || window.__currentEditingLead.notes)) || [];
            const notas = Array.isArray(current) ? current.slice() : [];
            const author = (JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}').username) || 'Usuario';
            notas.push({ text, author, at: new Date().toISOString() });
            for (const uurl of [`/api/customers/${leadId}`, `/api/leads/${leadId}`]) {
              const putRes = await fetch(uurl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : undefined },
                body: JSON.stringify({ notas })
              });
              if (putRes.ok) { ok = true; break; }
              try { lastTxt = await putRes.text(); } catch(_) {}
            }
          } catch(e) { lastTxt = e?.message || String(e); }
        }

        if (!ok && leadId) alert('No se pudo persistir la nota: ' + (lastTxt || 'Error desconocido'));
      } catch (e) {
        console.error('Error en agregarNotaCliente:', e);
        alert('Error al agregar la nota: ' + (e?.message || e));
      }
    };

    // Función para cerrar el modal de edición
    window.cerrarModalEdicion = function() {
      const modal = document.getElementById('editarModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Función para guardar los cambios
    window.guardarCambiosLead = async function() {
      const leadId = document.getElementById('edit-id').value;
      
      const nombreCompleto = [
        document.getElementById('edit-nombres').value.trim(),
        document.getElementById('edit-apellidos').value.trim()
      ].filter(Boolean).join(' ');

      const tipoServicio = (document.getElementById('edit-tipo-servicios').value
        || (window.__currentEditingLead && (window.__currentEditingLead.tipo_servicio || window.__currentEditingLead.tipo_servicios || window.__currentEditingLead.servicios_texto))
        || '').toString().trim();
      if (!tipoServicio) {
        alert('Falta el campo "Tipo de servicio"');
        try { document.getElementById('edit-tipo-servicios').focus(); } catch(_) {}
        return;
      }
      const datosActualizados = {
        nombre_cliente: nombreCompleto,
        telefono_principal: document.getElementById('edit-telefono').value,
        telefono_alterno: document.getElementById('edit-telefono-alt').value,
        numero_cuenta: document.getElementById('edit-numero-cuenta').value,
        autopago: document.getElementById('edit-autopago').value,
        direccion: document.getElementById('edit-direccion').value,
        // Compatibilidad: enviar ambos nombres de campo
        tipo_servicio: tipoServicio,
        tipo_servicios: tipoServicio,
        sistema: document.getElementById('edit-sistema').value,
        riesgo: document.getElementById('edit-riesgo').value,
        dia_venta: document.getElementById('edit-dia-venta').value,
        dia_instalacion: document.getElementById('edit-dia-instalacion').value,
        status: document.getElementById('edit-status').value,
        mercado: document.getElementById('edit-mercado').value,
        supervisor: document.getElementById('edit-supervisor').value,
        comentario: document.getElementById('edit-comentario').value,
        motivo_llamada: document.getElementById('edit-motivo-llamada').value,
        zip_code: document.getElementById('edit-zip-code').value,
        zip: document.getElementById('edit-zip-code').value,
        puntaje: parseFloat(document.getElementById('edit-puntaje').value) || 0
      };

      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        let method = 'PUT';
        // Intentar customers primero, luego leads
        let candidates = leadId ? [`/api/customers/${leadId}`, `/api/leads/${leadId}`] : ['/api/leads'];
        let url = candidates[0];
        // Si no hay ID, crear (POST)
        if (!leadId) {
          method = 'POST';
          url = '/api/leads';
          try {
            const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const agenteId = u.id || u._id || u?.usuario?._id || u?.user?._id || '';
            const agenteNombre = u.username || u.name || u.nombre || u?.usuario?.name || u?.usuario?.nombre || '';
            if (agenteId) datosActualizados.agenteId = agenteId;
            if (agenteNombre) {
              datosActualizados.agenteNombre = agenteNombre;
              datosActualizados.nombreAgente = agenteNombre;
              datosActualizados.agente = agenteNombre;
            }
          } catch(_) {}
        }

        // Intentar en cadena sobre las URLs candidatas
        let lastErrTxt = '';
        let ok = false;
        for (const uurl of candidates) {
          const resp = await fetch(uurl, {
            method,
            headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : undefined },
            body: JSON.stringify(datosActualizados)
          });
          if (resp.ok) { ok = true; break; }
          try { lastErrTxt = await resp.text(); } catch(_) {}
        }
        if (!ok) {
          let msg = 'Error al actualizar el registro';
          if (lastErrTxt) msg += ': ' + lastErrTxt;
          throw new Error(msg);
        }

        alert('✅ Registro actualizado exitosamente');
        cerrarModalEdicion();
        
        // Recargar la tabla
        location.reload();
      } catch (error) {
        console.error('Error al guardar cambios:', error);
        alert('❌ Error al actualizar el registro: ' + error.message);
      }
    };

    window.eliminarLead = function(id) {
      if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
        console.log('Eliminar lead:', id);
        alert('Función de eliminación - ID: ' + id + '\n\nEsta funcionalidad se implementará próximamente.');
        // TODO: Implementar lógica de eliminación
      }
    };
  </script>
  <!-- Cargar primero el m¨®dulo de datos de clientes -->
  <!-- <script src="js/data/costumer-mock-data.js"></script> -->
  <script>
    // Funci¨®n para mostrar mensajes de depuraci¨®n
    function debugLog(message, data) {
      if (data !== undefined) {
        console.log(`[DEBUG] ${message}`, data);
      } else {
        console.log(`[DEBUG] ${message}`);
      }
    }

    // Logs de diagn¨®stico: conteo por TEAM y por agente (incluye "Sin asignar (TEAM IRANIA)")
    function logDiagnosticoAsignacion(leads) {
      try {
        const norm = (s) => {
          try {
            return String(s || '')
              .toLowerCase()
              .normalize('NFD')
              .replace(/\p{Diacritic}/gu, '')
              .trim();
          } catch { return ''; }
        };

        const getTeam = (l) => {
          const t = l?.supervisor || l?.team || l?.Team || l?.equipo || l?._raw?.supervisor || l?._raw?.team || l?._raw?.equipo || '';
          return t ? t.toString().trim() : '';
        };
        const getAgentSimple = (l) => {
          const cand = [
            l?.agenteNombre,
            l?.nombreAgente,
            l?.agente,
            l?.agent,
            l?._raw?.agenteNombre,
            l?._raw?.nombreAgente,
            l?._raw?.agente,
            l?._raw?.agent
          ];
          const v = cand.find(x => x && String(x).trim().length);
          return v ? String(v).trim() : '';
        };

        const perTeam = new Map(); // team -> Map(agentLabel -> count)
        for (const l of Array.isArray(leads) ? leads : []) {
          const team = getTeam(l);
          const teamKey = team || '(Sin TEAM)';
          const teamMap = perTeam.get(teamKey) || new Map();
          let agent = getAgentSimple(l);
          // Marcar sin asignar para TEAM IRANIA
          if (!agent) {
            const tnorm = norm(team);
            if (tnorm.includes('team irania')) agent = 'Sin asignar (TEAM IRANIA)';
            else agent = '(Sin agente)';
          }
          teamMap.set(agent, (teamMap.get(agent) || 0) + 1);
          perTeam.set(teamKey, teamMap);
        }

        // Log general
        const resumen = {};
        for (const [team, m] of perTeam.entries()) {
          resumen[team] = Object.fromEntries([...m.entries()].sort((a,b) => b[1]-a[1]));
        }
        console.log('[DIAGN?STICO ASIGNACI?N] Conteo por TEAM y agente:', resumen);

        // Log espec¨ªfico TEAM IRANIA
        const keyIrania = [...perTeam.keys()].find(k => norm(k).includes('team irania'));
        if (keyIrania) {
          console.log(`[AGRUPACI?N TEAM IRANIA] Conteo por agente:`, Object.fromEntries(perTeam.get(keyIrania).entries()));
        }
      } catch (e) {
        console.warn('logDiagnosticoAsignacion: error al generar diagn¨®stico', e);
      }
    }

    // Helpers para UI de comentarios
    function escapeHtml(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      } catch { return ''; }
    }

    function normalizarTexto(s) {
      try {
        return String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu, '')
          .trim();
      } catch { return ''; }
    }

    function obtenerIniciales(nombre) {
      const n = String(nombre || '').trim();
      if (!n) return '?';
      const parts = n.split(/\s+/);
      const first = parts[0]?.[0] || '';
      const last = parts.length > 1 ? parts[parts.length - 1]?.[0] : '';
      return (first + last).toUpperCase();
    }

    function obtenerUsuarioActual() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return user.name || user.nombre || user.email || user.username || 'Yo';
      } catch {
        return 'Yo';
      }
    }

    // Funci¨®n para inicializar la p¨¢gina
    function initPage() {
      debugLog('Inicializando p¨¢gina...');
      cargarInfoUsuario();
    }
    // Funci¨®n para cargar la informaci¨®n del usuario
    function cargarInfoUsuario() {
      debugLog('Iniciando cargarInfoUsuario');
      
      try {
        // Datos de usuario de ejemplo
        const userData = {
          name: 'Usuario Demo',
          role: 'admin',
          email: 'demo@example.com'
        };
        
        debugLog('Datos de usuario a mostrar:', userData);
        
        // Actualizar la interfaz con los datos del usuario
        if (userData.name) {
          const userNameElement = document.getElementById('sidebar-user-name');
          debugLog('Elemento de nombre de usuario encontrado:', !!userNameElement);
          if (userNameElement) {
            debugLog('Actualizando nombre de usuario a:', userData.name);
            userNameElement.textContent = userData.name;
            userNameElement.style.color = '#2d3748'; // Asegurar que el color sea visible
            debugLog('Nombre de usuario actualizado correctamente');
          } else {
            debugLog('No se encontr¨® el elemento sidebar-user-name');
          }
        }
        
        if (userData.role) {
          const userRoleElement = document.getElementById('sidebar-user-role');
          debugLog('Elemento de rol de usuario encontrado:', !!userRoleElement);
          if (userRoleElement) {
            // Formatear el rol para mostrarlo mejor
            const roleNames = {
              'admin': 'Administrador',
              'supervisor': 'Supervisor',
              'agent': 'Agente'
            };
            const rolMostrado = roleNames[userData.role] || userData.role;
            debugLog('Actualizando rol de usuario a:', rolMostrado);
            userRoleElement.textContent = rolMostrado;
            userRoleElement.style.display = 'inline-block'; // Asegurar que sea visible
            debugLog('Rol de usuario actualizado correctamente');
          } else {
            debugLog('No se encontr¨® el elemento sidebar-user-role');
          }
        }
      } catch (error) {
        console.error('Error en cargarInfoUsuario:', error);
      }
    }

    // Configurar botón de cerrar sesión y cargar info del usuario
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM completamente cargado, inicializando página...');
      // Inicializar la página
      initPage();
      
      // Configurar botón de cerrar sesión
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          // Redirigir a la p¨¢gina de inicio de sesi¨®n
          window.location.href = 'index.html';
        });
      }
    });
  </script>
  
  <!-- Script de cierre de sesión unificado -->
  <script src="js/auth-logout.js"></script>
  <!-- <script src="js/monthly-cutoff.js"></script> -->
  
  <!-- Utilidades de fecha (IMPORTANTE: cargar primero para evitar bug UTC) -->
  <!-- <script src="js/date-utils.js?v=1"></script> -->
  
  <!-- Scripts de Costumer -->
  <!-- <script src="js/costumer-actions.js?v=5"></script> -->
  <!-- <script src="js/costumer-init.js?v=5"></script> -->
  <!-- <script src="js/costumer-calendar.js?v=5"></script> -->
</body>
</html>
